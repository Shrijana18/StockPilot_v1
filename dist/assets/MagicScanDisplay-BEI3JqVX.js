import{l as ue,j as e}from"./index-DRC3F7i0.js";import{r as f}from"./router-BPBaD_i0.js";import{P as E,s as me}from"./pricing-SUVGnFgL.js";function pe(t){return new Promise(s=>setTimeout(s,t))}async function fe(t=!1){try{const s=ue.currentUser;return s?await s.getIdToken(t):null}catch{return null}}async function M(t,s,n,{timeoutMs:l=2e4,retries:i=1,requireAuth:c=!1,headers:p={}}={}){let o;for(let d=0;d<=i;d++){const u=new AbortController,r=setTimeout(()=>u.abort(),l);try{const m=await fe(d!==0),b={"Content-Type":"application/json",...p};if(m&&(b.Authorization=`Bearer ${m}`),c&&!m)throw new Error("Not authenticated");const a=await fetch(s,{method:t,headers:b,body:n!==void 0?JSON.stringify(n):void 0,signal:u.signal});clearTimeout(r);let h=null;try{h=await a.json()}catch{h=null}if(!a.ok){const x=h&&(h.error||h.message)||`HTTP ${a.status}`,S=new Error(x);throw S.status=a.status,S}return h}catch(m){if(clearTimeout(r),o=m,d===i)break;await pe(400*(d+1))}}throw o||new Error("Request failed")}const L={get:(t,s)=>M("GET",t,void 0,s),post:(t,s,n)=>M("POST",t,s,n),put:(t,s,n)=>M("PUT",t,s,n),del:(t,s)=>M("DELETE",t,void 0,s)},ee={},he=typeof window<"u"&&window._SP_FN_REGION||ee?.VITE_FN_REGION||"us-central1",xe=typeof window<"u"&&window._SP_PROJECT_ID||ee?.VITE_PROJECT_ID||"stockpilotv1",ge=`https://${he}-${xe}.cloudfunctions.net/lookupBarcode`;async function Te(t){if(!t)throw new Error("No barcode provided");try{const s=await L.post(ge,{code:t},{timeoutMs:15e3,retries:1});if(s?.ok===!1){const n=s?.error||s?.message||"Lookup failed";throw new Error(n)}if(!s?.data&&!s?.product)throw new Error("Lookup response missing data");return s.data||s.product}catch(s){const n=s?.message||String(s);throw/abort/i.test(n)?new Error("Barcode lookup timed out. Please check your connection and try again."):new Error(`Network error during barcode lookup: ${n}`)}}const V={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_FUNCTIONS_ORIGIN:"https://us-central1-stockpilotv1.cloudfunctions.net",VITE_MSG91_WIDGET_ID:"356a79684758348381353138",VITE_PARSE_URL:"https://asia-south1-stockpilotv1.cloudfunctions.net/parse",VITE_REACT_APP_OCR_FUNCTION_URL:"https://ocrfromimage-rg2uh6cnqq-el.a.run.app",VITE_SPEECH_WS_URL:"wss://flyp-voice-streamer-30934537475.asia-south1.run.app/ws"};async function Ee(t){try{if(t&&typeof window<"u"&&/image\//.test(t.type)){const c=await new Promise((x,S)=>{const w=new FileReader;w.onload=()=>x(w.result),w.onerror=()=>S(new Error("File read error")),w.readAsDataURL(t)}),p=await new Promise((x,S)=>{const w=new Image;w.onload=()=>x(w),w.onerror=()=>S(new Error("Image load error")),w.src=c}),o=768,d=768;let{width:u,height:r}=p;const m=Math.min(1,o/u,d/r);m<1&&(u=Math.round(u*m),r=Math.round(r*m));const b=document.createElement("canvas");return b.width=u,b.height=r,b.getContext("2d").drawImage(p,0,0,u,r),b.toDataURL("image/jpeg",.72).replace(/^data:[^;]+;base64,/,"")}}catch(c){console.warn("fileToBase64 downscale path failed, falling back:",c?.message||c)}if(!t||typeof t.arrayBuffer!="function")throw new Error("fileToBase64: invalid file/blob");const s=await t.arrayBuffer();let n="";const l=new Uint8Array(s),i=32768;for(let c=0;c<l.length;c+=i){const p=l.subarray(c,c+i);n+=String.fromCharCode.apply(null,p)}return btoa(n)}function te(t){return t&&String(t).trim().replace(/^data:[^;]+;base64,/,"")}const be=typeof window<"u"&&window._SP_FN_REGION||typeof import.meta<"u"&&V&&void 0||"us-central1",we=typeof window<"u"&&window._SP_PROJECT_ID||typeof import.meta<"u"&&V&&void 0||"stockpilotv1",re=typeof window<"u"&&window._SP_FN_HOST||typeof import.meta<"u"&&V&&void 0||`https://${be}-${we}.cloudfunctions.net`;async function Pe(t={}){const{base64:s,imageBase64:n,contextPrompt:l=""}=t||{},i=te(s||n||"");if(!i)throw new Error("identifyProductFromImage: provide { base64 }");const c=`${re}/identifyProductFromImage`,p={imageBase64:i,contextPrompt:l},o=await L.post(c,p,{timeoutMs:25e3,retries:1});if(!(o?.ok??o?.success??!1)){const r=o?.message||o?.error||"Image identify failed";throw new Error(r)}const u=o.product||o.best||o.autofill||{};return{ok:!0,product:u,best:o.best||u,suggestions:o.suggestions||[],raw:o}}async function Ie(t={}){const{base64:s,imageBase64:n,contextPrompt:l=""}=t||{},i=te(s||n||"");if(!i)throw new Error("identifyProductsFromImage: provide { base64 }");const c=`${re}/identifyProductsFromImage`,p={imageBase64:i,contextPrompt:l},o=await L.post(c,p,{timeoutMs:4e4,retries:1});if(!(o?.ok??o?.success??!1)){const m=o?.message||o?.error||"Multi identify failed";throw new Error(m)}const u=Array.isArray(o.products)?o.products:Array.isArray(o.items)?o.items:[],r=Number(o.total!==void 0?o.total:o.count!==void 0?o.count:u.length);return{ok:!0,products:u,items:u,count:r,total:r,raw:o}}const ye=[{hsn:"1905",rate:18,keywords:["biscuit","cookie","wafer"],description:"Bread, pastry, cakes, biscuits"},{hsn:"1905",rate:5,keywords:["bread","khari"],description:"Bread (often 5%‚Äîcheck local notifications)"},{hsn:"0401",rate:5,keywords:["milk","dairy"],description:"Milk & dairy (many are exempt/5%, verify exact item)"},{hsn:"0403",rate:12,keywords:["curd","lassi","buttermilk","yogurt"],description:"Fermented dairy (curd, lassi)"},{hsn:"0406",rate:12,keywords:["cheese"],description:"Cheese"},{hsn:"1006",rate:0,keywords:["rice","basmati"],description:"Rice (often nil if unpacked)"},{hsn:"1101",rate:5,keywords:["atta","flour","maida","wheat flour"],description:"Flours (packaged often 5%)"},{hsn:"0910",rate:5,keywords:["haldi","turmeric","masala"],description:"Spices (e.g., turmeric) often 5%"},{hsn:"0902",rate:5,keywords:["tea","chai"],description:"Tea"},{hsn:"0901",rate:5,keywords:["coffee"],description:"Coffee"},{hsn:"1701",rate:5,keywords:["sugar"],description:"Sugar"},{hsn:"1704",rate:18,keywords:["chocolate","toffee","candy"],description:"Sugar confectionery / chocolate"},{hsn:"2202",rate:18,keywords:["soft drink","cola","juice","energy drink"],description:"Soft drinks / beverages (non-alcoholic)"},{hsn:"3305",rate:18,keywords:["shampoo","hair oil"],description:"Hair preparations (shampoo, oils)"},{hsn:"3306",rate:18,keywords:["toothpaste","oral","mouthwash"],description:"Oral/dental"},{hsn:"3304",rate:18,keywords:["cosmetic","cream","makeup","lipstick","kajal"],description:"Beauty/makeup preparations"},{hsn:"3401",rate:18,keywords:["soap","detergent"],description:"Soap & detergents"},{hsn:"61xx",rate:12,keywords:["tshirt","shirt","jeans","trouser","kurti","saree","cloth","garment","apparel"],description:"Apparel (value-based slabs apply)"},{hsn:"62xx",rate:12,keywords:["jacket","blazer","dress","skirt","suit"],description:"Apparel (woven)"},{hsn:"8517",rate:18,keywords:["mobile","smartphone","cellphone"],description:"Telephone sets / mobiles"},{hsn:"8528",rate:18,keywords:["tv","television","monitor"],description:"Monitors/Televisions"},{hsn:"8504",rate:18,keywords:["charger","adapter","power supply"],description:"Power supplies/chargers"},{hsn:"8507",rate:18,keywords:["battery"],description:"Batteries"},{hsn:"8536",rate:18,keywords:["switch","mcb","socket"],description:"Electrical apparatus for switching"},{hsn:"7318",rate:18,keywords:["screw","nut","bolt","fastener"],description:"Screws, bolts, nuts"},{hsn:"8201",rate:12,keywords:["shovel","spade","hoe"],description:"Hand tools for agriculture"}];function D(t){return String(t||"").toLowerCase().trim()}function Z(t={}){const s=D(t.name),n=D(t.category),l=`${s} ${n}`.trim();if(!l)return null;let i=null,c=0;for(const o of ye){let d=0;for(const u of o.keywords){if(!u)continue;const r=D(u);r.length!==0&&l.includes(r)&&(d+=Math.min(1,r.length/10))}d>c&&(c=d,i=o)}if(!i||c===0)return null;const p=Math.max(.5,Math.min(.95,.6+c/3));return{rate:i.rate,hsn:i.hsn,description:i.description,source:"keyword_suggested",confidence:p}}function Fe({mode:t,setMode:s,values:n,onChange:l,productName:i,category:c}){const p=a=>Number(a)||0,o=p(n?.mrp),d=p(n?.basePrice),u=p(n?.taxRate),r=n?.legacySellingPrice===""?"":p(n?.legacySellingPrice),m=f.useMemo(()=>t!==E.MRP_INCLUSIVE||!o?null:me(o,u||0),[t,o,u]),b=[{key:E.LEGACY,label:"Simple"},{key:E.MRP_INCLUSIVE,label:"MRP (incl. GST)"},{key:E.BASE_PLUS_TAX,label:"Base + GST"}];return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:b.map(a=>e.jsx("button",{type:"button",onClick:()=>s(a.key),className:`px-3 py-1 rounded-md border text-sm transition
              ${t===a.key?"bg-emerald-600/20 border-emerald-500":"border-zinc-600 hover:border-zinc-500"}`,children:a.label},a.key))}),t===E.LEGACY&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-zinc-400",children:"Selling Price (Final)"}),e.jsx("input",{type:"number",inputMode:"decimal",value:r??"",onChange:a=>l({legacySellingPrice:a.target.value===""?"":+a.target.value}),className:"w-full mt-1 rounded-md bg-zinc-800 border border-zinc-600 px-3 py-2",placeholder:"e.g., 118.00"})]})}),t===E.MRP_INCLUSIVE&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-zinc-400",children:"MRP (incl. GST)"}),e.jsx("input",{type:"number",inputMode:"decimal",value:n?.mrp??"",onChange:a=>l({mrp:a.target.value===""?"":+a.target.value}),className:"w-full mt-1 rounded-md bg-zinc-800 border border-zinc-600 px-3 py-2",placeholder:"e.g., 118.00"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-xs text-zinc-400",children:["GST % ",e.jsx("span",{className:"text-zinc-500",children:"(optional)"})]}),e.jsx("button",{type:"button",onClick:()=>{const a=Z({name:i,category:c});a&&l({taxRate:a.rate,hsnCode:a.hsn,taxSource:a.source,taxConfidence:a.confidence})},className:"text-xs px-2 py-1 rounded border border-zinc-600 hover:border-zinc-500",title:"Try to guess GST % from product/category",children:"Suggest GST"})]}),e.jsx("input",{type:"number",inputMode:"decimal",value:n?.taxRate??"",onChange:a=>l({taxRate:a.target.value===""?"":+a.target.value}),className:"w-full mt-1 rounded-md bg-zinc-800 border border-zinc-600 px-3 py-2",placeholder:"e.g., 5, 12, 18"}),(n?.hsnCode||n?.taxSource)&&e.jsxs("div",{className:"mt-1 text-[11px] text-zinc-500",children:[n?.taxSource==="keyword_suggested"?"Suggested":"Provided"," HSN: ",n?.hsnCode||"‚Äî"]})]})]}),m&&e.jsxs("div",{className:"text-xs text-zinc-400",children:["Split preview: Base ‚Çπ",m.base.toFixed(2)," + GST ‚Çπ",m.tax.toFixed(2)," = ‚Çπ",o.toFixed(2)]})]}),t===E.BASE_PLUS_TAX&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-zinc-400",children:"Unit/Base Price (excl. GST)"}),e.jsx("input",{type:"number",inputMode:"decimal",value:n?.basePrice??"",onChange:a=>l({basePrice:a.target.value===""?"":+a.target.value}),className:"w-full mt-1 rounded-md bg-zinc-800 border border-zinc-600 px-3 py-2",placeholder:"e.g., 100.00"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-xs text-zinc-400",children:["GST % ",e.jsx("span",{className:"text-zinc-500",children:"(optional)"})]}),e.jsx("button",{type:"button",onClick:()=>{const a=Z({name:i,category:c});a&&l({taxRate:a.rate,hsnCode:a.hsn,taxSource:a.source,taxConfidence:a.confidence})},className:"text-xs px-2 py-1 rounded border border-zinc-600 hover:border-zinc-500",title:"Try to guess GST % from product/category",children:"Suggest GST"})]}),e.jsx("input",{type:"number",inputMode:"decimal",value:n?.taxRate??"",onChange:a=>l({taxRate:a.target.value===""?"":+a.target.value}),className:"w-full mt-1 rounded-md bg-zinc-800 border border-zinc-600 px-3 py-2",placeholder:"e.g., 5, 12, 18"}),(n?.hsnCode||n?.taxSource)&&e.jsxs("div",{className:"mt-1 text-[11px] text-zinc-500",children:[n?.taxSource==="keyword_suggested"?"Suggested":"Provided"," HSN: ",n?.hsnCode||"‚Äî"]})]})]}),d>0&&e.jsxs("div",{className:"text-xs text-zinc-400",children:["Final preview: ‚Çπ",(d+d*(u||0)/100).toFixed(2)," ","(Base ‚Çπ",d.toFixed(2)," + GST ‚Çπ",(d*(u||0)/100).toFixed(2),")"]})]})]})}function ze({open:t,onClose:s,onDetected:n,torch:l=!1}){const i=f.useRef(null),c=f.useRef(null),p=f.useRef(null),o=f.useRef(null),[d,u]=f.useState(""),[r,m]=f.useState(!0),[b,a]=f.useState(!1);return f.useEffect(()=>{if(!t)return;let h=!1;const x=()=>{if(p.current&&cancelAnimationFrame(p.current),p.current=null,i.current){try{i.current.pause()}catch{}i.current.srcObject=null}c.current&&(c.current.getTracks().forEach(w=>w.stop()),c.current=null),a(!1)};return(async()=>{if(u(""),a(!0),!("BarcodeDetector"in window)){m(!1),a(!1);return}try{const T=["ean_13","ean_8","upc_a","upc_e","code_128","code_39","qr_code","pdf417","aztec","data_matrix"];o.current=new window.BarcodeDetector({formats:T});const A={video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},audio:!1},P=await navigator.mediaDevices.getUserMedia(A);if(h)return;if(c.current=P,i.current){if(i.current.srcObject=P,await i.current.play(),l)try{const _=P.getVideoTracks()[0];(_.getCapabilities?.()||{}).torch&&await _.applyConstraints({advanced:[{torch:!0}]})}catch{}const F=async()=>{if(!i.current||i.current.readyState!==4){p.current=requestAnimationFrame(F);return}try{const _=await o.current.detect(i.current);if(_&&_.length){const{rawValue:I,format:C}=_[0];x(),n?.({rawValue:I,format:C});return}}catch{}p.current=requestAnimationFrame(F)};F()}}catch(T){u(T?.message||"Unable to access camera"),a(!1)}})(),()=>{h=!0,x()}},[t,n,l]),t?e.jsx("div",{className:"fixed inset-0 z-[2000] bg-black/70 backdrop-blur-sm flex items-center justify-center",children:e.jsxs("div",{className:"relative bg-white w-[min(92vw,760px)] rounded-2xl shadow-2xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"inline-flex h-2 w-2 rounded-full bg-emerald-500 animate-pulse"}),e.jsx("h3",{className:"text-lg font-semibold",children:r?"Scan Barcode / QR":"Scanner Not Supported"})]}),e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1.5 rounded-md border text-sm hover:bg-gray-50",children:"Close"})]}),r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative bg-black",children:[e.jsx("video",{ref:i,className:"w-full max-h-[65vh] object-contain",playsInline:!0,muted:!0}),e.jsx("div",{className:"pointer-events-none absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-[80%] h-44 border-2 border-white/80 rounded-xl shadow-[0_0_0_9999px_rgba(0,0,0,0.35)]"})}),e.jsx("div",{className:"absolute left-4 bottom-4 text-[11px] bg-white/90 text-gray-800 px-2.5 py-1 rounded-full",children:b?"Scanning‚Ä¶":"Idle"})]}),e.jsxs("div",{className:"p-3 text-center text-xs text-gray-600",children:["Align the code within the box. It auto-detects EAN/UPC/Code128/QR.",d?e.jsx("div",{className:"text-red-600 mt-2",children:d}):null]})]}):e.jsxs("div",{className:"p-6 text-sm",children:[e.jsx("p",{className:"font-medium mb-2",children:"Your browser doesn‚Äôt support the Barcode Detection API."}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-gray-600",children:[e.jsx("li",{children:"Try Chrome on Android or a recent desktop Chromium browser."}),e.jsx("li",{children:"You can still type or paste the code manually in the form."}),e.jsx("li",{children:"We can add a fallback library (Quagga2 / html5-qrcode) later if you need iOS Safari support."})]})]})]})}):null}function ve(t,s,n){const i=t.getImageData(0,0,s,n).data;let c=0,p=0;const o=[0,1,0,1,-4,1,0,1,0];for(let u=1;u<n-1;u+=4)for(let r=1;r<s-1;r+=4){const m=(u*s+r)*4,b=i[m]*.299+i[m+1]*.587+i[m+2]*.114;c+=b;let a=0;for(let h=-1;h<=1;h++)for(let x=-1;x<=1;x++){const S=(h+1)*3+(x+1),w=((u+h)*s+(r+x))*4,T=i[w]*.299+i[w+1]*.587+i[w+2]*.114;a+=T*o[S]}p+=a*a}const d=s/4*(n/4);return{brightness:c/d,sharpness:p/d}}function ke({busy:t,statusText:s="Scanning‚Ä¶",frameQuality:n="poor",statusHint:l="Align product",scanState:i="idle"}){const c=n==="good",p=i==="idle",o=i==="analyzing";let d="border-red-400 animate-pulse-red";return p&&(d="border-white/50"),c&&(d="border-emerald-300 animate-pulse-green"),e.jsxs("div",{className:"absolute inset-0 pointer-events-none z-20",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/35 via-black/10 to-black/35"}),e.jsxs("div",{className:"absolute inset-4 md:inset-6 rounded-2xl overflow-hidden ring-2 ring-white/20 transition-all duration-300",children:[o&&e.jsx("div",{className:"absolute top-0 left-0 w-full h-full overflow-hidden",children:e.jsx("div",{className:"laser-line"})}),e.jsx("div",{className:`absolute top-0 left-0 w-12 h-12 md:w-16 md:h-16 border-t-4 border-l-4 rounded-tl-2xl transition-all duration-300 ${d}`}),e.jsx("div",{className:`absolute top-0 right-0 w-12 h-12 md:w-16 md:h-16 border-t-4 border-r-4 rounded-tr-2xl transition-all duration-300 ${d}`}),e.jsx("div",{className:`absolute bottom-0 left-0 w-12 h-12 md:w-16 md:h-16 border-b-4 border-l-4 rounded-bl-2xl transition-all duration-300 ${d}`}),e.jsx("div",{className:`absolute bottom-0 right-0 w-12 h-12 md:w-16 md:h-16 border-b-4 border-r-4 rounded-br-2xl transition-all duration-300 ${d}`})]}),e.jsx("div",{className:"absolute bottom-3 inset-x-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/55 backdrop-blur text-white text-xs font-medium shadow-lg",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full transition-colors ${t?"bg-amber-300 animate-pulse":c?"bg-emerald-300":p?"bg-white/50":"bg-red-400"}`}),t?s:l]})})]})}function Me({open:t,onClose:s,onCapture:n,busy:l=!1,title:i="Magic Scan (Live)",subtitle:c="Align the product in the frame. The scan will trigger automatically when the image is clear.",badge:p,batchMode:o=!1,statusText:d="Scanning‚Ä¶",error:u=""}){const r=f.useRef(null),m=f.useRef(null),b=f.useRef(null),a=f.useRef(null),h=f.useRef(!1),[x,S]=f.useState("idle"),[w,T]=f.useState(!1),[A,P]=f.useState("poor"),[F,_]=f.useState("Ready to scan"),I=f.useRef(0),[C,$]=f.useState(!1),[Se,q]=f.useState(""),[je,B]=f.useState(!1),[Ne,ae]=f.useState(1),se=f.useRef(1),ne=f.useRef(1),[H,oe]=f.useState("environment"),[J,O]=f.useState(!1),[Q,Y]=f.useState(!0),G=()=>{try{b.current&&b.current.getTracks().forEach(v=>v.stop()),b.current=null,a.current=null,m.current&&(m.current.width=0,m.current.height=0)}catch{}},ie=async()=>{G(),$(!1),q("");const v={video:{facingMode:H,width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:!1};let k;try{k=await navigator.mediaDevices.getUserMedia(v)}catch(g){throw q("Camera access failed. Please allow camera permissions."),g}b.current=k;const j=k.getVideoTracks()[0];a.current=j;try{await j.applyConstraints({advanced:[{focusMode:"continuous"}]})}catch{}try{await j.applyConstraints({advanced:[{exposureMode:"continuous"}]})}catch{}try{await j.applyConstraints({advanced:[{whiteBalanceMode:"continuous"}]})}catch{}try{const g=j?.getCapabilities?.()||{};if(Y("torch"in g),typeof g.zoom=="number"||g.zoom&&g.zoom.min!==void 0){B(!0);const y=g.zoom?.min??1,R=g.zoom?.max??1;se.current=y,ne.current=R,ae(Math.max(1,y))}else B(!1)}catch{Y(!1),B(!1)}if(r.current){r.current.srcObject=k;const g=new Promise(y=>{const R=r.current;if(!R||R.readyState>=2)return y();const N=()=>{R.removeEventListener("loadedmetadata",N),y()};R.addEventListener("loadedmetadata",N)});if(await Promise.race([g,new Promise(y=>setTimeout(y,800))]),m.current&&r.current){const y=window.devicePixelRatio||1,R=Math.max(1,r.current.videoWidth||1280),N=Math.max(1,r.current.videoHeight||720);m.current.width=Math.round(R*y),m.current.height=Math.round(N*y)}await r.current.play().catch(y=>{console.warn("Initial video play failed, will retry on user interaction.",y)}),$(!0)}O(!1)};f.useEffect(()=>(t?(S("idle"),_("Ready to scan"),(async()=>{try{await ie()}catch{s?.()}})()):G(),()=>G()),[t,H]),f.useEffect(()=>{if(t&&C&&!l&&x==="analyzing"){const v=setTimeout(()=>{_("Scan difficult. Try uploading a photo instead.")},8e3);let k=0,j=null,g=0;const y=55,R=18,N=()=>{if(!r.current||!m.current||h.current){j=r.current&&r.current.requestVideoFrameCallback?r.current.requestVideoFrameCallback(N):k=requestAnimationFrame(N);return}const z=m.current,K=z.getContext("2d",{willReadFrequently:!0});K.drawImage(r.current,0,0,z.width,z.height);const X=ve(K,z.width,z.height);let U=!0;X.brightness<y?(_("More light needed"),U=!1,g++):(X.sharpness<R&&(_("Hold steady, image is blurry"),U=!1),g=0),g>=6&&Q&&!J&&((async()=>{try{await a.current?.applyConstraints({advanced:[{torch:!0}]}),O(!0)}catch{}})(),g=0),U?(P("good"),_("Perfect, hold it!"),I.current++,I.current>=3&&W()):(P("poor"),I.current=0),j=r.current&&r.current.requestVideoFrameCallback?r.current.requestVideoFrameCallback(N):k=requestAnimationFrame(N)};return r.current&&r.current.requestVideoFrameCallback?j=r.current.requestVideoFrameCallback(N):k=requestAnimationFrame(N),()=>{if(j&&r.current&&r.current.cancelVideoFrameCallback)try{r.current.cancelVideoFrameCallback(j)}catch{}k&&cancelAnimationFrame(k),clearTimeout(v)}}},[t,C,l,x]);const W=async()=>{if(!(h.current||!C)){h.current=!0,S("capturing"),T(!0),setTimeout(()=>T(!1),500);try{const v=r.current,k=m.current,j=k.getContext("2d"),g=[];for(let y=0;y<3;y++){j.drawImage(v,0,0,k.width,k.height);const R=k.toDataURL("image/jpeg",.92).replace(/^data:image\/jpeg;base64,/,"");g.push(R),await new Promise(N=>setTimeout(N,180))}n?.({base64:g[0],framesBase64:g})}finally{h.current=!1}}},ce=()=>oe(v=>v==="environment"?"user":"environment"),le=async()=>{try{const v=!J;await a.current.applyConstraints({advanced:[{torch:v}]}),O(v)}catch{}},de=()=>{r.current&&r.current.paused&&r.current.play().catch(v=>console.warn("Video play failed on click:",v)),S("analyzing")};return t?e.jsxs("div",{className:"fixed inset-0 z-[1100] bg-black/80 backdrop-blur-sm flex items-center justify-center",children:[e.jsxs("div",{className:"w-[min(500px,95vw)] rounded-2xl border border-white/15 bg-white/10 shadow-2xl relative overflow-hidden",children:[e.jsxs("div",{className:"px-5 pt-5 pb-3",children:[e.jsx("div",{className:"font-bold text-lg text-white",children:i}),e.jsx("div",{className:"text-[11px] text-white/80 mt-1",children:c})]}),e.jsxs("div",{className:"relative mx-5 rounded-2xl overflow-hidden border border-white/20 bg-black/70 mb-4 flex items-center justify-center min-h-[260px]",children:[e.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-[280px] object-cover"}),e.jsx(ke,{busy:l,statusText:d,frameQuality:A,statusHint:F,scanState:x}),w&&e.jsx("div",{className:"absolute inset-0 z-30 animate-flash-green pointer-events-none"}),e.jsx("canvas",{ref:m,className:"hidden","data-role":"capture-canvas"}),x==="idle"&&C&&!l&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-30",children:e.jsx("button",{type:"button",onClick:de,className:"px-6 py-3 rounded-xl font-semibold text-white bg-emerald-500/80 hover:bg-emerald-500 shadow-lg backdrop-blur-sm border border-emerald-400/50",children:"Start Scanning"})})]}),e.jsxs("div",{className:"px-5 pb-5 flex items-center justify-center gap-3",children:[x==="analyzing"&&e.jsx("button",{type:"button",onClick:W,disabled:l||!C,className:"px-4 py-2 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 to-cyan-400 shadow-lg",children:"Scan Now"}),e.jsx("button",{type:"button",onClick:s,className:"px-4 py-2 rounded-xl font-semibold text-white/80 bg-white/10 border border-white/20 hover:bg-white/20 text-sm",disabled:l,children:"Cancel"}),e.jsx("button",{type:"button",onClick:ce,className:"px-3 py-2 rounded-xl text-sm",disabled:l||!C,children:"üîÅ"}),e.jsx("button",{type:"button",onClick:le,className:"px-3 py-2 rounded-xl text-sm",disabled:l||!Q||!C,children:"üî¶"})]})]}),e.jsx("style",{children:`
        @keyframes pulse-red {
          0%, 100% { box-shadow: 0 0 18px rgba(239, 68, 68, 0.45); }
          50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.7); }
        }
        @keyframes pulse-green {
          0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.55); }
          50% { box-shadow: 0 0 35px rgba(16, 185, 129, 0.8); }
        }
        .animate-pulse-red { animation: pulse-red 2.5s infinite; }
        .animate-pulse-green { animation: pulse-green 1.5s infinite; }

        @keyframes sweep {
          0% { transform: translateY(-10%); }
          100% { transform: translateY(110%); }
        }
        .laser-line {
          position: absolute;
          left: 0;
          width: 100%;
          height: 2px;
          background: linear-gradient(90deg, transparent, rgba(110, 231, 183, 0.8), transparent);
          box-shadow: 0 0 10px rgba(110, 231, 183, 0.9);
          animation: sweep 2.2s infinite ease-in-out;
        }

        @keyframes flash-green {
          0%, 100% { background-color: transparent; }
          50% { background-color: rgba(16, 185, 129, 0.3); }
        }
        .animate-flash-green {
          animation: flash-green 0.5s ease-out;
        }

        canvas[data-role="capture-canvas"] {
          display: none;
          width: 0 !important;
          height: 0 !important;
        }
      `})]}):null}export{Me as M,Fe as P,ze as a,Pe as b,Ee as f,Ie as i,Te as l};
