import{d as _,e as B,l as C,s as O}from"./firebase-DWi1MSv1.js";import{d as v}from"./index-DRC3F7i0.js";const b=(t,s)=>_(v,"businesses",t,"retailerDefaults",s),M=Object.freeze({enabled:!0,taxType:null,autodetectTaxType:!0,gstRate:18,cgstRate:9,sgstRate:9,igstRate:18,deliveryFee:0,packingFee:0,insuranceFee:0,otherFee:0,discountPct:0,discountAmt:0,roundRule:"nearest",updatedAt:null,updatedBy:null}),R=Object.freeze({enabled:null,taxType:null,autodetectTaxType:null,gstRate:null,cgstRate:null,sgstRate:null,igstRate:null,deliveryFee:null,packingFee:null,insuranceFee:null,otherFee:null,discountPct:null,discountAmt:null,roundRule:null,notes:null,updatedAt:null,updatedBy:null}),r=t=>typeof t=="number"&&Number.isFinite(t),c=(t,s)=>r(t)?t:r(s)?s:0,S=t=>!r(t)||t<0?0:t>100?100:t;async function q(t,s){if(!t||!s)throw new Error("getRetailerDefaults: distributorId & retailerId required");const a=b(t,s),n=await B(a);if(!n.exists())return{...R};const e=n.data()||{};return{...R,...e}}async function H(t,s,a={},{actorUid:n}={}){if(!t||!s)throw new Error("setRetailerDefaults: distributorId & retailerId required");const e=I(a),o=b(t,s);return await C(o,{...e,updatedAt:O(),updatedBy:n||null},{merge:!0}),!0}function N({defaults:t,distributorProfile:s,retailerProfile:a}){if(t?.autodetectTaxType){const e=h(s),o=h(a);if(e&&o)return e===o?"CGST_SGST":"IGST"}return t?.taxType||"CGST_SGST"}function V({itemsSubTotal:t=0,defaults:s,distributorProfile:a,retailerProfile:n}){const e={...M,...s},o=N({defaults:e,distributorProfile:a,retailerProfile:n}),i=S(e.discountPct),D=t*i/100,E=r(e.discountAmt)?e.discountAmt:0,T=Math.max(D,E),y=c(e.deliveryFee,0),F=c(e.packingFee,0),m=c(e.insuranceFee,0),x=c(e.otherFee,0),l=Math.max(0,t-T)+y+F+m+x;let d=0,f=0,g=0;if(o==="CGST_SGST"){const p=c(e.cgstRate,0),L=c(e.sgstRate,0);d=l*p/100,f=l*L/100}else{const p=c(e.igstRate,r(e.gstRate)?e.gstRate:0);g=l*p/100}const A=d+f+g,w=l+A,{rounded:P,roundOff:G}=z(w,e.roundRule);return{version:1,taxType:o,autodetectTaxType:!!e.autodetectTaxType,itemsSubTotal:u(t),discountPct:i,discountAmt:u(T),delivery:u(y),packing:u(F),insurance:u(m),other:u(x),taxableBase:u(l),taxBreakup:{cgst:u(d),sgst:u(f),igst:u(g)},subTotal:u(t),taxes:u(A),roundOff:u(G),grandTotal:u(P)}}function I(t={}){const s={...R},a=(n,e,o=i=>i)=>t[n]===null?null:t[n]===void 0?s[n]:e(t[n])?o(t[n]):s[n];return{enabled:t.enabled===null?null:typeof t.enabled=="boolean"?t.enabled:s.enabled,taxType:a("taxType",n=>typeof n=="string"),autodetectTaxType:a("autodetectTaxType",n=>typeof n=="boolean"),gstRate:a("gstRate",r),cgstRate:a("cgstRate",r),sgstRate:a("sgstRate",r),igstRate:a("igstRate",r),deliveryFee:a("deliveryFee",r),packingFee:a("packingFee",r),insuranceFee:a("insuranceFee",r),otherFee:a("otherFee",r),discountPct:a("discountPct",r,S),discountAmt:a("discountAmt",r),roundRule:a("roundRule",n=>["nearest","up","down"].includes(n)),notes:a("notes",n=>typeof n=="string")}}function h(t){return t?.stateCode||k(t?.gstin)||null||null}function k(t){return typeof t!="string"||t.length<2?null:t.slice(0,2)}function z(t,s="nearest"){const n=(o=>{switch(s){case"up":return Math.ceil(o);case"down":return Math.floor(o);case"nearest":default:return Math.round(o)}})(t),e=n-t;return{rounded:n,roundOff:e}}function u(t){const s=Number(t||0);return Math.round(s*100)/100}export{V as c,q as g,H as s};
