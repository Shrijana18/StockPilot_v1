function t(i){return Math.round((Number(i)+Number.EPSILON)*100)/100}function a(i,n=0){const d=Number(i);return Number.isFinite(d)?d:n}function W(i,n){return!i||!n||i.trim().toLowerCase()===n.trim().toLowerCase()?"CGST_SGST":"IGST"}function z({lines:i=[],orderCharges:n={},distributorState:d,retailerState:_,roundingEnabled:U=!1,rounding:C="NEAREST"}={}){let h=0,P=0,g=0,D=0;const L=i.map((s={})=>{const A=t(a(s.qty)),B=t(a(s.price)),o=t(a(s.gstRate)),e=t(A*B);h=t(h+e),D=t(D+e);const c=t(a(s.itemDiscountPct)),m=t(a(s.itemDiscountAmt)),q=String(s.itemDiscountChangedBy||"").toLowerCase();let u;q==="amt"?u=Math.max(0,Math.min(e,m)):q==="pct"?u=t(e*Math.max(0,Math.min(100,c))/100):u=m?Math.max(0,Math.min(e,m)):t(e*Math.max(0,Math.min(100,c))/100),u=t(u),P=t(P+u);const v=t(e-u);return g=t(g+v),{...s,qty:A,price:B,itemDiscountPct:c,gstRate:o,gross:e,discountAmount:u,taxable:v}}),G=g,N=t(a(n.delivery)),F=t(a(n.packing)),w=t(a(n.insurance)),I=t(a(n.other)),E=t(N+F+w+I),S=t(G+E),O=t(a(n.discountPct)),b=t(a(n.discountAmt)),R=t(S*Math.max(0,Math.min(100,O))/100),j=String(n.discountChangedBy||"").toLowerCase();let r;j==="amt"?r=b:j==="pct"?r=R:r=b||R,r=t(Math.max(0,Math.min(S,r)));const y=t(S-r),k=W(d,_);let f=0,x=0,T=0;if(y>0){const s=D||h||1;L.map(o=>{const e=s>0?o.gross/s:0;return{...o,allocatedCharges:t(E*e)}}).map(o=>{const e=s>0?o.gross/s:0,c=t(r*e);return{...o,allocatedDiscount:c,adjustedTaxableBase:t(o.taxable+o.allocatedCharges-c)}}).forEach(o=>{const e=t(a(o.gstRate)),c=o.adjustedTaxableBase>0?t(o.adjustedTaxableBase*e/100):0;if(k==="IGST")T=t(T+c);else{const m=t(c/2);f=t(f+m),x=t(x+m)}})}const l=t(y+f+x+T);let M=0,p=t(l);if(U)if(C==="UP"){const s=Math.ceil(l);M=t(s-l),p=s}else if(C==="DOWN"){const s=Math.floor(l);M=t(s-l),p=s}else{const s=Math.round(l);M=t(s-l),p=s}return{lines:L,orderCharges:{delivery:N,packing:F,insurance:w,other:I,discountPct:O,discountAmt:b},grossItems:h,lineDiscountTotal:P,itemsSubTotal:g,subTotal:G,discountTotal:r,taxableBase:y,taxType:k,taxBreakup:{cgst:t(f),sgst:t(x),igst:t(T)},roundOff:M,grandTotal:p}}export{z as c};
