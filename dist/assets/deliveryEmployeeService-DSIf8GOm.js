import{d as m}from"./index-DRC3F7i0.js";import{c as v,g as b,q as A,w as E,p as _,d as y,e as g,s as d,u as w,l as T}from"./firebase-DWi1MSv1.js";const x=async(n,s,o)=>{try{const e=y(m,"businesses",n,"employees",o),p=await g(e);if(!p.exists())throw new Error("Employee not found");const r=p.data(),l=y(m,"stores",n,"customerOrders",s),i=await g(l);if(!i.exists())throw new Error("Order not found");const t=i.data(),a={assignedEmployeeId:o,assignedEmployee:{id:o,name:r.name||"",phone:r.phone||"",flypEmployeeId:r.flypEmployeeId||o},assignedAt:d(),status:"out_for_delivery",outForDeliveryAt:d(),"statusHistory.out_for_delivery":d(),deliveryAgent:{name:r.name||"",phone:r.phone||"",employeeId:o,flypEmployeeId:r.flypEmployeeId||o,vehicleNumber:t.deliveryAgent?.vehicleNumber||""},updatedAt:d()};await w(l,a);const c=y(m,"customerOrders",s);try{await w(c,a)}catch{const R=await g(l);R.exists()&&await T(c,{...R.data(),...a},{merge:!0})}const u=o,f=r.flypEmployeeId||o,h=y(m,"businesses",n,"employeeDeliveries",`${s}_${u}`);return await T(h,{orderId:s,employeeId:u,flypEmployeeId:f,retailerId:n,status:"assigned",assignedAt:d(),orderData:{orderNumber:t.orderNumber,customerName:t.customerName,customerPhone:t.customerPhone,deliveryAddress:t.deliveryAddress,total:t.total,items:t.items,orderType:t.orderType},employeeData:{name:r.name,phone:r.phone,flypEmployeeId:f}},{merge:!0}),{success:!0,message:"Order assigned to employee"}}catch(e){throw console.error("Error assigning order to employee:",e),e}},C=async n=>{try{const s=v(m,"businesses",n,"employees");return(await b(s)).docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.status==="active")}catch(s){throw console.error("Error getting retailer employees:",s),s}},k=(n,s,o)=>{let e=()=>{};return(async()=>{if(s.toUpperCase().startsWith("EMP-")){const r=v(m,"businesses",n,"employees"),l=A(r,E("flypEmployeeId","==",s.toUpperCase())),i=await b(l);return i.empty?null:i.docs[0].id}else return s})().then(r=>{if(!r){console.error("Employee document not found for:",s),o([]);return}const l=A(v(m,"businesses",n,"employeeDeliveries"),E("employeeId","==",r),E("status","in",["assigned","picked_up","out_for_delivery"]));e=_(l,i=>{const t=i.docs.map(a=>({id:a.id,...a.data()})).sort((a,c)=>{const u=a.assignedAt?.toDate?a.assignedAt.toDate().getTime():0;return(c.assignedAt?.toDate?c.assignedAt.toDate().getTime():0)-u});o(t)},i=>{console.error("Error subscribing to employee deliveries:",i),o([])})}).catch(r=>{console.error("Error resolving employee document ID:",r),o([])}),()=>e()},N=async(n,s,o)=>{try{let e=o;if(o.toUpperCase().startsWith("EMP-")){const f=v(m,"businesses",n,"employees"),h=A(f,E("flypEmployeeId","==",o.toUpperCase())),D=await b(h);if(!D.empty)e=D.docs[0].id;else throw new Error("Employee not found")}const p=y(m,"businesses",n,"employeeDeliveries",`${s}_${e}`),r=await g(p);if(!r.exists())throw new Error("Assignment not found");const l=y(m,"businesses",n,"employees",e),i=await g(l),t=i.exists()?i.data():r.data().employeeData||{};await w(p,{status:"picked_up",pickedUpAt:d()});const a=y(m,"stores",n,"customerOrders",s),c={status:"out_for_delivery",outForDeliveryAt:d(),"statusHistory.out_for_delivery":d(),deliveryAgent:{name:t.name||"",phone:t.phone||"",employeeId:e,flypEmployeeId:t.flypEmployeeId||e},assignedEmployee:{id:e,name:t.name||"",phone:t.phone||"",flypEmployeeId:t.flypEmployeeId||e},updatedAt:d()};await w(a,c);const u=y(m,"customerOrders",s);try{await w(u,c)}catch{const h=await g(a);h.exists()&&await T(u,{...h.data(),...c},{merge:!0})}return{success:!0}}catch(e){throw console.error("Error marking order as picked up:",e),e}},P=async(n,s,o,e={})=>{try{let p=o;if(o.toUpperCase().startsWith("EMP-")){const h=v(m,"businesses",n,"employees"),D=A(h,E("flypEmployeeId","==",o.toUpperCase())),R=await b(D);if(!R.empty)p=R.docs[0].id;else throw new Error("Employee not found")}const r=y(m,"businesses",n,"employeeDeliveries",`${s}_${p}`),l=await g(r);if(!l.exists())throw new Error("Assignment not found");const i=y(m,"businesses",n,"employees",p),t=await g(i),a=t.exists()?t.data():l.data().employeeData||{};await w(r,{status:"delivered",deliveredAt:d(),deliveryProof:{signature:e.signature||null,photo:e.photo||null,notes:e.notes||""}});const c=y(m,"stores",n,"customerOrders",s),u={status:"delivered",deliveredAt:d(),"statusHistory.delivered":d(),deliveredBy:{type:"employee",employeeId:p,flypEmployeeId:a.flypEmployeeId||p,name:a.name||l.data().employeeData?.name||""},deliveryAgent:{name:a.name||l.data().employeeData?.name||"",phone:a.phone||l.data().employeeData?.phone||"",employeeId:p,flypEmployeeId:a.flypEmployeeId||p},updatedAt:d()};await w(c,u);const f=y(m,"customerOrders",s);try{await w(f,u)}catch{const D=await g(c);D.exists()&&await T(f,{...D.data(),...u},{merge:!0})}return{success:!0}}catch(p){throw console.error("Error marking order as delivered:",p),p}},$=async(n,s,o=50)=>{try{let e=s;if(s.toUpperCase().startsWith("EMP-")){const i=v(m,"businesses",n,"employees"),t=A(i,E("flypEmployeeId","==",s.toUpperCase())),a=await b(t);if(!a.empty)e=a.docs[0].id;else return[]}const p=v(m,"businesses",n,"employeeDeliveries"),r=A(p,E("employeeId","==",e),E("status","==","delivered"));return(await b(r)).docs.map(i=>({id:i.id,...i.data()})).sort((i,t)=>{const a=i.deliveredAt?.toDate?i.deliveredAt.toDate().getTime():0;return(t.deliveredAt?.toDate?t.deliveredAt.toDate().getTime():0)-a}).slice(0,o)}catch(e){throw console.error("Error getting delivery history:",e),e}};export{x as a,$ as b,P as c,C as g,N as m,k as s};
