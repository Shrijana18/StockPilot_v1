import{j as t,e as S,b as n,c as x,f as k,y as j,h as N}from"./index-DRC3F7i0.js";import{r as m,b as P,u as A,R as T}from"./router-BPBaD_i0.js";import{httpsCallable as C}from"./index.esm-Bux_mLJ0.js";import{f as R,h as _}from"./firebase-DWi1MSv1.js";import{m as D}from"./proxy-BgUy8BPw.js";import"./vendor-Ckhrjn13.js";const z=()=>{const[s,u]=m.useState({employeeId:"",pin:""}),[g,a]=m.useState(!1),[h,i]=m.useState(""),[b,I]=P(),w=A(),l=T.useRef(!1);m.useEffect(()=>{u({employeeId:"",pin:""}),b.toString()&&I({},{replace:!0})},[]);const E=async p=>{p.preventDefault(),i(""),a(!0);try{if(!s.employeeId.trim()||!s.pin.trim()){i("Please enter both Employee ID and PIN"),a(!1);return}const d=await C(S,"retailerEmployeeLogin")({employeeId:s.employeeId.toUpperCase(),pin:s.pin});if(!d.data.success){i(d.data.message||"Login failed. Please try again."),a(!1);return}const{employeeData:e,customToken:o}=d.data;if(!o||typeof o!="string"||o.trim().length===0){console.error("[EmployeeLogin] ‚ùå Invalid custom token received:",{hasToken:!!o,type:typeof o,length:o?.length}),i("Login failed: Invalid authentication token. Please try again."),a(!1);return}try{if(l.current){console.warn("[EmployeeLogin] ‚ö†Ô∏è Sign-in already in progress, skipping duplicate call");return}if(l.current=!0,!n){l.current=!1,console.error("[EmployeeLogin] ‚ùå empAuth instance is null/undefined"),i("Login failed: Authentication service unavailable. Please try again."),a(!1);return}if(typeof n!="object"||!n.app){console.error("[EmployeeLogin] ‚ùå empAuth is not a valid Firebase Auth instance:",{type:typeof n,hasApp:!!n?.app,empAuthKeys:n?Object.keys(n):[]}),i("Login failed: Authentication service unavailable. Please try again."),a(!1);return}if(!o||typeof o!="string"||o.trim().length===0){console.error("[EmployeeLogin] ‚ùå Token invalid right before signIn:",{hasToken:!!o,type:typeof o,length:o?.length,isEmpty:o?.trim().length===0}),i("Login failed: Invalid authentication token. Please try again."),a(!1);return}if(n.currentUser){console.log("[EmployeeLogin] ‚ö†Ô∏è Already signed in, signing out first:",n.currentUser.uid);try{await R(n),await new Promise(r=>setTimeout(r,200))}catch(r){console.warn("[EmployeeLogin] Sign out failed (non-fatal):",r)}}if(console.log("[EmployeeLogin] üîë Signing in with custom token...",{tokenLength:o.length,tokenPrefix:o.substring(0,20)+"...",authAppName:n.app?.name,authAppId:n.app?.options?.appId}),!n||!o){console.error("[EmployeeLogin] ‚ùå CRITICAL: Auth or token became invalid right before signIn!",{hasAuth:!!n,hasToken:!!o}),i("Login failed: Authentication error. Please try again."),a(!1);return}if(await _(n,o),!n.currentUser){console.error("[EmployeeLogin] ‚ùå Auth not set after signInWithCustomToken"),l.current=!1,i("Login failed: Authentication not set. Please try again."),a(!1);return}console.log("[EmployeeLogin] ‚úÖ Signed in successfully:",n.currentUser.uid),l.current=!1}catch(r){l.current=!1,console.error("[EmployeeLogin] ‚ùå signInWithCustomToken failed:",r),console.error("[EmployeeLogin] SignIn error details:",{code:r?.code,message:r?.message,name:r?.name,stack:r?.stack}),r?.code==="auth/argument-error"?(console.error("[EmployeeLogin] ‚ùå auth/argument-error - This means invalid auth instance or token!",{hasAuth:!!n,authType:typeof n,hasToken:!!o,tokenType:typeof o,tokenLength:o?.length}),i("Login failed: Authentication configuration error. Please restart the app.")):i(r?.message||"Login failed: Authentication error. Please try again."),a(!1);return}x({employeeId:String(e.id||"").trim(),retailerId:String(e.retailerId||"").trim(),name:e.name||"",role:e.role||"Employee",flypEmployeeId:String(e.flypEmployeeId||e.id||"").trim(),accessSections:e.accessSections||{}}),k();try{localStorage.setItem("__flyp_commit_check",Date.now().toString()),localStorage.removeItem("__flyp_commit_check"),localStorage.getItem("employeeSession")||(console.warn("[Login] Session storage verification failed, retrying..."),x({employeeId:String(e.id||"").trim(),retailerId:String(e.retailerId||"").trim(),name:e.name||"",role:e.role||"Employee",flypEmployeeId:String(e.flypEmployeeId||e.id||"").trim(),accessSections:e.accessSections||{}}))}catch(r){console.error("[Login] Failed to verify localStorage commit:",r)}j.success("Login successful! Redirecting...");const y={retailerId:e.retailerId,employeeId:e.id,name:e.name,role:e.role,flypEmployeeId:e.flypEmployeeId||e.id,accessSections:e.accessSections||{}},L=typeof window<"u"&&window.Capacitor,v=window.location.hostname!=="localhost";L?(N(y),setTimeout(()=>{w("/employee-dashboard",{replace:!0,state:{fromLogin:!0,session:y}})},400)):setTimeout(()=>{window.location.href="/employee-dashboard"},v?1e3:500)}catch(c){console.error("Login error:",c),i(c.message||"Login failed. Please try again."),a(!1)}},f=p=>{const{name:c,value:d}=p.target;u(e=>({...e,[c]:d}))};return t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4",children:t.jsx(D.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"w-full max-w-md",children:t.jsxs("div",{className:"bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 shadow-2xl p-8",children:[t.jsxs("div",{className:"text-center mb-8",children:[t.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-500/20 rounded-full mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-emerald-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),t.jsx("h1",{className:"text-2xl font-bold text-white mb-2",children:"Retailer Employee Login"}),t.jsx("p",{className:"text-white/70 text-sm",children:"Enter your credentials to access the system"})]}),t.jsxs("form",{onSubmit:E,className:"space-y-6",children:[h&&t.jsx("div",{className:"bg-red-500/10 border border-red-500/30 text-red-300 px-4 py-3 rounded-lg text-sm",children:h}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-white/90 mb-2",children:"Employee ID"}),t.jsx("input",{type:"text",name:"employeeId",value:s.employeeId,onChange:f,className:"w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all",placeholder:"FLYP-RETAIL-XXXXXX",required:!0,autoComplete:"off"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-white/90 mb-2",children:"PIN"}),t.jsx("input",{type:"password",name:"pin",value:s.pin,onChange:f,className:"w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all",placeholder:"Enter your PIN",required:!0})]}),t.jsx("button",{type:"submit",disabled:g,className:"w-full py-3 px-4 bg-emerald-500 hover:bg-emerald-600 disabled:bg-emerald-500/50 text-white font-semibold rounded-lg transition-colors duration-200 disabled:cursor-not-allowed",children:g?t.jsxs("div",{className:"flex items-center justify-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"Signing In..."]}):"Sign In"})]}),t.jsx("div",{className:"mt-6 text-center",children:t.jsx("p",{className:"text-white/50 text-xs",children:"Need help? Contact your manager for assistance."})})]})})})};export{z as default};
