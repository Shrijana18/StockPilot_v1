import{p as Ce,j as t,q as W,d as X,y as u,r as ke,s as Ue,u as Fe,g as Me}from"./index-DRC3F7i0.js";import{r as m,R as ne}from"./router-BPBaD_i0.js";import{d as oe,c as J,s as ce,l as le,q as Ae,w as Re,g as Le}from"./firebase-DWi1MSv1.js";import{P as Ie,a as _e,M as qe,f as Be,i as de,b as ue,l as De}from"./MagicScanDisplay-BEI3JqVX.js";import{l as ge}from"./logInventoryChange-kGfLyhaN.js";import{P as v,b as Ee}from"./pricing-SUVGnFgL.js";import{calculateSellingUnitPrice as me,calculateSellingUnitStock as pe,validateLooseProductConfig as Te}from"./looseProductUtils-DQPoVx_a.js";import"./vendor-Ckhrjn13.js";import"./index.esm-Bux_mLJ0.js";function $e({rows:f,onAutofill:$,onAddSelected:P}){const[i,b]=ne.useState(()=>{const s={};return f.forEach((o,x)=>s[x]=!0),s}),[h,L]=ne.useState({}),d=(s,o,x)=>{L(j=>({...j,[s]:{...j[s],[o]:x}}))},N=s=>b(o=>({...o,[s]:!o[s]})),w=f.length>0&&f.every((s,o)=>i[o]),S=f.filter((s,o)=>i[o]);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"overflow-auto rounded-lg border border-white/10 max-h-[60vh]",children:t.jsxs("table",{className:"w-full text-sm",children:[t.jsx("thead",{className:"bg-white/10 sticky top-0 backdrop-blur-sm",children:t.jsxs("tr",{children:[t.jsx("th",{className:"p-2 w-12",children:t.jsx("input",{type:"checkbox",checked:w,onChange:s=>{const o={};f.forEach((x,j)=>o[j]=s.target.checked),b(o)}})}),t.jsx("th",{className:"p-2 text-left",children:"Product"}),t.jsx("th",{className:"p-2 w-32",children:"Quantity"}),t.jsx("th",{className:"p-2 w-32",children:"Cost Price"}),t.jsx("th",{className:"p-2 w-24",children:"MRP"}),t.jsx("th",{className:"p-2 w-24",children:"Unit"}),t.jsx("th",{className:"p-2 w-16",children:"Conf."}),t.jsx("th",{className:"p-2 w-20"})]})}),t.jsxs("tbody",{children:[f.map((s,o)=>t.jsxs("tr",{className:`border-t border-white/10 ${i[o]?"bg-white/5":"opacity-60"}`,children:[t.jsx("td",{className:"p-2 text-center",children:t.jsx("input",{type:"checkbox",checked:!!i[o],onChange:()=>N(o)})}),t.jsxs("td",{className:"p-2",children:[t.jsxs("div",{className:"font-medium",children:[s.brand?`${s.brand} `:"",s.productName]}),t.jsx("div",{className:"text-xs text-white/70",children:s.category})]}),t.jsx("td",{className:"p-2",children:t.jsx("input",{type:"number",placeholder:"Qty",className:"w-full p-1.5 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-1 focus:ring-emerald-400/50",onChange:x=>d(o,"quantity",x.target.value)})}),t.jsx("td",{className:"p-2",children:t.jsx("input",{type:"number",placeholder:"Cost",className:"w-full p-1.5 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-1 focus:ring-emerald-400/50",onChange:x=>d(o,"costPrice",x.target.value)})}),t.jsxs("td",{className:"p-2 text-center",children:[s.mrp?`â‚¹${s.mrp}`:"-",s.sellingPrice&&s.sellingPrice!==s.mrp&&t.jsxs("div",{className:"text-xs text-white/60",children:["SP: â‚¹",s.sellingPrice]})]}),t.jsx("td",{className:"p-2 text-center",children:s.unit||"-"}),t.jsxs("td",{className:"p-2 text-center",children:[Math.round((s.confidence||0)*100),"%"]}),t.jsx("td",{className:"p-2 text-right",children:t.jsx("button",{className:"text-xs px-2 py-1 rounded bg-emerald-400/20 hover:bg-emerald-400/30",onClick:()=>$(s),children:"Fill Form"})})]},o)),!f.length&&t.jsx("tr",{children:t.jsx("td",{colSpan:8,className:"p-4 text-center text-white/70",children:"No items detected"})})]})]})}),t.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[t.jsxs("div",{className:"text-xs text-white/70",children:[S.length," of ",f.length," products selected"]}),t.jsx("button",{disabled:!S.length,onClick:()=>P(S,h),className:"px-3 py-2 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 disabled:opacity-50",children:"Add Selected Products to Inventory"})]})]})}const Je=()=>{const{currentUser:f}=Ce(),[$,P]=m.useState(!1),[i,b]=m.useState({productName:"",sku:"",brand:"",category:"",quantity:"",costPrice:"",sellingPrice:"",unit:"",description:"",image:null}),[h,L]=m.useState(!1),[d,N]=m.useState({baseUnit:"",sellingUnit:"",conversionFactor:"",baseUnitCost:"",baseUnitSellingPrice:"",minSellingQuantity:"1"}),[w,S]=m.useState(v.LEGACY),[s,o]=m.useState({mrp:"",basePrice:"",taxRate:"",legacySellingPrice:"",hsnCode:"",taxSource:"",taxConfidence:""}),[x,j]=m.useState(!1),[I,_]=m.useState(null),[K,q]=m.useState(!1),[U,C]=m.useState(""),[he,B]=m.useState(!1),[G,Z]=m.useState(!1),[D,E]=m.useState(!1),[F,xe]=m.useState(!1),[be,M]=m.useState(!1),[O,ee]=m.useState({items:[],count:0}),[te,Q]=m.useState([]),[fe,A]=m.useState(""),Y=async e=>{const a=String(e||"").trim();if(a)try{C(a),Z(!0),A("");const n=W();if(!n)return;const c=Ae(J(X,"businesses",n,"products"),Re("barcode","==",a)),r=await Le(c);if(!r.empty){const g=r.docs[0].data();b(l=>({...l,productName:g.productName||l.productName,brand:g.brand||l.brand,category:g.category||l.category,sku:g.sku||l.sku,unit:g.unit||l.unit,description:g.description||l.description})),A("your-inventory"),Q([]),u.info("This barcode already exists in your inventory. Pre-filled from your record.");return}try{const g=await De(a);b(l=>({...l,productName:g.productName||l.productName,brand:g.brand||l.brand,category:g.category||l.category,unit:g.size||l.unit})),A(g.source||"catalog"),Q([]),u.success("âœ¨ Auto-filled from barcode lookup. Please confirm price & tax.")}catch{u.warn("No public info found for this code. Please enter details manually.")}}catch(n){console.warn("prefillFromCode error:",n),u.error("Failed to look up product details.")}finally{Z(!1)}},H=(e={})=>{b(a=>({...a,productName:e.productName||a.productName,brand:e.brand||a.brand,category:e.category||a.category,sku:e.sku||a.sku,unit:e.unit||a.unit,description:e.description||a.description||""})),e.hsn&&o(a=>({...a,hsnCode:e.hsn,taxSource:"AI"})),e.gst!==void 0&&e.gst!==null&&e.gst!==""&&o(a=>({...a,taxRate:e.gst})),e.mrp!==void 0&&e.mrp!==null&&e.mrp!==""?o(a=>({...a,mrp:e.mrp})):e.priceMRP!==void 0&&e.priceMRP!==null&&e.priceMRP!==""&&o(a=>({...a,mrp:e.priceMRP})),e.sellingPrice!==void 0&&e.sellingPrice!==null&&e.sellingPrice!==""?o(a=>({...a,legacySellingPrice:e.sellingPrice})):e.price!==void 0&&e.price!==null&&e.price!==""&&o(a=>({...a,legacySellingPrice:e.price}))},ae=async(e,a)=>{A(e.source||"vision");let n=[];Array.isArray(e.suggestions)&&e.suggestions.length>0?n=e.suggestions:Array.isArray(e.labels)&&e.labels.length>0&&(n=e.labels),Q(r=>Array.from(new Set([...r||[],...n||[]]))),e.code&&(await Y(e.code),C(e.code)),b(r=>({...r,productName:a?.productName||e.productName||r.productName,brand:a?.brand||e.brand||r.brand,category:a?.category??e.category??r.category,sku:a?.sku||e.sku||r.sku,unit:a?.unit||e.unit||e.size||r.unit,description:a?.description||e.description||r.description||""})),e.hsn&&o(r=>({...r,hsnCode:e.hsn,taxSource:e.taxSource||"AI",taxConfidence:e.confidence||""})),e.gst!==void 0&&o(r=>({...r,taxRate:e.gst}));const c={high:.9,medium:.7,low:.5};typeof e.confidence=="string"&&c[e.confidence]&&o(r=>({...r,taxConfidence:c[e.confidence]})),e.mrp!==void 0&&e.mrp!==null&&e.mrp!==""?o(r=>({...r,mrp:e.mrp})):e.priceMRP!==void 0&&e.priceMRP!==null&&e.priceMRP!==""&&o(r=>({...r,mrp:e.priceMRP})),e.sellingPrice!==void 0&&e.sellingPrice!==null&&e.sellingPrice!==""?o(r=>({...r,legacySellingPrice:e.sellingPrice})):e.price!==void 0&&e.price!==null&&e.price!==""&&w===v.LEGACY&&(s.legacySellingPrice===""||s.legacySellingPrice===void 0)&&o(r=>({...r,legacySellingPrice:e.price})),!I&&e.imageUrl&&_(e.imageUrl)},ye=async({base64:e,framesBase64:a,barcode:n})=>{try{if(E(!0),n&&C(n),F){const l=await de({base64:e,maxProducts:12});ee(l||{items:[],count:0}),M(!0),P(!1),(l?.count??0)===0?u.info("No products detected. Try a closer photo."):u.success(`Found ${l.count} products`);return}const c=await ue({base64:e,framesBase64:Array.isArray(a)?a:void 0,barcode:n}),r=c?.autofill;r&&H(r);const g=c?.best||{};await ae({...g,suggestions:c?.suggestions},r),u.success("âœ¨ FLYP Magic completed! Please review all fields carefully."),P(!1)}catch(c){console.error("Magic Scan live error:",c),u.warn("Could not identify the image. Please enter details manually.")}finally{E(!1)}},we=async e=>{const a=e.target.files?.[0];if(a)try{E(!0);const n=await Be(a);if(F){const l=await de({base64:n,maxProducts:20});ee(l||{items:[],count:0}),M(!0),(l?.count??0)===0?u.info("No products detected. Try a closer photo."):u.success(`Found ${l.count} products`);return}const c=await ue({base64:n}),r=c?.autofill;r&&H(r);const g=c?.best||{};await ae({...g,suggestions:c?.suggestions},r),u.success("âœ¨ FLYP Magic completed! Please review all fields carefully.")}catch(n){console.error("Magic Scan image identify error:",n),u.warn("Could not identify the image. Please enter details manually.")}finally{E(!1),e.target.value=""}},y=e=>{const{name:a,value:n,files:c}=e.target;if(a==="image"){const r=c[0];b({...i,image:r}),_(URL.createObjectURL(r))}else b({...i,[a]:n})},k=(e,a)=>{N(n=>{const c={...n,[e]:a};return(e==="baseUnitSellingPrice"||e==="conversionFactor")&&(e==="baseUnitSellingPrice"?parseFloat(a):parseFloat(n.baseUnitSellingPrice),e==="conversionFactor"?parseFloat(a):parseFloat(n.conversionFactor)),c})},Ne=()=>{const e=d.baseUnit.toLowerCase(),a=d.sellingUnit.toLowerCase(),n={"1 packet (100 pieces)":{"1 piece":100,piece:100},"1kg":{"100g":10,"500g":2,gram:1e3,g:1e3},"1 strip (10 tablets)":{"1 tablet":10,tablet:10},"1 packet":{"1 piece":100,piece:100}};let c=!1;for(const[r,g]of Object.entries(n))if(e.includes(r.split("(")[0].trim())||e.includes(r)){for(const[l,p]of Object.entries(g))if(a.includes(l)){N(T=>({...T,conversionFactor:p.toString()})),c=!0,u.success(`Auto-calculated: 1 ${d.baseUnit} = ${p} ${d.sellingUnit}`);break}if(c)break}c||u.info("Could not auto-calculate. Please enter conversion factor manually.")},je=async()=>{try{if(s.hsnCode&&String(s.hsnCode).trim()){u.info("HSN already filled. Clear it first to use AI.");return}if(!i.productName?.trim()){u.warn("Enter Product Name first.");return}if(x)return;j(!0);const e=await fetch("https://us-central1-stockpilotv1.cloudfunctions.net/generateHSNAndGST",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productName:i.productName,brand:i.brand,category:i.category,unit:i.unit})});let a="";try{a=await e.clone().text()}catch{}if(!e.ok){let c="";try{const r=JSON.parse(a||"{}");c=r.details||r.error||""}catch{}if(e.status===429){u.error(`Rate limited by AI: ${c||"Please wait a moment and try again."}`);return}throw new Error(`Failed to fetch HSN and GST (${e.status}) ${c||a||""}`)}const n=await e.json();o(c=>({...c,hsnCode:n.hsn||"",taxRate:n.gst!==void 0?n.gst:"",taxSource:"AI",taxConfidence:n.taxConfidence||n.confidence||""})),u.success("âœ¨ HSN & GST auto-suggest applied!")}catch(e){console.error("Auto-suggest error:",e),u.error("âŒ Failed to auto-suggest HSN & GST.")}finally{j(!1)}},ve=async e=>{e.preventDefault();const a=W();if(!a)return;q(!0);const{productName:n,sku:c,quantity:r,costPrice:g}=i;let l="";if(w===v.LEGACY?!s.legacySellingPrice&&!i.sellingPrice&&(l="Please enter Selling Price."):w===v.MRP_INCLUSIVE?s.mrp||(l="Please enter MRP (incl. GST)."):w===v.BASE_PLUS_TAX&&(s.basePrice||(l="Please enter Unit/Base Price.")),!n||!c||!r||!g||l){u.error(l||"Please fill all required fields"),q(!1);return}try{const p=Ee(w,{mrp:Number(s.mrp),basePrice:Number(s.basePrice),taxRate:Number(s.taxRate),legacySellingPrice:Number(s.legacySellingPrice!==""?s.legacySellingPrice:i.sellingPrice)});let T="";if(i.image){const R=ke(Ue,`inventory/${a}/${Date.now()}_${i.image.name}`);await Fe(R,i.image),T=await Me(R)}if(h){const R=Te({isLooseProduct:!0,baseUnit:d.baseUnit,sellingUnit:d.sellingUnit,conversionFactor:parseFloat(d.conversionFactor)||0});if(!R.valid){u.error(R.errors[0]),q(!1);return}}const z=h&&parseFloat(d.conversionFactor)||1,Pe=h?parseFloat(d.baseUnitCost)||parseFloat(i.costPrice)||0:parseFloat(i.costPrice)||0,se=h&&parseFloat(d.baseUnitSellingPrice)||p.sellingPrice,ie=h?me(se,z):p.sellingPrice,Se=h?pe(Number(i.quantity),z):Number(i.quantity),V=oe(J(X,"businesses",a,"products")),re={productName:i.productName,sku:i.sku,brand:i.brand,category:i.category,quantity:Number(i.quantity),costPrice:Number(i.costPrice),sellingPrice:h?ie:p.sellingPrice,pricingMode:p.pricingMode,...p.mrp!==void 0?{mrp:p.mrp}:{},...p.basePrice!==void 0?{basePrice:p.basePrice}:{},...p.taxRate!==void 0?{taxRate:p.taxRate}:{},...s.hsnCode?{hsnCode:s.hsnCode}:{},...s.taxSource?{taxSource:s.taxSource}:{},...s.taxConfidence?{taxConfidence:Number(s.taxConfidence)}:{},...U?{barcode:U}:{},unit:h?d.baseUnit:i.unit,description:i.description,imageUrl:T,id:V.id,createdAt:ce(),addedBy:a,isLooseProduct:h||!1,...h?{baseUnit:d.baseUnit,sellingUnit:d.sellingUnit,conversionFactor:z,stockInSellingUnit:Se,baseUnitCost:Pe,baseUnitSellingPrice:se,sellingUnitPrice:ie,minSellingQuantity:parseFloat(d.minSellingQuantity)||1}:{}};await le(V,re),await ge({productId:V.id,sku:i.sku,previousData:{},updatedData:re,action:"created",source:"manual"}),u.success("âœ… Product added successfully!"),b({productName:"",sku:"",brand:"",category:"",quantity:"",costPrice:"",sellingPrice:"",unit:"",description:"",image:null}),S(v.LEGACY),o({mrp:"",basePrice:"",taxRate:"",legacySellingPrice:"",hsnCode:"",taxSource:"",taxConfidence:""}),L(!1),N({baseUnit:"",sellingUnit:"",conversionFactor:"",baseUnitCost:"",baseUnitSellingPrice:"",minSellingQuantity:"1"}),_(null),C(""),B(!1)}catch(p){console.error("Error adding product:",p),u.error("âŒ Failed to add product. Please try again.")}finally{q(!1)}};return t.jsxs("div",{className:"p-4 mt-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)] text-white",children:[t.jsx("div",{className:"mb-4 p-4 rounded-xl border border-white/15 bg-gradient-to-r from-purple-600/30 via-pink-500/20 to-orange-400/20",children:t.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"text-base font-semibold text-white flex items-center gap-2",children:[t.jsx("span",{className:"text-lg",children:"âœ¨"})," FLYP Magic Scan"]}),t.jsx("p",{className:"text-xs text-white/80 mt-1",children:"Point your camera or upload a photo â€” weâ€™ll magically read the product and auto-fill details."})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:()=>P(!0),className:"px-4 py-2 rounded-xl font-semibold text-white bg-gradient-to-r from-purple-500 via-pink-400 to-orange-400 shadow-lg hover:shadow-xl text-sm flex items-center gap-2",title:"Scan live with camera",children:"ðŸ“· Magic Scan (Live)"}),t.jsx("button",{type:"button",onClick:()=>document.getElementById("magic-photo-input-top")?.click(),className:"px-4 py-2 rounded-xl font-semibold text-white bg-gradient-to-r from-purple-500 via-pink-400 to-orange-400 shadow-lg hover:shadow-xl text-sm flex items-center gap-2",title:"Upload a product photo",children:"ðŸ–¼ï¸ Upload Photo"}),t.jsx("input",{id:"magic-photo-input-top",type:"file",accept:"image/*",capture:"environment",className:"hidden",onChange:we}),t.jsxs("label",{className:"ml-1 inline-flex items-center gap-2 text-[11px] text-white/85 px-2 py-1 rounded-lg border border-white/15 bg-white/5",children:[t.jsx("input",{type:"checkbox",checked:F,onChange:e=>xe(e.target.checked),className:"accent-emerald-400"}),"Batch mode"]})]})]})}),t.jsx("h2",{className:"text-lg font-semibold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-emerald-200",children:"Add Inventory Manually"}),t.jsxs("form",{onSubmit:ve,className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[t.jsx("input",{type:"text",name:"productName",placeholder:"Product Name",value:i.productName,onChange:y,required:!0,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsx("input",{type:"text",name:"sku",placeholder:"SKU",value:i.sku,onChange:y,required:!0,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsx("input",{type:"text",name:"brand",placeholder:"Brand",value:i.brand,onChange:y,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsx("input",{type:"text",name:"category",placeholder:"Category",value:i.category,onChange:y,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsxs("div",{className:"md:col-span-1",children:[t.jsx("input",{type:"text",name:"barcode",placeholder:"Barcode / QR (optional)",value:U,onChange:e=>C(e.target.value.trim()),className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsxs("div",{className:"mt-2 flex items-center gap-2 flex-wrap",children:[t.jsx("button",{type:"button",onClick:()=>B(!0),className:"px-3 py-2 rounded-md border border-white/20 bg-white/5 hover:bg-white/10 text-white text-sm",title:"Scan with camera",children:"Scan Barcode / QR"}),t.jsx("button",{type:"button",onClick:()=>Y(U),disabled:!U||G,className:"px-3 py-2 rounded-md border border-white/20 bg-white/5 hover:bg-white/10 text-white text-sm disabled:opacity-50",title:"Lookup details for the typed code",children:"Fetch details"})]}),G&&t.jsx("p",{className:"mt-1 text-xs text-white/60",children:"Looking up product detailsâ€¦"}),D&&t.jsx("p",{className:"mt-1 text-xs text-pink-200 animate-pulse",children:"âœ¨ Scanning magicallyâ€¦"}),fe&&!G&&!D&&t.jsxs("div",{className:"mt-2 space-y-1",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs font-semibold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400",children:"âœ¨ FLYP Magic"}),t.jsx("span",{className:"text-xs text-emerald-300/90",children:"Product details detected"})]}),t.jsxs("div",{className:"flex items-start gap-1.5 px-2 py-1.5 rounded-lg bg-amber-500/10 border border-amber-500/20",children:[t.jsx("span",{className:"text-xs text-amber-300",children:"âš ï¸"}),t.jsx("p",{className:"text-xs text-amber-200/90 leading-relaxed",children:"FLYP Magic can make mistakes. Please review all fields carefully and verify accuracy before adding to inventory."})]})]}),!!te.length&&t.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[t.jsx("span",{className:"text-xs text-white/70",children:"Did you mean:"}),te.filter((e,a,n)=>e&&n.indexOf(e)===a).slice(0,5).map((e,a)=>t.jsx("button",{type:"button",onClick:()=>b(n=>({...n,productName:e})),className:"text-xs px-2 py-1 rounded-full border border-white/20 bg-white/5 hover:bg-white/10 text-white",title:"Use this as Product Name",children:e.length>36?e.slice(0,34)+"â€¦":e},a))]})]}),t.jsx("input",{type:"number",name:"quantity",placeholder:"Quantity",value:i.quantity,onChange:y,required:!0,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsx("input",{type:"number",name:"costPrice",placeholder:"Cost Price",value:i.costPrice,onChange:y,required:!0,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsxs("div",{className:"col-span-2 rounded-xl border border-white/15 bg-white/5 p-3",children:[t.jsx("div",{className:"text-sm font-medium text-white/90 mb-2",children:"Pricing"}),t.jsx(Ie,{mode:w,setMode:S,values:s,onChange:e=>o(a=>({...a,...e})),productName:i.productName,category:i.category})]}),t.jsxs("div",{className:"col-span-2 rounded-xl border border-white/15 bg-white/5 p-3",children:[t.jsx("div",{className:"text-sm font-medium text-white/90 mb-2",children:"Tax Details"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 items-end",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"text-xs text-white/60 flex items-center gap-2",children:[t.jsx("span",{children:"HSN Code"}),s.taxSource==="AI"&&t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-400/15 text-emerald-300 ring-1 ring-emerald-400/25",children:"âœ¨ AI Suggested"})]}),t.jsx("input",{type:"text",name:"hsnCode",placeholder:"Enter HSN (leave blank to Auto-Suggest)",value:s.hsnCode,onChange:e=>o(a=>({...a,hsnCode:e.target.value})),className:"w-full p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsxs("div",{className:"flex items-center justify-between mt-1",children:[t.jsxs("p",{className:"text-xs text-white/50",children:["Not sure? Click ",t.jsx("span",{className:"font-medium",children:"Auto-Suggest"}),"."]}),s.hsnCode?.toString().trim()&&t.jsx("button",{type:"button",onClick:()=>o(e=>({...e,hsnCode:"",taxSource:"",taxConfidence:""})),className:"text-xs text-sky-300 hover:underline",children:"Clear"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-white/60",children:"GST %"}),t.jsx("input",{type:"number",name:"taxRate",placeholder:"GST %",value:s.taxRate,onChange:e=>o(a=>({...a,taxRate:e.target.value})),className:"w-full p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})]}),t.jsx("div",{className:"md:justify-self-end",children:t.jsx("button",{type:"button",onClick:je,disabled:x||!i.productName?.trim()||s.hsnCode&&String(s.hsnCode).trim(),title:s.hsnCode&&String(s.hsnCode).trim()?"HSN is already filled manually. Clear it to use AI.":i.productName?.trim()?"Let AI suggest HSN & GST":"Enter Product Name first",className:"w-full md:w-auto px-4 py-2 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)] disabled:opacity-50 disabled:cursor-not-allowed",children:x?"Suggestingâ€¦":"Auto-Suggest"})})]})]}),t.jsxs("div",{className:"col-span-2 rounded-xl border border-white/15 bg-white/5 p-4",children:[t.jsx("div",{className:"flex items-center justify-between mb-3",children:t.jsxs("div",{children:[t.jsxs("label",{className:"text-sm font-medium text-white/90 flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:h,onChange:e=>{L(e.target.checked),e.target.checked?N(a=>({...a,baseUnit:i.unit||a.baseUnit,baseUnitCost:i.costPrice||a.baseUnitCost,baseUnitSellingPrice:s.legacySellingPrice||i.sellingPrice||a.baseUnitSellingPrice})):N({baseUnit:"",sellingUnit:"",conversionFactor:"",baseUnitCost:"",baseUnitSellingPrice:"",minSellingQuantity:"1"})},className:"w-4 h-4 accent-emerald-400"}),t.jsx("span",{children:"ðŸ›’ Sell as Loose Product"})]}),t.jsx("p",{className:"text-xs text-white/60 mt-1",children:"Enable this for products sold in smaller quantities (e.g., individual chocolates, loose tablets, rice by weight)"})]})}),h&&t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-white/60 mb-1 block",children:"Base Unit (What you buy)"}),t.jsx("input",{type:"text",placeholder:"e.g., 1 Packet (100 pieces)",value:d.baseUnit,onChange:e=>k("baseUnit",e.target.value),className:"w-full p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-white/60 mb-1 block",children:"Selling Unit (What you sell)"}),t.jsx("input",{type:"text",placeholder:"e.g., 1 piece",value:d.sellingUnit,onChange:e=>k("sellingUnit",e.target.value),className:"w-full p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-white/60 mb-1 block",children:"Conversion Factor"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"number",placeholder:"e.g., 100 (1 base = 100 selling)",value:d.conversionFactor,onChange:e=>k("conversionFactor",e.target.value),className:"flex-1 p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50",min:"1",step:"0.01"}),t.jsx("button",{type:"button",onClick:Ne,className:"px-3 py-2 rounded-md border border-white/20 bg-white/5 hover:bg-white/10 text-white text-xs",title:"Try to auto-calculate from unit names",children:"Auto"})]}),t.jsxs("p",{className:"text-xs text-white/50 mt-1",children:["How many ",d.sellingUnit||"selling units"," = 1 ",d.baseUnit||"base unit","?"]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-white/60 mb-1 block",children:"Min. Selling Quantity"}),t.jsx("input",{type:"number",placeholder:"e.g., 1",value:d.minSellingQuantity,onChange:e=>k("minSellingQuantity",e.target.value),className:"w-full p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50",min:"0.01",step:"0.01"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-white/60 mb-1 block",children:"Base Unit Cost (â‚¹)"}),t.jsx("input",{type:"number",placeholder:"Cost per base unit",value:d.baseUnitCost||i.costPrice,onChange:e=>k("baseUnitCost",e.target.value),className:"w-full p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50",step:"0.01"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-white/60 mb-1 block",children:"Base Unit Selling Price (â‚¹)"}),t.jsx("input",{type:"number",placeholder:"Selling price per base unit",value:d.baseUnitSellingPrice||s.legacySellingPrice||i.sellingPrice,onChange:e=>k("baseUnitSellingPrice",e.target.value),className:"w-full p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50",step:"0.01"})]}),d.baseUnitSellingPrice&&d.conversionFactor&&t.jsxs("div",{className:"col-span-2 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20",children:[t.jsx("div",{className:"text-xs text-emerald-300 font-medium mb-1",children:"Calculated Selling Price"}),t.jsxs("div",{className:"text-sm text-white",children:["â‚¹",me(parseFloat(d.baseUnitSellingPrice)||0,parseFloat(d.conversionFactor)||1).toFixed(2)," per ",d.sellingUnit||"selling unit"]}),i.quantity&&t.jsxs("div",{className:"text-xs text-white/60 mt-1",children:["Stock: ",pe(parseFloat(i.quantity)||0,parseFloat(d.conversionFactor)||1)," ",d.sellingUnit||"selling units"," available"]})]})]})]}),!h&&t.jsx("input",{type:"text",name:"unit",placeholder:"Unit (e.g., box, piece)",value:i.unit,onChange:y,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"}),t.jsx("textarea",{name:"description",placeholder:"Description",value:i.description,onChange:y,className:"p-2 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50 col-span-2"}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("input",{type:"file",name:"image",accept:"image/*",onChange:y,className:"mb-2 p-2 rounded bg-white/10 border border-white/20 text-white file:bg-white/10 file:border-0 file:px-3 file:py-1 file:mr-3 file:rounded cursor-pointer"}),I&&t.jsx("img",{src:I,alt:"Product preview",className:"h-24 w-24 object-cover rounded border border-white/20 ring-1 ring-white/10"})]}),t.jsx("button",{type:"submit",disabled:K,className:"px-4 py-2 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)] col-span-2 disabled:opacity-60 disabled:cursor-not-allowed",children:K?"Uploading...":"Add Product"}),t.jsx(_e,{open:he,onClose:()=>B(!1),onDetected:({rawValue:e})=>{B(!1),Y(e)}})]}),be&&t.jsx("div",{className:"fixed inset-0 z-[1150] bg-black/70 backdrop-blur-sm flex items-center justify-center",children:t.jsxs("div",{className:"w-[min(760px,95vw)] max-h-[85vh] overflow-auto rounded-2xl border border-white/15 bg-white/10 p-4 text-white",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"font-semibold",children:["Detected Products ",O?.count?`(${O.count})`:""]}),t.jsx("button",{onClick:()=>M(!1),className:"text-white/70 hover:text-white",children:"âœ•"})]}),t.jsx($e,{rows:O?.items||[],onAutofill:e=>{H({productName:e.productName,brand:e.brand,category:e.category,unit:e.unit,description:e.description||"",mrp:e.mrp,sellingPrice:e.sellingPrice,priceMRP:e.mrp,sku:e.barcode||""}),A("vision-batch"),!I&&(e.imageUrl||e.thumbBase64)&&_(e.imageUrl||e.thumbBase64),e.barcode&&C(e.barcode),u.success("Added to form"),M(!1)},onAddSelected:async e=>{if(e.length)try{const a=W();for(const n of e){const c=oe(J(X,"businesses",a,"products")),r=n.barcode&&String(n.barcode).trim()||`SKU-${Date.now()}-${Math.random().toString(36).slice(2,7).toUpperCase()}`,g=Number(n.mrp||0)||0,l={id:c.id,productName:n.productName||"",sku:r,brand:n.brand||"",category:n.category||"",quantity:0,costPrice:0,sellingPrice:g,pricingMode:v.LEGACY,mrp:g,unit:n.unit||"",...n.barcode?{barcode:n.barcode}:{},createdAt:ce(),addedBy:a};await le(c,l),await ge({productId:c.id,sku:l.sku,previousData:{},updatedData:l,action:"created",source:"magic-batch"})}u.success(`Added ${e.length} products`),M(!1)}catch(a){console.error(a),u.error("Failed adding selected products.")}}})]})}),D&&t.jsx("div",{className:"fixed inset-0 z-[1000] bg-black/70 backdrop-blur-sm flex items-center justify-center",children:t.jsxs("div",{className:"w-[min(520px,90vw)] rounded-2xl border border-white/20 bg-white/10 p-6 text-center shadow-2xl",children:[t.jsxs("div",{className:"relative h-28 overflow-hidden rounded-xl border border-white/20 bg-black/40 mb-4",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/60 to-transparent animate-[scan_2s_linear_infinite]"}),t.jsx("div",{className:"absolute inset-0 pointer-events-none",children:t.jsx("div",{className:"w-full h-full animate-pulse opacity-30 bg-[radial-gradient(circle_at_30%_50%,rgba(255,255,255,0.25),transparent_40%),radial-gradient(circle_at_70%_50%,rgba(255,255,255,0.15),transparent_40%)]"})})]}),t.jsx("div",{className:"text-white font-semibold",children:"Analyzing product with FLYP Magicâ€¦"}),t.jsx("div",{className:"text-white/80 text-xs mt-1",children:"Reading labels, brand & size â€¢ Finding HSN/GST â€¢ Looking up catalogs"})]})}),t.jsx("style",{children:`
        @keyframes scan {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(100%); }
        }
        @keyframes scanline {
          0% { transform: translateY(-50%); opacity: 0.0; }
          10% { opacity: 1; }
          100% { transform: translateY(50%); opacity: 0.0; }
        }
      `}),t.jsx(qe,{open:$,onClose:()=>P(!1),onCapture:ye,busy:D,title:"Magic Scan (Live)",subtitle:F?"Capture once to detect multiple products.":"Align the product, hold steady, then tap Scan. We'll capture a quick burst for accuracy.",badge:F?"Batch mode":void 0})]})};export{Je as default};
