import{j as e,l as ke,d as D,y as K,w as Ye,p as Je}from"./index-DRC3F7i0.js";import{r as d,c as mt,d as xt,u as pt}from"./router-BPBaD_i0.js";import{c as je,g as Ee,d as q,e as xe,u as oe,s as ie,l as Ce,q as Me,w as Fe,p as ct,o as ft,v as gt,V as ge}from"./firebase-DWi1MSv1.js";import{httpsCallable as Xe}from"./index.esm-Bux_mLJ0.js";import{c as bt,g as wt,s as Ke}from"./proformaDefaults-BAnk_cr8.js";import{m as ee}from"./proxy-BgUy8BPw.js";import{A as yt}from"./AddRetailerModal-ksR6C5rK.js";import{u as vt,A as et,G as jt,I as Nt}from"./esm-LCaBFwtY.js";import{e as tt}from"./index-CbpqHhv-.js";import{A as Ct}from"./index-DSciU07p.js";import"./vendor-Ckhrjn13.js";const kt=({distributorId:r})=>{const[t,s]=d.useState([]),[a,c]=d.useState(!1),[l,h]=d.useState(null),[m,o]=d.useState(""),[v,j]=d.useState(!0),x=()=>r||ke?.currentUser?.uid||null;d.useEffect(()=>{(async()=>{j(!0);const C=x();if(!C){j(!1);return}try{const M=je(D,`businesses/${C}/connectionRequests`),P=await Ee(M),u=await Promise.all(P.docs.map(async w=>{const L=w.data(),_=L.retailerId;let k={};try{const p=q(D,"businesses",_),$=await xe(p);$.exists()?k=$.data():console.warn("Retailer business doc not found for:",_)}catch(p){console.error("âŒ Error fetching retailer info:",p.message)}return{id:w.id,retailerId:_,status:L.status,sentAt:L.sentAt,message:L.message||"",...k}}));s(u)}catch(M){console.error("Failed to fetch requests",M),K.error("Failed to load requests")}finally{j(!1)}})()},[r]);const b=async(N,C)=>{const M=x();if(!M)return;const P=q(D,"businesses",M),u=await xe(P),w=u.exists()?u.data():{},L=q(D,`businesses/${M}/connectionRequests/${N}`);await oe(L,{status:C,acceptedAt:ie()}),console.log("âœ… Updated distributor's connectionRequests status to:",C);const _=q(D,`businesses/${N}/sentRequests/${M}`);try{await oe(_,{status:C,acceptedAt:ie()}),console.log("âœ… Updated retailer's sentRequests status to:",C)}catch(k){console.error("âŒ Failed to update retailer's sentRequest:",k.message)}try{const k=q(D,"businesses",N),p=await xe(k),$=p.exists()?p.data():{};console.log("ğŸ”„ Saving distributor to retailer's connectedDistributors..."),await Ce(q(D,`businesses/${N}/connectedDistributors/${M}`),{distributorId:M,distributorName:w.businessName||"Unnamed Distributor",distributorOwner:w.ownerName||"Unknown Owner",distributorEmail:w.email||"",distributorPhone:w.phone||"",city:w.city||"",connectedAt:ie(),status:"accepted"},{merge:!0}),console.log("âœ… Saved to retailer's connectedDistributors"),console.log("ğŸ”„ Saving retailer to distributor's connectedRetailers..."),await Ce(q(D,`businesses/${M}/connectedRetailers/${N}`),{retailerId:N,retailerName:$.businessName||"Unnamed Retailer",retailerEmail:$.email||"",retailerPhone:$.phone||"",city:$.city||"",connectedAt:ie(),status:"accepted"},{merge:!0}),console.log("âœ… Saved to distributor's connectedRetailers");try{await Ce(q(D,`distributors/${M}/connectedRetailers/${N}`),{retailerId:N,retailerUid:N,retailerName:$.businessName||"Unnamed Retailer",retailerEmail:$.email||"",retailerPhone:$.phone||"",city:$.city||"",connectedAt:ie(),status:"accepted",relationshipStatus:"active"},{merge:!0}),console.log("âœ… Saved to distributors/<dist>/connectedRetailers (compat)")}catch(Z){console.warn("âš ï¸ Failed to write compat connectedRetailers under distributors/",Z?.message)}try{await Ce(q(D,`businesses/${N}/connectedDistributorsLegacy/${M}`),{distributorId:M,distributorUid:M,distributorName:w.businessName||"Unnamed Distributor",distributorOwner:w.ownerName||"Unknown Owner",distributorEmail:w.email||"",distributorPhone:w.phone||"",city:w.city||"",connectedAt:ie(),status:"accepted",relationshipStatus:"active"},{merge:!0}),console.log("âœ… Saved compat mirror to retailer's connectedDistributorsLegacy")}catch(Z){console.warn("âš ï¸ Failed to write compat mirror under connectedDistributorsLegacy/",Z?.message)}K.success("Retailer request accepted successfully!")}catch(k){console.error("âŒ Failed to create connected entries:",k.message)}s(k=>k.map(p=>p.id===N?{...p,status:C}:p))},T=N=>{h(N),o(""),c(!0)},S=async()=>{if(!l)return;const N=x();if(!N)return;const C=q(D,`businesses/${N}/connectionRequests/${l}`),M=q(D,`businesses/${l}/sentRequests/${N}`);await oe(C,{status:"rejected",rejectionNote:m,rejectedAt:ie()}),await oe(M,{status:"rejected",rejectionNote:m,rejectedAt:ie()}),s(P=>P.map(u=>u.retailerId===l?{...u,status:"rejected"}:u)),c(!1),K.info("Retailer request rejected.")};return e.jsxs("div",{className:"text-white",children:[e.jsx("h2",{className:"text-2xl font-semibold mb-4 sticky top-[72px] z-10 py-2 px-3 rounded-xl border border-white/10 backdrop-blur-xl bg-[#0B0F14]/60 supports-[backdrop-filter]:bg-[#0B0F14]/50 shadow-sm animate-fade-in",children:"Incoming Retailer Requests"}),v?e.jsx("div",{className:"text-center py-8 text-white/60",children:"Loading requests..."}):t.length===0?e.jsx("p",{className:"text-white/70 text-center mt-8 italic",children:"You're all caught up! No new requests."}):e.jsx("ul",{className:"space-y-4 animate-fade-in",children:t.map(N=>e.jsx("li",{className:"bg-white/5 backdrop-blur-xl border border-white/10 text-white p-4 rounded-xl transition-transform duration-200 hover:scale-[1.005] shadow-xl",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:N.businessName}),e.jsxs("p",{className:"text-sm text-white/70",children:[N.ownerName," (",N.email,")"]}),e.jsxs("p",{className:"text-sm",children:["Status:"," ",e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs ${N.status==="accepted"?"bg-emerald-500/20 text-emerald-200":N.status==="rejected"?"bg-rose-500/20 text-rose-200":"bg-amber-500/20 text-amber-200"}`,children:N.status})]}),N.sentAt?.seconds&&e.jsxs("p",{className:"text-xs text-white/50 mt-1",children:["Sent at:"," ",new Date(N.sentAt.seconds*1e3).toLocaleString()]}),N.message&&e.jsxs("p",{className:"text-sm italic text-white/60 mt-1",children:['Message: "',N.message,'"']}),N.address&&e.jsxs("p",{className:"text-sm text-white/60",children:["ğŸ“ Address: ",N.address]}),N.city&&e.jsxs("p",{className:"text-sm text-white/60",children:["ğŸ™ï¸ City: ",N.city]}),N.phone&&e.jsxs("p",{className:"text-sm text-white/60",children:["ğŸ“ Phone: ",N.phone]})]}),e.jsxs("div",{className:"space-x-2",children:[e.jsx("button",{onClick:()=>b(N.retailerId,"accepted"),disabled:N.status==="accepted",className:"bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-3 py-1.5 rounded-full disabled:opacity-50 transition duration-200 transform hover:scale-[1.02]",children:"Accept"}),e.jsx("button",{onClick:()=>T(N.retailerId),className:"bg-gradient-to-r from-rose-500 to-amber-500 text-white px-3 py-1.5 rounded-full transition duration-200 transform hover:scale-[1.02]",children:"Reject"})]})]})},N.id))}),a&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/60 z-50",children:e.jsxs("div",{className:"transition-all duration-300 ease-in-out transform scale-100 bg-[#0B0F14]/90 backdrop-blur-2xl border border-white/10 text-white p-6 rounded-2xl shadow-[0_20px_60px_rgba(0,0,0,0.55)] w-96",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Reject Retailer"}),e.jsx("p",{className:"mb-4 text-sm text-white/70",children:"Are you sure you want to reject this request?"}),e.jsx("textarea",{className:"w-full rounded-xl p-2.5 mb-4 bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-emerald-400/50",placeholder:"Optional reason for rejection...",value:m,onChange:N=>o(N.target.value)}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:()=>c(!1),className:"px-4 py-2 rounded-full bg-white/10 text-white border border-white/20 hover:bg-white/15",children:"Cancel"}),e.jsx("button",{onClick:S,className:"px-4 py-2 rounded-full text-white bg-gradient-to-r from-rose-500 to-amber-500",children:"Confirm Reject"})]})]})})]})},de=({label:r,name:t,value:s,onChange:a,step:c="0.01",min:l="0",hint:h,compact:m=!1})=>e.jsxs("div",{className:m?"flex flex-col gap-0.5":"flex flex-col gap-1",children:[e.jsx("label",{className:m?"text-xs font-medium text-white":"text-sm font-medium text-white",children:r}),e.jsx("input",{type:"number",inputMode:"decimal",step:c,min:l,className:`w-full rounded-lg border border-white/15 bg-white/5 px-3 ${m?"py-1.5 text-[13px]":"py-2 text-sm"} text-white placeholder-white/40 outline-none focus:border-indigo-400 text-right`,name:t,value:s??"",onChange:o=>a(t,o.target.value===""?"":Number(o.target.value))}),h?e.jsx("p",{className:m?"text-[11px] text-white/60":"text-xs text-white/60",children:h}):null]}),$e=({label:r,checked:t,onChange:s,compact:a=!1})=>e.jsxs("label",{className:"inline-flex items-center gap-3",children:[e.jsx("span",{className:a?"text-xs font-medium text-white":"text-sm font-medium text-white",children:r}),e.jsx("button",{type:"button",onClick:()=>s(!t),className:`relative inline-flex ${a?"h-5 w-9":"h-6 w-11"} items-center rounded-full transition ${t?"bg-indigo-600":"bg-white/30"}`,children:e.jsx("span",{className:`inline-block ${a?"h-3.5 w-3.5":"h-4 w-4"} transform rounded-full bg-white transition ${t?a?"translate-x-5":"translate-x-6":"translate-x-1"}`})})]});async function st(r){if(!r)return{};const t=q(D,"businesses",r,"orderSettings","global");try{const s=await xe(t);if(s.exists())return s.data()||{}}catch(s){console.error("getGlobalDefaultsSafe error",s)}return{}}async function St(r,t){if(!r)throw new Error("Missing distributorId");const s=q(D,"businesses",r,"orderSettings","global");await Ce(s,t,{merge:!0})}function Rt({compact:r=!1,distributorId:t,retailerId:s=null,scope:a="global"}={}){const[c,l]=d.useState(!0),[h,m]=d.useState(!1),[o,v]=d.useState(!0),[j,x]=d.useState(!0),[b,T]=d.useState(null),[S,N]=d.useState(!1),[C,M]=d.useState(18),[P,u]=d.useState(9),[w,L]=d.useState(9),[_,k]=d.useState(18),[p,$]=d.useState(0),[Z,X]=d.useState(0),[Q,V]=d.useState(0),[R,W]=d.useState(0),[Y,le]=d.useState(0),[A,ne]=d.useState(0),[ce,pe]=d.useState("nearest"),[se,Pe]=d.useState(1e4),[ye,re]=d.useState(null),H=t||ke?.currentUser?.uid||null;async function me(i,f){if(!i||!f)return{};const F=q(D,"businesses",i,"orderSettings","global","retailerOverrides",f);try{const U=await xe(F);if(U.exists())return U.data()||{}}catch(U){console.error("getRetailerOverrideSafe error",U)}return{}}async function ae(i,f,F){if(!i||!f)throw new Error("Missing distributorId/retailerId");const U=q(D,"businesses",i,"orderSettings","global","retailerOverrides",f);await Ce(U,F,{merge:!0})}const Ne=d.useMemo(()=>({enabled:o,autodetectTaxType:j,taxType:b,gstRate:C,cgstRate:P,sgstRate:w,igstRate:_,deliveryFee:p,packingFee:Z,insuranceFee:Q,otherFee:R,discountPct:Y,discountAmt:A,roundRule:ce,skipProforma:S}),[o,j,b,C,P,w,_,p,Z,Q,R,Y,A,ce,S]);d.useEffect(()=>{let i=!0;async function f(){try{if(!H)return;if(l(!0),a==="retailer"&&s){const[F,U]=await Promise.all([st(H),me(H,s)]),n={...F,...U};v(!!n.enabled),x(!!n.autodetectTaxType),T(n.taxType??null),M(I(n.gstRate,18)),u(I(n.cgstRate,9)),L(I(n.sgstRate,9)),k(I(n.igstRate,18)),$(I(n.deliveryFee,0)),X(I(n.packingFee,0)),V(I(n.insuranceFee,0)),W(I(n.otherFee,0)),le(_e(I(n.discountPct,0))),ne(I(n.discountAmt,0)),pe(["nearest","up","down"].includes(n.roundRule)?n.roundRule:"nearest"),N(!!n.skipProforma)}else{const F=await st(H);v(!!F.enabled),x(!!F.autodetectTaxType),T(F.taxType??null),M(I(F.gstRate,18)),u(I(F.cgstRate,9)),L(I(F.sgstRate,9)),k(I(F.igstRate,18)),$(I(F.deliveryFee,0)),X(I(F.packingFee,0)),V(I(F.insuranceFee,0)),W(I(F.otherFee,0)),le(_e(I(F.discountPct,0))),ne(I(F.discountAmt,0)),pe(["nearest","up","down"].includes(F.roundRule)?F.roundRule:"nearest"),N(!!F.skipProforma)}}catch(F){console.error("Load defaults failed:",F),De("Failed to load defaults")}finally{i&&l(!1)}}return f(),()=>{i=!1}},[H,a,s]),d.useEffect(()=>{try{if(!o){re(null);return}const i=bt({itemsSubTotal:I(se,0),defaults:Ne,distributorProfile:null,retailerProfile:null});re(i)}catch(i){console.warn("Preview computation failed",i),re(null)}},[Ne,se,o]);const Se=async()=>{if(!H){De("Not authenticated. Please re-login.");return}try{m(!0);const i={enabled:o,autodetectTaxType:j,taxType:b,gstRate:I(C,0),cgstRate:I(P,0),sgstRate:I(w,0),igstRate:I(_,0),deliveryFee:I(p,0),packingFee:I(Z,0),insuranceFee:I(Q,0),otherFee:I(R,0),discountPct:_e(I(Y,0)),discountAmt:I(A,0),roundRule:ce,skipProforma:!!S};a==="retailer"&&s?await ae(H,s,i):await St(H,i),De("Defaults saved")}catch(i){console.error("Save defaults failed:",i),De("Failed to save defaults")}finally{m(!1)}};return e.jsx("div",{className:`grid grid-cols-1 ${r?"gap-4":"gap-6"}`,children:e.jsxs("div",{className:`w-full grid grid-cols-1 sm:grid-cols-2 ${r?"gap-3":"gap-4"} rounded-xl border border-white/10 bg-white/5 p-4 md:p-6 shadow-lg`,children:[e.jsxs("div",{className:`sm:col-span-2 flex items-center justify-between ${r?"mb-1":"mb-0"}`,children:[e.jsx("h3",{className:r?"text-sm font-semibold text-white":"text-sm md:text-base font-semibold text-white",children:a==="retailer"?"Defaults (Retailer Override)":"Global Defaults"}),e.jsx($e,{label:"Enabled",checked:o,onChange:v,compact:r}),e.jsx("span",{className:"flex-1"}),e.jsx($e,{label:"Skip Proforma (direct Order)",checked:S,onChange:N,compact:r})]}),e.jsx($e,{label:"Autodetect Tax Type (by state)",checked:j,onChange:x,compact:r}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:r?"text-xs font-medium text-white":"text-sm font-medium text-white",children:"Tax Type (fallback)"}),e.jsxs("select",{className:`w-full rounded-lg border border-white/15 bg-white/5 px-3 ${r?"py-1.5 text-[13px]":"py-2 text-sm"} text-white outline-none focus:border-indigo-400`,value:b??"",onChange:i=>T(i.target.value||null),children:[e.jsx("option",{value:"",children:"Auto / Not Set"}),e.jsx("option",{value:"CGST_SGST",children:"CGST + SGST"}),e.jsx("option",{value:"IGST",children:"IGST"})]}),e.jsx("p",{className:r?"text-[11px] text-white/60":"text-xs text-white/60",children:"If Autodetect is ON and state codes are known, intrastate â†’ CGST/SGST, interstate â†’ IGST."})]}),e.jsx(de,{compact:r,label:"GST (Single) %",name:"gstRate",value:C,onChange:(i,f)=>M(ue(f)),hint:"Used for IGST when CGST/SGST not specified"}),e.jsx(de,{compact:r,label:"CGST %",name:"cgstRate",value:P,onChange:(i,f)=>u(ue(f))}),e.jsx(de,{compact:r,label:"SGST %",name:"sgstRate",value:w,onChange:(i,f)=>L(ue(f))}),e.jsx(de,{compact:r,label:"IGST %",name:"igstRate",value:_,onChange:(i,f)=>k(ue(f))}),e.jsx(de,{compact:r,label:"Delivery Fee (â‚¹)",name:"deliveryFee",value:p,onChange:(i,f)=>$(ue(f))}),e.jsx(de,{compact:r,label:"Packing Fee (â‚¹)",name:"packingFee",value:Z,onChange:(i,f)=>X(ue(f))}),e.jsx(de,{compact:r,label:"Insurance Fee (â‚¹)",name:"insuranceFee",value:Q,onChange:(i,f)=>V(ue(f))}),e.jsx(de,{compact:r,label:"Other Fee (â‚¹)",name:"otherFee",value:R,onChange:(i,f)=>W(ue(f))}),e.jsx(de,{compact:r,label:"Discount %",name:"discountPct",value:Y,onChange:(i,f)=>le(_e(ue(f))),hint:"0 to 100"}),e.jsx(de,{compact:r,label:"Discount Amount (â‚¹)",name:"discountAmt",value:A,onChange:(i,f)=>ne(ue(f)),hint:"If both % and amount are set, higher discount is applied."}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:r?"text-xs font-medium text-white":"text-sm font-medium text-white",children:"Rounding"}),e.jsxs("select",{className:`w-full rounded-lg border border-white/15 bg-white/5 px-3 ${r?"py-1.5 text-[13px]":"py-2 text-sm"} text-white outline-none focus:border-indigo-400`,value:ce,onChange:i=>pe(i.target.value),children:[e.jsx("option",{value:"nearest",children:"Nearest â‚¹"}),e.jsx("option",{value:"up",children:"Round Up"}),e.jsx("option",{value:"down",children:"Round Down"})]})]}),e.jsx("div",{className:`sm:col-span-2 flex items-center justify-end gap-3 ${r?"pt-1":"pt-2"}`,children:e.jsx("button",{type:"button",onClick:Se,disabled:h||c,className:`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium text-white shadow-sm ${h||c?"bg-indigo-400 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-700"}`,children:h?"Saving...":"Save Defaults"})}),e.jsx("p",{className:"text-xs text-white/50 text-right mt-1 sm:col-span-2",children:"Changes here affect only this retailer."})]})})}function I(r,t=0){const s=Number(r);return Number.isFinite(s)?s:t}function ue(r){if(r===""||r===null||typeof r>"u")return"";const t=Number(r);return Number.isFinite(t)?t:0}function _e(r){const t=Number(r||0);return!Number.isFinite(t)||t<0?0:t>100?100:t}function De(r){try{K.dismiss(),K(r,{type:"success"})}catch{console.log(r)}}const At=(r={})=>r?["taxType","autodetectTaxType","gstRate","cgstRate","sgstRate","igstRate","deliveryFee","packingFee","insuranceFee","otherFee","discountPct","discountAmt","roundRule","notes","enabled"].some(s=>r[s]!==void 0&&r[s]!==null&&r[s]!==""):!1;function Tt({distributorId:r}){const[t,s]=d.useState(!0),[a,c]=d.useState([]),[l,h]=d.useState(null),[m,o]=d.useState({});d.useEffect(()=>{let b=!0;async function T(){if(r){s(!0);try{const S=je(D,"businesses",r,"connectedRetailers"),N=Me(S,Fe("status","==","accepted")),C=await Ee(N),M=[];for(const P of C.docs){const u=P.id,w=P.data(),L=await xe(q(D,"businesses",u)),_=L.exists()?L.data():{},k=await wt(r,u);M.push({retailerId:u,retailerName:_.businessName||_.ownerName||_.name||w.retailerName||"Unnamed",retailerEmail:_.email||w.retailerEmail||"",override:k})}if(b){c(M);const P={};M.forEach(u=>{P[u.retailerId]=u.override}),o(P)}}catch(S){console.error("Load retailer defaults failed",S),K.error("Failed to load retailer defaults")}finally{b&&s(!1)}}}return T(),()=>{b=!1}},[r]);const v=(b,T,S)=>{o(N=>({...N,[b]:{...N[b],[T]:S}}))},j=async b=>{try{await Ke(r,b,m[b],{actorUid:ke?.currentUser?.uid}),K.success("Overrides saved")}catch(T){console.error("Save override failed",T),K.error("Failed to save overrides")}},x=async b=>{try{await Ke(r,b,{taxType:null,autodetectTaxType:null,gstRate:null,cgstRate:null,sgstRate:null,igstRate:null,deliveryFee:null,packingFee:null,insuranceFee:null,otherFee:null,discountPct:null,discountAmt:null,roundRule:null,notes:null}),o(T=>({...T,[b]:{}})),K.success("Overrides cleared")}catch(T){console.error("Clear override failed",T),K.error("Failed to clear overrides")}};return t?e.jsx("div",{className:"p-4 text-sm text-white/60",children:"Loading retailer defaultsâ€¦"}):e.jsxs("div",{className:"mt-6 overflow-x-auto rounded-2xl border border-white/10 bg-white/5",children:[e.jsxs("table",{className:"min-w-full text-sm text-white",children:[e.jsx("thead",{className:"bg-white/5 text-white/70",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-medium text-white/80",children:"Retailer"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-white/80",children:"Tax Type"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-white/80",children:"GST%"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-white/80",children:"Delivery Fee"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-white/80",children:"Discount%"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-white/80",children:"Actions"})]})}),e.jsxs("tbody",{children:[a.map(b=>{const T=m[b.retailerId]||{};return e.jsxs("tr",{className:"border-t border-white/10 hover:bg-white/5 transition",children:[e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-medium text-white",children:b.retailerName}),b.retailerEmail&&e.jsx("div",{className:"text-xs text-white/60",children:b.retailerEmail}),e.jsx("div",{className:"mt-1",children:At(T)?e.jsx("span",{className:"inline-block rounded-full border border-emerald-300/30 bg-emerald-400/10 px-2 py-0.5 text-[10px] font-medium text-emerald-200",children:"Overridden"}):e.jsx("span",{className:"inline-block rounded-full border border-white/20 bg-white/10 px-2 py-0.5 text-[10px] font-medium text-white/70",children:"Inherits Global"})})]}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("select",{className:"rounded border border-white/15 bg-white/5 px-2 py-1 text-sm text-white outline-none focus:border-indigo-400",value:T.taxType??"",onChange:S=>v(b.retailerId,"taxType",S.target.value||null),children:[e.jsx("option",{value:"",children:"Default"}),e.jsx("option",{value:"CGST_SGST",children:"CGST+SGST"}),e.jsx("option",{value:"IGST",children:"IGST"})]})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",className:"w-24 rounded border border-white/15 bg-white/5 px-2 py-1 text-sm text-white outline-none focus:border-indigo-400 text-right",value:T.gstRate??"",onChange:S=>v(b.retailerId,"gstRate",S.target.value===""?null:Number(S.target.value)),inputMode:"decimal",step:"0.01"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",className:"w-24 rounded border border-white/15 bg-white/5 px-2 py-1 text-sm text-white outline-none focus:border-indigo-400 text-right",value:T.deliveryFee??"",onChange:S=>v(b.retailerId,"deliveryFee",S.target.value===""?null:Number(S.target.value)),inputMode:"decimal",step:"0.01"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",className:"w-24 rounded border border-white/15 bg-white/5 px-2 py-1 text-sm text-white outline-none focus:border-indigo-400 text-right",value:T.discountPct??"",onChange:S=>v(b.retailerId,"discountPct",S.target.value===""?null:Number(S.target.value)),inputMode:"decimal",step:"0.01"})}),e.jsxs("td",{className:"px-3 py-2 space-x-2",children:[e.jsx("button",{onClick:()=>j(b.retailerId),className:"rounded bg-indigo-600 px-3 py-1 text-white hover:bg-indigo-700 shadow",children:"Save"}),e.jsx("button",{onClick:()=>x(b.retailerId),className:"rounded bg-white/10 border border-white/20 px-3 py-1 text-white hover:bg-white/15",children:"Clear"})]})]},b.retailerId)}),a.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-4 text-center text-sm text-white/60",children:"No connected retailers with accepted status."})})]})]}),e.jsx("div",{className:"h-1"})]})}function Et({open:r,onClose:t,distributorId:s,containerClassName:a="w-[98%] max-w-[1080px] h-[90vh]",bodyClassName:c="h-[calc(90vh-104px)] overflow-y-auto"}){const[l,h]=d.useState(!1),[m,o]=d.useState([]),[v,j]=d.useState({}),[x,b]=d.useState({enabled:!0,taxType:"",autodetectTaxType:"",gstRate:"",cgstRate:"",sgstRate:"",igstRate:"",deliveryFee:"",packingFee:"",insuranceFee:"",otherFee:"",discountPct:"",discountAmt:"",roundRule:"",notes:""}),T=d.useMemo(()=>m.length>0&&m.every(u=>v[u.retailerId]),[m,v]);d.useEffect(()=>{if(!r)return;const u=w=>{w.key==="Escape"&&t?.()};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[r,t]),d.useEffect(()=>{if(!r)return;let u=!0;async function w(){if(s){h(!0);try{const L=je(D,"businesses",s,"connectedRetailers"),_=Me(L,Fe("status","==","accepted")),k=await Ee(_),p=[];for(const $ of k.docs){const Z=$.id,X=$.data(),Q=await xe(q(D,"businesses",Z)),V=Q.exists()?Q.data():{};p.push({retailerId:Z,retailerName:V.businessName||V.ownerName||V.name||X.retailerName||"Unnamed",retailerEmail:V.email||X.retailerEmail||""})}if(u){o(p);const $={};p.forEach(Z=>$[Z.retailerId]=!1),j($)}}catch(L){console.error("Failed to load connected retailers",L),K.error("Failed to load connected retailers")}finally{u&&h(!1)}}}return w(),()=>{u=!1}},[r,s]);const S=()=>{b({enabled:!0,taxType:"",autodetectTaxType:"",gstRate:"",cgstRate:"",sgstRate:"",igstRate:"",deliveryFee:"",packingFee:"",insuranceFee:"",otherFee:"",discountPct:"",discountAmt:"",roundRule:"",notes:""}),j({}),t?.()},N=()=>{const u={};m.forEach(w=>{u[w.retailerId]=!T}),j(u)},C=u=>{j(w=>({...w,[u]:!w[u]}))},M=()=>{const u=(w,L=!1)=>{if(w===""||w===void 0)return null;if(L){const _=Number(w);return Number.isFinite(_)?_:null}return w==="true"?!0:w==="false"?!1:w};return{enabled:x.enabled,taxType:x.taxType||null,autodetectTaxType:x.autodetectTaxType===""?null:x.autodetectTaxType===!0||x.autodetectTaxType==="true",gstRate:u(x.gstRate,!0),cgstRate:u(x.cgstRate,!0),sgstRate:u(x.sgstRate,!0),igstRate:u(x.igstRate,!0),deliveryFee:u(x.deliveryFee,!0),packingFee:u(x.packingFee,!0),insuranceFee:u(x.insuranceFee,!0),otherFee:u(x.otherFee,!0),discountPct:u(x.discountPct,!0),discountAmt:u(x.discountAmt,!0),roundRule:x.roundRule||null,notes:x.notes||null}},P=async()=>{try{h(!0);const u=M(),w=ke?.currentUser?.uid||null,L=m.filter(_=>v[_.retailerId]);if(L.length===0){K.info("Select at least one retailer");return}for(const _ of L)await Ke(s,_.retailerId,u,{actorUid:w});K.success(`Defaults assigned to ${L.length} retailer(s)`),S()}catch(u){console.error("Assign defaults failed",u),K.error("Failed to assign defaults")}finally{h(!1)}};return r?mt.createPortal(e.jsxs("div",{role:"dialog","aria-modal":"true","aria-label":"Assign Retailer Overrides (Bulk)",className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:S}),e.jsxs("div",{className:`relative z-10 rounded-2xl border border-white/10 bg-[#0B0F14]/95 backdrop-blur-2xl shadow-[0_20px_60px_rgba(0,0,0,0.55)] overflow-hidden w-[98%] max-w-[1080px] ${a}`,children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-3 border-b border-white/10 bg-[#0B0F14]/95",children:[e.jsx("h3",{className:"text-base font-semibold text-white",children:"Assign Retailer Overrides (Bulk)"}),e.jsx("button",{onClick:S,className:"rounded-md bg-white/10 border border-white/20 px-3 py-1.5 text-sm text-white hover:bg-white/15",children:"Close"})]}),e.jsx("div",{className:`p-4 md:p-5 ${c}`,children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-12 h-full",children:[e.jsxs("div",{className:"md:col-span-5 lg:col-span-4 flex flex-col min-h-0",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium text-white",children:"Select Retailers"}),e.jsx("button",{onClick:N,className:"text-xs text-indigo-300 hover:text-indigo-200",disabled:l||m.length===0,children:T?"Clear All":"Select All"})]}),e.jsx("input",{type:"text",placeholder:"Search retailersâ€¦",className:"mb-2 w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/50 outline-none focus:border-indigo-400",onChange:u=>{const w=u.target.value.toLowerCase();o(L=>L.map(_=>({..._,_hidden:!(_.retailerName?.toLowerCase().includes(w)||_.retailerEmail?.toLowerCase().includes(w))})))}}),e.jsx("div",{className:"flex-1 overflow-y-auto rounded border border-white/10 bg-black/20",children:l?e.jsx("div",{className:"p-3 text-sm text-white/60",children:"Loadingâ€¦"}):m.length===0?e.jsx("div",{className:"p-3 text-sm text-white/60",children:"No connected retailers."}):e.jsx("ul",{className:"divide-y divide-white/10",children:m.map(u=>u._hidden?null:e.jsxs("li",{className:"flex items-center gap-3 p-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:!!v[u.retailerId],onChange:()=>C(u.retailerId)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-medium text-white",children:u.retailerName}),u.retailerEmail?e.jsx("div",{className:"truncate text-xs text-white/60",children:u.retailerEmail}):null]})]},u.retailerId))})})]}),e.jsx("div",{className:"md:col-span-7 lg:col-span-8 min-h-0",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-sm text-white",children:"Enable overrides"}),e.jsx("button",{type:"button",onClick:()=>b(u=>({...u,enabled:!u.enabled})),className:`relative inline-flex h-6 w-11 items-center rounded-full transition ${x.enabled?"bg-indigo-600":"bg-white/30"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition ${x.enabled?"translate-x-6":"translate-x-1"}`})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-white",children:"Autodetect Tax Type"}),e.jsxs("select",{className:"mt-1 w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-indigo-400",value:x.autodetectTaxType,onChange:u=>b(w=>({...w,autodetectTaxType:u.target.value})),children:[e.jsx("option",{value:"",children:"Leave as-is"}),e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium text-white",children:"Tax Type (fallback)"}),e.jsxs("select",{className:"mt-1 w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-indigo-400",value:x.taxType,onChange:u=>b(w=>({...w,taxType:u.target.value})),children:[e.jsx("option",{value:"",children:"Leave as-is"}),e.jsx("option",{value:"CGST_SGST",children:"CGST + SGST"}),e.jsx("option",{value:"IGST",children:"IGST"})]})]}),e.jsx(he,{label:"GST (Single) %",value:x.gstRate,onChange:u=>b(w=>({...w,gstRate:u}))}),e.jsx(he,{label:"CGST %",value:x.cgstRate,onChange:u=>b(w=>({...w,cgstRate:u}))}),e.jsx(he,{label:"SGST %",value:x.sgstRate,onChange:u=>b(w=>({...w,sgstRate:u}))}),e.jsx(he,{label:"IGST %",value:x.igstRate,onChange:u=>b(w=>({...w,igstRate:u}))}),e.jsx(he,{label:"Delivery Fee (â‚¹)",value:x.deliveryFee,onChange:u=>b(w=>({...w,deliveryFee:u}))}),e.jsx(he,{label:"Packing Fee (â‚¹)",value:x.packingFee,onChange:u=>b(w=>({...w,packingFee:u}))}),e.jsx(he,{label:"Insurance Fee (â‚¹)",value:x.insuranceFee,onChange:u=>b(w=>({...w,insuranceFee:u}))}),e.jsx(he,{label:"Other Fee (â‚¹)",value:x.otherFee,onChange:u=>b(w=>({...w,otherFee:u}))}),e.jsx(he,{label:"Discount %",value:x.discountPct,onChange:u=>b(w=>({...w,discountPct:u}))}),e.jsx(he,{label:"Discount Amount (â‚¹)",value:x.discountAmt,onChange:u=>b(w=>({...w,discountAmt:u}))}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium text-white",children:"Rounding"}),e.jsxs("select",{className:"mt-1 w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-indigo-400",value:x.roundRule,onChange:u=>b(w=>({...w,roundRule:u.target.value})),children:[e.jsx("option",{value:"",children:"Leave as-is"}),e.jsx("option",{value:"nearest",children:"Nearest â‚¹"}),e.jsx("option",{value:"up",children:"Round Up"}),e.jsx("option",{value:"down",children:"Round Down"})]})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium text-white",children:"Notes"}),e.jsx("textarea",{className:"mt-1 w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-indigo-400",rows:3,value:x.notes,onChange:u=>b(w=>({...w,notes:u.target.value})),placeholder:"Optional internal notes"})]})]})})]})}),e.jsxs("div",{className:"flex items-center justify-between border-t border-white/10 px-5 py-3 bg-[#0B0F14]/95",children:[e.jsxs("div",{className:"text-xs text-white/60",children:[Object.values(v).filter(Boolean).length," selected"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"rounded-md bg-white/10 border border-white/20 px-3 py-2 text-sm text-white hover:bg-white/15",onClick:S,disabled:l,children:"Cancel"}),e.jsx("button",{className:`rounded-md px-3 py-2 text-sm text-white ${l?"bg-indigo-400":"bg-indigo-600 hover:bg-indigo-700"}`,onClick:P,disabled:l,children:l?"Assigningâ€¦":"Assign to Selected"})]})]})]})]}),document.body):null}function he({label:r,value:t,onChange:s}){return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-sm font-medium text-white",children:r}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.01",min:"0",className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/40 outline-none focus:border-indigo-400 text-right",value:t,onChange:a=>s(a.target.value)})]})}function rt(r={}){const t=ke?.currentUser?.uid||null,a=(r.scope||(r.retailerId?"retailer":"global"))==="retailer",c=!!r.hideGlobalCtas,[l,h]=d.useState(!1),[m,o]=d.useState(!1);d.useEffect(()=>{const j=document.body.style.overflow;return l||m?document.body.style.overflow="hidden":document.body.style.overflow=j||"",()=>{document.body.style.overflow=j||""}},[l,m]);const v=d.useCallback(j=>{j.key==="Escape"&&(m&&o(!1),l&&h(!1))},[m,l]);return e.jsxs("div",{className:"order-settings-root p-4 md:p-6 lg:p-8",children:[e.jsx("style",{children:`
        .order-settings-root .card { border-radius: 12px; }
        .order-settings-root .section-title { margin-bottom: 0.5rem; }
        .order-settings-root .muted { color: rgba(255,255,255,0.6); }
      `}),e.jsxs("header",{className:"mb-4 md:mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-2xl font-semibold text-white",children:"Order Settings"}),a?e.jsxs("p",{className:"mt-1 text-sm text-white/70",children:["Define defaults for ",e.jsx("strong",{children:"this retailer only"}),". These values override your global defaults when creating proformas or orders for this retailer."]}):e.jsxs("p",{className:"mt-1 text-sm text-white/70",children:["Define your ",e.jsx("strong",{children:"default"})," taxes & charges for proformas. Use ",e.jsx("strong",{children:"Bulk Assign"})," for many retailers and ",e.jsx("strong",{children:"Review Overrides"})," to fineâ€‘tune individual retailers."]})]}),!a&&!c&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>o(!0),className:"rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 px-3 py-2 text-sm font-medium text-white",children:"Review Overrides"}),e.jsx("button",{onClick:()=>h(!0),className:"rounded-lg bg-indigo-600 hover:bg-indigo-700 px-3 py-2 text-sm font-medium text-white",children:"Bulk Assign Defaults"})]})]}),e.jsxs("section",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 md:p-6 elevate",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between gap-3",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-white flex items-center gap-2",children:[a?"Retailer Defaults":"Global Defaults",e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded-full bg-white/10 border border-white/15 text-white/70",children:a?"Retailer Specific":"Applies to all"})]}),e.jsx("span",{className:"text-xs subtle",children:"Baseline for new proformas; individual overrides take precedence"})]}),e.jsxs("div",{className:"space-y-4 compact-form",children:[e.jsx(Rt,{distributorId:t}),e.jsx("div",{className:"text-xs subtle pt-1",children:"Tip: Perâ€‘retailer overrides take priority over global defaults. Turn on â€œEnabledâ€ to activate default charges/percentages."})]})]}),m&&e.jsxs("div",{role:"dialog","aria-modal":"true","aria-label":"Retailer Overrides",onKeyDown:v,tabIndex:-1,className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>o(!1)}),e.jsxs("div",{className:"relative w-[98%] max-w-[1080px] h-[90vh] rounded-2xl border border-white/10 bg-[#0B0F14]/95 backdrop-blur-2xl shadow-[0_20px_60px_rgba(0,0,0,0.55)] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-3 border-b border-white/10 bg-[#0B0F14]/95",children:[e.jsx("div",{className:"text-white font-semibold",children:"Retailer Overrides"}),e.jsx("button",{onClick:()=>o(!1),className:"rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 px-3 py-1.5 text-sm text-white",children:"Close"})]}),e.jsx("div",{className:"h-[calc(90vh-104px)] overflow-y-auto p-4 md:p-5 glass-scroll",children:e.jsx(Tt,{distributorId:t})}),e.jsx("div",{className:"px-5 py-3 border-t border-white/10 bg-[#0B0F14]/95 flex items-center justify-end",children:e.jsx("button",{onClick:()=>o(!1),className:"rounded-lg bg-indigo-600 hover:bg-indigo-700 px-4 py-2 text-sm font-medium text-white",children:"Done"})})]})]}),e.jsx(Et,{open:l,onClose:()=>h(!1),distributorId:t,containerClassName:"w-[98%] max-w-[1080px] h-[90vh]",bodyClassName:"h-[calc(90vh-104px)] overflow-y-auto"})]})}const at=(r="")=>r.toString().trim().toLowerCase().replace(/\b([a-z])/g,t=>t.toUpperCase()),Ue=(r="")=>r.toString().replace(/[-_]/g," ").replace(/\b([a-z])/gi,t=>t.toUpperCase()).trim();function Mt({status:r}){const t=(r||"").toString().toLowerCase();let s="bg-white/5 text-white/70 border border-white/15";return t==="accepted"||t==="active"||t==="approved"?s="bg-emerald-500/15 text-emerald-300 border border-emerald-400/30":t==="provisioned"||t==="provisioned-local"||t==="pending"||t==="invited"?s="bg-amber-500/15 text-amber-300 border border-amber-400/30":(t==="rejected"||t==="blocked"||t==="disabled")&&(s="bg-rose-500/15 text-rose-300 border border-rose-400/30"),e.jsx("span",{className:`inline-block px-2.5 py-1 rounded-lg text-xs font-medium whitespace-nowrap ${s}`,title:Ue(r)||"â€”","aria-label":`Status: ${Ue(r)||"Unknown"}`,children:Ue(r)||"â€”"})}const Ge=(r="")=>r.toString().toLowerCase().trim(),Ft=r=>{const t=(r||"").replace(/[^\d]/g,"");return t?t.length===10?`+91${t}`:t.length===12&&t.startsWith("91")?`+${t}`:t.length===13&&t.startsWith("91")?`+${t}`:t.length===12&&t.startsWith("91")===!1?`+91${t.slice(-10)}`:`+91${t.slice(-10)}`:null},Pt=({distributorId:r})=>{const[t,s]=d.useState([]),[a,c]=d.useState(!0),[l,h]=d.useState(null),[m,o]=d.useState({}),[v,j]=d.useState(""),[x,b]=d.useState(""),T=d.useRef(null),[S,N]=d.useState("all"),[C,M]=d.useState(18),[P,u]=d.useState(1),[w,L]=d.useState(!1),[_,k]=d.useState(!1),[p,$]=d.useState(null),[Z,X]=d.useState("overview"),[Q,V]=d.useState(!1),[R,W]=d.useState({}),[Y,le]=d.useState(!1),A=i=>{$(i),X("overview"),V(!1),W({}),document.body.style.overflow="hidden"},ne=()=>{$(null),V(!1),W({}),document.body.style.overflow=""},ce=()=>{p&&(W({businessName:p.businessName||p.retailerName||"",retailerName:p.retailerName||p.businessName||"",email:p.email||p.retailerEmail||"",retailerEmail:p.retailerEmail||p.email||"",phone:p.phone||p.retailerPhone||"",retailerPhone:p.retailerPhone||p.phone||"",city:p.city||p.retailerCity||"",retailerCity:p.retailerCity||p.city||"",state:p.state||p.retailerState||"",retailerState:p.retailerState||p.state||"",address:p.address||p.retailerAddress||"",retailerAddress:p.retailerAddress||p.address||"",gst:p.gst||p.gstNumber||"",gstNumber:p.gstNumber||p.gst||""}),V(!0))},pe=()=>{V(!1),W({})},se=(i,f)=>{W(F=>({...F,[i]:f,...i==="businessName"?{retailerName:f}:{},...i==="retailerName"?{businessName:f}:{},...i==="email"?{retailerEmail:f}:{},...i==="retailerEmail"?{email:f}:{},...i==="phone"?{retailerPhone:f}:{},...i==="retailerPhone"?{phone:f}:{},...i==="city"?{retailerCity:f}:{},...i==="retailerCity"?{city:f}:{},...i==="state"?{retailerState:f}:{},...i==="retailerState"?{state:f}:{},...i==="address"?{retailerAddress:f}:{},...i==="retailerAddress"?{address:f}:{},...i==="gst"?{gstNumber:f}:{},...i==="gstNumber"?{gst:f}:{}}))},Pe=async()=>{if(!(!p||!r)){le(!0);try{const i=q(D,"businesses",r,"connectedRetailers",p.id),f={updatedAt:new Date().toISOString()};if(R.businessName?.trim()&&(f.businessName=R.businessName.trim(),f.retailerName=R.businessName.trim()),R.email?.trim()&&(f.email=R.email.trim(),f.retailerEmail=R.email.trim()),R.phone?.trim()){const g=Ft(R.phone.trim());g?(f.phone=g,f.retailerPhone=g):(f.phone=R.phone.trim(),f.retailerPhone=R.phone.trim())}R.city?.trim()&&(f.city=R.city.trim(),f.retailerCity=R.city.trim()),R.state?.trim()&&(f.state=R.state.trim(),f.retailerState=R.state.trim()),R.address?.trim()&&(f.address=R.address.trim(),f.retailerAddress=R.address.trim()),R.gst?.trim()&&(f.gst=R.gst.trim().toUpperCase(),f.gstNumber=R.gst.trim().toUpperCase()),await oe(i,f),$(g=>({...g,...f}));const F=je(D,"businesses",r,"connectedRetailers"),n=(await Ee(F)).docs.map(g=>({id:g.id,...g.data()}));s(n),V(!1),W({}),alert("Retailer information updated successfully!")}catch(i){console.error("Error updating retailer:",i),alert("Failed to update retailer information: "+(i.message||"Unknown error"))}finally{le(!1)}}};d.useEffect(()=>{const i=document.body.style.overflow;return w||!!p||_?document.body.style.overflow="hidden":document.body.style.overflow=i||"",()=>{document.body.style.overflow=i||""}},[w,p,_]);const ye=d.useCallback(i=>{if((i.metaKey||i.ctrlKey)&&i.key.toLowerCase()==="k"){i.preventDefault(),T.current?.focus();return}i.key==="Escape"&&(w&&L(!1),p&&ne(),_&&k(!1))},[w,p,_]);d.useEffect(()=>(document.addEventListener("keydown",ye),()=>document.removeEventListener("keydown",ye)),[ye]),d.useEffect(()=>{if(!r)return;c(!0),h(null);const i=je(D,"businesses",r,"connectedRetailers"),f=Me(i,Fe("status","in",["accepted","provisioned","provisioned-local"])),F=ct(f,async U=>{const n=U.docs.map(g=>{const y=g.data()||{};return{id:y.retailerId||g.id,status:y.status||"provisioned",businessName:y.retailerName||"Retailer",email:y.retailerEmail||"",city:y.retailerCity||y.city||"",state:y.retailerState||y.state||"",address:y.retailerAddress||y.address||"",phone:y.retailerPhone||"",connectedAt:y.connectedAt||null,provisionalId:y.provisionalId||null,addedBy:y.addedBy||null,createdAt:y.createdAt||null}});s(n),c(!1)},U=>{console.error("connectedRetailers live query failed",U),h("Failed to fetch retailers."),c(!1)});return()=>F()},[r]),d.useEffect(()=>{if(!r||!t.length)return;const i=Array.from(new Set(t.map(f=>f.addedBy?.type==="employee"?f.addedBy.id:null).filter(Boolean).filter(f=>!m[f])));i.length&&(async()=>{const f={};for(const F of i)try{const U=q(D,"businesses",r,"distributorEmployees",F),n=await xe(U);if(n.exists()){const g=n.data()||{};f[F]={name:g.name||"",flypEmployeeId:g.flypEmployeeId||""}}}catch{}Object.keys(f).length&&o(F=>({...F,...f}))})()},[r,t,m]),d.useEffect(()=>{const i=setTimeout(()=>b(v),250);return()=>clearTimeout(i)},[v]);const re=d.useMemo(()=>{const i=new Set;return t.forEach(f=>{f.city&&i.add(f.city)}),["all",...Array.from(i).sort((f,F)=>f.localeCompare(F))]},[t]),H=d.useMemo(()=>{const i=Ge(x);return t.filter(f=>{const F=S==="all"||Ge(f.city)===Ge(S),U=`${f.businessName} ${f.email} ${f.phone} ${f.city}`.toLowerCase(),n=i===""||U.includes(i);return F&&n})},[t,x,S]),me=Math.max(1,Math.ceil(H.length/C)),ae=Math.min(P,me),Ne=d.useMemo(()=>{const i=(ae-1)*C;return H.slice(i,i+C)},[H,ae,C]);function Se({retailer:i,onManage:f}){const F=(i.businessName||i.name||"R").split(" ").filter(Boolean).slice(0,2).map(G=>G[0]?.toUpperCase()).join("")||"R",[U,n]=d.useState(!1),[g,y]=d.useState([]),[E,O]=d.useState(!1),B=d.useCallback(async()=>{if(r){O(!0);try{const G=je(D,"businesses",r,"employeeActivity"),J=Me(G,Fe("targetId","==",i.id),ft("createdAt","desc"),gt(5)),fe=await Ee(J);y(fe.docs.map(Le=>({id:Le.id,...Le.data()})))}catch{y([])}finally{O(!1)}}},[r,i?.id]),z=G=>{G.stopPropagation();const J=!U;n(J),J&&g.length===0&&B()};return d.useEffect(()=>{if(!U)return;const G=J=>{J.target.closest(".activity-popup-container")||n(!1)};return document.addEventListener("click",G),()=>document.removeEventListener("click",G)},[U]),e.jsxs("div",{className:"flex items-center justify-between gap-4 relative z-0",children:[e.jsxs("div",{className:"flex items-center gap-4 min-w-0 flex-1",children:[e.jsx("div",{className:"h-14 w-14 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-cyan-500/20 text-emerald-300 flex items-center justify-center text-lg font-bold shadow-lg border border-emerald-500/30 flex-shrink-0","aria-label":`Retailer avatar ${i.businessName||i.name||"Retailer"}`,role:"img",children:F}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"text-white font-bold text-lg truncate",title:i.businessName||i.name||"Retailer",children:at(i.businessName||i.name||"Retailer")}),e.jsx(Mt,{status:i.status||"provisioned"})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-white/70 mb-1",children:[i.city&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"ğŸ“"}),e.jsx("span",{className:"truncate",children:at(i.city)})]}),i.email&&e.jsxs("span",{className:"flex items-center gap-1 truncate",title:i.email,children:[e.jsx("span",{children:"ğŸ“§"}),e.jsx("span",{className:"truncate",children:i.email})]}),i.phone&&!i.email&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"ğŸ“"}),e.jsx("span",{children:i.phone})]})]}),i.addedBy?.type==="employee"&&e.jsxs("div",{className:"text-xs text-white/50 truncate",children:["Added by: ",i.addedBy.name||m[i.addedBy.id]?.name||"Employee",(i.addedBy.flypEmployeeId||m[i.addedBy.id]?.flypEmployeeId)&&` (${i.addedBy.flypEmployeeId||m[i.addedBy.id]?.flypEmployeeId})`]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 relative",children:[/^provisioned/.test(i.status||"")&&e.jsx("button",{onClick:async()=>{try{const J=await Xe(Ye,"createProvisionalRetailer")({distributorId:r,payload:{businessName:i.businessName,email:i.email||null,phone:i.phone||null}}),{provisionalId:fe,inviteUrl:Le}=J?.data||{};if(fe){await oe(q(D,"businesses",r,"connectedRetailers",i.id),{provisionalId:fe,status:"provisioned"});try{await navigator.clipboard.writeText(Le)}catch{}alert("Invite link created and copied to clipboard")}}catch(G){console.error("Invite create failed",G),alert("Failed to create invite")}},className:"rounded-lg px-4 py-2 text-sm bg-amber-500/90 text-black hover:bg-amber-400 border border-amber-400/40 transition-all shadow-md hover:shadow-lg font-medium",title:"Send invite",children:"Send Invite"}),e.jsxs("div",{className:"relative activity-popup-container",children:[e.jsx("button",{onClick:z,title:"Recent activity",className:"rounded-lg p-2 bg-white/10 hover:bg-white/15 border border-white/20 text-white transition-all","aria-label":"View recent activity",children:"â“˜"}),U&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 w-72 rounded-xl border border-white/20 bg-gradient-to-br from-slate-900 to-slate-800 shadow-2xl z-[9999] overflow-hidden",onClick:G=>G.stopPropagation(),children:[e.jsx("div",{className:"px-4 py-3 border-b border-white/10 bg-white/5",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold text-white",children:"Recent Activity"}),e.jsx("button",{onClick:G=>{G.stopPropagation(),n(!1)},className:"text-white/60 hover:text-white transition","aria-label":"Close",children:"âœ•"})]})}),e.jsx("div",{className:"max-h-60 overflow-y-auto","aria-live":"polite",children:E?e.jsx("div",{className:"p-4 text-sm text-white/60 text-center",children:"Loadingâ€¦"}):g.length===0?e.jsx("div",{className:"p-4 text-sm text-white/60 text-center",children:"No activity yet."}):e.jsx("ul",{className:"p-2 space-y-1",children:g.map(G=>e.jsxs("li",{className:"text-xs text-white/80 flex items-center justify-between gap-2 px-3 py-2 rounded-lg hover:bg-white/10 transition",children:[e.jsxs("span",{className:"truncate flex-1",children:[e.jsx("span",{className:"capitalize font-medium text-emerald-300",children:G.type}),G.meta?.name&&e.jsxs("span",{className:"text-white/60",children:[" â€“ ",G.meta.name]})]}),e.jsx("span",{className:"text-white/50 text-xs whitespace-nowrap",children:G.createdAt?.toDate?.().toLocaleDateString?.()||""})]},G.id))})})]})]}),e.jsx("button",{onClick:f,className:"rounded-lg px-5 py-2 text-sm font-semibold bg-gradient-to-r from-emerald-500 to-cyan-500 text-white hover:from-emerald-400 hover:to-cyan-400 shadow-lg hover:shadow-emerald-500/25 transition-all transform hover:scale-105","aria-label":"Manage retailer",children:"Manage"})]})]})}return e.jsxs("div",{className:"p-6 md:p-10",children:[e.jsx("div",{className:"mb-6 border-b border-white/10 pb-3",children:e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Connected Retailers"}),e.jsxs("p",{className:"text-xs text-white/60 mt-0.5",children:[H.length," of ",t.length," retailers â€¢ Page ",ae,"/",me]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{value:v,onChange:i=>{j(i.target.value),u(1)},placeholder:"Search name, email, phone, city",className:"w-64 max-w-[70vw] rounded-lg bg-white/10 border border-white/20 px-3 py-2 pr-8 text-sm text-white placeholder-white/50 outline-none focus:ring-2 focus:ring-emerald-400/40",ref:T,"aria-label":"Search retailers"}),e.jsx("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 text-white/60 text-sm",children:"âŒ˜K"})]}),e.jsx("select",{value:S,onChange:i=>{N(i.target.value),u(1)},className:"rounded-lg bg-white/10 border border-white/20 px-3 py-2 text-sm text-white outline-none focus:ring-2 focus:ring-emerald-400/40",children:re.map(i=>e.jsx("option",{value:i,children:i==="all"?"All Cities":i},i))}),e.jsx("select",{value:C,onChange:i=>{M(Number(i.target.value)),u(1)},className:"rounded-lg bg-white/10 border border-white/20 px-2 py-2 text-sm text-white outline-none focus:ring-2 focus:ring-emerald-400/40",children:[12,18,24,36].map(i=>e.jsxs("option",{value:i,children:[i,"/page"]},i))})]}),e.jsxs("button",{onClick:()=>L(!0),className:"px-3 py-2 rounded-lg text-sm border bg-white/10 text-white border-white/20 hover:bg-white/15 flex items-center gap-2 transition-all",title:"Open global/bulk order settings","aria-label":"Open global and bulk order settings",children:["âš™ï¸ ",e.jsx("span",{className:"hidden sm:inline",children:"Settings"})]})]})]})}),a?e.jsxs("div",{className:"flex flex-col items-center justify-center h-40 text-white/70",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-t-4 border-emerald-400 mb-3"}),e.jsx("span",{children:"Loading retailers..."})]}):l?e.jsx("div",{className:"text-red-400",children:l}):H.length===0?e.jsxs("div",{className:"text-white/60 text-center py-16 border border-dashed border-white/10 rounded-xl",children:[e.jsx("p",{className:"text-lg mb-1",children:"No retailers found"}),e.jsx("p",{className:"text-sm text-white/40",children:"Try adjusting filters or adding new retailers."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3",children:Ne.map(i=>e.jsx(ee.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},whileHover:{scale:1.01},className:"rounded-2xl border border-white/10 bg-gradient-to-r from-white/5 to-white/[0.02] backdrop-blur-sm p-5 hover:border-emerald-500/50 hover:from-white/10 hover:to-white/5 transition-all duration-200 shadow-lg hover:shadow-emerald-500/10",children:e.jsx(Se,{retailer:i,onManage:()=>A(i)})},i.id))}),e.jsxs("div",{className:"mt-6 flex items-center justify-between text-sm text-white/70 border-t border-white/10 pt-4",children:[e.jsxs("div",{children:["Showing ",(ae-1)*C+1,"â€“",Math.min(ae*C,H.length)," of ",H.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>u(i=>Math.max(1,i-1)),disabled:ae===1,className:"px-3 py-1.5 rounded-lg bg-white/10 border border-white/15 disabled:opacity-50 hover:bg-white/15","aria-label":"Previous page",children:"Prev"}),e.jsxs("span",{children:["Page ",ae,"/",me]}),e.jsx("button",{onClick:()=>u(i=>Math.min(me,i+1)),disabled:ae===me,className:"px-3 py-1.5 rounded-lg bg-white/10 border border-white/15 disabled:opacity-50 hover:bg-white/15","aria-label":"Next page",children:"Next"})]})]})]}),p&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-start justify-center pt-10",role:"dialog","aria-modal":"true","aria-labelledby":"retailer-manage-title",children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm",onClick:ne}),e.jsxs("div",{className:"relative w-[96%] max-w-6xl rounded-2xl border border-white/10 bg-gradient-to-b from-[#0B0F14]/95 to-[#0F1319]/95 backdrop-blur-xl shadow-[0_24px_80px_rgba(0,0,0,0.6)] overflow-hidden animate-[fadeIn_.18s_ease-out]",children:[e.jsx("style",{children:`
              @keyframes fadeIn { from { opacity: 0; transform: scale(.98) } to { opacity: 1; transform: scale(1) } }
            `}),e.jsxs("div",{className:"px-6 py-5 border-b border-white/10 flex items-center justify-between bg-[#0E1319]/90 backdrop-blur",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-white/60 uppercase tracking-wide mb-0.5",children:"Retailer"}),e.jsx("h2",{id:"retailer-manage-title",className:"text-xl font-semibold text-white",children:p.businessName||"Retailer"}),e.jsxs("div",{className:"text-xs text-white/60",children:[p.email||"â€”"," â€¢ ",p.phone||"â€”"]})]}),e.jsx("button",{"aria-label":"Close retailer panel",onClick:ne,className:"rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 px-4 py-2 text-sm text-white font-medium transition-all",children:"âœ• Close"})]}),e.jsx("div",{className:"px-6 py-3 border-b border-white/10 bg-[#0E1319]/60 backdrop-blur-md",children:e.jsx("div",{className:"flex items-center gap-3 overflow-x-auto no-scrollbar",children:["overview","orders","defaults","assistant"].map(i=>e.jsx("button",{onClick:()=>X(i),className:`px-4 py-2.5 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${Z===i?"bg-emerald-500 text-black shadow-[0_0_10px_rgba(16,185,129,0.4)]":"bg-white/10 text-white border border-white/10 hover:bg-white/15"}`,children:i==="overview"?"Retailer Overview":i==="orders"?"Orders":i==="defaults"?"Set Defaults":"Assistant"},i))})}),e.jsxs("div",{className:"max-h-[78vh] overflow-y-auto px-6 py-6 space-y-6",children:[Z==="overview"&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-sm text-white/60",children:"Contact"}),/^provisioned/.test(p.status||"")&&!Q&&e.jsx("button",{onClick:ce,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium transition-colors",children:"âœï¸ Edit"})]}),Q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-white/60 mb-1",children:"Business Name *"}),e.jsx("input",{type:"text",value:R.businessName||"",onChange:i=>se("businessName",i.target.value),className:"w-full bg-slate-800/60 border border-white/10 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"Enter business name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-white/60 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:R.email||"",onChange:i=>se("email",i.target.value),className:"w-full bg-slate-800/60 border border-white/10 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"Enter email"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-white/60 mb-1",children:"Phone"}),e.jsx("input",{type:"tel",value:R.phone||"",onChange:i=>se("phone",i.target.value),className:"w-full bg-slate-800/60 border border-white/10 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"Enter phone number"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-white/60 mb-1",children:"City"}),e.jsx("input",{type:"text",value:R.city||"",onChange:i=>se("city",i.target.value),className:"w-full bg-slate-800/60 border border-white/10 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"City"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-white/60 mb-1",children:"State"}),e.jsx("input",{type:"text",value:R.state||"",onChange:i=>se("state",i.target.value),className:"w-full bg-slate-800/60 border border-white/10 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"State"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-white/60 mb-1",children:"Address"}),e.jsx("textarea",{value:R.address||"",onChange:i=>se("address",i.target.value),rows:2,className:"w-full bg-slate-800/60 border border-white/10 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"Enter address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-white/60 mb-1",children:"GST Number"}),e.jsx("input",{type:"text",value:R.gst||"",onChange:i=>se("gst",i.target.value.toUpperCase()),className:"w-full bg-slate-800/60 border border-white/10 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"GST Number",maxLength:15})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{onClick:Pe,disabled:Y||!R.businessName?.trim(),className:"flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:Y?"Saving...":"ğŸ’¾ Save Changes"}),e.jsx("button",{onClick:pe,disabled:Y,className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md text-sm transition-colors disabled:opacity-50",children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-white font-semibold",children:p.businessName||p.retailerName||"â€”"}),e.jsx("div",{className:"text-white/80 text-sm mt-1",children:p.email||p.retailerEmail||"â€”"}),e.jsx("div",{className:"text-white/80 text-sm",children:p.phone||p.retailerPhone||"â€”"}),e.jsxs("div",{className:"text-white/60 text-xs mt-2",children:["City: ",p.city||p.retailerCity||"â€”"]}),p.state&&e.jsxs("div",{className:"text-white/60 text-xs",children:["State: ",p.state||p.retailerState]}),p.address&&e.jsxs("div",{className:"text-white/60 text-xs",children:["Address: ",p.address||p.retailerAddress]}),p.gst&&e.jsxs("div",{className:"text-white/60 text-xs",children:["GST: ",p.gst||p.gstNumber]}),e.jsxs("div",{className:"text-white/60 text-xs mt-2",children:["Status: ",e.jsx("span",{className:"uppercase",children:p.status||"provisioned"})]}),e.jsxs("div",{className:"text-white/60 text-xs mt-1",children:["Added: ",p.createdAt?.toDate?.().toLocaleString?.()||"â€”"]}),e.jsxs("div",{className:"text-white/60 text-xs",children:["Added by: ",p.addedBy?.type||"â€”",p.addedBy?.name?` ${p.addedBy.name}`:"",p.addedBy?.flypEmployeeId?` (${p.addedBy.flypEmployeeId})`:p.addedBy?.id?` (${p.addedBy.id})`:""]})]})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 p-4",children:[e.jsx("div",{className:"text-sm text-white/60 mb-2",children:"Quick Actions"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm",children:"Create Order"}),/^provisioned/.test(p.status||"")&&e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-500 text-black hover:bg-emerald-400 text-sm",onClick:async()=>{try{const f=await Xe(Ye,"createProvisionalRetailer")({distributorId:r,payload:{businessName:p.businessName,email:p.email||null,phone:p.phone||null}}),{provisionalId:F,inviteUrl:U}=f?.data||{};if(F){await oe(q(D,"businesses",r,"connectedRetailers",p.id),{provisionalId:F,status:"provisioned"});try{await navigator.clipboard.writeText(U)}catch{}alert("Invite link created and copied")}}catch{alert("Failed to create invite")}},children:"Send Invite"}),e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm",children:"Send Reminder"}),e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm",children:"View Payments"})]})]})]}),Z==="orders"&&e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 p-4",children:[e.jsx("div",{className:"text-sm text-white/60 mb-2",children:"Recent Orders"}),e.jsx("div",{className:"text-white/60 text-sm",children:"Coming soon: list distributor â†’ retailer orders with statuses."})]}),Z==="defaults"&&e.jsxs("div",{className:"p-0",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold text-white",children:"Retailer Defaults"}),e.jsxs("div",{className:"text-xs text-white/60",children:["These settings apply ",e.jsx("span",{className:"text-white font-medium",children:"only to this retailer"})," and override your global defaults."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>k(!0),className:"px-3 py-1.5 text-xs rounded-md bg-white/10 hover:bg-white/15 border border-white/15 text-white transition",children:"Preview"}),e.jsx("span",{className:"px-3 py-1.5 text-xs rounded-md bg-emerald-500/20 text-emerald-400 border border-emerald-400/30",children:"Retailer Specific"})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsx(rt,{scope:"retailer",distributorId:r,retailerId:p.id,hideGlobalCtas:!0})})]}),e.jsxs("div",{className:"sticky bottom-0 mt-4 -mx-6 px-6 py-3 bg-[#0B0F14]/85 backdrop-blur border-t border-white/10 flex items-center justify-end gap-2",children:[e.jsx("span",{className:"text-xs text-white/50 mr-auto",children:"Changes here affect this retailer only."}),e.jsx("button",{onClick:()=>X("overview"),className:"px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 text-white text-sm",children:"Done"})]})]}),Z==="assistant"&&e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 p-4",children:[e.jsx("div",{className:"text-sm text-white/60 mb-2",children:"Assistant"}),e.jsx("div",{className:"text-white/60 text-sm",children:"Chat and quick actions for this retailer (placeholder)."})]})]})]})]}),_&&e.jsxs("div",{className:"fixed inset-0 z-[60] flex items-start justify-center pt-10",role:"dialog","aria-modal":"true","aria-labelledby":"retailer-defaults-preview-title",children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm",onClick:()=>k(!1)}),e.jsxs("div",{className:"relative w-[96%] max-w-4xl rounded-2xl border border-white/10 bg-gradient-to-b from-[#0B0F14]/95 to-[#0F1319]/95 backdrop-blur-xl shadow-[0_24px_80px_rgba(0,0,0,0.6)] overflow-hidden animate-[fadeIn_.18s_ease-out]",children:[e.jsx("style",{children:"@keyframes fadeIn { from { opacity:0; transform: scale(.98) } to { opacity:1; transform: scale(1) } }"}),e.jsxs("div",{className:"px-5 py-4 border-b border-white/10 flex items-center justify-between bg-[#0E1319]/90",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-white/60 uppercase tracking-wide",children:"Preview"}),e.jsx("h3",{id:"retailer-defaults-preview-title",className:"text-lg font-semibold text-white",children:"Invoice / Proforma preview"})]}),e.jsx("button",{"aria-label":"Close preview",onClick:()=>k(!1),className:"rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 px-4 py-2 text-sm text-white",children:"âœ• Close"})]}),e.jsx("div",{className:"max-h-[70vh] overflow-y-auto p-5",children:e.jsx("div",{className:"rounded-xl border border-white/10 bg-white/5 p-6 text-white/70 text-sm",children:"Preview placeholder â€” this will render a mini proforma/invoice using the current defaults for this retailer."})})]})]}),w&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-start justify-center pt-10",onKeyDown:ye,tabIndex:-1,role:"dialog","aria-modal":"true","aria-labelledby":"order-settings-title",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>L(!1)}),e.jsxs("div",{className:"relative w-[95%] max-w-6xl rounded-2xl border border-white/10 bg-[#0B0F14]/95 backdrop-blur-2xl shadow-[0_20px_60px_rgba(0,0,0,0.55)] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-3 border-b border-white/10",children:[e.jsx("div",{id:"order-settings-title",className:"text-white font-semibold",children:"Order Settings â€” Global & Bulk"}),e.jsx("button",{onClick:()=>L(!1),className:"rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 px-3 py-1.5 text-sm text-white",children:"Close"})]}),e.jsx("div",{className:"max-h-[80vh] overflow-y-auto p-4 glass-scroll",children:e.jsx(rt,{scope:"global"})})]})]})]})},it=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],Be=1,Re=8;class He{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[s,a]=new Uint8Array(t,0,2);if(s!==219)throw new Error("Data does not appear to be in a KDBush format.");const c=a>>4;if(c!==Be)throw new Error(`Got v${c} data when expected v${Be}.`);const l=it[a&15];if(!l)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(t,2,1),[m]=new Uint32Array(t,4,1);return new He(m,h,l,t)}constructor(t,s=64,a=Float64Array,c){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+s,2),65535),this.ArrayType=a,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const l=it.indexOf(this.ArrayType),h=t*2*this.ArrayType.BYTES_PER_ELEMENT,m=t*this.IndexArrayType.BYTES_PER_ELEMENT,o=(8-m%8)%8;if(l<0)throw new Error(`Unexpected typed array class: ${a}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,Re,t),this.coords=new this.ArrayType(this.data,Re+m+o,t*2),this._pos=t*2,this._finished=!0):(this.data=new ArrayBuffer(Re+h+m+o),this.ids=new this.IndexArrayType(this.data,Re,t),this.coords=new this.ArrayType(this.data,Re+m+o,t*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(Be<<4)+l]),new Uint16Array(this.data,2,1)[0]=s,new Uint32Array(this.data,4,1)[0]=t)}add(t,s){const a=this._pos>>1;return this.ids[a]=a,this.coords[this._pos++]=t,this.coords[this._pos++]=s,a}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Ve(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,s,a,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:h,nodeSize:m}=this,o=[0,l.length-1,0],v=[];for(;o.length;){const j=o.pop()||0,x=o.pop()||0,b=o.pop()||0;if(x-b<=m){for(let C=b;C<=x;C++){const M=h[2*C],P=h[2*C+1];M>=t&&M<=a&&P>=s&&P<=c&&v.push(l[C])}continue}const T=b+x>>1,S=h[2*T],N=h[2*T+1];S>=t&&S<=a&&N>=s&&N<=c&&v.push(l[T]),(j===0?t<=S:s<=N)&&(o.push(b),o.push(T-1),o.push(1-j)),(j===0?a>=S:c>=N)&&(o.push(T+1),o.push(x),o.push(1-j))}return v}within(t,s,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:c,coords:l,nodeSize:h}=this,m=[0,c.length-1,0],o=[],v=a*a;for(;m.length;){const j=m.pop()||0,x=m.pop()||0,b=m.pop()||0;if(x-b<=h){for(let C=b;C<=x;C++)nt(l[2*C],l[2*C+1],t,s)<=v&&o.push(c[C]);continue}const T=b+x>>1,S=l[2*T],N=l[2*T+1];nt(S,N,t,s)<=v&&o.push(c[T]),(j===0?t-a<=S:s-a<=N)&&(m.push(b),m.push(T-1),m.push(1-j)),(j===0?t+a>=S:s+a>=N)&&(m.push(T+1),m.push(x),m.push(1-j))}return o}}function Ve(r,t,s,a,c,l){if(c-a<=s)return;const h=a+c>>1;dt(r,t,h,a,c,l),Ve(r,t,s,a,h-1,1-l),Ve(r,t,s,h+1,c,1-l)}function dt(r,t,s,a,c,l){for(;c>a;){if(c-a>600){const v=c-a+1,j=s-a+1,x=Math.log(v),b=.5*Math.exp(2*x/3),T=.5*Math.sqrt(x*b*(v-b)/v)*(j-v/2<0?-1:1),S=Math.max(a,Math.floor(s-j*b/v+T)),N=Math.min(c,Math.floor(s+(v-j)*b/v+T));dt(r,t,s,S,N,l)}const h=t[2*s+l];let m=a,o=c;for(Ae(r,t,a,s),t[2*c+l]>h&&Ae(r,t,a,c);m<o;){for(Ae(r,t,m,o),m++,o--;t[2*m+l]<h;)m++;for(;t[2*o+l]>h;)o--}t[2*a+l]===h?Ae(r,t,a,o):(o++,Ae(r,t,o,c)),o<=s&&(a=o+1),s<=o&&(c=o-1)}}function Ae(r,t,s,a){ze(r,s,a),ze(t,2*s,2*a),ze(t,2*s+1,2*a+1)}function ze(r,t,s){const a=r[t];r[t]=r[s],r[s]=a}function nt(r,t,s,a){const c=r-s,l=t-a;return c*c+l*l}const Lt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:r=>r},ot=Math.fround||(r=>(t=>(r[0]=+t,r[0])))(new Float32Array(1)),ve=2,we=3,Ze=4,be=5,ut=6;class _t{constructor(t){this.options=Object.assign(Object.create(Lt),t),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(t){const{log:s,minZoom:a,maxZoom:c}=this.options;s&&console.time("total time");const l=`prepare ${t.length} points`;s&&console.time(l),this.points=t;const h=[];for(let o=0;o<t.length;o++){const v=t[o];if(!v.geometry)continue;const[j,x]=v.geometry.coordinates,b=ot(Oe(j)),T=ot(Ie(x));h.push(b,T,1/0,o,-1,1),this.options.reduce&&h.push(0)}let m=this.trees[c+1]=this._createTree(h);s&&console.timeEnd(l);for(let o=c;o>=a;o--){const v=+Date.now();m=this.trees[o]=this._createTree(this._cluster(m,o)),s&&console.log("z%d: %d clusters in %dms",o,m.numItems,+Date.now()-v)}return s&&console.timeEnd("total time"),this}getClusters(t,s){let a=((t[0]+180)%360+360)%360-180;const c=Math.max(-90,Math.min(90,t[1]));let l=t[2]===180?180:((t[2]+180)%360+360)%360-180;const h=Math.max(-90,Math.min(90,t[3]));if(t[2]-t[0]>=360)a=-180,l=180;else if(a>l){const x=this.getClusters([a,c,180,h],s),b=this.getClusters([-180,c,l,h],s);return x.concat(b)}const m=this.trees[this._limitZoom(s)],o=m.range(Oe(a),Ie(h),Oe(l),Ie(c)),v=m.data,j=[];for(const x of o){const b=this.stride*x;j.push(v[b+be]>1?lt(v,b,this.clusterProps):this.points[v[b+we]])}return j}getChildren(t){const s=this._getOriginId(t),a=this._getOriginZoom(t),c="No cluster with the specified id.",l=this.trees[a];if(!l)throw new Error(c);const h=l.data;if(s*this.stride>=h.length)throw new Error(c);const m=this.options.radius/(this.options.extent*Math.pow(2,a-1)),o=h[s*this.stride],v=h[s*this.stride+1],j=l.within(o,v,m),x=[];for(const b of j){const T=b*this.stride;h[T+Ze]===t&&x.push(h[T+be]>1?lt(h,T,this.clusterProps):this.points[h[T+we]])}if(x.length===0)throw new Error(c);return x}getLeaves(t,s,a){s=s||10,a=a||0;const c=[];return this._appendLeaves(c,t,s,a,0),c}getTile(t,s,a){const c=this.trees[this._limitZoom(t)],l=Math.pow(2,t),{extent:h,radius:m}=this.options,o=m/h,v=(a-o)/l,j=(a+1+o)/l,x={features:[]};return this._addTileFeatures(c.range((s-o)/l,v,(s+1+o)/l,j),c.data,s,a,l,x),s===0&&this._addTileFeatures(c.range(1-o/l,v,1,j),c.data,l,a,l,x),s===l-1&&this._addTileFeatures(c.range(0,v,o/l,j),c.data,-1,a,l,x),x.features.length?x:null}getClusterExpansionZoom(t){let s=this._getOriginZoom(t)-1;for(;s<=this.options.maxZoom;){const a=this.getChildren(t);if(s++,a.length!==1)break;t=a[0].properties.cluster_id}return s}_appendLeaves(t,s,a,c,l){const h=this.getChildren(s);for(const m of h){const o=m.properties;if(o&&o.cluster?l+o.point_count<=c?l+=o.point_count:l=this._appendLeaves(t,o.cluster_id,a,c,l):l<c?l++:t.push(m),t.length===a)break}return l}_createTree(t){const s=new He(t.length/this.stride|0,this.options.nodeSize,Float32Array);for(let a=0;a<t.length;a+=this.stride)s.add(t[a],t[a+1]);return s.finish(),s.data=t,s}_addTileFeatures(t,s,a,c,l,h){for(const m of t){const o=m*this.stride,v=s[o+be]>1;let j,x,b;if(v)j=ht(s,o,this.clusterProps),x=s[o],b=s[o+1];else{const N=this.points[s[o+we]];j=N.properties;const[C,M]=N.geometry.coordinates;x=Oe(C),b=Ie(M)}const T={type:1,geometry:[[Math.round(this.options.extent*(x*l-a)),Math.round(this.options.extent*(b*l-c))]],tags:j};let S;v||this.options.generateId?S=s[o+we]:S=this.points[s[o+we]].id,S!==void 0&&(T.id=S),h.features.push(T)}}_limitZoom(t){return Math.max(this.options.minZoom,Math.min(Math.floor(+t),this.options.maxZoom+1))}_cluster(t,s){const{radius:a,extent:c,reduce:l,minPoints:h}=this.options,m=a/(c*Math.pow(2,s)),o=t.data,v=[],j=this.stride;for(let x=0;x<o.length;x+=j){if(o[x+ve]<=s)continue;o[x+ve]=s;const b=o[x],T=o[x+1],S=t.within(o[x],o[x+1],m),N=o[x+be];let C=N;for(const M of S){const P=M*j;o[P+ve]>s&&(C+=o[P+be])}if(C>N&&C>=h){let M=b*N,P=T*N,u,w=-1;const L=((x/j|0)<<5)+(s+1)+this.points.length;for(const _ of S){const k=_*j;if(o[k+ve]<=s)continue;o[k+ve]=s;const p=o[k+be];M+=o[k]*p,P+=o[k+1]*p,o[k+Ze]=L,l&&(u||(u=this._map(o,x,!0),w=this.clusterProps.length,this.clusterProps.push(u)),l(u,this._map(o,k)))}o[x+Ze]=L,v.push(M/C,P/C,1/0,L,-1,C),l&&v.push(w)}else{for(let M=0;M<j;M++)v.push(o[x+M]);if(C>1)for(const M of S){const P=M*j;if(!(o[P+ve]<=s)){o[P+ve]=s;for(let u=0;u<j;u++)v.push(o[P+u])}}}}return v}_getOriginId(t){return t-this.points.length>>5}_getOriginZoom(t){return(t-this.points.length)%32}_map(t,s,a){if(t[s+be]>1){const h=this.clusterProps[t[s+ut]];return a?Object.assign({},h):h}const c=this.points[t[s+we]].properties,l=this.options.map(c);return a&&l===c?Object.assign({},l):l}}function lt(r,t,s){return{type:"Feature",id:r[t+we],properties:ht(r,t,s),geometry:{type:"Point",coordinates:[Dt(r[t]),Ot(r[t+1])]}}}function ht(r,t,s){const a=r[t+be],c=a>=1e4?`${Math.round(a/1e3)}k`:a>=1e3?`${Math.round(a/100)/10}k`:a,l=r[t+ut],h=l===-1?{}:Object.assign({},s[l]);return Object.assign(h,{cluster:!0,cluster_id:r[t+we],point_count:a,point_count_abbreviated:c})}function Oe(r){return r/360+.5}function Ie(r){const t=Math.sin(r*Math.PI/180),s=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return s<0?0:s>1?1:s}function Dt(r){return(r-.5)*360}function Ot(r){const t=(180-r*360)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function It(r,t){var s={};for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&t.indexOf(a)<0&&(s[a]=r[a]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var c=0,a=Object.getOwnPropertySymbols(r);c<a.length;c++)t.indexOf(a[c])<0&&Object.prototype.propertyIsEnumerable.call(r,a[c])&&(s[a[c]]=r[a[c]]);return s}class te{static isAdvancedMarkerAvailable(t){return google.maps.marker&&t.getMapCapabilities().isAdvancedMarkersAvailable===!0}static isAdvancedMarker(t){return google.maps.marker&&t instanceof google.maps.marker.AdvancedMarkerElement}static setMap(t,s){this.isAdvancedMarker(t)?t.map=s:t.setMap(s)}static getPosition(t){if(this.isAdvancedMarker(t)){if(t.position){if(t.position instanceof google.maps.LatLng)return t.position;if(t.position.lat&&t.position.lng)return new google.maps.LatLng(t.position.lat,t.position.lng)}return new google.maps.LatLng(null)}return t.getPosition()}static getVisible(t){return this.isAdvancedMarker(t)?!0:t.getVisible()}}class We{constructor({markers:t,position:s}){this.markers=t,s&&(s instanceof google.maps.LatLng?this._position=s:this._position=new google.maps.LatLng(s))}get bounds(){if(this.markers.length===0&&!this._position)return;const t=new google.maps.LatLngBounds(this._position,this._position);for(const s of this.markers)t.extend(te.getPosition(s));return t}get position(){return this._position||this.bounds.getCenter()}get count(){return this.markers.filter(t=>te.getVisible(t)).length}push(t){this.markers.push(t)}delete(){this.marker&&(te.setMap(this.marker,null),this.marker=void 0),this.markers.length=0}}class $t{constructor({maxZoom:t=16}){this.maxZoom=t}noop({markers:t}){return Ut(t)}}const Ut=r=>r.map(s=>new We({position:te.getPosition(s),markers:[s]}));class Gt extends $t{constructor(t){var{maxZoom:s,radius:a=60}=t,c=It(t,["maxZoom","radius"]);super({maxZoom:s}),this.state={zoom:-1},this.superCluster=new _t(Object.assign({maxZoom:this.maxZoom,radius:a},c))}calculate(t){let s=!1;const a={zoom:t.map.getZoom()};if(!tt(t.markers,this.markers)){s=!0,this.markers=[...t.markers];const c=this.markers.map(l=>{const h=te.getPosition(l);return{type:"Feature",geometry:{type:"Point",coordinates:[h.lng(),h.lat()]},properties:{marker:l}}});this.superCluster.load(c)}return s||(this.state.zoom<=this.maxZoom||a.zoom<=this.maxZoom)&&(s=!tt(this.state,a)),this.state=a,s&&(this.clusters=this.cluster(t)),{clusters:this.clusters,changed:s}}cluster({map:t}){return this.superCluster.getClusters([-180,-90,180,90],Math.round(t.getZoom())).map(s=>this.transformCluster(s))}transformCluster({geometry:{coordinates:[t,s]},properties:a}){if(a.cluster)return new We({markers:this.superCluster.getLeaves(a.cluster_id,1/0).map(l=>l.properties.marker),position:{lat:s,lng:t}});const c=a.marker;return new We({markers:[c],position:te.getPosition(c)})}}class Bt{constructor(t,s){this.markers={sum:t.length};const a=s.map(l=>l.count),c=a.reduce((l,h)=>l+h,0);this.clusters={count:s.length,markers:{mean:c/s.length,sum:c,min:Math.min(...a),max:Math.max(...a)}}}}class zt{render({count:t,position:s},a,c){const h=`<svg fill="${t>Math.max(10,a.clusters.markers.mean)?"#ff0000":"#0000ff"}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="50" height="50">
<circle cx="120" cy="120" opacity=".6" r="70" />
<circle cx="120" cy="120" opacity=".3" r="90" />
<circle cx="120" cy="120" opacity=".2" r="110" />
<text x="50%" y="50%" style="fill:#fff" text-anchor="middle" font-size="50" dominant-baseline="middle" font-family="roboto,arial,sans-serif">${t}</text>
</svg>`,m=`Cluster of ${t} markers`,o=Number(google.maps.Marker.MAX_ZINDEX)+t;if(te.isAdvancedMarkerAvailable(c)){const x=new DOMParser().parseFromString(h,"image/svg+xml").documentElement;x.setAttribute("transform","translate(0 25)");const b={map:c,position:s,zIndex:o,title:m,content:x};return new google.maps.marker.AdvancedMarkerElement(b)}const v={position:s,zIndex:o,title:m,icon:{url:`data:image/svg+xml;base64,${btoa(h)}`,anchor:new google.maps.Point(25,25)}};return new google.maps.Marker(v)}}function Zt(r,t){for(let s in t.prototype)r.prototype[s]=t.prototype[s]}class Qe{constructor(){Zt(Qe,google.maps.OverlayView)}}var Te;(function(r){r.CLUSTERING_BEGIN="clusteringbegin",r.CLUSTERING_END="clusteringend",r.CLUSTER_CLICK="click"})(Te||(Te={}));const qt=(r,t,s)=>{s.fitBounds(t.bounds)};class Kt extends Qe{constructor({map:t,markers:s=[],algorithmOptions:a={},algorithm:c=new Gt(a),renderer:l=new zt,onClusterClick:h=qt}){super(),this.markers=[...s],this.clusters=[],this.algorithm=c,this.renderer=l,this.onClusterClick=h,t&&this.setMap(t)}addMarker(t,s){this.markers.includes(t)||(this.markers.push(t),s||this.render())}addMarkers(t,s){t.forEach(a=>{this.addMarker(a,!0)}),s||this.render()}removeMarker(t,s){const a=this.markers.indexOf(t);return a===-1?!1:(te.setMap(t,null),this.markers.splice(a,1),s||this.render(),!0)}removeMarkers(t,s){let a=!1;return t.forEach(c=>{a=this.removeMarker(c,!0)||a}),a&&!s&&this.render(),a}clearMarkers(t){this.markers.length=0,t||this.render()}render(){const t=this.getMap();if(t instanceof google.maps.Map&&t.getProjection()){google.maps.event.trigger(this,Te.CLUSTERING_BEGIN,this);const{clusters:s,changed:a}=this.algorithm.calculate({markers:this.markers,map:t,mapCanvasProjection:this.getProjection()});if(a||a==null){const c=new Set;for(const h of s)h.markers.length==1&&c.add(h.markers[0]);const l=[];for(const h of this.clusters)h.marker!=null&&(h.markers.length==1?c.has(h.marker)||te.setMap(h.marker,null):l.push(h.marker));this.clusters=s,this.renderClusters(),requestAnimationFrame(()=>l.forEach(h=>te.setMap(h,null)))}google.maps.event.trigger(this,Te.CLUSTERING_END,this)}}onAdd(){this.idleListener=this.getMap().addListener("idle",this.render.bind(this)),this.render()}onRemove(){google.maps.event.removeListener(this.idleListener),this.reset()}reset(){this.markers.forEach(t=>te.setMap(t,null)),this.clusters.forEach(t=>t.delete()),this.clusters=[]}renderClusters(){const t=new Bt(this.markers,this.clusters),s=this.getMap();this.clusters.forEach(a=>{a.markers.length===1?a.marker=a.markers[0]:(a.marker=this.renderer.render(a,t,s),a.markers.forEach(c=>te.setMap(c,null)),this.onClusterClick&&a.marker.addListener("click",c=>{google.maps.event.trigger(this,Te.CLUSTER_CLICK,a),this.onClusterClick(c,a,s)})),te.setMap(a.marker,s)})}}const Vt="AIzaSyBPkkXZWll0VifG5kb0DDSsoV5UB-n5pFE",Wt=["drawing","places"],Ht={width:"100%",height:"650px",borderRadius:"16px"},qe={lat:20.5937,lng:78.9629},Qt=5,Yt=(r,t="#10b981")=>{const s=r?r.charAt(0).toUpperCase():"R",a=`
    <svg width="60" height="78" viewBox="0 0 60 78" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="shadow-${s}" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
          <feOffset dx="0" dy="3" result="offsetblur"/>
          <feComponentTransfer>
            <feFuncA type="linear" slope="0.4"/>
          </feComponentTransfer>
          <feMerge>
            <feMergeNode/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <linearGradient id="grad-${s}" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:${t};stop-opacity:1" />
          <stop offset="100%" style="stop-color:${t}dd;stop-opacity:1" />
        </linearGradient>
      </defs>
      <!-- Pin shadow -->
      <ellipse cx="30" cy="72" rx="12" ry="4" fill="#000" opacity="0.25"/>
      <!-- Pin body with gradient -->
      <path d="M30 0 C18.405 0 9 9.405 9 21 C9 33 30 60 30 60 C30 60 51 33 51 21 C51 9.405 41.595 0 30 0 Z" 
            fill="url(#grad-${s})" 
            stroke="#ffffff" 
            stroke-width="3"
            filter="url(#shadow-${s})"/>
      <!-- Initial circle with glow -->
      <circle cx="30" cy="27" r="15" fill="#ffffff" filter="url(#shadow-${s})"/>
      <text x="30" y="33" font-family="Arial, sans-serif" font-size="20" font-weight="bold" 
            text-anchor="middle" fill="${t}">${s}</text>
    </svg>
  `;return{url:`data:image/svg+xml;charset=UTF-8,${encodeURIComponent(a)}`,scaledSize:new window.google.maps.Size(60,78),anchor:new window.google.maps.Point(30,78)}};function Jt({distributorId:r}){const{isLoaded:t,loadError:s}=vt({id:"google-map-script",googleMapsApiKey:Vt,libraries:Wt}),[a,c]=d.useState([]),[l,h]=d.useState([]),[m,o]=d.useState(null),[v,j]=d.useState(null),[x,b]=d.useState(!0),[T,S]=d.useState(!1),[N,C]=d.useState(qe),[M,P]=d.useState(Qt),[u,w]=d.useState(""),[L,_]=d.useState(!1),[k,p]=d.useState([]),[$,Z]=d.useState(!1),[X,Q]=d.useState(""),V=d.useRef(null),R=d.useRef(null),W=d.useRef(null),Y=d.useRef([]),le=d.useRef(null),A=d.useRef(null),ne=d.useRef(null),ce=d.useRef([]);d.useEffect(()=>{if(!r)return;(async()=>{try{const g=q(D,"businesses",r),y=await xe(g);if(y.exists()){const E=y.data();let O=[];E.territories&&Array.isArray(E.territories)?O=E.territories.map(B=>({id:B.id||Date.now().toString(),center:{lat:B.center.lat,lng:B.center.lng},zoom:B.zoom||10,name:B.name||null})):E.territoryCenter&&E.territoryZoom&&(O=[{id:"legacy-"+Date.now(),center:{lat:E.territoryCenter.lat,lng:E.territoryCenter.lng},zoom:E.territoryZoom,name:E.territoryName||null}]),p(O),O.length>0&&(C(O[0].center),P(O[0].zoom))}}catch(g){console.error("Error loading territories:",g)}})()},[r]),d.useEffect(()=>{if(!r){b(!1);return}const n=je(D,"businesses",r,"connectedRetailers"),g=Me(n,Fe("status","in",["accepted","provisioned","provisioned-local"])),y=ct(g,E=>{const O=E.docs.map(B=>{const z=B.data()||{};return{id:z.retailerId||B.id,docId:B.id,businessName:z.retailerName||"Retailer",email:z.retailerEmail||"",phone:z.retailerPhone||"",address:z.retailerAddress||z.address||"",city:z.retailerCity||z.city||"",state:z.retailerState||z.state||"",status:z.status||"provisioned",lat:z.lat||null,lng:z.lng||null,formattedAddress:z.formattedAddress||null}});c(O),b(!1)},E=>{console.error("Error fetching retailers:",E),K.error("Failed to load retailers"),b(!1)});return()=>y()},[r]),d.useEffect(()=>{if(a.length===0){h([]);return}const n=a.filter(y=>y.lat&&y.lng).map(y=>({...y,formattedAddress:y.formattedAddress||pe(y)}));if(h(n),k.length>0){const y=k[0];C(y.center),P(y.zoom)}else n.length>0&&ye(n);const g=a.filter(y=>!y.lat&&!y.lng&&(y.address||y.city||y.state));g.length>0&&V.current&&Pe(g)},[a,k]);const pe=n=>{const g=[];return n.address&&g.push(n.address),n.city&&g.push(n.city),n.state&&g.push(n.state),g.length===0?null:!n.address&&n.city&&n.state?`${n.city}, ${n.state}, India`:g.join(", ")+", India"},se=(n,g)=>new Promise((y,E)=>{g.geocode({address:n,region:"IN"},(O,B)=>{if(B==="OK"&&O&&O[0]){const z=O[0].geometry.location;y({lat:z.lat(),lng:z.lng(),formattedAddress:O[0].formatted_address})}else E(new Error(`Geocoding failed: ${B}`))})}),Pe=async n=>{S(!0);const g=[];for(const y of n)try{const E=pe(y);if(!E)continue;const O=await se(E,V.current);O&&g.push({...y,lat:O.lat,lng:O.lng,formattedAddress:O.formattedAddress})}catch(E){console.error(`Geocoding failed for ${y.businessName}:`,E)}h(y=>{const E=[...y];return g.forEach(O=>{const B=E.findIndex(z=>z.id===O.id);B>=0?E[B]=O:E.push(O)}),E}),S(!1)},ye=n=>{if(n.length===0)return;if(n.length===1){C({lat:n[0].lat,lng:n[0].lng}),P(12);return}const g=n.map(fe=>fe.lat),y=n.map(fe=>fe.lng),E=(Math.min(...g)+Math.max(...g))/2,O=(Math.min(...y)+Math.max(...y))/2;C({lat:E,lng:O});const B=Math.max(...g)-Math.min(...g),z=Math.max(...y)-Math.min(...y),G=Math.max(B,z);let J=5;G<.01?J=12:G<.05?J=10:G<.1?J=8:G<.5&&(J=6),P(J)},re=d.useCallback(()=>{!R.current||!window.google?.maps||(ce.current.forEach(n=>n.setMap(null)),ce.current=[],k.forEach((n,g)=>{const y=new window.google.maps.Marker({position:n.center,map:R.current,icon:{path:window.google.maps.SymbolPath.CIRCLE,fillColor:"#3b82f6",fillOpacity:.8,strokeColor:"#ffffff",strokeWeight:3,scale:15},title:n.name||`Territory ${g+1}`,zIndex:1e3});ce.current.push(y)}))},[k]),H=d.useCallback(n=>{R.current=n,V.current=new window.google.maps.Geocoder,k.length>0&&R.current&&re()},[k,re]);d.useEffect(()=>{R.current&&k.length>0&&re()},[k,re]);const me=d.useCallback(()=>{if(!le.current)return;const n=le.current.getPlace();if(n.geometry&&R.current){const g=n.geometry.location,y={lat:g.lat(),lng:g.lng()};C(y),P(15),A.current?A.current.setPosition(y):(A.current=new window.google.maps.Marker({position:y,map:R.current,draggable:!0,title:"Drag to adjust",icon:{path:window.google.maps.SymbolPath.CIRCLE,fillColor:"#3b82f6",fillOpacity:1,strokeColor:"#ffffff",strokeWeight:3,scale:10}}),A.current.addListener("dragend",()=>{const E=A.current.getPosition();C({lat:E.lat(),lng:E.lng()})})),w(n.formatted_address||"")}},[]),ae=d.useCallback(n=>{if(!L||!v)return;const g={lat:n.latLng.lat(),lng:n.latLng.lng()};A.current?A.current.setPosition(g):R.current&&(A.current=new window.google.maps.Marker({position:g,map:R.current,draggable:!0,icon:{path:window.google.maps.SymbolPath.CIRCLE,fillColor:"#3b82f6",fillOpacity:1,strokeColor:"#ffffff",strokeWeight:3,scale:10}}),A.current.addListener("dragend",()=>{const y=A.current.getPosition();C({lat:y.lat(),lng:y.lng()})})),C(g),V.current&&V.current.geocode({location:g},(y,E)=>{E==="OK"&&y&&y[0]&&w(y[0].formatted_address)})},[L,v]),Ne=async()=>{if(!v||!A.current){K.error("Please select a location first");return}const n=A.current.getPosition();try{const g=q(D,"businesses",r,"connectedRetailers",v.docId),y={lat:n.lat(),lng:n.lng(),formattedAddress:u||v.formattedAddress||null,locationUpdatedAt:ie(),updatedAt:ie()};await oe(g,y),K.success("âœ… Location saved successfully!"),_(!1),j(null),A.current&&(A.current.setMap(null),A.current=null),w("")}catch(g){console.error("Error saving location:",g),K.error("Failed to save. Please check permissions.")}},Se=async()=>{if(!A.current||!r){K.error("Please set your territory location first");return}const n=A.current.getPosition(),g=R.current?.getZoom()||10;try{const y={id:Date.now().toString(),center:{lat:n.lat(),lng:n.lng()},zoom:g,name:X||null},E=[...k,y],O=q(D,"businesses",r);await oe(O,{territories:E.map(B=>({id:B.id,center:B.center,zoom:B.zoom,name:B.name})),territoryUpdatedAt:ie(),territoryCenter:ge(),territoryZoom:ge(),territoryName:ge()}),p(E),re(),K.success(`âœ… Territory "${y.name||"added"}" saved!`),Z(!1),A.current&&(A.current.setMap(null),A.current=null),Q("")}catch(y){console.error("Error saving territory:",y),K.error("Failed to save territory")}},i=async n=>{if(!(!r||!n))try{const g=k.filter(E=>E.id!==n),y=q(D,"businesses",r);g.length===0?await oe(y,{territories:ge(),territoryCenter:ge(),territoryZoom:ge(),territoryName:ge(),territoryUpdatedAt:ge()}):await oe(y,{territories:g.map(E=>({id:E.id,center:E.center,zoom:E.zoom,name:E.name})),territoryUpdatedAt:ie()}),p(g),re(),K.success("âœ… Territory removed")}catch(g){console.error("Error removing territory:",g),K.error("Failed to remove territory")}},f=n=>{j(n),_(!0),n.lat&&n.lng?(C({lat:n.lat,lng:n.lng}),P(15),A.current&&A.current.setMap(null),R.current&&(A.current=new window.google.maps.Marker({position:{lat:n.lat,lng:n.lng},map:R.current,draggable:!0,icon:{path:window.google.maps.SymbolPath.CIRCLE,fillColor:"#3b82f6",fillOpacity:1,strokeColor:"#ffffff",strokeWeight:3,scale:10}}),A.current.addListener("dragend",()=>{const g=A.current.getPosition();C({lat:g.lat(),lng:g.lng()})})),w(n.formattedAddress||"")):(C(k.length>0?k[0].center:qe),P(k.length>0?k[0].zoom:10))},F=()=>{if(Z(!0),k.length>0){const n=k[0];C(n.center),P(n.zoom),Q(n.name||""),R.current&&n.center&&(A.current&&A.current.setMap(null),A.current=new window.google.maps.Marker({position:n.center,map:R.current,draggable:!0,icon:{path:window.google.maps.SymbolPath.CIRCLE,fillColor:"#3b82f6",fillOpacity:1,strokeColor:"#ffffff",strokeWeight:4,scale:15}}),A.current.addListener("dragend",()=>{const g=A.current.getPosition();C({lat:g.lat(),lng:g.lng()})}))}else C(qe),P(5),Q("")};d.useEffect(()=>{if(!R.current||!window.google?.maps||l.length===0||L||$)return;W.current&&(W.current.clearMarkers(),W.current=null),Y.current.forEach(g=>g.setMap(null)),Y.current=[];const n=l.map((g,y)=>{const E=["#10b981","#3b82f6","#8b5cf6","#f59e0b","#ef4444"],O=E[y%E.length],B=Yt(g.businessName,O),z=new window.google.maps.Marker({position:{lat:g.lat,lng:g.lng},map:R.current,title:g.businessName,icon:B});return z.addListener("click",()=>{o(g)}),z});return Y.current=n,W.current=new Kt({map:R.current,markers:n}),()=>{W.current&&(W.current.clearMarkers(),W.current=null),Y.current.forEach(g=>g.setMap(null)),Y.current=[]}},[l,L,$]);const U=d.useMemo(()=>a.filter(n=>!n.lat||!n.lng),[a]);return x?e.jsx("div",{className:"flex items-center justify-center h-[600px] text-white/70",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-emerald-500/30 border-t-emerald-500 mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:"Loading territory view..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-1",children:"Territory Management"}),e.jsx("p",{className:"text-sm text-white/60",children:"Visualize and manage your retailer network on the map"})]}),e.jsx("button",{onClick:F,className:"px-5 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-400 hover:to-cyan-400 text-white font-semibold text-sm shadow-lg shadow-blue-500/25 transition-all duration-200 transform hover:scale-105",children:k.length>0?`ğŸ“ Manage Territories (${k.length})`:"ğŸ“ Set Territory"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(ee.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-white/10 bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-xl p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm text-white/60 font-medium",children:"Total Retailers"}),e.jsx("div",{className:"text-2xl",children:"ğŸª"})]}),e.jsx("div",{className:"text-3xl font-bold text-white",children:a.length})]}),e.jsxs(ee.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"rounded-2xl border border-emerald-500/20 bg-gradient-to-br from-emerald-500/10 to-emerald-600/5 backdrop-blur-xl p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm text-emerald-200/80 font-medium",children:"With Location"}),e.jsx("div",{className:"text-2xl",children:"âœ…"})]}),e.jsx("div",{className:"text-3xl font-bold text-emerald-400",children:l.length})]}),e.jsxs(ee.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"rounded-2xl border border-amber-500/20 bg-gradient-to-br from-amber-500/10 to-amber-600/5 backdrop-blur-xl p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm text-amber-200/80 font-medium",children:"Need Location"}),e.jsx("div",{className:"text-2xl",children:"âš ï¸"})]}),e.jsx("div",{className:"text-3xl font-bold text-amber-400",children:U.length})]}),e.jsxs(ee.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"rounded-2xl border border-cyan-500/20 bg-gradient-to-br from-cyan-500/10 to-cyan-600/5 backdrop-blur-xl p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm text-cyan-200/80 font-medium",children:"Territory"}),e.jsx("div",{className:"text-2xl",children:k.length>0?"ğŸ“":"âŒ"})]}),e.jsx("div",{className:"text-lg font-bold text-cyan-400",children:k.length>0?`${k.length} Set`:"Not Set"})]})]}),k.length>0&&e.jsx(ee.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-3",children:k.map((n,g)=>e.jsx(ee.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:g*.1},className:"rounded-2xl border border-blue-500/30 bg-gradient-to-r from-blue-500/10 to-cyan-500/10 backdrop-blur-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-2xl",children:"ğŸ“"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"text-sm font-semibold text-blue-200 truncate",children:["Territory ",g+1,": ",n.name||"Unnamed territory"]}),e.jsxs("div",{className:"text-xs text-blue-200/70",children:[n.center.lat.toFixed(4),", ",n.center.lng.toFixed(4)]})]})]}),e.jsx("button",{onClick:()=>i(n.id),className:"ml-3 px-4 py-2 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-200 text-sm font-medium transition flex-shrink-0",children:"Remove"})]})},n.id))}),e.jsxs(ee.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"rounded-2xl border border-white/10 bg-gradient-to-br from-slate-900/50 to-slate-800/50 backdrop-blur-xl p-5 shadow-2xl",children:[L&&v&&t&&e.jsxs(ee.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"mb-4 p-5 rounded-xl bg-gradient-to-r from-blue-500/10 to-cyan-500/10 border border-blue-500/30 backdrop-blur-xl",children:[e.jsxs("div",{className:"text-sm font-semibold text-blue-200 mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ğŸ“"}),"Set Location: ",v.businessName]}),e.jsx(et,{onLoad:n=>{le.current=n},onPlaceChanged:me,options:{componentRestrictions:{country:"in"},types:["address"]},children:e.jsx("input",{type:"text",placeholder:"ğŸ” Search address or click on map...",value:u,onChange:n=>w(n.target.value),className:"w-full rounded-xl bg-white/10 border-2 border-blue-500/30 text-white placeholder-white/50 px-5 py-3 focus:outline-none focus:border-blue-400 focus:ring-4 focus:ring-blue-400/20 transition"})}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-blue-200/70 flex items-center gap-2",children:[e.jsx("span",{children:"ğŸ’¡"}),e.jsx("span",{children:"Click map or search, then drag marker to adjust"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{_(!1),j(null),A.current&&(A.current.setMap(null),A.current=null)},className:"px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 text-white text-sm font-medium transition",children:"Cancel"}),e.jsx("button",{onClick:Ne,disabled:!A.current,className:"px-5 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-white text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25 transition transform hover:scale-105",children:"âœ… Save Location"})]})]})]}),s&&e.jsx("div",{className:"flex items-center justify-center h-[650px] text-red-400 rounded-xl bg-red-500/10 border border-red-500/30",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx("div",{className:"text-4xl mb-3",children:"âš ï¸"}),e.jsx("p",{className:"text-lg font-semibold mb-2",children:"Failed to load Google Maps"}),e.jsx("p",{className:"text-sm text-red-300",children:s.message})]})}),!t&&!s&&e.jsx("div",{className:"flex items-center justify-center h-[650px] text-white/70 rounded-xl bg-white/5",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-emerald-500/30 border-t-emerald-500 mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:"Loading map..."})]})}),t&&e.jsx(jt,{mapContainerStyle:Ht,center:N,zoom:M,onLoad:H,onClick:ae,options:{styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}],zoomControl:!0,streetViewControl:!1,mapTypeControl:!0,fullscreenControl:!0},children:m&&!L&&e.jsx(Nt,{position:{lat:m.lat,lng:m.lng},onCloseClick:()=>o(null),options:{pixelOffset:new window.google.maps.Size(0,-10)},children:e.jsxs("div",{className:"p-4 min-w-[260px] max-w-[320px]",children:[e.jsx("h3",{className:"font-bold text-lg text-slate-900 mb-3 pr-6",children:m.businessName}),m.formattedAddress&&e.jsx("div",{className:"mb-3 pb-3 border-b border-gray-200",children:e.jsx("p",{className:"text-sm text-gray-700 leading-relaxed",children:m.formattedAddress})}),e.jsxs("div",{className:"space-y-2 mb-4",children:[m.email&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx("span",{className:"text-base",children:"ğŸ“§"}),e.jsx("span",{className:"truncate",children:m.email})]}),m.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx("span",{className:"text-base",children:"ğŸ“"}),e.jsx("span",{children:m.phone})]})]}),e.jsx("button",{onClick:()=>{o(null),f(m)},className:"w-full px-4 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg text-sm font-semibold hover:from-blue-400 hover:to-cyan-400 transition-all shadow-md hover:shadow-lg transform hover:scale-[1.02]",children:"ğŸ“ Update Location"})]})})})]}),U.length>0&&!L&&e.jsxs(ee.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"rounded-2xl border border-amber-500/30 bg-gradient-to-br from-amber-500/10 to-orange-500/5 backdrop-blur-xl p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center",children:e.jsx("span",{className:"text-xl",children:"âš ï¸"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-semibold text-amber-200",children:["Retailers Needing Location (",U.length,")"]}),e.jsx("div",{className:"text-xs text-amber-200/70",children:"Set locations to visualize them on the map"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:U.map(n=>e.jsxs(ee.div,{whileHover:{scale:1.02},className:"flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/10 hover:border-amber-500/50 hover:bg-white/10 transition-all",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-white font-semibold truncate",children:n.businessName}),e.jsx("div",{className:"text-xs text-white/60 truncate mt-1",children:n.city&&n.state?`${n.city}, ${n.state}`:"No address"})]}),e.jsx("button",{onClick:()=>f(n),className:"ml-3 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-400 hover:to-cyan-400 text-white text-xs font-semibold shadow-lg shadow-blue-500/25 transition transform hover:scale-105 whitespace-nowrap",children:"Set Location"})]},n.id))})]}),e.jsx(Ct,{children:$&&e.jsx(ee.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-md",onClick:()=>{Z(!1),A.current&&(A.current.setMap(null),A.current=null)},children:e.jsxs(ee.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},onClick:n=>n.stopPropagation(),className:"bg-gradient-to-br from-slate-900/95 to-slate-800/95 rounded-3xl border border-white/20 p-8 max-w-3xl w-[95%] max-h-[90vh] overflow-y-auto shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-2xl font-bold text-white mb-1",children:["ğŸ“ Manage Territories (",k.length,")"]}),e.jsx("p",{className:"text-sm text-white/60",children:"Add multiple territories for your business operation areas. Map will zoom to your territories automatically."})]}),e.jsx("button",{onClick:()=>{Z(!1),A.current&&(A.current.setMap(null),A.current=null)},className:"text-white/70 hover:text-white text-2xl w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/10 transition",children:"âœ•"})]}),t&&e.jsxs("div",{className:"mb-6",children:[e.jsx(et,{onLoad:n=>{ne.current=n},onPlaceChanged:()=>{if(ne.current&&R.current){const n=ne.current.getPlace();if(n.geometry){const g=n.geometry.location,y={lat:g.lat(),lng:g.lng()};C(y),P(12),Q(n.formatted_address||n.name||""),A.current?A.current.setPosition(y):R.current&&(A.current=new window.google.maps.Marker({position:y,map:R.current,draggable:!0,icon:{path:window.google.maps.SymbolPath.CIRCLE,fillColor:"#3b82f6",fillOpacity:1,strokeColor:"#ffffff",strokeWeight:4,scale:15}}),A.current.addListener("dragend",()=>{const E=A.current.getPosition();C({lat:E.lat(),lng:E.lng()})}))}}},options:{componentRestrictions:{country:"in"},types:["(cities)"]},children:e.jsx("input",{type:"text",placeholder:"ğŸ” Search your city or area...",value:X,onChange:n=>Q(n.target.value),className:"w-full rounded-xl bg-white/10 border-2 border-blue-500/30 text-white placeholder-white/50 px-5 py-3 focus:outline-none focus:border-blue-400 focus:ring-4 focus:ring-blue-400/20 transition"})}),e.jsxs("div",{className:"text-xs text-white/60 mt-2 flex items-center gap-2",children:[e.jsx("span",{children:"ğŸ’¡"}),e.jsx("span",{children:"Search for your area or click on the map below, then drag the blue marker to adjust"})]})]}),k.length>0&&e.jsxs("div",{className:"mb-6 rounded-xl border border-white/10 bg-white/5 p-4",children:[e.jsxs("div",{className:"text-sm font-semibold text-white mb-3",children:["Current Territories (",k.length,"):"]}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:k.map((n,g)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/10 hover:bg-white/10 transition",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"text-sm font-medium text-white truncate",children:[g+1,". ",n.name||`Territory ${g+1}`]}),e.jsxs("div",{className:"text-xs text-white/60",children:[n.center.lat.toFixed(4),", ",n.center.lng.toFixed(4)]})]}),e.jsx("button",{onClick:()=>{window.confirm(`Remove territory "${n.name||`Territory ${g+1}`}"?`)&&i(n.id)},className:"ml-3 px-3 py-1.5 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-200 text-xs font-medium transition flex-shrink-0",children:"Remove"})]},n.id))})]}),e.jsx("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-2xl",children:"ğŸ’¡"}),e.jsxs("div",{className:"text-sm text-blue-200/90",children:[e.jsx("div",{className:"font-semibold mb-2",children:"How Multiple Territories Work:"}),e.jsxs("ul",{className:"space-y-1 text-xs",children:[e.jsx("li",{children:"â€¢ Add multiple cities/areas as territories"}),e.jsx("li",{children:"â€¢ Map automatically zooms to your first territory when opened"}),e.jsx("li",{children:"â€¢ All territories are shown with blue markers on the map"}),e.jsx("li",{children:"â€¢ You can add, update, or remove territories at any time"})]})]})]})}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{Z(!1),A.current&&(A.current.setMap(null),A.current=null)},className:"px-5 py-2.5 rounded-xl bg-white/10 hover:bg-white/15 text-white text-sm font-medium transition",children:"Done"}),e.jsx("button",{onClick:Se,disabled:!A.current,className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25 transition transform hover:scale-105",children:"âœ… Add Territory"})]})]})})})]})}function Xt(r="retailer-requests"){const t=xt(),s=pt();return[d.useMemo(()=>{const h=new URLSearchParams(t.search).get("tab");return["retailer-requests","manage-retailers","territory-view"].includes(h)?h:r},[t.search,r]),l=>{const h=new URLSearchParams(t.search);h.set("tab",l),s({search:h.toString()},{replace:!0})}]}function hs(){const[r,t]=Xt("retailer-requests"),[s,a]=d.useState(!1),{user:c,initialized:l}=Je?Je():{user:null,initialized:!0},h=c?.uid||ke?.currentUser?.uid||null,m=d.useRef(0),o=j=>{m.current=window.scrollY||0,t(j)};d.useLayoutEffect(()=>{window.scrollTo({top:m.current,left:0,behavior:"auto"})},[r]);const v=d.useCallback(j=>{(navigator.platform.toUpperCase().includes("MAC")?j.metaKey:j.ctrlKey)&&(j.key==="n"||j.key==="N")&&(j.preventDefault(),a(!0))},[]);return d.useEffect(()=>(window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)),[v]),d.useEffect(()=>{const j=document.body.style.overflow;return s?document.body.style.overflow="hidden":document.body.style.overflow=j||"",()=>{document.body.style.overflow=j||""}},[s]),e.jsxs("div",{className:"p-4 md:p-6 lg:p-8 mx-auto max-w-7xl",children:[e.jsx("style",{children:`
        .no-scrollbar::-webkit-scrollbar{display:none}
        .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
      `}),e.jsx("header",{className:"mb-4 md:mb-6 bg-[#0B0F14]/60 backdrop-blur rounded-xl border border-white/10",children:e.jsxs("div",{className:"px-3 py-3 md:px-4 md:py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-semibold text-white",children:"Retailers"}),e.jsx("p",{className:"mt-0.5 text-xs md:text-sm text-gray-300 truncate",children:"Review incoming requests and manage connected retailers."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",role:"tablist","aria-label":"Retailer panel tabs",children:[e.jsx("button",{id:"tab-retailer-requests",role:"tab","aria-selected":r==="retailer-requests","aria-controls":"tab-panel-requests",onClick:()=>o("retailer-requests"),className:`px-3 md:px-4 py-2 text-sm rounded-lg border transition ${r==="retailer-requests"?"bg-emerald-500 text-black border-emerald-400":"bg-white/5 text-white border-white/10 hover:bg-white/10"}`,children:"Retailer Requests"}),e.jsx("button",{id:"tab-manage-retailers",role:"tab","aria-selected":r==="manage-retailers","aria-controls":"tab-panel-manage",onClick:()=>o("manage-retailers"),className:`px-3 md:px-4 py-2 text-sm rounded-lg border transition ${r==="manage-retailers"?"bg-emerald-500 text-black border-emerald-400":"bg-white/5 text-white border-white/10 hover:bg-white/10"}`,children:"Manage Retailers"}),e.jsx("button",{id:"tab-territory-view",role:"tab","aria-selected":r==="territory-view","aria-controls":"tab-panel-territory",onClick:()=>o("territory-view"),className:`px-3 md:px-4 py-2 text-sm rounded-lg border transition ${r==="territory-view"?"bg-emerald-500 text-black border-emerald-400":"bg-white/5 text-white border-white/10 hover:bg-white/10"}`,children:"Territory View"})]})]})}),r==="retailer-requests"?e.jsx("section",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 md:p-6",role:"tabpanel",id:"tab-panel-requests",children:e.jsx(kt,{distributorId:h})}):null,r==="manage-retailers"?e.jsx("section",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 md:p-6",role:"tabpanel",id:"tab-panel-manage",children:e.jsx(Pt,{distributorId:h})}):null,r==="territory-view"?e.jsx("section",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 md:p-6",role:"tabpanel",id:"tab-panel-territory",children:e.jsx(Jt,{distributorId:h})}):null,e.jsx("button",{onClick:()=>a(!0),className:"fixed bottom-[calc(1rem+env(safe-area-inset-bottom))] right-4 md:right-6 h-12 w-12 md:h-14 md:w-14 rounded-full shadow-xl bg-emerald-500 text-black hover:bg-emerald-400 ring-1 ring-emerald-400/40 transition focus:outline-none focus:ring-2 focus:ring-emerald-300","aria-label":"Add retailer (Cmd/Ctrl + N)",title:"Add retailer (Cmd/Ctrl + N)","aria-haspopup":"dialog",style:{zIndex:60},children:e.jsx("span",{className:"text-xl md:text-2xl leading-none",children:"ï¼‹"})}),e.jsx(yt,{open:s,onClose:()=>a(!1),distributorId:h,useCloudFunction:!0,uiVariant:"centered",autofocus:!0,onCreated:()=>{a(!1),o("manage-retailers")}})]})}export{hs as default};
