import{c as E,q as W,w as _,T as F,o as N,g as P,d as B,e as Y}from"./firebase-DWi1MSv1.js";import{d as S}from"./index-DRC3F7i0.js";import{d as v}from"./dayjs.min-BE7Gq_ss.js";import{g as b}from"./vendor-Ckhrjn13.js";var k={exports:{}},L=k.exports,T;function V(){return T||(T=1,(function(t,s){(function(a,n){t.exports=n()})(L,(function(){return function(a,n){n.prototype.isSameOrBefore=function(e,i){return this.isSame(e,i)||this.isBefore(e,i)}}}))})(k)),k.exports}var j=V();const H=b(j);var O={exports:{}},Q=O.exports,I;function G(){return I||(I=1,(function(t,s){(function(a,n){t.exports=n()})(Q,(function(){return function(a,n){n.prototype.isSameOrAfter=function(e,i){return this.isSame(e,i)||this.isAfter(e,i)}}}))})(O)),O.exports}var K=G();const z=b(K);var x={exports:{}},J=x.exports,R;function X(){return R||(R=1,(function(t,s){(function(a,n){t.exports=n()})(J,(function(){return function(a,n){n.prototype.weekday=function(e){var i=this.$locale().weekStart||0,r=this.$W,o=(r<i?r+7:r)-i;return this.$utils().u(e)?o:this.subtract(o,"day").add(e,"day")}}}))})(x)),x.exports}var Z=X();const U=b(Z);v.extend(H);v.extend(z);v.extend(U);const ee=async(t,s,a,n="retailer")=>{try{const e=await te(t,s,n),i=e?e.length:0;if(!e||e.length===0)return C(a,i);const r=e.length,o=r>=7?7:r>=3?r:Math.max(1,r),c=ne(e,o),h=ae(e,o),m=re(e),f=se(e),y=ie({movingAverage:c,weightedAverage:h,trendAnalysis:m,seasonalFactor:f}),u=oe(e,y),p=r<7?Math.max(40,u-(7-r)*5):u,d=Number(a.quantity||0),M=y.dailyDemand,g=M>0?Math.floor(d/M):1/0,A=ce(y,d,e),q=le(g,p,d,y);return{dailyDemand:Math.round(y.dailyDemand*10)/10,weeklyDemand:Math.round(y.weeklyDemand),monthlyDemand:Math.round(y.monthlyDemand),currentStock:d,daysUntilStockout:g===1/0?null:g,reorderPoint:A.quantity,reorderDate:A.date,confidence:Math.round(p),riskLevel:q,riskMessage:ue(q,g),trend:m.direction,trendPercentage:m.percentage,insights:me(y,e,d,g),last7DaysSales:e.slice(-7).reduce((l,D)=>l+D.quantity,0),last30DaysSales:e.reduce((l,D)=>l+D.quantity,0),avgDailySales:e.length>0?Math.round(e.reduce((l,D)=>l+D.quantity,0)/e.length*10)/10:0,recommendedOrderQuantity:de(y,d,A),urgency:g<7?"urgent":g<14?"high":g<30?"medium":"low",dataProgress:{daysOfData:r,daysNeeded:Math.max(0,7-r),minDaysRequired:7,progressPercent:Math.min(100,r/7*100),isReady:r>=7}}}catch(e){return console.error("Error calculating forecast:",e),C(a,0)}},te=async(t,s,a)=>{try{const n=[],i=v().subtract(90,"days");if(a==="retailer"){const o=E(S,`businesses/${t}/finalizedInvoices`),c=W(o,_("createdAt",">=",F.fromDate(i.toDate())),N("createdAt","desc"));(await P(c)).forEach(m=>{const f=m.data();(f.cart||f.cartItems||[]).forEach(u=>{if(u.id===s||u.inventoryId===s||u.sku===s){const p=f.createdAt?.toDate?f.createdAt.toDate():new Date(f.createdAt);n.push({date:v(p),quantity:Number(u.quantity||0),revenue:Number(u.price||0)*Number(u.quantity||0)})}})})}else if(a==="distributor"){const o=E(S,`businesses/${t}/orderRequests`),c=await P(o),h=["DELIVERED","Delivered","delivered","SHIPPED","Shipped","shipped","OUT_FOR_DELIVERY","Out for Delivery","out for delivery","ACCEPTED","Accepted","accepted","INVOICED","Invoiced","invoiced"],m=B(S,`businesses/${t}/products`,s),f=await Y(m),u=(f.exists()?f.data():null)?.sku;c.forEach(p=>{const d=p.data(),M=d.statusCode||d.status||"",g=String(M).toUpperCase();if(!h.some(l=>g===l.toUpperCase()||g.includes("DELIVERED")||g.includes("SHIPPED")||g.includes("ACCEPTED")))return;(d.items||[]).forEach(l=>{const D=l.sku||l.SKU,$=l.distributorProductId||l.productId;if(!(D&&u&&D===u||$&&$===s||D&&D===s))return;let w=null;if(d.statusTimestamps?.acceptedAt)w=d.statusTimestamps.acceptedAt.toDate?d.statusTimestamps.acceptedAt.toDate():new Date(d.statusTimestamps.acceptedAt);else if(d.statusTimestamps?.deliveredAt)w=d.statusTimestamps.deliveredAt.toDate?d.statusTimestamps.deliveredAt.toDate():new Date(d.statusTimestamps.deliveredAt);else if(d.statusTimestamps?.shippedAt)w=d.statusTimestamps.shippedAt.toDate?d.statusTimestamps.shippedAt.toDate():new Date(d.statusTimestamps.shippedAt);else if(d.timestamp)w=d.timestamp.toDate?d.timestamp.toDate():new Date(d.timestamp);else if(d.createdAt)w=d.createdAt.toDate?d.createdAt.toDate():new Date(d.createdAt);else return;v(w).isBefore(i)||n.push({date:v(w),quantity:Number(l.quantity||l.qty||0),revenue:Number(l.price||l.sellingPrice||l.unitPrice||0)*Number(l.quantity||l.qty||0),retailerId:d.retailerId,orderId:p.id})})})}const r={};return n.forEach(o=>{const c=o.date.format("YYYY-MM-DD");r[c]||(r[c]={date:o.date,quantity:0,revenue:0}),r[c].quantity+=o.quantity,r[c].revenue+=o.revenue}),Object.values(r).sort((o,c)=>o.date.valueOf()-c.date.valueOf()).map(o=>({date:o.date,quantity:o.quantity,revenue:o.revenue}))}catch(n){return console.error("Error fetching historical sales:",n),[]}},ne=(t,s=7)=>{const a=t.length,n=Math.min(s,Math.max(1,a));if(a===0)return{dailyDemand:0,weeklyDemand:0,monthlyDemand:0};const r=t.slice(-n).reduce((o,c)=>o+c.quantity,0)/n;return{dailyDemand:r,weeklyDemand:r*7,monthlyDemand:r*30}},ae=(t,s=7)=>{const a=t.length,n=Math.min(s,Math.max(1,a));if(a===0)return{dailyDemand:0,weeklyDemand:0,monthlyDemand:0};const e=t.slice(-n);let i=0,r=0;e.forEach((c,h)=>{const m=h+1;i+=c.quantity*m,r+=m});const o=i/r;return{dailyDemand:o,weeklyDemand:o*7,monthlyDemand:o*30}},re=t=>{if(t.length<14)return{direction:"stable",percentage:0};const s=t.slice(0,Math.floor(t.length/2)),a=t.slice(Math.floor(t.length/2)),n=s.reduce((o,c)=>o+c.quantity,0)/s.length,e=a.reduce((o,c)=>o+c.quantity,0)/a.length,i=n>0?(e-n)/n*100:0;let r="stable";return i>10?r="increasing":i<-10&&(r="decreasing"),{direction:r,percentage:Math.round(i*10)/10}},se=t=>{if(t.length<14)return{dailyDemand:0,weeklyDemand:0,monthlyDemand:0};const s={0:[],1:[],2:[],3:[],4:[],5:[],6:[]};t.forEach(e=>{const i=e.date.day();s[i].push(e.quantity)});const a={};Object.keys(s).forEach(e=>{const i=s[e];i.length>0&&(a[e]=i.reduce((r,o)=>r+o,0)/i.length)});const n=Object.values(a).reduce((e,i)=>e+(i||0),0)/7;return{dailyDemand:n,weeklyDemand:n*7,monthlyDemand:n*30}},ie=t=>{const s=t.weightedAverage.dailyDemand*.4+t.movingAverage.dailyDemand*.3+t.seasonalFactor.dailyDemand*.2+(t.trendAnalysis.direction==="increasing"?t.movingAverage.dailyDemand*1.1:t.trendAnalysis.direction==="decreasing"?t.movingAverage.dailyDemand*.9:t.movingAverage.dailyDemand)*.1;return{dailyDemand:Math.max(0,s),weeklyDemand:s*7,monthlyDemand:s*30}},oe=(t,s)=>{if(t.length===0)return 0;if(t.length<7)return Math.max(40,Math.round(40+t.length/7*20));if(t.length<30)return 70;if(t.length<60)return 85;const a=t.map(c=>c.quantity),n=a.reduce((c,h)=>c+h,0)/a.length,e=a.reduce((c,h)=>c+Math.pow(h-n,2),0)/a.length,i=Math.sqrt(e),r=n>0?i/n:1,o=Math.max(0,100-r*100);return Math.min(95,Math.max(50,o))},ce=(t,s,a)=>{const n=t.dailyDemand*7,i=t.dailyDemand*5,r=Math.ceil(n+i),o=s>0?Math.max(0,Math.floor((s-r)/t.dailyDemand)):0,c=v().add(o,"days");return{quantity:r,date:c,daysUntilReorder:o}},de=(t,s,a)=>{const n=t.monthlyDemand+t.dailyDemand*7,e=Math.max(0,Math.ceil(n-s));return e<=10?e:e<=25?Math.ceil(e/5)*5:e<=100?Math.ceil(e/10)*10:Math.ceil(e/25)*25},le=(t,s,a,n)=>a===0?"critical":t===null||t===1/0?"low":t<3?"critical":t<7?"high":t<14?"medium":(t<30,"low"),ue=(t,s)=>t==="critical"?s===null?"Out of stock! Order immediately.":`Will finish in ${s} days! Order now.`:t==="high"?`Will finish in ${s} days. Order soon.`:t==="medium"?`Will finish in ${s} days. Plan to order.`:`Stock will last ${s} days. You're good!`,me=(t,s,a,n)=>{const e=[];if(n!==null&&n<7&&e.push({type:"warning",icon:"âš ï¸",message:`This will finish in ${n} days. Order now to avoid running out!`,action:"order_now"}),s.length>=14){const i=s.slice(-7).reduce((o,c)=>o+c.quantity,0)/7,r=s.slice(-14,-7).reduce((o,c)=>o+c.quantity,0)/7;i>r*1.2?e.push({type:"trend",icon:"ðŸ“ˆ",message:`Great! You're selling ${Math.round((i-r)/r*100)}% more this week. Customers like this product!`,action:"increase_stock"}):i<r*.8&&r>0&&e.push({type:"trend",icon:"ðŸ“‰",message:`Sales down ${Math.round((r-i)/r*100)}% this week. Maybe order less next time.`,action:"reduce_stock"})}return n!==null&&n>60&&e.push({type:"info",icon:"ðŸ“¦",message:`You have a lot of stock (${n} days). Maybe order less next time.`,action:"review_stock"}),e},C=(t,s=0)=>{const a=Number(t.quantity||0),n=s,e=7,i=Math.max(0,e-n),r=Math.min(100,n/e*100);let o=null,c="low",h="Stock is good!",m=0,f=0,y=0,u=20,p="low";return a===0?(c="critical",h="Out of stock! Order immediately.",p="urgent",u=100):a<=5?(m=.5,f=3,y=15,o=Math.floor(a/m),c=o<7?"critical":"high",h=`Low stock (${a} units). Order soon to avoid stockout.`,p="high",u=40):a<=10?(m=.3,f=2,y=9,o=Math.floor(a/m),c=o<14?"high":"medium",h=`Stock is getting low (${a} units). Plan to reorder.`,p="medium",u=30):(o=null,h=`You have ${a} units in stock. Once we see sales data, we'll predict when you'll need more!`,u=20),{dailyDemand:Math.round(m*10)/10,weeklyDemand:Math.round(f),monthlyDemand:Math.round(y),currentStock:a,daysUntilStockout:o,reorderPoint:{quantity:Math.max(10,Math.ceil(f*2)),date:v().add(7,"days")},confidence:u,riskLevel:c,riskMessage:h,trend:"stable",trendPercentage:0,insights:he(a,n,i),last7DaysSales:0,last30DaysSales:0,avgDailySales:m,recommendedOrderQuantity:a<=10?Math.max(20,a*2):0,urgency:p,dataProgress:{daysOfData:n,daysNeeded:i,minDaysRequired:e,progressPercent:r,isReady:n>=e}}},he=(t,s,a,n)=>{const e=[];return t===0?e.push({type:"critical",icon:"ðŸš¨",message:"This product is out of stock! Order immediately to fulfill retailer orders.",action:"order_now"}):t<=5?e.push({type:"warning",icon:"âš ï¸",message:`Very low stock (${t} units). Order now to avoid stockout and lost sales.`,action:"order_urgent"}):t<=10?e.push({type:"info",icon:"ðŸ“¦",message:`Stock is getting low (${t} units). Consider ordering soon.`,action:"order_soon"}):e.push({type:"success",icon:"âœ…",message:`Good stock level (${t} units). We're tracking sales to predict when you'll need more.`,action:"monitor"}),s===0?e.push({type:"info",icon:"ðŸ“Š",message:"Once retailers start ordering this product, we'll show accurate demand predictions and reorder suggestions!",action:"wait_for_data"}):a>0?e.push({type:"info",icon:"ðŸ“ˆ",message:`We have ${s} day${s>1?"s":""} of sales data. With ${a} more day${a>1?"s":""}, predictions will be more accurate!`,action:"collecting_data"}):e.push({type:"success",icon:"ðŸŽ¯",message:"We have enough sales data for accurate predictions!",action:"ready"}),e},ve=async(t,s,a="retailer")=>{const n=await Promise.all(s.map(async i=>{const r=await ee(t,i.id,i,a);return{productId:i.id,productName:i.name||i.productName,sku:i.sku,...r}})),e={critical:0,high:1,medium:2,low:3};return n.sort((i,r)=>{const o=e[i.riskLevel]??3,c=e[r.riskLevel]??3;return o-c}),n};export{z as a,ve as b,H as i,U as w};
