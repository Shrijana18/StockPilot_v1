import{d as l}from"./index-DRC3F7i0.js";import{c as h,q as O,o as w,p as S,e as m,d as p,g as k,m as b,s as d,l as A,u as P,a as M}from"./firebase-DWi1MSv1.js";const q=async s=>{try{const r=await m(p(l,"stores",s));return r.exists()?{id:r.id,...r.data()}:null}catch(r){throw console.error("Error getting marketplace store:",r),r}},N=async(s,r)=>{try{const e=p(l,"stores",s),t=await m(e),c={...r,retailerId:s,updatedAt:d()};return t.exists()||(c.createdAt=d(),c.isActive=!0,c.rating=0,c.totalOrders=0,c.totalReviews=0),await A(e,c,{merge:!0}),{success:!0}}catch(e){return console.error("Error saving marketplace store:",e),{success:!1,error:e.message}}},x=async(s,r)=>{try{return await P(p(l,"stores",s),{isActive:r,updatedAt:d()}),{success:!0}}catch(e){return console.error("Error toggling store status:",e),{success:!1,error:e.message}}},L=async s=>{try{const r=h(l,"businesses",s,"products");return(await k(r)).docs.map(t=>({id:t.id,...t.data()}))}catch(r){throw console.error("Error getting retailer products:",r),r}},D=async s=>{try{const r=h(l,"stores",s,"products");return(await k(r)).docs.map(t=>({id:t.id,...t.data()}))}catch(r){throw console.error("Error getting marketplace products:",r),r}},$=async(s,r,e={})=>{try{const t=p(l,"stores",s,"products",r.id),c=e.mrp??r.mrp??r.price??0,n=r.sellingPrice??r.price??0,i=e.offerPrice,o=e.discountPercent;let f=e.sellingPrice??n,u=e.offerLabel;if(i!=null&&i>0){f=i;const y=c||f;if(y>f){const v=Math.round((1-f/y)*100);u=u||(v?`${v}% OFF`:null)}}else o!=null&&o>0&&(c||n)&&(f=Math.round((c||n)*(1-o/100)*100)/100,u=u||`${o}% OFF`);const a={name:r.productName||r.name,description:r.description||"",brand:r.brand||"",category:r.category||"General",sku:r.sku||"",barcode:r.barcode||"",mrp:c,sellingPrice:f,offerPrice:i??null,discountPercent:o??null,offerLabel:u||null,returnPolicy:e.returnPolicy??"inherit",inStock:(r.quantity||0)>0,quantity:r.quantity||0,imageUrl:r.imageUrl||r.image||"",images:r.images||[],unit:r.unit||"pcs",packSize:r.packSize||"1",isAvailable:e.isAvailable!==!1,displayOrder:e.displayOrder||0,tags:e.tags||[],originalProductId:r.id,storeId:s,syncedAt:d(),updatedAt:d()};return await A(t,a),{success:!0}}catch(t){return console.error("Error syncing product to marketplace:",t),{success:!1,error:t.message}}},U=async(s,r)=>{try{const e=b(l);for(const t of r){const c=p(l,"stores",s,"products",t.id),n=t.mrp||t.price||0,i=t.sellingPrice||t.price||0,o={name:t.productName||t.name,description:t.description||"",brand:t.brand||"",category:t.category||"General",sku:t.sku||"",mrp:n,sellingPrice:i,offerPrice:null,discountPercent:null,offerLabel:null,returnPolicy:"inherit",inStock:(t.quantity||0)>0,quantity:t.quantity||0,imageUrl:t.imageUrl||t.image||"",unit:t.unit||"pcs",isAvailable:!0,originalProductId:t.id,storeId:s,syncedAt:d(),updatedAt:d()};e.set(c,o)}return await e.commit(),{success:!0,count:r.length}}catch(e){return console.error("Error bulk syncing products:",e),{success:!1,error:e.message}}},j=async(s,r)=>{try{return await M(p(l,"stores",s,"products",r)),{success:!0}}catch(e){return console.error("Error removing product from marketplace:",e),{success:!1,error:e.message}}},T=async(s,r,e)=>{try{return await P(p(l,"stores",s,"products",r),{...e,updatedAt:d()}),{success:!0}}catch(t){return console.error("Error updating product availability:",t),{success:!1,error:t.message}}},B=async(s,r,e)=>{try{const t=p(l,"stores",s,"products",r),c=await m(t);if(!c.exists())return{success:!1,error:"Product not found"};const n=c.data(),i=n.mrp||n.sellingPrice||0,o={updatedAt:d()};Object.prototype.hasOwnProperty.call(e,"returnPolicy")&&(o.returnPolicy=e.returnPolicy),Object.prototype.hasOwnProperty.call(e,"isAvailable")&&(o.isAvailable=e.isAvailable);const f=e.offerPrice,u=e.discountPercent;if(f!==void 0)if(f===""||f===null)o.offerPrice=null,o.discountPercent=null,o.offerLabel=null,o.sellingPrice=n.mrp||n.sellingPrice||0;else{const a=parseFloat(f);!isNaN(a)&&a>=0&&(o.offerPrice=a,o.sellingPrice=a,o.discountPercent=null,o.offerLabel=i>a?`${Math.round((1-a/i)*100)}% OFF`:null)}else if(u!==void 0)if(u===""||u===null)o.offerPrice=null,o.discountPercent=null,o.offerLabel=null,o.sellingPrice=n.mrp||n.sellingPrice||0;else{const a=parseFloat(u);if(!isNaN(a)&&a>=0&&a<=100){const y=Math.round(i*(1-a/100)*100)/100;o.discountPercent=a,o.offerPrice=null,o.sellingPrice=y,o.offerLabel=`${a}% OFF`}}return await P(t,o),{success:!0}}catch(t){return console.error("Error updating product marketplace data:",t),{success:!1,error:t.message}}},z=async(s,r,e)=>{try{const t=b(l);for(const c of r){const n=p(l,"stores",s,"products",c),i=await m(n);if(!i.exists())continue;const o=i.data(),f=o.mrp||o.sellingPrice||0,u={updatedAt:d()};if(e.returnPolicy!==void 0&&(u.returnPolicy=e.returnPolicy),e.discountPercent!==void 0&&e.discountPercent!==""&&e.discountPercent!==null){const a=parseFloat(e.discountPercent);if(!isNaN(a)&&a>=0&&a<=100){const y=Math.round(f*(1-a/100)*100)/100;u.discountPercent=a,u.offerPrice=null,u.sellingPrice=y,u.offerLabel=`${a}% OFF`}}Object.keys(u).length>1&&t.update(n,u)}return await t.commit(),{success:!0,count:r.length}}catch(t){return console.error("Error bulk updating product marketplace data:",t),{success:!1,error:t.message}}},G=(s,r)=>{const e=h(l,"stores",s,"customerOrders"),t=O(e,w("createdAt","desc"));return S(t,c=>{const n=c.docs.map(i=>({id:i.id,...i.data()}));r(n)},c=>{console.error("Error subscribing to orders:",c)})},g=async(s,r,e,t={})=>{try{const c=p(l,"stores",s,"customerOrders",r),n=p(l,"customerOrders",r),i={status:e,[`statusHistory.${e}`]:d(),updatedAt:d(),...t};await P(c,i);try{await P(n,i)}catch{}return{success:!0}}catch(c){return console.error("Error updating order status:",c),{success:!1,error:c.message}}},R=async(s,r)=>{try{const e=b(l);for(const t of r){const c=p(l,"stores",s,"products",t.productId),n=await m(c);if(n.exists()){const o=n.data().quantity||0,f=Math.max(0,o-(t.quantity||1));e.update(c,{quantity:f,inStock:f>0,updatedAt:d()});const u=p(l,"businesses",s,"products",t.productId);try{e.update(u,{quantity:f,updatedAt:d()})}catch{}}}return await e.commit(),{success:!0}}catch(e){return console.error("Error deducting order stock:",e),{success:!1,error:e.message}}},Q=async(s,r,e=30)=>{try{const t=p(l,"stores",s,"customerOrders",r),c=await m(t);if(!c.exists())return{success:!1,error:"Order not found"};const n=c.data();return n.items&&n.items.length>0&&await R(s,n.items),g(s,r,"confirmed",{estimatedDeliveryMinutes:e,confirmedAt:d(),stockDeducted:!0})}catch(t){return console.error("Error accepting order:",t),{success:!1,error:t.message}}},_=async(s,r)=>g(s,r,"preparing",{preparingStartedAt:d()}),C=async(s,r)=>g(s,r,"ready",{readyAt:d()}),H=async(s,r,e={})=>g(s,r,"out_for_delivery",{outForDeliveryAt:d(),deliveryPartner:e.partnerName||"Store Delivery",deliveryPartnerPhone:e.partnerPhone||"",deliveryVehicle:e.vehicleNumber||"",deliveryAgent:{name:e.partnerName||"Store Delivery",phone:e.partnerPhone||"",vehicleNumber:e.vehicleNumber||""}}),V=async(s,r)=>g(s,r,"delivered",{deliveredAt:d()}),J=async(s,r,e="")=>g(s,r,"cancelled",{cancelledAt:d(),cancellationReason:e,cancelledBy:"retailer"});export{L as a,D as b,U as c,z as d,$ as e,B as f,q as g,G as h,J as i,V as j,C as k,_ as l,H as m,Q as n,j as r,N as s,x as t,T as u};
