import{j as e,y as i,l as E,w as U,d as N}from"./index-DRC3F7i0.js";import{r as a}from"./router-BPBaD_i0.js";import{httpsCallable as M}from"./index.esm-Bux_mLJ0.js";import{q as O,c as B,p as H,u as A,d as v,a as J}from"./firebase-DWi1MSv1.js";import{m as _}from"./index-BrhajXHK.js";import"./vendor-Ckhrjn13.js";import"./index-CprmGC-M.js";const G=()=>{const[o,x]=a.useState({name:"",email:"",phone:"",role:"Staff"}),[u,m]=a.useState(!1),h=b=>x(c=>({...c,[b.target.name]:b.target.value})),P=()=>{const{name:b,phone:c}=o;return b?.trim()?c?.trim()?c.replace(/\D/g,"").length!==10?"Phone number must have exactly 10 digits":null:"Phone is required":"Name is required"},k=async b=>{b.preventDefault();const c=P();if(c){i.error(c);return}try{if(m(!0),!E.currentUser){i.error("User not authenticated. Please log in again.");return}const{name:I,email:C,phone:$,role:S}=o,g=`+91${$.replace(/\D/g,"").slice(-10)}`,w=(await M(U,"createEmployee")({name:I,email:C,phone:g,role:S}))?.data;if(!w?.success)throw new Error(w?.message||"Failed to create employee");i.success(`Employee created: ${w.flypEmployeeId} | PIN: ${w.pin} (Valid for 30 days)`),x({name:"",email:"",phone:"",role:"Staff"})}catch(p){console.error("Create employee error:",p),i.error(p?.message||"Failed to create employee")}finally{m(!1)}};return e.jsxs("form",{onSubmit:k,className:"space-y-4 max-w-md",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-1",children:"Name"}),e.jsx("input",{name:"name",value:o.name,onChange:h,className:"w-full bg-white/10 border border-white/20 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-gray-400",placeholder:"Employee name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-1",children:"Email (optional)"}),e.jsx("input",{type:"email",name:"email",value:o.email,onChange:h,className:"w-full bg-white/10 border border-white/20 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-gray-400",placeholder:"name@example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-1",children:"Phone Number"}),e.jsx("input",{name:"phone",value:o.phone,onChange:h,className:"w-full bg-white/10 border border-white/20 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-gray-400",placeholder:"+91XXXXXXXXXX"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-1",children:"Role"}),e.jsxs("select",{name:"role",value:o.role,onChange:h,className:"w-full bg-white/10 border border-white/20 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white",children:[e.jsx("option",{children:"Staff"}),e.jsx("option",{children:"Billing"}),e.jsx("option",{children:"Inventory"}),e.jsx("option",{children:"Analytics"}),e.jsx("option",{children:"Manager"})]})]}),e.jsx("button",{type:"submit",disabled:u,className:`w-full bg-gradient-to-r from-blue-600 to-teal-500 text-white py-2 rounded-md ${u?"opacity-70 cursor-not-allowed":""}`,children:u?"Creating‚Ä¶":"Create Employee"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"Employee ID and PIN will be auto-generated and shown in the success message. PIN is valid for 30 days."})]})},Q=({open:o,name:x,onConfirm:u,onCancel:m})=>o?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:m}),e.jsxs("div",{role:"dialog","aria-modal":"true",className:"relative w-full max-w-md mx-4 rounded-2xl border border-white/15 bg-gray-900/90 shadow-2xl p-6 text-white",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Reset PIN?"}),e.jsxs("p",{className:"text-sm text-gray-300 mb-6",children:["Are you sure you want to reset the PIN for ",e.jsxs("span",{className:"font-medium",children:['"',x,'"']}),"? The new PIN will be visible for 2 minutes."]}),e.jsxs("div",{className:"flex items-center justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:m,className:"px-3 py-2 rounded-lg border border-white/20 bg-white/5 hover:bg-white/10 text-gray-200",children:"Cancel"}),e.jsx("button",{type:"button",onClick:u,className:"px-3 py-2 rounded-lg border border-red-400/30 bg-red-500/20 hover:bg-red-500/30 text-red-200",children:"Reset PIN"})]})]})]}):null,W=()=>{const[o,x]=a.useState([]),[u,m]=a.useState([]),[h,P]=a.useState(""),[k,b]=a.useState(!0),[c,p]=a.useState({}),[I,C]=a.useState({}),[$,S]=a.useState(0),[y,g]=a.useState({open:!1,id:null,name:""}),l=E.currentUser;a.useEffect(()=>{if(!l?.uid)return;const t=O(B(N,"businesses",l.uid,"employees")),r=H(t,s=>{const n=s.docs.map(d=>({id:d.id,...d.data()}));x(n),m(n),b(!1)});return()=>r()},[l]),a.useEffect(()=>{const t=setInterval(()=>S(r=>r+1),1e3);return()=>clearInterval(t)},[]),a.useEffect(()=>{if(!y.open)return;const t=r=>{r.key==="Escape"&&g({open:!1,id:null,name:""})};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[y.open]),a.useEffect(()=>{const t=h.toLowerCase(),r=o.filter(s=>{const n=(s.flypEmployeeId||s.id||"").toString().toLowerCase();return s.name?.toLowerCase().includes(t)||s.email?.toLowerCase().includes(t)||s.role?.toLowerCase().includes(t)||s.phone?.toLowerCase?.().includes(t)||n.includes(t)});m(r)},[h,o]);const L=async t=>{window.confirm("Are you sure you want to delete this employee?")&&(await J(v(N,"businesses",l.uid,"employees",t)),i.success("Employee deleted successfully"))},w=async(t,r)=>{if(!E.currentUser){i.error("Please sign in again.");return}try{await E.currentUser.getIdToken(!0)}catch(s){console.warn("Failed to refresh ID token before resetPin:",s)}try{const n=await M(U,"resetPin")({employeeId:t}),d=n?.data?.success??!1,f=n?.data?.newPin;if(!d||!f)throw new Error(n?.data?.message||"Reset failed");const j=t,Y=Date.now()+120*1e3;p(D=>({...D,[j]:{pin:f,expiresAt:Y}})),setTimeout(()=>{p(D=>{const F={...D};return delete F[j],F})},120*1e3);try{await navigator.clipboard.writeText(f),i.success(`PIN reset for "${r}". New PIN copied to clipboard.`)}catch{i.success(`PIN reset for "${r}". (Couldn't copy automatically)`),console.log("New PIN:",f)}}catch(s){console.error("Reset PIN Error:",s.code,s.message,s.details);const n=s?.code,d=s?.details,f=s?.message,j=n==="unauthenticated"?"You are not signed in.":n==="not-found"?"Employee not found.":d||f||"Something went wrong while resetting the PIN.";i.error(j)}},X=async t=>{const r=t.status==="active"?"inactive":"active";try{await A(v(N,"businesses",l.uid,"employees",t.id),{status:r}),i.success(`Status changed to ${r}`)}catch(s){console.error("Status update error:",s),i.error("Failed to update status. Please try again.")}},V=t=>{if(!t?.toDate)return"-";const r=t.toDate(),n=Math.floor((new Date-r)/1e3);return n<60?"Just now":n<3600?`${Math.floor(n/60)} mins ago`:n<86400?r.toLocaleTimeString():r.toLocaleDateString()},R=t=>{const r=Math.max(0,Math.ceil(t/1e3)),s=Math.floor(r/60),n=String(r%60).padStart(2,"0");return`${s}:${n}`},T=(t,r)=>{g({open:!0,id:t,name:r})},z=t=>{if(!t.pinExpiresAt)return!t.pinHash;const r=t.pinExpiresAt?.toDate?t.pinExpiresAt.toDate():new Date(t.pinExpiresAt);return new Date>r},q=t=>{if(z(t))return"expired";if(t.pinCreatedAt){const r=t.pinCreatedAt?.toDate?t.pinCreatedAt.toDate():new Date(t.pinCreatedAt);if(Math.floor((new Date-r)/(1e3*60*60*24))>=25)return"expiring"}return"valid"},K=t=>{C(r=>({...r,[t]:!r[t]}))};return e.jsxs("div",{className:"p-4 text-white",children:[e.jsx("h2",{className:"text-2xl font-semibold mb-4",children:"View Employees"}),e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"text",placeholder:"Search by name, email or role...",value:h,onChange:t=>P(t.target.value),className:"w-full px-4 py-2 rounded-lg backdrop-blur-md bg-white/10 border border-white/20 placeholder-gray-400 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})}),k?e.jsx("div",{className:"backdrop-blur-md bg-white/10 border border-white/20 rounded-xl p-6 text-sm text-gray-200",children:"Loading..."}):u.length===0?e.jsx("div",{className:"backdrop-blur-md bg-white/10 border border-white/20 rounded-xl p-6 text-sm text-gray-300",children:"No employees found."}):e.jsx("div",{className:"overflow-x-auto backdrop-blur-md bg-white/5 border border-white/10 rounded-2xl shadow-xl",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-xs uppercase tracking-wider bg-white/10",children:[e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"FLYP Employee ID"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Name"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Email"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Phone"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Role"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Access"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Status"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Presence"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"PIN"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Created At"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Login Link"}),e.jsx("th",{className:"py-3 px-4 border-b border-white/10",children:"Actions"})]})}),e.jsx("tbody",{children:u.map(t=>e.jsxs("tr",{className:"text-sm hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"py-3 px-4 border-b border-white/10 text-gray-200",children:t.flypEmployeeId||t.id||"-"}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10",children:t.name||"-"}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10 text-gray-200",children:t.email||"-"}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10 text-gray-200",children:t.phone||"-"}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10",children:e.jsxs("select",{value:t.role||"",onChange:async r=>{const s=r.target.value;await A(v(N,"businesses",l.uid,"employees",t.id),{role:s}),i.success(`Role updated to ${s}`)},className:"text-sm px-2 py-1 rounded bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",className:"bg-gray-900",children:"Select"}),e.jsx("option",{value:"Manager",className:"bg-gray-900",children:"Manager"}),e.jsx("option",{value:"Sales",className:"bg-gray-900",children:"Sales"}),e.jsx("option",{value:"Inventory",className:"bg-gray-900",children:"Inventory"}),e.jsx("option",{value:"Admin",className:"bg-gray-900",children:"Admin"})]})}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10",children:e.jsx("div",{className:"flex flex-col gap-1 text-xs sm:text-sm",children:["inventory","billing","analytics","delivery"].map(r=>e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!t.accessSections?.[r],onChange:async s=>{const n={...t.accessSections||{},[r]:s.target.checked};try{await A(v(N,"businesses",l.uid,"employees",t.id),{accessSections:n});const d=r==="delivery"?"Delivery":r.charAt(0).toUpperCase()+r.slice(1);i.success(`${d} ${s.target.checked?"granted":"revoked"} for ${t.name||t.flypEmployeeId||t.id}`)}catch(d){console.error("Access update error:",d),i.error("Failed to update access. Please try again.")}},className:"accent-emerald-500 h-3.5 w-3.5"}),e.jsx("span",{className:"capitalize text-gray-200",children:r==="delivery"?"Delivery":r})]},r))})}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10",children:e.jsx("button",{onClick:()=>X(t),className:`px-2 py-1 rounded text-xs transition-colors border ${t.status==="active"?"bg-green-500/15 text-green-300 border-green-400/20":"bg-white/10 text-gray-300 border-white/20"}`,children:t.status==="active"?"Active":"Inactive"})}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10",children:t.online?e.jsx("span",{className:"text-green-300 font-medium",children:"Online"}):e.jsxs("span",{className:"text-gray-400 text-xs italic",children:["Last seen: ",V(t.lastSeen)]})}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10",children:(()=>{const r=t.flypEmployeeId||t.id,s=c[r],n=q(t),d=I[r];return e.jsx("div",{className:"space-y-2",children:s&&s.expiresAt>Date.now()?e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-amber-200",children:"New PIN:"}),e.jsx("div",{className:"font-mono text-sm font-bold text-amber-300",children:s.pin}),e.jsxs("div",{className:"text-xs text-amber-400",children:["Expires in ",R(s.expiresAt-Date.now())]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:`text-[10px] px-2 py-0.5 rounded-full border ${n==="expired"?"bg-rose-500/10 text-rose-300 border-rose-500/30":n==="expiring"?"bg-amber-500/10 text-amber-300 border-amber-500/30":"bg-emerald-500/10 text-emerald-300 border-emerald-500/30"}`,children:n}),e.jsx("button",{onClick:()=>T(r,t.name),className:"text-xs text-amber-300 hover:text-amber-200 underline",children:"Reset"})]}),e.jsx("button",{onClick:()=>K(r),className:`w-full px-2 py-1.5 rounded-md border text-xs font-mono transition-all ${n==="expired"?"border-red-400/30 bg-red-500/10 text-red-200":n==="expiring"?"border-yellow-400/30 bg-yellow-500/10 text-yellow-200":"border-emerald-400/30 bg-emerald-500/10 text-emerald-200"}`,children:d?t.pin||"No PIN":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"})]})})})()}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10 text-gray-300",children:t.createdAt?.toDate?.().toLocaleDateString()||"-"}),e.jsx("td",{className:"py-3 px-4 border-b border-white/10",children:t.flypEmployeeId||t.id?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("a",{href:`${typeof window<"u"&&window.location?window.location.origin:"https://flypnow.com"}/employee-login?empId=${encodeURIComponent(t.flypEmployeeId||t.id)}${l?.uid?`&retailerId=${encodeURIComponent(l.uid)}`:""}`,target:"_blank",rel:"noopener noreferrer",className:"text-blue-300 hover:text-blue-200 underline-offset-2 hover:underline text-sm",children:"Open Link"}),e.jsx("button",{onClick:()=>{const s=`${typeof window<"u"&&window.location?window.location.origin:"https://flypnow.com"}/employee-login?empId=${encodeURIComponent(t.flypEmployeeId||t.id)}${l?.uid?`&retailerId=${encodeURIComponent(l.uid)}`:""}`;navigator.clipboard.writeText(s),i.success("Login link copied!")},className:"text-blue-300 hover:text-blue-200 underline-offset-2 hover:underline text-sm",children:"Copy Link"})]}):e.jsx("span",{className:"text-gray-500 text-xs italic",children:"No FLYP ID"})}),e.jsxs("td",{className:"py-3 px-4 border-b border-white/10",children:[(()=>{const r=t.flypEmployeeId||t.id,s=c[r];if(s&&s.expiresAt>Date.now()){const n=s.expiresAt-Date.now();return e.jsxs("span",{className:"mr-3 inline-flex items-center px-2 py-1 rounded border border-yellow-400/30 bg-yellow-500/10 text-yellow-200 text-xs",children:["PIN: ",e.jsx("span",{className:"font-mono ml-1",children:s.pin}),e.jsxs("span",{className:"ml-2 opacity-80",children:["(",R(n),")"]})]})}return null})(),e.jsx("button",{onClick:()=>L(t.id),className:"text-red-300 hover:text-red-200",children:e.jsx(_,{})}),e.jsx("button",{onClick:()=>T(t.flypEmployeeId||t.id,t.name),className:"ml-3 text-blue-300 hover:text-blue-200 underline-offset-2 hover:underline text-sm",type:"button",children:"Reset PIN"})]})]},t.id))})]})}),e.jsx(Q,{open:y.open,name:y.name,onCancel:()=>g({open:!1,id:null,name:""}),onConfirm:async()=>{const{id:t,name:r}=y;g({open:!1,id:null,name:""}),await w(t,r)}})]})},ae=()=>{const[o,x]=a.useState("add");return e.jsxs("div",{className:"p-6 text-white backdrop-blur-lg bg-gradient-to-b from-gray-900/60 to-gray-800/60 rounded-2xl border border-white/10 shadow-xl",children:[e.jsxs("div",{className:"flex gap-4 mb-8 justify-center",children:[e.jsx("button",{className:`px-5 py-2 rounded-lg font-semibold transition-all duration-300 border backdrop-blur-md ${o==="add"?"bg-gradient-to-r from-blue-600 to-teal-500 text-white border-transparent shadow-md":"bg-white/10 border-white/20 text-gray-300 hover:text-white hover:bg-white/15"}`,onClick:()=>x("add"),children:"‚ûï Add Employee"}),e.jsx("button",{className:`px-5 py-2 rounded-lg font-semibold transition-all duration-300 border backdrop-blur-md ${o==="view"?"bg-gradient-to-r from-blue-600 to-teal-500 text-white border-transparent shadow-md":"bg-white/10 border-white/20 text-gray-300 hover:text-white hover:bg-white/15"}`,onClick:()=>x("view"),children:"üëÅÔ∏è View Employees"})]}),o==="add"&&e.jsx(G,{}),o==="view"&&e.jsx(W,{})]})};export{ae as default};
