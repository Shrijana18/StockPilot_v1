import{_ as he,w as ge,j as e,l as O,d as Y,y as E}from"./index-DRC3F7i0.js";import{r as p,c as de}from"./router-BPBaD_i0.js";import{I as me,P as fe,a as ye,B as Ne,n as we,h as G,M as ve,b as ke}from"./BillingSettings-DR-owPbP.js";import{C as Pe}from"./CustomerForm-oVhzeonX.js";import{httpsCallable as je}from"./index.esm-Bux_mLJ0.js";import{d as z,l as oe,e as K,u as re,c as Ie,p as Ae}from"./firebase-DWi1MSv1.js";import{p as De,F as Se}from"./FileSaver.min-DVuNBBJs.js";import{D as Ce}from"./DistributorManualInvoicePdf-B4FHrTjE.js";import"./vendor-Ckhrjn13.js";import"./index-CbpqHhv-.js";import"./bidi-DLACMwmw.js";import"./pricing-SUVGnFgL.js";const ue=(t,c,r="")=>t?`upi://pay?${new URLSearchParams({pa:t.trim(),am:c.toFixed(2),cu:"INR",...r&&{tn:r.substring(0,50)}}).toString()}`:null,se=(t,c,r="",l="phonepe")=>t?{phonepe:`phonepe://pay?pa=${encodeURIComponent(t)}&am=${c.toFixed(2)}&cu=INR&tn=${encodeURIComponent(r||"")}`,googlepay:`tez://upi/pay?pa=${encodeURIComponent(t)}&am=${c.toFixed(2)}&cu=INR&tn=${encodeURIComponent(r||"")}`,paytm:`paytmmp://pay?pa=${encodeURIComponent(t)}&am=${c.toFixed(2)}&cu=INR&tn=${encodeURIComponent(r||"")}`}[l]||ue(t,c,r):null,Le=({invoiceNumber:t,amount:c,customerName:r,businessName:l,paymentMethods:a={},invoiceLink:N="",dueDate:s=null})=>{const w=`â‚¹${Number(c).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`;let m=`ðŸ’° *Payment Request*

`;return m+=`Hello ${r},

`,m+=`Invoice: *${t}*
`,m+=`Amount: *${w}*
`,s&&(m+=`Due Date: *${s}*
`),m+=`
ðŸ“± *Payment Options:*

`,a.upi&&a.upi.upiId&&(m+=`ðŸ’³ *UPI Payment:*
`,m+=`UPI ID: *${a.upi.upiId}*
`,a.upi.upiLink&&(m+=`Tap to pay: ${a.upi.upiLink}
`),m+=`
`),a.card&&a.card.enabled&&(m+=`ðŸ’³ *Card Payment:*
`,a.card.paymentLink?m+=`Pay via card: ${a.card.paymentLink}
`:m+=`Contact ${l} for card payment details
`,m+=`
`),a.bank&&a.bank.accountNumber&&(m+=`ðŸ¦ *Bank Transfer:*
`,m+=`Bank: ${a.bank.bankName||"N/A"}
`,m+=`Account: ${a.bank.accountNumber}
`,m+=`IFSC: ${a.bank.ifsc||"N/A"}
`,m+=`Account Name: ${a.bank.accountName||"N/A"}
`,m+=`
`),N&&(m+=`
ðŸ“„ View invoice: ${N}
`),m+=`
Thank you!
â€” ${l}`,m},Ue=(t,c)=>{if(!t)return null;const r=t.toString().replace(/\D/g,""),l=r.startsWith("91")?r:`91${r}`,a=encodeURIComponent(c);return`https://wa.me/${l}?text=${a}`},Me=async(t,c)=>{try{const{doc:r,getDoc:l}=await he(async()=>{const{doc:w,getDoc:m}=await import("./firebase-DWi1MSv1.js").then(T=>T.ad);return{doc:w,getDoc:m}},[]),a=r(c,"businesses",t,"preferences","billing"),N=await l(a);if(!N.exists())return ce();const s=N.data();return{upi:{enabled:!0,upiId:s.payment?.upiId||"",upiQrUrl:s.payment?.upiQrUrl||"",multipleUpiIds:s.payment?.multipleUpiIds||[]},card:{enabled:s.payment?.card?.enabled||!1,gateway:s.payment?.card?.gateway||"",merchantId:s.payment?.card?.merchantId||"",apiKey:s.payment?.card?.apiKey||"",paymentLinkEnabled:s.payment?.card?.paymentLinkEnabled||!1},bank:{enabled:!0,bankName:s.bank?.bankName||"",branch:s.bank?.branch||"",accountNumber:s.bank?.accountNumber||"",ifsc:s.bank?.ifsc||"",accountName:s.bank?.accountName||""},notifications:{sendOnInvoice:s.payment?.notifications?.sendOnInvoice||!1,sendOnCredit:s.payment?.notifications?.sendOnCredit||!0,autoSendPaymentLink:s.payment?.notifications?.autoSendPaymentLink||!1}}}catch(r){return console.error("Error loading payment gateway config:",r),ce()}},ce=()=>({upi:{enabled:!0,upiId:"",upiQrUrl:"",multipleUpiIds:[]},card:{enabled:!1,gateway:"",merchantId:"",apiKey:"",paymentLinkEnabled:!1},bank:{enabled:!0,bankName:"",branch:"",accountNumber:"",ifsc:"",accountName:""},notifications:{sendOnInvoice:!1,sendOnCredit:!0,autoSendPaymentLink:!1}}),Te=(t,c)=>{const r=t.totalAmount||t.totals?.grandTotal||0,l=t.invoiceNumber||t.invoiceId||"N/A",a=`Payment for invoice ${l}`,N={upi:null,upiPhonePe:null,upiGooglePay:null,upiPaytm:null,card:null,whatsapp:null};return c.upi?.enabled&&c.upi?.upiId&&(N.upi=ue(c.upi.upiId,r,a),N.upiPhonePe=se(c.upi.upiId,r,a,"phonepe"),N.upiGooglePay=se(c.upi.upiId,r,a,"googlepay"),N.upiPaytm=se(c.upi.upiId,r,a,"paytm")),c.card?.enabled&&c.card?.paymentLinkEnabled&&(N.card=`#card-payment-${l}`),N},_e=async(t,c,r={})=>{try{const a=await je(ge,"generatePaymentLink")({invoiceId:t,amount:c,customerInfo:r});return a.data.success?{success:!0,paymentLink:a.data.paymentLink,paymentLinkId:a.data.paymentLinkId,expiresAt:a.data.expiresAt}:{success:!1,error:a.data.error||"Failed to generate payment link"}}catch(l){return console.error("Error generating payment link:",l),{success:!1,error:l.message||"Failed to generate payment link"}}},Fe=t=>{const c=t?.payment?.card;return c?.enabled&&c?.merchantAccountId&&c?.merchantStatus==="active"&&c?.paymentLinkEnabled},pe=({isOpen:t,onClose:c,invoice:r,customer:l})=>{const[a,N]=p.useState(null),[s,w]=p.useState(!1),[m,T]=p.useState({upi:!0,card:!1,bank:!0}),[d,X]=p.useState(null);p.useEffect(()=>{if(!t||!r)return;(async()=>{const C=O.currentUser?.uid;if(C)try{const R=await Me(C,Y);N(R);const V=Te(r,R);X(V)}catch(R){console.error("Error loading payment config:",R),E.error("Failed to load payment settings")}})()},[t,r]);const B=async(U="whatsapp")=>{if(!r||!l){E.error("Invoice or customer information missing");return}w(!0);try{const C=r.totalAmount||r.totals?.grandTotal||0,R=r.invoiceNumber||r.invoiceId||"N/A",V=r.seller?.businessName||"Business",M={};if(m.upi&&a?.upi?.enabled&&a.upi.upiId&&(M.upi={upiId:a.upi.upiId,upiLink:d?.upi||null}),m.card&&a?.card?.enabled)if(Fe(a))try{const i=r.totalAmount||r.totals?.grandTotal||0,k=r.invoiceId||r.id,h=await _e(k,i,{name:l.name||l.businessName,email:l.email,phone:l.phone});h.success?M.card={enabled:!0,paymentLink:h.paymentLink}:(console.warn("Failed to generate card payment link:",h.error),M.card={enabled:!0,paymentLink:null,error:h.error})}catch(i){console.error("Error generating card payment link:",i),M.card={enabled:!0,paymentLink:null}}else M.card={enabled:!0,paymentLink:d?.card||null};m.bank&&a?.bank?.enabled&&(M.bank=a.bank);const W=r.id?`${window.location.origin}/invoice/${O.currentUser?.uid}/${r.id}`:"",q=Le({invoiceNumber:R,amount:C,customerName:l.name||l.businessName||"Customer",businessName:V,paymentMethods:M,invoiceLink:W,dueDate:r.creditDueDate?new Date(r.creditDueDate).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}):null});if(U==="whatsapp"){const i=l.phone||l.buyer?.phone;if(!i){E.error("Customer phone number is required"),w(!1);return}const k=Ue(i,q);k?(window.open(k,"_blank"),E.success("Opening WhatsApp...")):E.error("Failed to generate WhatsApp link")}else U==="copy"&&(await navigator.clipboard.writeText(q),E.success("Payment message copied to clipboard!"));c()}catch(C){console.error("Error sending payment link:",C),E.error("Failed to send payment link")}finally{w(!1)}};if(!t)return null;const Q=r?.totalAmount||r?.totals?.grandTotal||0,L=r?.invoiceNumber||r?.invoiceId||"N/A";return de.createPortal(e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"w-full max-w-2xl mx-4 rounded-xl border border-white/10 bg-white/10 backdrop-blur-2xl text-white shadow-xl",children:[e.jsxs("div",{className:"p-4 md:p-6 border-b border-white/10 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Send Payment Link"}),e.jsx("button",{className:"opacity-80 hover:opacity-100 text-2xl leading-none",onClick:c,disabled:s,children:"Ã—"})]}),e.jsxs("div",{className:"p-4 md:p-6 space-y-4",children:[e.jsxs("div",{className:"p-4 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("p",{className:"text-sm text-white/70 mb-1",children:"Invoice"}),e.jsx("p",{className:"font-semibold text-lg",children:L}),e.jsxs("p",{className:"text-sm text-white/70 mt-1",children:["Amount: ",e.jsxs("span",{className:"font-semibold text-emerald-300",children:["â‚¹",Number(Q).toFixed(2)]})]}),e.jsxs("p",{className:"text-sm text-white/70",children:["Customer: ",l?.name||l?.businessName||"N/A"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"font-semibold text-base",children:"Select Payment Methods to Include"}),a?.upi?.enabled&&a.upi.upiId&&e.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10 transition",children:[e.jsx("input",{type:"checkbox",checked:m.upi,onChange:U=>T(C=>({...C,upi:U.target.checked})),className:"w-5 h-5 accent-emerald-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:"UPI Payment"}),e.jsx("p",{className:"text-sm text-white/70",children:a.upi.upiId}),d?.upi&&e.jsx("a",{href:d.upi,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-emerald-300 hover:underline mt-1 inline-block",onClick:U=>U.stopPropagation(),children:"Test UPI Link"})]})]}),a?.card?.enabled&&e.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10 transition",children:[e.jsx("input",{type:"checkbox",checked:m.card,onChange:U=>T(C=>({...C,card:U.target.checked})),className:"w-5 h-5 accent-emerald-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:"Card Payment"}),e.jsx("p",{className:"text-sm text-white/70",children:a.card.gateway||"Card payment gateway"})]})]}),a?.bank?.enabled&&a.bank.accountNumber&&e.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10 transition",children:[e.jsx("input",{type:"checkbox",checked:m.bank,onChange:U=>T(C=>({...C,bank:U.target.checked})),className:"w-5 h-5 accent-emerald-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:"Bank Transfer"}),e.jsxs("p",{className:"text-sm text-white/70",children:[a.bank.bankName," - ",a.bank.accountNumber]})]})]}),!a&&e.jsx("p",{className:"text-sm text-white/60 italic",children:"Loading payment configuration..."}),a&&!a.upi?.upiId&&!a.card?.enabled&&!a.bank?.accountNumber&&e.jsx("p",{className:"text-sm text-amber-300 italic",children:"No payment methods configured. Please set up payment methods in Billing Settings."})]}),m.upi&&d?.upi&&e.jsxs("div",{className:"p-4 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Quick UPI Payment"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[d.upiPhonePe&&e.jsx("a",{href:d.upiPhonePe,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm border border-white/20",children:"PhonePe"}),d.upiGooglePay&&e.jsx("a",{href:d.upiGooglePay,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm border border-white/20",children:"Google Pay"}),d.upiPaytm&&e.jsx("a",{href:d.upiPaytm,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm border border-white/20",children:"Paytm"})]})]})]}),e.jsxs("div",{className:"p-4 md:p-6 border-t border-white/10 flex items-center justify-end gap-3",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-white/20 hover:bg-white/10 transition",onClick:c,disabled:s,children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 rounded-lg font-medium text-sm border border-white/20 hover:bg-white/10 transition",onClick:()=>B("copy"),disabled:s||!m.upi&&!m.card&&!m.bank,children:"Copy Message"}),e.jsx("button",{className:"px-4 py-2 rounded-lg font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)] transition disabled:opacity-50",onClick:()=>B("whatsapp"),disabled:s||!m.upi&&!m.card&&!m.bank||!l?.phone,title:l?.phone?"":"Customer phone number required",children:s?"Sending...":"Send via WhatsApp"})]})]})}),document.body)};function ne(t){if(t===void 0)return;if(t===null||typeof t!="object")return t;if(Array.isArray(t))return t.map(ne).filter(r=>r!==void 0);const c={};for(const[r,l]of Object.entries(t)){const a=ne(l);a!==void 0&&(c[r]=a)}return c}function $e(t,c="$"){const r=[],l=(a,N)=>{if(a===void 0){r.push(N);return}a&&typeof a=="object"&&(Array.isArray(a)?a.forEach((s,w)=>l(s,`${N}[${w}]`)):Object.entries(a).forEach(([s,w])=>l(w,`${N}.${s}`)))};return l(t,c),r}const Re=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`line-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,Ee=async(t,c)=>{for(const r of c)try{console.log("Updating distributor stock for:",r.name,"ID:",r.id,"Qty:",r.quantity);const l=z(Y,"businesses",t,"products",r.id),a=await K(l);if(a.exists()){const s=(parseFloat(a.data().quantity)||0)-r.quantity,w=s<0?0:s;await re(l,{quantity:w}),console.log("Distributor stock updated to:",w)}else console.warn("Product not found in distributor inventory for ID:",r.id)}catch(l){console.error("Error updating distributor stock for product ID:",r.id,l.message)}},Ge=()=>{const[t,c]=p.useState({name:"",phone:"",email:"",address:"",city:"",state:""}),[r,l]=p.useState([]),[a,N]=p.useState({includeGST:!1,includeCGST:!1,includeSGST:!1,includeIGST:!1,gstRate:9,cgstRate:9,sgstRate:9,igstRate:18,invoiceType:"",paymentMode:"",deliveryCharge:0,packingCharge:0,otherCharge:0,extras:{deliveryFee:0,packagingFee:0,insuranceType:"none",insuranceValue:0},driver:{name:"",phone:"",vehicle:"",tracking:""}}),[s,w]=p.useState([]),[m,T]=p.useState({visible:!1,issuedAt:null}),[d,X]=p.useState(null),[B,Q]=p.useState(""),[L,U]=p.useState(null),[C,R]=p.useState({cash:0,upi:0,card:0}),[V,M]=p.useState(!1),[W,q]=p.useState(!1),[i,k]=p.useState({branding:{logoUrl:"",signatureUrl:"",stampUrl:""},bank:{bankName:"",branch:"",accountNumber:"",ifsc:"",accountName:""},payment:{upiId:"",upiQrUrl:""},terms:""}),[h,A]=p.useState({subtotal:0,taxBreakdown:{},extras:{},finalTotal:0,grandTotal:0}),I=(n,u)=>{Array.isArray(n)&&l(n),u&&typeof u=="object"&&A(o=>({...o,...u,grandTotal:u.grandTotal??u.finalTotal??o.grandTotal}))};p.useEffect(()=>{(async()=>{const u=O.currentUser;if(u){const o=z(Y,"businesses",u.uid),y=await K(o);y.exists()&&X({...y.data(),uid:u.uid})}})()},[]),p.useEffect(()=>{(async()=>{const u=O.currentUser?.uid;if(u)try{const o=z(Y,"businesses",u,"preferences","billing"),y=await K(o);if(y.exists()){const b=y.data(),g=b.bank||{},j={bankName:g.bankName||g.name||"",branch:g.branch||"",accountNumber:g.accountNumber||g.account||"",ifsc:g.ifsc||"",accountName:g.accountName||""};k({branding:{logoUrl:b.branding?.logoUrl||"",signatureUrl:b.branding?.signatureUrl||"",stampUrl:b.branding?.stampUrl||""},bank:j,payment:{upiId:b.payment?.upiId||"",upiQrUrl:b.payment?.upiQrUrl||""},terms:b.terms||""})}}catch(o){console.warn("Failed to load billing settings:",o)}})()},[]);const v=n=>{if(!n)return;const u=n.productName||n.name||n.title||n.label||"",o=n.pricingMode?n.pricingMode:n.mrp?"MRP_INCLUSIVE":n.basePrice?"BASE_PLUS_GST":"SELLING_SIMPLE",y=Number(n.gstRate??n.taxRate??a?.gstRate??0),b=we({pricingMode:o,gstRate:y,hsnCode:n.hsnCode,sellingPrice:n.sellingPrice??n.price??void 0,sellingIncludesGst:!(o==="SELLING_SIMPLE"||o==="BASE_PLUS_GST"),mrp:n.mrp,basePrice:n.basePrice}),g={cartLineId:Re(),id:n.id,name:u,sku:n.sku||"",brand:n.brand||"",category:n.category||"",quantity:1,price:Number(b.unitPriceNet??0),discount:0,unit:n.unit||n.packSize||"",pricingMode:o,gstRate:y,inlineGstRate:y,hsnCode:n.hsnCode||"",mrp:n.mrp??void 0,basePrice:n.basePrice??void 0,normalized:{unitPriceNet:Number(b.unitPriceNet??0),taxPerUnit:Number(b.taxPerUnit??0),unitPriceGross:Number(b.unitPriceGross??0),effectiveRate:Number(b.effectiveRate??y)}};w(j=>j.find(S=>S.id===g.id)?j:[...j,{id:g.id,name:u}]),l(j=>[...j,g])},P=n=>{const u=Math.max(0,parseFloat(n.quantity)||0),o=Math.max(0,Math.min(100,parseFloat(n.discount)||0));if(n?.normalized&&(n.pricingMode==="MRP_INCLUSIVE"||n.pricingMode==="BASE_PLUS_GST")){const g=Math.max(0,parseFloat(n.normalized.unitPriceNet)||0),j=Math.max(0,parseFloat(n.normalized.taxPerUnit)||0),D=g>0?j/g:0,S=g*(1-o/100),_=S*(1+D),$=_-S;return{unitNet:g,unitTax:j,unitGross:g*(1+D),unitNetAfterDisc:S,unitTaxAfterDisc:$,unitGrossAfterDisc:_,lineNetAfterDisc:S*u,lineTaxAfterDisc:$*u,lineGrossAfterDisc:_*u}}if(n.pricingMode==="SELLING_SIMPLE"||n.pricingMode==="LEGACY"){const g=Math.max(0,parseFloat(n.price)||0),j=Math.max(0,parseFloat(n.inlineGstRate??n.gstRate??0))/100,D=g*(1-o/100),S=D*(1+j),_=S-D;return{unitNet:g,unitTax:g*j,unitGross:g*(1+j),unitNetAfterDisc:D,unitTaxAfterDisc:_,unitGrossAfterDisc:S,lineNetAfterDisc:D*u,lineTaxAfterDisc:_*u,lineGrossAfterDisc:S*u}}const y=Math.max(0,parseFloat(n.price)||0),b=y*(1-o/100);return{unitNet:b,unitTax:0,unitGross:y,unitNetAfterDisc:b,unitTaxAfterDisc:0,unitGrossAfterDisc:b,lineNetAfterDisc:b*u,lineTaxAfterDisc:0,lineGrossAfterDisc:b*u}},f=n=>(n||[]).map(u=>{const o=P(u);return{...u,unitPriceNet:o.unitNet,unitPriceGross:o.unitGross,unitPriceNetAfterDiscount:o.unitNetAfterDisc,unitTaxAfterDiscount:o.unitTaxAfterDisc,unitPriceGrossAfterDiscount:o.unitGrossAfterDisc,lineNetAfterDiscount:o.lineNetAfterDisc,lineTaxAfterDiscount:o.lineTaxAfterDisc,lineGrossAfterDiscount:o.lineGrossAfterDisc}});function F(n,u){const o=u||{},y=o.extras||{},b=parseFloat(o.deliveryCharge)||0,g=parseFloat(o.packingCharge)||0,j=parseFloat(o.otherCharge)||0,D=parseFloat(y.deliveryFee)||0,S=parseFloat(y.packagingFee)||0;let _=0;const $=y.insuranceType||"none",x=parseFloat(y.insuranceValue)||0;return $==="flat"?_=x:$==="percent"&&(_=n*(x/100)),{delivery:b+D,packaging:g+S,insurance:Math.max(0,_),other:j,total:b+D+(g+S)+Math.max(0,_)+j,meta:{type:$,val:x}}}const te=()=>{const n=f(r),u=n.reduce(($,x)=>$+(parseFloat(x.lineNetAfterDiscount)||0),0),o=n.reduce(($,x)=>$+(parseFloat(x.lineTaxAfterDiscount)||0),0),y=0,b=0,g=0,j=0,D=F(u,a),S=D.total,_=parseFloat((u+o+S).toFixed(2));return{subtotal:u,gstAmount:y,cgstAmount:b,sgstAmount:g,igstAmount:j,rowTax:o,charges:S,grandTotal:_,enriched:n,extras:D}},H=n=>c(n),ie=async()=>{if(!d){alert("User not authenticated or user info missing.");return}if(r.length===0){alert("Cart is empty. Please add products to generate invoice.");return}M(!0);const n=G().format("YYYY-MM-DDTHH:mm:ss.SSSZ"),u="INV-"+Math.random().toString(36).substr(2,9).toUpperCase();Q(u);try{if(t&&t.custId){const x=z(Y,"businesses",d.uid,"customers",t.custId),Z=await K(x);if(Z.exists()){const xe={...Z.data(),...t,updatedAt:n};await re(x,xe)}else await oe(x,{...t,createdAt:n})}}catch(x){console.error("Error saving/updating customer:",x),alert("Failed to save customer info. Please try again."),M(!1);return}const o=te(),y=o.grandTotal;if(a.paymentMode==="Split"){const x=a.splitPayment||C||{},Z=(Number(x.cash)||0)+(Number(x.upi)||0)+(Number(x.card)||0);if(Number(Z.toFixed(2))!==Number(y.toFixed(2))){alert(`Split payment does not match invoice total. Total: â‚¹${y}, Split: â‚¹${Z}`),M(!1);return}}let b=!1,g=null,j=null;a.paymentMode?.toLowerCase()==="credit"?j=a.creditDueDate||G().add(7,"days").format("YYYY-MM-DD"):(b=!0,g=n);const D={...a};delete D.splitCash,delete D.splitUPI,delete D.splitCard,delete D.splitPayment;const S=a.splitPayment||C,$={invoiceNumber:`INV-${G().format("YYYYMMDD")}-${Math.random().toString(36).substr(2,6).toUpperCase()}`,buyer:{businessName:t.name||t.businessName||"N/A",name:t.name||"N/A",email:t.email||"",phone:t.phone||"",address:t.address||"",city:t.city||"",state:t.state||""},seller:{businessName:(d.businessName||d.distributorName||"").trim()||"N/A",ownerName:(d.ownerName||d.name||d.userName||"").trim()||"N/A",email:(d.email||"").trim()||"",phone:(d.phone||"").trim()||"",address:(d.address||"").trim()||"",city:(d.city||"").trim()||"",state:(d.state||"").trim()||"",gstNumber:(d.gstin||d.gstNumber||"").trim()||"",pan:(d.pan||"").trim()||""},items:o.enriched.map(x=>({productName:x.name,name:x.name,sku:x.sku,brand:x.brand,category:x.category,quantity:x.quantity,qty:x.quantity,unit:x.unit,sellingPrice:x.unitPriceGrossAfterDiscount,price:x.unitPriceGrossAfterDiscount,unitPrice:x.unitPriceGrossAfterDiscount,mrp:x.mrp,basePrice:x.basePrice,gstRate:x.gstRate,hsnCode:x.hsnCode,pricingMode:x.pricingMode})),customer:t,custId:t&&t.custId?t.custId:void 0,cartItems:o.enriched,settings:D,paymentMode:a.paymentMode,invoiceType:a.invoiceType,issuedAt:n,invoiceId:u,totalAmount:y,splitPayment:S,creditDueDate:j,isPaid:b,paidOn:g,payment:{mode:a.paymentMode||"",isPaid:b,paidOn:g,status:b?"Paid":"Pending"},chargesSnapshot:{delivery:o.extras?.delivery||0,packing:o.extras?.packaging||0,insurance:o.extras?.insurance||0,other:o.extras?.other||0,insuranceType:a?.extras?.insuranceType||"none",insuranceValue:a?.extras?.insuranceValue||0},taxSnapshot:{rowTax:o.rowTax,cartLevel:{gst:o.gstAmount,cgst:o.cgstAmount,sgst:o.sgstAmount,igst:o.igstAmount}},totals:{grossItems:o.subtotal,itemsSubTotal:o.subtotal,subTotal:o.subtotal,delivery:o.extras?.delivery||0,packing:o.extras?.packaging||0,insurance:o.extras?.insurance||0,other:o.extras?.other||0,taxableBase:o.subtotal+o.extras?.total,taxBreakup:{gst:o.gstAmount,cgst:o.cgstAmount,sgst:o.sgstAmount,igst:o.igstAmount},grandTotal:o.grandTotal}};U($),M(!1),T({visible:!0,issuedAt:n})},be=()=>T({visible:!1,issuedAt:null});return m.visible&&d&&L?e.jsx(me,{customer:t,cartItems:r,settings:a,paymentMode:a.paymentMode,invoiceType:a.invoiceType,issuedAt:m.issuedAt,invoiceId:B,onCancel:be,onConfirm:async()=>{try{const n=z(Y,"businesses",d.uid,"invoices",B),u=ne({...L,createdAt:L.issuedAt,isPaid:L.isPaid,paidOn:L.paidOn,creditDueDate:L.creditDueDate}),o=$e(u);o.length&&console.warn("[DistributorCreateInvoice preview confirm] undefined at:",o),await oe(n,u),console.log("Distributor invoice saved to Firestore:",B),await Ee(d.uid,r);const y=(a.paymentMode||"").toLowerCase();(y==="upi"||y==="card"||y==="credit"&&!L.isPaid)&&t?.phone?q(!0):(alert("Invoice created successfully!"),c({name:"",phone:"",email:"",address:"",city:"",state:""}),l([]),w([]),T({visible:!1,issuedAt:null}))}catch(n){console.error("Error saving invoice:",n.message),alert("Failed to save invoice. Please try again.");return}},taxRates:{gst:a.gstRate,cgst:a.cgstRate,sgst:a.sgstRate,igst:a.igstRate},userInfo:{businessName:(d.businessName||d.distributorName||"").trim()||"N/A",ownerName:(d.ownerName||d.name||d.userName||"").trim()||"N/A",address:(d.address||"").trim()||"N/A",city:(d.city||"").trim()||"N/A",state:(d.state||"").trim()||"N/A",phone:(d.phone||"").trim()||"N/A",email:(d.email||"").trim()||"N/A",gstin:(d.gstin||d.gstNumber||"").trim()||"N/A",pan:(d.pan||"").trim()||"N/A"},branding:i.branding,bank:i.bank,payment:i.payment,terms:i.terms}):W&&L?e.jsx(e.Fragment,{children:e.jsx(pe,{isOpen:W,onClose:()=>{q(!1),c({name:"",phone:"",email:"",address:"",city:"",state:""}),l([]),w([]),T({visible:!1,issuedAt:null}),alert("Invoice created successfully!")},invoice:L,customer:t})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6 px-2 sm:px-4 md:px-6 pb-32 pt-[env(safe-area-inset-top)] text-white",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold",children:"Create Invoice"}),e.jsx("p",{className:"text-xs sm:text-sm text-white/70",children:"Sell products and generate invoices"})]}),e.jsxs("div",{className:"p-3 sm:p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-base sm:text-lg font-semibold mb-2 text-white",children:"Customer Information"}),d&&e.jsx(Pe,{customer:t,onChange:H,userId:d.uid})]}),e.jsxs("div",{className:"p-3 sm:p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("h2",{className:"text-base sm:text-lg font-semibold text-white",children:"Add Product"})}),e.jsx(fe,{onSelect:n=>{if(!n)return;const u=n.productName||n.name||n.title||n.label||"",o={id:n.id,...n,productName:u,pricingMode:n.pricingMode||(n.mrp?"MRP_INCLUSIVE":"SELLING_SIMPLE"),gstRate:n.gstRate??n.taxRate??0,sellingIncludesGst:n.sellingIncludesGst??n.pricingMode!=="BASE_PLUS_GST"};s.find(b=>b.id===o.id)||(w(b=>[...b,o]),v(o))}})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsx(ye,{settings:a,onChange:N,grandTotal:h.grandTotal||h.finalTotal||0}),a.paymentMode==="Credit"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-white/80 mb-1",children:"Credit Due Date (Default: 7 days from today)"}),e.jsx("input",{type:"date",className:"w-full rounded px-3 py-2 bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50",value:a.creditDueDate||"",onChange:n=>N(u=>({...u,creditDueDate:n.target.value}))})]})]}),e.jsxs("div",{className:"p-3 sm:p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-base sm:text-lg font-semibold mb-2 text-white",children:"Product Cart"}),e.jsx(Ne,{selectedProducts:s,cartItems:r,onUpdateCart:I,settings:a})]}),e.jsx("div",{className:"hidden md:flex justify-end",children:e.jsx("button",{onClick:ie,className:"px-6 py-2 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)] transition",children:"Create Invoice"})}),e.jsx("div",{className:"fixed bottom-3 sm:bottom-4 inset-x-3 sm:inset-x-4 z-50 md:hidden",children:e.jsx("button",{onClick:ie,className:"w-full text-slate-900 py-3 rounded-xl shadow-lg text-base sm:text-lg font-semibold bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)]",children:"Create Invoice"})})]}),V&&e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative p-4 sm:p-6 rounded-2xl border border-white/10 bg-white/10 shadow-2xl text-white w-[min(90vw,420px)]",children:[e.jsx("div",{className:"mx-auto mb-3 h-8 w-8 sm:h-10 sm:w-10 rounded-full border-4 border-white/30 border-t-emerald-300 animate-spin"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-base sm:text-lg font-semibold",children:"Creating invoiceâ€¦"}),e.jsx("div",{className:"text-xs sm:text-sm text-white/80 mt-1",children:"Preparing preview and totals"})]}),e.jsx("div",{className:"mt-4 h-2 w-full overflow-hidden rounded-full bg-white/10",children:e.jsx("div",{className:"h-full w-1/2 animate-[shimmer_1.6s_linear_infinite] bg-gradient-to-r from-transparent via-white/60 to-transparent"})}),e.jsx("style",{children:"@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}"})]})})]})},ee={branding:{logoUrl:"",signatureUrl:"",stampUrl:""},bank:{bankName:"",branch:"",accountNumber:"",ifsc:"",accountName:""},payment:{upiId:"",upiQrUrl:""},terms:""},J=(t={})=>t.paymentMode?.toLowerCase()||t.payment?.mode?.toLowerCase()||t.settings?.paymentMode?.toLowerCase()||"",le=(t={})=>t.creditDueDate||t.settings?.creditDueDate||null,ae=(t={})=>typeof t.isPaid=="boolean"?t.isPaid:t.payment?.isPaid===!0||t.payment?.status?.toLowerCase()==="paid"?!0:J(t)!=="credit",Ye=t=>`â‚¹${Number(t||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,Oe=t=>t?(t instanceof Date?t:t?.toDate?.()||new Date(t)).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}):"N/A",Be=t=>t?(t instanceof Date?t:t?.toDate?.()||new Date(t)).toLocaleString("en-IN",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",Ve=t=>{if(!t||!O.currentUser?.uid)return null;const c=t.id;return`${window.location.origin}/invoice/${O.currentUser.uid}/${c}`},qe=t=>{if(!t)return null;const c=t.customer?.phone||t.buyer?.phone,r=c?c.toString().replace(/\D/g,""):"",l=t.invoiceNumber||t.invoiceId||t.id,a=Ye(t.totalAmount||t.totals?.grandTotal||0),N=Be(t.issuedAt||t.createdAt),s=t.seller?.businessName||t.seller?.name||"our team",w=Ve(t),m=[`ðŸ“„ Invoice ${l}`,`ðŸ’° Amount: ${a}`,`ðŸ“… Issued: ${N}`,"","ðŸ”— View and download your digital invoice:",w||"Link unavailable","","You can view the invoice online and download the PDF from the link above.","","Thank you for your business!",`â€” ${s}`].join(`
`).trim(),T=encodeURIComponent(m);return`${r?`https://wa.me/${r}`:"https://wa.me/"}?text=${T}`},ze=()=>{const[t,c]=p.useState([]),[r,l]=p.useState([]),[a,N]=p.useState(""),[s,w]=p.useState(null),[m,T]=p.useState(""),[d,X]=p.useState(""),[B,Q]=p.useState(!1),[L,U]=p.useState(ee),[C,R]=p.useState(!0),[V,M]=p.useState(!1),[W,q]=p.useState(!1);return p.useEffect(()=>{(async()=>{const k=O.currentUser?.uid;if(k)try{const h=z(Y,"businesses",k,"preferences","billing"),A=await K(h);if(A.exists()){const I=A.data(),v=I.bank||{},P={bankName:v.bankName||v.name||"",branch:v.branch||"",accountNumber:v.accountNumber||v.account||"",ifsc:v.ifsc||"",accountName:v.accountName||""},f={...ee,...I,branding:{...ee.branding,...I.branding||{}},bank:P,payment:{...ee.payment,...I.payment||{}},terms:I.terms||""};U(f)}}catch(h){console.warn("Failed to load billing settings:",h)}})()},[]),p.useEffect(()=>{const i=O.currentUser?.uid;if(!i){R(!1);return}console.log("[DistributorViewManualInvoices] Setting up real-time listener for manual invoices");const k=Ie(Y,`businesses/${i}/invoices`),h=Ae(k,async A=>{console.log("[DistributorViewManualInvoices] Snapshot received, size:",A.size);const v=(await Promise.all(A.docs.map(async P=>{const f=P.data();if(f.orderId)return null;let F=f.customer||f.buyer||{};if(f.custId)try{const H=await K(z(Y,"businesses",i,"customers",f.custId));H.exists()&&(F={...F,...H.data()})}catch(H){console.warn("Customer lookup failed:",H)}const te=f.issuedAt?f.issuedAt instanceof Date?f.issuedAt:f.issuedAt?.toDate?.()||new Date(f.issuedAt):f.createdAt instanceof Date?f.createdAt:f.createdAt?.toDate?.()||new Date(f.createdAt||Date.now());return{id:P.id,...f,customer:{name:F.name||F.businessName||f.buyer?.businessName||"Unnamed",businessName:F.businessName||F.name||f.buyer?.businessName||"Unnamed",phone:F.phone||f.buyer?.phone||"",email:F.email||f.buyer?.email||"",address:F.address||f.buyer?.address||"",city:F.city||f.buyer?.city||"",state:F.state||f.buyer?.state||""},createdAt:te,totalAmount:f.totalAmount||f.totals?.grandTotal||0}}))).filter(P=>P!==null&&P.createdAt).sort((P,f)=>new Date(f.createdAt)-new Date(P.createdAt));console.log("[DistributorViewManualInvoices] Setting invoices, count:",v.length),c(v),R(!1)},A=>{console.error("[DistributorViewManualInvoices] Error loading invoices:",A),R(!1)});return()=>h()},[]),p.useEffect(()=>{const i=a.toLowerCase(),k=t.filter(h=>{const A=h.customer?.name?.toLowerCase().includes(i)||h.customer?.businessName?.toLowerCase().includes(i)||h.invoiceNumber?.toLowerCase().includes(i)||h.invoiceId?.toLowerCase().includes(i)||h.invoiceType?.toLowerCase().includes(i),I=h.createdAt?new Date(h.createdAt):null,v=m?G(I).format("YYYY-MM-DD")>=m:!0,P=d?G(I).format("YYYY-MM-DD")<=d:!0;return A&&v&&P});l(k)},[a,t,m,d]),C?e.jsx("div",{className:"px-4 py-6 md:px-6 pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] text-white",children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-3 h-8 w-8 rounded-full border-4 border-white/30 border-t-emerald-300 animate-spin"}),e.jsx("p",{className:"text-white/70",children:"Loading invoices..."})]})})}):e.jsxs("div",{className:"px-4 py-6 md:px-6 pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] text-white",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-emerald-200",children:"Manual Invoices"}),e.jsx("p",{className:"text-sm text-white/60 mb-4",children:"Invoices created manually for direct sales (not from orders)"}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-end mb-4 gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"Search by customer, invoice number, or type...",value:a,onChange:i=>N(i.target.value),className:"px-4 py-2 w-full rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"w-48",children:[e.jsx("label",{className:"block text-sm mb-1 text-white/80",children:"Start Date"}),e.jsx("input",{type:"date",value:m,onChange:i=>T(i.target.value),className:"px-3 py-2 rounded-xl w-full bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})]}),e.jsxs("div",{className:"w-48",children:[e.jsx("label",{className:"block text-sm mb-1 text-white/80",children:"End Date"}),e.jsx("input",{type:"date",value:d,onChange:i=>X(i.target.value),className:"px-3 py-2 rounded-xl w-full bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})]})]})]}),r.length===0?e.jsxs("div",{className:"text-center py-12 text-white/60",children:[e.jsx("p",{className:"text-lg mb-2",children:"No manual invoices found"}),e.jsx("p",{className:"text-sm",children:"Create your first invoice to get started"})]}):e.jsx("div",{className:"space-y-4",children:r.map(i=>{const h=J(i)==="credit",A=ae(i),I=le(i),v=I?G(I):null,P=v?v.isBefore(G(),"day"):!1;return e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"px-4 py-4 flex flex-col md:flex-row justify-between items-start md:items-center text-sm space-y-2 md:space-y-0 bg-white/10 backdrop-blur-xl border border-white/10 rounded-xl shadow-[0_8px_40px_rgba(0,0,0,0.35)] hover:bg-white/15 transition",children:[e.jsxs("div",{className:"flex-1 mb-2 md:mb-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold text-base",children:i.customer?.name||i.customer?.businessName||"Unnamed"}),i.invoiceNumber&&e.jsxs("span",{className:"text-xs text-white/60",children:["(",i.invoiceNumber,")"]})]}),e.jsxs("p",{className:"text-white/70 text-sm",children:[i.customer?.address||"No Address"," | ",i.customer?.phone||"No Phone"]}),e.jsxs("p",{className:"text-white/60 text-xs mt-1",children:["Items: ",i.items?.length||i.cartItems?.length||0," | Date: ",i.createdAt?G(i.createdAt).local().format("DD MMM YYYY, hh:mm A"):"N/A"]}),h&&!A&&v&&e.jsxs("p",{className:`text-xs mt-1 ${P?"text-orange-400":"text-red-400"}`,children:[P?"âš ï¸ Overdue: ":"ðŸ“… Credit Due: ",v.format("DD MMM YYYY")]})]}),e.jsxs("div",{className:"flex flex-col items-end justify-center gap-2 relative min-h-[50px]",children:[h&&!A&&v&&e.jsx("span",{className:`absolute top-1/2 right-[72px] transform -translate-y-1/2 text-white text-[10px] px-3 py-[2px] rounded-full shadow whitespace-nowrap ${P?"bg-orange-600":"bg-red-600"}`,children:P?"Overdue":"Credit Due"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded ${A?"bg-emerald-500/20 text-emerald-300":"bg-amber-500/20 text-amber-300"}`,children:A?"Paid":"Pending"}),e.jsxs("p",{className:"font-semibold text-lg",children:["â‚¹",Number(i.totalAmount||0).toFixed(2)]})]}),e.jsx("button",{className:"mt-1 px-3 py-1 rounded-lg text-xs font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_6px_20px_rgba(16,185,129,0.35)] transition",onClick:()=>w(i),children:"View"})]})]})},i.id)})}),s&&de.createPortal(e.jsx("div",{className:"fixed inset-0 w-screen h-screen bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"rounded-lg shadow-lg p-4 md:p-6 max-w-4xl xl:max-w-5xl 2xl:max-w-6xl w-full max-h-screen overflow-y-auto space-y-4 text-white bg-white/10 backdrop-blur-2xl border border-white/10 mx-4",children:[e.jsx("div",{className:"invoice-preview-container",children:e.jsx(me,{customer:s.customer,cartItems:(s.cartItems||s.items||[]).map(i=>({...i,unit:i.unit||"-",name:i.name||i.productName||"Unknown",quantity:i.quantity||i.qty||0,price:i.price||i.sellingPrice||i.unitPrice||0})),settings:{...s.settings,creditDueDate:le(s),splitCash:s.splitPayment?.cash||s.settings?.splitCash||0,splitUPI:s.splitPayment?.upi||s.settings?.splitUPI||0,splitCard:s.splitPayment?.card||s.settings?.splitCard||0,isPaid:s.isPaid,paidOn:s.paidOn,paidVia:s.paidVia,deliveryFee:s.chargesSnapshot?.delivery||s.totals?.delivery||0,packagingFee:s.chargesSnapshot?.packing||s.totals?.packing||0,insuranceType:s.chargesSnapshot?.insuranceType||"none",insuranceValue:s.chargesSnapshot?.insuranceValue||0},deliveryExtras:{driverName:s.settings?.driver?.name||"",driverPhone:s.settings?.driver?.phone||"",vehicleId:s.settings?.driver?.vehicle||"",trackingRef:s.settings?.driver?.tracking||""},invoiceType:s.invoiceType,paymentMode:J(s),issuedAt:s.createdAt||s.issuedAt,userInfo:{businessName:s.seller?.businessName||"N/A",ownerName:s.seller?.ownerName||"N/A",address:s.seller?.address||"N/A",city:s.seller?.city||"N/A",state:s.seller?.state||"N/A",phone:s.seller?.phone||"N/A",email:s.seller?.email||"N/A",gstNumber:s.seller?.gstNumber||s.seller?.gstin||"N/A",pan:s.seller?.pan||"N/A"},onCancel:()=>w(null),viewOnly:!0,previewMode:!0,branding:L.branding,bank:L.bank,payment:L.payment,terms:L.terms})}),e.jsxs("div",{className:"mt-4 p-4 rounded text-sm bg-white/5 backdrop-blur-xl border border-white/10",children:[e.jsxs("p",{className:"mb-2",children:["Invoice from ",e.jsx("strong",{children:s.seller?.businessName||"Distributor"}),s.seller?.address&&e.jsxs(e.Fragment,{children:[" located at ",e.jsx("strong",{children:s.seller.address})]}),".",e.jsx("br",{}),"Total: ",e.jsxs("strong",{children:["â‚¹",Number(s.totalAmount||0).toFixed(2)]}),e.jsx("br",{}),"Issued on:"," ",e.jsx("strong",{children:s.createdAt?G(s.createdAt).format("DD MMM YYYY, hh:mm A"):s.issuedAt?G(s.issuedAt).format("DD MMM YYYY, hh:mm A"):"N/A"})]}),(()=>{const k=J(s)==="credit",h=ae(s);return k&&!h?e.jsx("button",{className:"px-4 py-2 rounded-lg mb-4 font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)]",onClick:()=>Q(!0),children:"Mark as Paid"}):null})(),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)] disabled:opacity-50 disabled:cursor-not-allowed",onClick:async()=>{if(s)try{M(!0);const k=await De(e.jsx(Ce,{invoice:s})).toBlob(),h=s.invoiceNumber||s.invoiceId||s.id,A=Oe(s.issuedAt||s.createdAt).replace(/\s+/g,"-"),I=`${h}-${A}.pdf`;Se.saveAs(k,I)}catch(i){console.error("[DistributorViewManualInvoices] Failed to generate PDF",i),E.error("Failed to generate PDF. Please try again.")}finally{M(!1)}},disabled:V,children:V?"Generating PDF...":"Download PDF (A4)"}),e.jsx("a",{href:qe(s),target:"_blank",rel:"noopener noreferrer",className:"px-4 py-2 rounded-lg inline-block font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)]",title:s.customer?.phone?`Send to ${s.customer.phone}`:"Open WhatsApp to share invoice link",children:"Send Invoice Link"}),(()=>{const i=J(s),k=ae(s);return i==="upi"||i==="card"||i==="credit"&&!k?e.jsx("button",{className:"px-4 py-2 rounded-lg font-medium text-white bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 hover:shadow-[0_8px_24px_rgba(99,102,241,0.35)]",onClick:()=>q(!0),title:"Send payment link to customer",children:"ðŸ’³ Send Payment Link"}):null})()]}),e.jsx("p",{className:"mt-2 text-xs text-white/70 italic",children:"Powered by FLYP â€” smart business invoicing"})]})]})}),document.body),B&&e.jsx(ve,{isOpen:!0,onClose:()=>Q(!1),invoice:s,onConfirm:async i=>{const k=O.currentUser?.uid;if(!k||!s)return;const h=`businesses/${k}/invoices/${s.id}`,A=z(Y,h),I=new Date;try{await re(A,{isPaid:!0,paidOn:I,paidVia:i,"payment.isPaid":!0,"payment.status":"Paid","payment.paidOn":I,"payment.paidVia":i});const v=t.map(P=>P.id===s.id?{...P,isPaid:!0,paidOn:I,paidVia:i,payment:{...P.payment,isPaid:!0,status:"Paid",paidOn:I,paidVia:i}}:P);c(v),l(v),E.success("Invoice marked as paid successfully!"),Q(!1),w(null)}catch(v){console.error("Error marking invoice as paid:",v),E.error("Failed to mark invoice as paid. Please try again.")}}}),W&&s&&e.jsx(pe,{isOpen:W,onClose:()=>q(!1),invoice:s,customer:s.customer||s.buyer})]})},it=()=>{const[t,c]=p.useState("create"),[r,l]=p.useState(!1);return e.jsxs("section",{className:"px-2 sm:px-4 py-4 sm:py-6 md:px-6 max-w-6xl mx-auto pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-3 sm:mb-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-lg sm:text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-emerald-200",children:"Manual Billing"}),e.jsx("button",{onClick:()=>l(!0),className:"ml-2 text-base sm:text-lg text-white/70 hover:text-white p-1 rounded-lg hover:bg-white/10 transition",title:"Billing Settings",children:"âš™"})]}),e.jsx("p",{className:"text-xs sm:text-sm text-white/70 mt-1",children:"Create and manage invoices for direct sales"})]})}),e.jsxs("div",{className:"flex flex-wrap justify-center mb-4 sm:mb-6 gap-1 sm:gap-2 bg-white/5 backdrop-blur-xl p-1 sm:p-2 rounded-2xl border border-white/10",children:[e.jsx("button",{className:`px-3 sm:px-4 py-2 rounded-l-xl transition text-sm sm:text-base ${t==="create"?"bg-emerald-500 text-slate-900 shadow-[0_8px_24px_rgba(16,185,129,0.35)]":"bg-white/10 text-white hover:bg-white/15 border border-white/15"}`,onClick:()=>c("create"),children:"Create Invoice"}),e.jsx("button",{className:`px-3 sm:px-4 py-2 rounded-r-xl transition text-sm sm:text-base ${t==="view"?"bg-emerald-500 text-slate-900 shadow-[0_8px_24px_rgba(16,185,129,0.35)]":"bg-white/10 text-white hover:bg-white/15 border border-white/15"}`,onClick:()=>c("view"),children:"View Invoices"})]}),t==="create"&&e.jsx("div",{className:"space-y-4 pb-28",children:e.jsx(Ge,{})}),t==="view"&&e.jsx(ze,{}),e.jsx(ke,{isOpen:r,onClose:()=>l(!1),onSaved:a=>{console.log("Billing settings saved:",a)}})]})};export{it as default};
