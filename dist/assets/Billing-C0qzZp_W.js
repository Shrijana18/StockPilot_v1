import{j as e,y as Ye,d as ke,_ as _t,l as ct}from"./index-DRC3F7i0.js";import{r as u,R as He,c as cs}from"./router-BPBaD_i0.js";import{a as Yt,I as Ct,P as ls,B as ds,h as Le,n as us,M as ms,b as ps}from"./BillingSettings-DR-owPbP.js";import{C as hs}from"./CustomerForm-oVhzeonX.js";import{i as it,g as qe,c as Qe,l as gt,d as Ue,e as at,u as It,q as ut,w as mt}from"./firebase-DWi1MSv1.js";import{D as fs,P as gs,S as xs,V as re,T as S,I as bs,p as ys,F as Ns}from"./FileSaver.min-DVuNBBJs.js";import"./vendor-Ckhrjn13.js";import"./index.esm-Bux_mLJ0.js";import"./index-CbpqHhv-.js";import"./bidi-DLACMwmw.js";const qt="wss://voice-streamer-xxxxx-uc.a.run.app/ws",vt=!/xxxxx/.test(qt),Ss=3e3,vs=2e3,Pt=5;function ws(n={}){const{autoStopSilenceMs:s=1500,onFinalize:t=()=>{},onPartial:i=()=>{},onError:a=()=>{},onStatusChange:c=()=>{},enableWebSocket:r=!0,enableWebSpeech:N=!0,language:j="en-IN",sampleRate:I=16e3}=n,[x,G]=u.useState(!1),[p,U]=u.useState(!1),[R,X]=u.useState("closed"),[F,pe]=u.useState(""),[ue,de]=u.useState([]),[l,v]=u.useState(""),[L,y]=u.useState(0),[Y,M]=u.useState(null),[V,O]=u.useState(null),J=u.useRef(null),xe=u.useRef(null),B=u.useRef(null),$=u.useRef(null),me=u.useRef(null),le=u.useRef(null),Ie=u.useRef(null),we=u.useRef(0),Re=u.useRef(!1),_e=u.useRef(!1),Te=u.useRef(""),Ge=u.useCallback(w=>{y(w),w>.01&&(le.current&&clearTimeout(le.current),le.current=setTimeout(()=>{x&&!p&&z()},s))},[x,p,s]),d=u.useCallback(()=>{if(!r||!vt){c?.("websocket-disabled");return}if(J.current?.readyState!==WebSocket.OPEN)try{const w=new WebSocket(qt);J.current=w,w.onopen=()=>{console.log("ðŸ”Œ WebSocket connected"),X("open"),O("websocket"),M(null),we.current=0,c?.("websocket-connected"),w.send(JSON.stringify({type:"config",lang:j,sampleRate:I,format:"pcm16",hints:["product","quantity","payment","customer","gst","discount"]}))},w.onmessage=C=>{try{const E=JSON.parse(C.data);if(E.type==="transcript"||E.partial||E.final){const Z=E.text||E.transcript||"",fe=E.final||E.isFinal||!1;Z.trim()&&(fe?(v(Z),de(be=>[...be,{id:Date.now(),text:Z.trim(),ts:new Date().toISOString(),method:"websocket"}]),t?.(Z)):(pe(Z),i?.(Z)))}else E.type==="error"&&(console.error("WebSocket error:",E.message),M(E.message),a?.(E.message))}catch(E){console.error("Failed to parse WebSocket message:",E)}},w.onclose=C=>{console.log("ðŸ”Œ WebSocket closed:",C.code,C.reason),X("closed"),C.code!==1e3&&Re.current&&A()},w.onerror=C=>{console.error("ðŸ”Œ WebSocket error:",C),M("WebSocket connection failed"),Te.current!=="ws-failed"&&(a?.("WebSocket connection failed"),Te.current="ws-failed"),X("error")}}catch(w){console.error("Failed to initialize WebSocket:",w),M("Failed to initialize WebSocket"),Te.current!=="ws-init-failed"&&(a?.("Failed to initialize WebSocket"),Te.current="ws-init-failed")}},[r,j,I,c,t,i,a]),h=u.useCallback(()=>{if(!N||me.current)return;const w=window.SpeechRecognition||window.webkitSpeechRecognition;if(!w){console.warn("Web Speech API not supported");return}const C=new w;C.lang=j,C.interimResults=!0,C.continuous=!0,C.maxAlternatives=1,C.onstart=()=>{console.log("ðŸŽ¤ Web Speech started"),X("open"),O("webspeech"),M(null),c?.("webspeech-started")},C.onresult=E=>{if(_e.current)return;let Z="",fe="";for(let be=E.resultIndex;be<E.results.length;be++){const De=E.results[be];De.isFinal?fe+=De[0].transcript.trim()+" ":Z+=De[0].transcript.trim()+" "}if(Z&&(pe(Z.trim()),i?.(Z.trim())),fe){const be=fe.trim();v(be),de(De=>[...De,{id:Date.now(),text:be,ts:new Date().toISOString(),method:"webspeech"}]),t?.(be),pe("")}},C.onerror=E=>{console.error("ðŸŽ¤ Web Speech error:",E.error),M(`Web Speech error: ${E.error}`),a?.(`Web Speech error: ${E.error}`),X("error")},C.onend=()=>{console.log("ðŸŽ¤ Web Speech ended"),_e.current?(X("paused"),U(!0)):(X("closed"),U(!1))},me.current=C},[N,j,c,t,i,a]),f=u.useCallback(async()=>{if($.current)try{const w=window.AudioContext||window.webkitAudioContext,C=new w({sampleRate:48e3});xe.current=C,await C.audioWorklet.addModule("/worklets/pcm16-encoder.js");const E=C.createMediaStreamSource($.current),Z=new AudioWorkletNode(C,"pcm16-encoder",{processorOptions:{targetRate:I,frameSize:320}});B.current=Z,Z.port.onmessage=({data:fe})=>{if(!fe||!fe.buffer)return;const be=new Int16Array(fe.buffer);let De=0;for(let ze=0;ze<be.length;ze++)De+=Math.abs(be[ze]);const Ve=De/be.length/32768;if(Ge(Ve),J.current?.readyState===WebSocket.OPEN)try{J.current.send(fe.buffer)}catch(ze){console.error("Failed to send audio data:",ze)}},E.connect(Z)}catch(w){console.error("Failed to initialize audio processing:",w),M("Failed to initialize audio processing"),a?.("Failed to initialize audio processing")}},[I,Ge,a]),A=u.useCallback(()=>{if(we.current>=Pt){console.log("Max reconnection attempts reached, falling back to Web Speech API"),O("webspeech"),h();return}we.current++,console.log(`Attempting reconnection ${we.current}/${Pt}`);const w=vs*Math.pow(2,we.current-1),C=Math.floor(Math.random()*300);Ie.current=setTimeout(()=>{d()},w+C)},[d,h]),T=u.useCallback(async()=>{if(!x)try{M(null),de([]),v(""),pe(""),Re.current=!0,_e.current=!1,U(!1);const w=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:48e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});if($.current=w,r&&vt){d();const C=setTimeout(()=>{if(J.current?.readyState!==WebSocket.OPEN){console.log("WebSocket connection timeout, falling back to Web Speech API"),O("webspeech"),h();try{me.current?.start()}catch{}}},Ss);J.current?.addEventListener("open",()=>{clearTimeout(C)})}else{O("webspeech"),h();try{me.current?.start()}catch{}}r&&vt&&await f(),G(!0),X("connecting")}catch(w){console.error("Failed to start voice capture:",w),M("Failed to access microphone"),a?.("Failed to access microphone"),X("error")}},[x,r,N,d,h,f,a]),z=u.useCallback(()=>{Re.current=!1,_e.current=!0,U(!0),X("paused"),J.current?.readyState===WebSocket.OPEN&&J.current.send(JSON.stringify({type:"stop"}));try{me.current?.stop()}catch{}le.current&&clearTimeout(le.current)},[]),P=u.useCallback(()=>{!x||!p||(_e.current=!1,U(!1),X("open"),V==="websocket"?J.current?.send(JSON.stringify({type:"start"})):V==="webspeech"&&me.current?.start())},[x,p,V]),_=u.useCallback(()=>{de([]),v(""),pe("")},[]);return u.useEffect(()=>()=>{Re.current=!1,J.current&&(J.current.close(),J.current=null),xe.current&&(xe.current.close(),xe.current=null),$.current&&($.current.getTracks().forEach(w=>w.stop()),$.current=null),le.current&&clearTimeout(le.current),Ie.current&&clearTimeout(Ie.current)},[]),{isListening:x,isPaused:p,connectionState:R,lastPartial:F,segments:ue,finalTranscript:l,audioLevel:L,error:Y,activeMethod:V,start:T,stop:z,resume:P,clearSegments:_,hasWebSocket:r,hasWebSpeech:N}}const js=n=>{if(!n)return"";try{const s=new Date(n),t=String(s.getHours()).padStart(2,"0"),i=String(s.getMinutes()).padStart(2,"0"),a=String(s.getSeconds()).padStart(2,"0");return`${t}:${i}:${a}`}catch{return""}};function ks({listening:n=!1,paused:s=!1,autoStopped:t=!1,wsState:i="closed",vu:a=0,lastPartial:c="",onToggleMic:r=()=>{},onClearTranscripts:N=()=>{},activity:j=[],chips:I=[]}){const x=n&&!s,G=u.useMemo(()=>s?{text:"Paused",tone:"bg-yellow-500/20 text-yellow-300 border-yellow-500/30"}:x?{text:"Listening",tone:"bg-emerald-500/15 text-emerald-300 border-emerald-500/30"}:i==="opening"?{text:"Connecting",tone:"bg-blue-500/15 text-blue-300 border-blue-500/30"}:t?{text:"Autoâ€‘stopped",tone:"bg-orange-500/15 text-orange-300 border-orange-500/30"}:{text:"Idle",tone:"bg-neutral-700/60 text-neutral-200 border-white/10"},[s,x,t,i]),p=u.useMemo(()=>["â€œadd two whey protein 500gâ€","â€œset payment to splitâ€","â€œcustomer phone 98â€¦ add seenuâ€","â€œGST 12 percentâ€","â€œdiscount 5% on milkâ€","â€œremove milkâ€"],[]),[U,R]=u.useState(0);u.useEffect(()=>{const B=setInterval(()=>R($=>($+1)%p.length),3500);return()=>clearInterval(B)},[p.length]);const X=28,F=Math.max(0,Math.min(1,a)),[pe,ue]=u.useState(0),de=x||i==="open";u.useEffect(()=>{if(!de)return;let B;const $=()=>{ue(me=>(me+1)%1e4),B=requestAnimationFrame($)};return B=requestAnimationFrame($),()=>{B&&cancelAnimationFrame(B)}},[de]);const[l,v]=u.useState(null),[L,y]=u.useState(0);u.useEffect(()=>{let B;return n&&!s?(l||v(Date.now()),B=setInterval(()=>y(Date.now()-(l||Date.now())),250)):(v(null),y(0)),()=>B&&clearInterval(B)},[n,s]);const Y=String(Math.floor(L/1e3/60)).padStart(2,"0"),M=String(Math.floor(L/1e3%60)).padStart(2,"0");u.useEffect(()=>{const B=$=>{const me=$.target&&$.target.tagName||"";/(input|textarea|select)/i.test(me)||$.code==="Space"&&($.preventDefault(),r())};return window.addEventListener("keydown",B),()=>window.removeEventListener("keydown",B)},[r]);const[V,O]=u.useState(!1),J=u.useRef(null);return u.useEffect(()=>{const B=$=>{J.current&&(J.current.contains($.target)||O(!1))};return document.addEventListener("mousedown",B),()=>document.removeEventListener("mousedown",B)},[]),e.jsx("div",{className:"relative rounded-2xl p-4 bg-gradient-to-br from-neutral-900/70 to-neutral-800/60 shadow-lg shadow-black/30 border border-white/10 overflow-hidden z-0 before:absolute before:inset-0 before:rounded-[1.1rem] before:animate-[gradient-border_4s_linear_infinite] before:bg-[conic-gradient(from_180deg_at_50%_50%,#34d399_0%,#06b6d4_33%,#f43f5e_66%,#34d399_100%)] before:opacity-70 before:pointer-events-none before:z-0 after:absolute after:inset-0 after:rounded-[1.1rem] after:bg-neutral-900/30 after:-z-10",children:e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-16 opacity-20 blur-3xl",children:e.jsx("div",{className:"w-full h-full animate-pulse",style:{background:"radial-gradient(60% 60% at 20% 20%, rgba(16,185,129,0.22) 0%, transparent 60%), radial-gradient(50% 50% at 80% 30%, rgba(59,130,246,0.18) 0%, transparent 60%), radial-gradient(40% 40% at 40% 80%, rgba(244,63,94,0.14) 0%, transparent 60%)"}})}),e.jsx("div",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 opacity-[0.045]",children:e.jsx("div",{className:"absolute inset-0",style:{backgroundImage:"linear-gradient(transparent 23px, rgba(255,255,255,.08) 24px), linear-gradient(90deg, transparent 23px, rgba(255,255,255,.08) 24px)",backgroundSize:"24px 24px"}})}),e.jsxs("div",{className:"flex items-center justify-between gap-3 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2.5 py-1 rounded-full text-xs border ${G.tone}`,children:G.text}),e.jsxs("span",{className:"text-xs opacity-60",children:["WS: ",i]}),n&&!s&&e.jsxs("span",{className:"ml-1 text-xs text-emerald-300/90",title:"Recording time",children:["â€¢ ",Y,":",M]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative z-10",ref:J,children:[e.jsx("button",{type:"button",onClick:()=>O(B=>!B),className:"h-9 px-3 rounded-full border text-sm bg-neutral-900/70 hover:bg-neutral-900 border-white/10",title:"Help & voice examples",children:"?"}),V&&e.jsxs("div",{role:"dialog","aria-label":"Voice help",className:"absolute right-0 mt-2 w-72 rounded-xl border border-white/10 bg-neutral-900/95 backdrop-blur p-3 shadow-xl z-20",children:[e.jsx("div",{className:"text-xs opacity-70 mb-1",children:"Say things like:"}),e.jsxs("ul",{className:"text-sm space-y-1",children:[e.jsx("li",{children:"â€¢ add 2 colgate 100g"}),e.jsx("li",{children:"â€¢ set payment to split"}),e.jsx("li",{children:"â€¢ customer phone 98â€¦ add seenu"}),e.jsx("li",{children:"â€¢ GST 12 percent"}),e.jsx("li",{children:"â€¢ discount 5% on milk"}),e.jsx("li",{children:"â€¢ remove milk"})]}),e.jsxs("div",{className:"mt-2 text-xs opacity-60",children:["Shortcut: press ",e.jsx("span",{className:"px-1 rounded bg-white/10",children:"Space"})," to toggle mic."]})]})]}),e.jsxs("button",{type:"button",onClick:r,"aria-pressed":x,className:`relative z-10 h-9 pl-9 pr-4 rounded-full border text-sm font-medium transition-all focus:outline-none
              ${x?"bg-emerald-600/90 border-emerald-400/60 text-white shadow-[0_0_0_2px_rgba(16,185,129,0.25)]":"bg-neutral-800/80 border-white/10 text-white/90 hover:bg-neutral-800"}
            `,title:"Toggle microphone (Space)",children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-px rounded-full",style:{background:x?`conic-gradient(rgba(34,197,94,0.45) ${L/1e3%60/60*360}deg, transparent 0deg)`:"transparent",mask:"linear-gradient(#000,#000) content-box, linear-gradient(#000,#000)",WebkitMask:"linear-gradient(#000,#000) content-box, linear-gradient(#000,#000)",maskComposite:"exclude",WebkitMaskComposite:"xor",padding:"2px"}}),x&&e.jsx("span",{className:"pointer-events-none absolute inset-0 rounded-full animate-[pulse_1.8s_ease-in-out_infinite]",style:{boxShadow:"0 0 0 0 rgba(16,185,129,0.45)"},"aria-hidden":!0}),x&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -top-2 -right-1",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",className:"opacity-70",children:e.jsx("path",{fill:"currentColor",d:"M12 2l1.2 3.4L16 6l-2.8 1.1L12 10l-1.2-2.9L8 6l2.8-.6L12 2Zm7 8l.8 2.2L22 13l-2.2.8L19 16l-.8-2.2L16 13l2.2-.8L19 10ZM5 12l1 2.6L9 15l-2.6 1L5 19l-1-3l-3-1l3-1l1-2Z"})})}),e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-90 pointer-events-none",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",className:"fill-current",children:e.jsx("path",{d:"M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm7-3a1 1 0 1 0-2 0 5 5 0 0 1-10 0 1 1 0 1 0-2 0 7 7 0 0 0 6 6.92V20H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.08A7 7 0 0 0 19 11Z"})})}),x?"Stop":"Start"]}),e.jsx("button",{type:"button",onClick:N,className:"h-9 px-4 rounded-full border text-sm bg-neutral-900/70 hover:bg-neutral-900 border-white/10 relative z-10",title:"Clear transcripts",children:"Clear"})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-12 gap-4",children:[e.jsxs("div",{className:"col-span-12 lg:col-span-7",children:[e.jsxs("div",{className:"h-16 flex items-end gap-[6px] rounded-xl border border-white/10 bg-neutral-900/80 px-3 py-2 overflow-hidden relative",children:[e.jsx("div",{className:`absolute inset-0 ${x?"bg-gradient-to-r from-emerald-400/35 via-teal-400/30 to-cyan-400/35":"bg-gradient-to-r from-cyan-400/30 via-sky-400/25 to-blue-400/30"} blur-xl pointer-events-none -z-10`}),e.jsx("div",{className:"absolute top-1 right-2 text-[10px] px-2 py-0.5 rounded-full border border-white/10 bg-black/30 backdrop-blur z-10",children:e.jsx("span",{className:x?"text-emerald-300":t?"text-orange-300":s?"text-yellow-300":"text-white/70",children:x?"ONÂ AIR":t?"Autoâ€‘stopped":s?"Paused":"Idle"})}),Array.from({length:X}).map((B,$)=>{const me=Math.sin($/X*Math.PI),le=de?(Math.sin($*.6+pe*.12)+1)/2:0,Ie=10+me*(28+F*36)+le*14,we=.7+me*.25+F*.25,Re=x?"from-emerald-400/90 to-emerald-200":"from-cyan-400/70 to-cyan-100";return e.jsx("div",{className:`w-[5px] rounded-[2px] bg-gradient-to-t ${Re} shadow-[inset_0_-6px_12px_rgba(0,0,0,0.25)] transition-[height,opacity] duration-100`,style:{height:Ie,opacity:we},"aria-hidden":!0},$)})]}),e.jsxs("div",{className:"mt-2 text-sm leading-6 rounded-xl border border-white/10 bg-neutral-900/60 p-3 min-h-[52px] relative overflow-hidden","aria-live":"polite",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-xl z-0 border-[2.5px] border-transparent",style:{background:"conic-gradient(from 90deg at 50% 50%, #34d39933 0%, #06b6d433 33%, #f43f5e33 66%, #34d39933 100%)",WebkitMask:"linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0)",maskComposite:"exclude",WebkitMaskComposite:"xor",opacity:.35,animation:"spin 3.5s linear infinite"}}),e.jsx("span",{className:"relative z-10 text-white/90",children:c||"Say a productâ€¦"}),x&&e.jsx("span",{className:"inline-block w-1.5 h-4 align-middle ml-1 bg-emerald-300 animate-pulse rounded relative z-10"}),!c&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"block text-xs mt-1 opacity-50 relative z-10",children:["Try saying ",e.jsx("em",{className:"not-italic text-emerald-300/90",children:p[U]})]}),e.jsx("div",{className:"mt-1 flex gap-1 items-center relative z-10",children:p.map((B,$)=>e.jsx("span",{className:`inline-block w-1.5 h-1.5 rounded-full ${$===U?"bg-emerald-400":"bg-white/35"}`},$))})]})]})]}),e.jsxs("div",{className:"col-span-12 lg:col-span-5",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-neutral-900/85 backdrop-blur p-3 max-h-56 overflow-y-auto relative nice-scroll","aria-live":"polite",children:[e.jsxs("div",{className:"pointer-events-none absolute inset-0 z-0",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-emerald-400/5 via-cyan-300/10 to-emerald-400/5 blur-lg animate-[shimmerX_3.5s_linear_infinite] z-0"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-white/5 opacity-10 animate-[shimmerY_5s_linear_infinite] z-0"})]}),e.jsxs("div",{className:"flex items-center justify-between sticky top-0 z-10 bg-neutral-900/80 backdrop-blur px-1 py-1 rounded-md",children:[e.jsx("div",{className:"text-xs opacity-60 mb-1",children:"Activity"}),e.jsxs("div",{className:"flex items-center gap-1 text-xs opacity-60",children:[e.jsx("span",{className:`inline-block w-1.5 h-1.5 rounded-full ${i==="open"?"bg-emerald-400":i==="opening"?"bg-blue-400":"bg-neutral-500"}`}),e.jsx("span",{children:i})]})]}),e.jsxs("ul",{className:"text-sm space-y-1 relative z-10 text-white/95 max-h-44 overflow-y-auto nice-scroll",children:[(j??[]).map((B,$)=>e.jsxs("li",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"truncate text-white/95",title:B.text,children:B.text}),e.jsx("span",{className:"shrink-0 text-[10px] px-1.5 py-0.5 rounded-full border border-white/10 bg-white/5 opacity-60",children:js(B.ts)})]},B.id??B.ts??$)),(!j||j.length===0)&&e.jsx("li",{className:"text-xs opacity-50",children:"No activity yet."})]})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[(I??[]).map((B,$)=>{const me=B.id??B.key??B.label??B.text??$,le=B.label??B.text??"â€”",Ie=B.onClick??B.action,we=B.type==="ok"?"border-emerald-400/40 text-emerald-300 bg-emerald-600/10 hover:bg-emerald-600/20":B.type==="warn"?"border-amber-400/40 text-amber-300 bg-amber-600/10 hover:bg-amber-600/20":"border-white/10 text-white/80 bg-neutral-800/70 hover:bg-neutral-800";return e.jsx("button",{onClick:Ie,type:"button",className:`text-xs px-2.5 py-1 rounded-full border transition-all duration-150 hover:translate-y-[-1px] ${we} hover:shadow-lg hover:shadow-emerald-300/20 hover:scale-105 focus:scale-105 focus:shadow-lg focus:shadow-cyan-400/30`,title:le,style:{transition:"transform 0.16s cubic-bezier(.4,2,.3,1), box-shadow 0.22s cubic-bezier(.4,2,.3,1)"},children:le},me)}),(!I||I.length===0)&&e.jsx("span",{className:"text-xs text-white/70",children:"No suggestions."})]})]})]})]})})}if(typeof document<"u"&&!document.getElementById("voicehud-magic-animations")){const n=document.createElement("style");n.id="voicehud-magic-animations",n.innerHTML=`
    @keyframes gradient-border {
      0% { filter: hue-rotate(0deg);}
      100% { filter: hue-rotate(360deg);}
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    @keyframes shimmerX {
      0% { opacity: 0.45; transform: translateX(-30%);}
      50% { opacity: 0.70; transform: translateX(30%);}
      100% { opacity: 0.45; transform: translateX(-30%);}
    }
    @keyframes shimmerY {
      0% { opacity: 0.15; transform: translateY(-30%);}
      50% { opacity: 0.35; transform: translateY(30%);}
      100% { opacity: 0.15; transform: translateY(-30%);}
    }
    .nice-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
    .nice-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,.4); border-radius: 8px; }
    .nice-scroll::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,.6); }
    .nice-scroll { scrollbar-width: thin; scrollbar-color: rgba(148,163,184,.5) transparent; }
  `,document.head.appendChild(n)}function Ts({cart:n=[],shadowQtys:s={},setShadowQtys:t=()=>{},discountModes:i={},setDiscountModes:a=()=>{},discountDrafts:c={},setDiscountDrafts:r=()=>{},onQtyChange:N=()=>{},onSetDiscount:j,onRemoveLine:I,inventory:x=[]}){const G=(l,v)=>String(l?.cartLineId??l?.id??l?.lineId??`${l?.sku||l?.name||"row"}-${v}`),p=(l,v)=>t(L=>({...L,[l]:v})),U=(l,v)=>a(L=>({...L,[l]:v})),R=(l,v)=>r(L=>({...L,[l]:v})),X=l=>{if(!l)return{};if(l.product&&typeof l.product=="object")return l.product;const v=String(l.sku||"").toLowerCase();if(v&&Array.isArray(x)&&x.length){const y=x.find(Y=>String(Y.sku||"").toLowerCase()===v);if(y)return y}const L=String(l.productName||l.name||"").toLowerCase();if(L&&Array.isArray(x)&&x.length){const y=x.find(Y=>String(Y.productName||Y.name||"").toLowerCase()===L);if(y)return y}return{}},F=Array.isArray(n)?n:[],pe=u.useMemo(()=>F.map((l,v)=>{const L=G(l,v),y=Ke((l&&l.normalized&&l.normalized.unitPriceNet)??l.unitPrice??l.price??l.sellingPrice??l.mrp,0),Y=Ke(l.qty??l.quantity,1),M=Ke(s[L]??Y,Y),V=i[L]==="amt"||i[L]==="pct"?i[L]:Cs(l),O=c[L]??Is(l,V),J=Ke(O,0),xe=V==="amt"?tt(J,0,y*M):Pe(y*M*(tt(J,0,100)/100)),B=Pe(y*M-xe),$=X(l),me=l.displayName||l.productName||l.name||$.productName||$.name||"â€”",le=l.brand||$.brand||"",Ie=l.unit||l.packSize||$.unit||"",we=l.category||$.category||"",Re=(l.pricingMode||"").toUpperCase(),_e=Re==="MRP_INCLUSIVE"?"MRP (incl.)":Re==="BASE_PLUS_GST"?"Base+GST":Re==="SELLING_SIMPLE"?"Selling (net)":Re||"",Te=Ke(l.inlineGstRate??l.gstRate??(l.normalized&&l.normalized.effectiveRate),NaN),Ge=Number.isFinite(Te)&&Te>0?Te:0,d=Pe(B*(Ge/100)),h=!!(l.useIGST||l.igst),f=h?0:Pe(d/2),A=h?0:Pe(d/2),T=h?d:0,z=Pe(B+d);return{row:l,idx:v,lineKey:L,unitPrice:y,qty:M,mode:V,draftStr:O,draftNum:J,discAmt:xe,subtotal:B,displayName:me,brand:le,unit:Ie,category:we,modeLabel:_e,gstRate:Te,effectiveGst:Ge,taxAmount:d,cgst:f,sgst:A,igst:T,grossTotal:z}}),[F,s,i,c,x]),ue=u.useMemo(()=>Pe(pe.reduce((l,v)=>l+(v.subtotal||0),0)),[pe]),de=u.useMemo(()=>pe.reduce((l,v)=>(l.tax+=v.taxAmount||0,l.cgst+=v.cgst||0,l.sgst+=v.sgst||0,l.igst+=v.igst||0,l.gross+=v.grossTotal||v.subtotal||0,l),{tax:0,cgst:0,sgst:0,igst:0,gross:0}),[pe]);return e.jsxs("div",{className:"rounded-2xl p-4 bg-gradient-to-br from-neutral-900/70 to-neutral-800/60 shadow-lg shadow-black/30 border border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 select-none",children:[e.jsxs("div",{className:"text-sm opacity-70",children:["Cart",e.jsxs("span",{className:"ml-2 inline-flex items-center rounded-full border border-white/10 px-2 py-0.5 text-[11px] opacity-80",children:[F.length," item",F.length===1?"":"s"]})]}),e.jsxs("div",{className:"text-xs opacity-70",children:["Subtotal: ",e.jsxs("span",{className:"font-semibold opacity-90",children:["â‚¹",ue.toFixed(2)]})]})]}),e.jsx("div",{className:"max-h-[60vh] overflow-auto rounded-xl border border-white/10",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsxs("colgroup",{children:[e.jsx("col",{style:{width:"46%"}}),e.jsx("col",{style:{width:"12%"}}),e.jsx("col",{style:{width:"14%"}}),e.jsx("col",{style:{width:"16%"}}),e.jsx("col",{style:{width:"12%"}}),I?e.jsx("col",{style:{width:"8%"}}):null]}),e.jsx("thead",{className:"sticky top-0 bg-neutral-900/80 backdrop-blur",children:e.jsxs("tr",{className:"text-left text-xs uppercase tracking-wider opacity-70",children:[e.jsx("th",{className:"px-3 py-2",children:"Item"}),e.jsx("th",{className:"px-3 py-2",children:"Price"}),e.jsx("th",{className:"px-3 py-2",children:"Qty"}),e.jsx("th",{className:"px-3 py-2",children:"Discount"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Subtotal"}),I&&e.jsx("th",{className:"px-3 py-2 text-center",children:"Action"})]})}),e.jsxs("tbody",{children:[pe.map(({row:l,lineKey:v,unitPrice:L,qty:y,mode:Y,draftStr:M,draftNum:V,subtotal:O,displayName:J,brand:xe,unit:B,category:$,modeLabel:me,gstRate:le,effectiveGst:Ie,taxAmount:we,cgst:Re,sgst:_e,igst:Te,grossTotal:Ge},d)=>{const h=z=>{const P=z<1?1:z;p(v,P),N({lineKey:v,cartLineId:l.cartLineId,id:l.id,sku:l.sku,name:l.name,qty:P})},f=z=>{const P=z.target.value;if(U(v,P),!j)return;const _=L*y,w=tt(V,0,100),C=tt(V,0,_),E=P==="pct"?w:_>0?Pe(C/_*100):0;j(P==="pct"?{lineKey:v,cartLineId:l.cartLineId,id:l.id,sku:l.sku,name:l.name,discountPct:w,discountAmt:void 0,discount:E}:{lineKey:v,cartLineId:l.cartLineId,id:l.id,sku:l.sku,name:l.name,discountAmt:C,discountPct:void 0,discount:E})},A=z=>{const P=z.target.value.replace(/[^\d.]/g,"");R(v,P);const _=Number(P);if(!j||!Number.isFinite(_))return;const w=L*y;if(Y==="pct"){const C=tt(_,0,100);j({lineKey:v,cartLineId:l.cartLineId,id:l.id,sku:l.sku,name:l.name,discountPct:C,discountAmt:void 0,discount:C})}else{const C=tt(_,0,w),E=w>0?Pe(C/w*100):0;j({lineKey:v,cartLineId:l.cartLineId,id:l.id,sku:l.sku,name:l.name,discountAmt:C,discountPct:void 0,discount:E})}},T=y>1;return e.jsxs("tr",{className:"border-t border-white/5 transition-colors hover:bg-white/5 "+(d%2?"bg-white/[0.01]":""),children:[e.jsxs("td",{className:"px-3 py-2 align-top",children:[e.jsx("div",{className:"font-medium opacity-90 truncate",title:J,children:J}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-0.5",children:[xe?e.jsx("span",{className:"text-[11px] opacity-80",children:xe}):null,B?e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded-md border border-white/10 bg-white/5 opacity-80",children:B}):null,$?e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded-md border border-white/10 bg-white/5 opacity-70",children:$}):null,me?e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded-md border border-white/10 bg-white/5 opacity-70",title:"Pricing mode",children:me}):null,Number.isFinite(le)&&le>0?e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded-md border border-white/10 bg-white/5 opacity-70",title:"GST rate applied",children:["GST ",le,"%"]}):null,e.jsx("span",{className:"text-[11px] opacity-50",children:"â€¢"}),e.jsx("span",{className:"text-[11px] font-mono opacity-60",children:l.sku||l.code||v})]}),Number.isFinite(le)&&le>0?e.jsx("div",{className:"w-full text-[10px] opacity-60",children:l.useIGST||l.igst?e.jsxs("span",{title:"IGST breakdown",children:["IGST ",le,"% = â‚¹",(O*(le/100)).toFixed(2)]}):e.jsxs("span",{title:"CGST/SGST breakdown",children:["CGST ",(le/2).toFixed(1),"% = â‚¹",(O*(le/200)).toFixed(2)," â€¢ SGST ",(le/2).toFixed(1),"% = â‚¹",(O*(le/200)).toFixed(2)]})}):null]}),e.jsxs("td",{className:"px-3 py-2 align-top whitespace-nowrap",children:["â‚¹",L.toFixed(2),l&&l.normalized&&typeof l.normalized.unitPriceNet<"u"?e.jsx("span",{className:"ml-1 text-[10px] opacity-60",title:"Net unit price (pre-GST)",children:"net"}):null]}),e.jsx("td",{className:"px-3 py-2 align-top",children:e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("button",{type:"button",className:`w-7 h-7 rounded-md border border-white/10 bg-neutral-800/70 hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-white/20 ${T?"":"opacity-50 cursor-not-allowed"}`,onClick:()=>T&&h(y-1),"aria-label":"Decrease quantity","aria-disabled":!T,title:"Decrease",children:"âˆ’"}),e.jsx("input",{className:"w-14 text-center px-2 py-1 rounded-md bg-neutral-800/70 border border-white/10 outline-none focus:ring-2 focus:ring-white/20",value:String(y),onChange:z=>{const P=z.target.value,_=Number(P);Number.isFinite(_)?h(_):p(v,P)},inputMode:"numeric","aria-label":"Quantity"}),e.jsx("button",{type:"button",className:"w-7 h-7 rounded-md border border-white/10 bg-neutral-800/70 hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-white/20",onClick:()=>h(y+1),"aria-label":"Increase quantity",title:"Increase",children:"+"})]})}),e.jsx("td",{className:"px-3 py-2 align-top",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 rounded-md bg-neutral-800/70 border border-white/10 text-xs focus:outline-none focus:ring-2 focus:ring-white/20",value:Y,onChange:f,"aria-label":"Discount type",title:"Choose discount type",children:[e.jsx("option",{value:"pct",children:"% off"}),e.jsx("option",{value:"amt",children:"â‚¹ off"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"w-24 pr-7 px-2 py-1 rounded-md bg-neutral-800/70 border border-white/10 text-right focus:outline-none focus:ring-2 focus:ring-white/20",inputMode:"decimal",value:M,onChange:A,placeholder:Y==="pct"?"0â€“100":"â‚¹","aria-label":"Discount value",title:"Enter discount"}),e.jsx("span",{className:"pointer-events-none absolute inset-y-0 right-2 flex items-center text-xs opacity-60",children:Y==="pct"?"%":"â‚¹"})]})]})}),e.jsxs("td",{className:"px-3 py-2 align-top text-right whitespace-nowrap font-medium",children:["â‚¹",O.toFixed(2)]}),I&&e.jsx("td",{className:"px-3 py-2 align-top text-center",children:e.jsx("button",{type:"button",className:"text-xs text-red-500 hover:text-red-400 font-semibold focus:outline-none focus:ring-2 focus:ring-red-500/30 rounded-md px-2 py-1",onClick:()=>I(l),"aria-label":"Remove line",title:"Remove this item",children:"Remove"})})]},v)}),F.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-8 text-center text-xs opacity-60",colSpan:I?6:5,children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"text-sm",children:"Cart is empty"}),e.jsxs("div",{className:"text-[11px] opacity-70",children:["Try saying: ",e.jsx("span",{className:"font-mono",children:"â€œadd 2 dairy milk 56gâ€"})]})]})})})]}),F.length>0&&e.jsxs("tfoot",{className:"sticky bottom-0 bg-neutral-900/80 backdrop-blur",children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 text-xs opacity-70",colSpan:3,children:"Live cart subtotal"}),e.jsxs("td",{className:"px-3 py-2 text-right text-xs opacity-70",children:[F.length," line",F.length===1?"":"s"]}),e.jsxs("td",{className:"px-3 py-2 text-right font-semibold",children:["â‚¹",ue.toFixed(2)]}),I&&e.jsx("td",{})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 text-xs opacity-70",colSpan:3,children:"Est. tax (items)"}),e.jsxs("td",{className:"px-3 py-2 text-right text-xs opacity-70",children:["CGST: â‚¹",Pe(de.cgst).toFixed(2)," â€¢ SGST: â‚¹",Pe(de.sgst).toFixed(2),de.igst>0?` â€¢ IGST: â‚¹${Pe(de.igst).toFixed(2)}`:""]}),e.jsxs("td",{className:"px-3 py-2 text-right font-semibold",children:["â‚¹",Pe(de.tax).toFixed(2)]}),I&&e.jsx("td",{})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 text-xs opacity-70",colSpan:4,children:"Grand total"}),e.jsxs("td",{className:"px-3 py-2 text-right font-semibold",children:["â‚¹",Pe(de.gross).toFixed(2)]}),I&&e.jsx("td",{})]})]})]})})]})}function Ke(n,s=0){const t=typeof n=="string"?Number(n):n;return Number.isFinite(t)?t:s}function tt(n,s,t){return Math.max(s,Math.min(t,n))}function Pe(n){return Math.round(Number(n||0)*100)/100}function Cs(n){const s=Ke(n.discountPct,NaN),t=Ke(n.discountAmt,NaN),i=Ke(n.discount,NaN);return Number.isFinite(s)&&s>0||Number.isFinite(i)&&i>0?"pct":Number.isFinite(t)&&t>0?"amt":"pct"}function Is(n,s){return String(s==="amt"?n.discountAmt??"":n.discountPct??n.discount??"")}function pt({children:n}){return e.jsx("kbd",{className:"inline-flex items-center px-1.5 py-[2px] rounded-md border border-white/20 bg-white/10 text-[10px] leading-none",children:n})}function Rs({children:n,hint:s}){return e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-base font-medium opacity-90",id:"panel-title",children:n}),s&&e.jsx("div",{className:"text-[11px] opacity-60",children:s})]})}function Ds({title:n="Did you meanâ€¦?",suggestions:s=[],onPick:t=()=>{},onDismiss:i=()=>{},hints:a=[{k:"Say",v:"â€œadd 2 colgate 100gâ€"},{k:"Qty",v:"â€œset quantity 3â€"},{k:"GST",v:"â€œgst 12%â€"}]}){return He.useEffect(()=>{const c=r=>{if(!(!s||s.length===0)){if(r.key==="Escape"){r.preventDefault(),i?.();return}if(r.key==="Enter"){r.preventDefault();const N=s[0];if(!N)return;typeof N.onPick=="function"?N.onPick(N):typeof t=="function"&&N.onPick==null&&typeof N.add!="function"?t(N):N.add?.();return}if(/^[1-9]$/.test(r.key)){const N=parseInt(r.key,10)-1,j=s[N];if(!j)return;r.preventDefault(),typeof j.onPick=="function"?j.onPick(j):typeof t=="function"&&j.onPick==null&&typeof j.add!="function"?t(j):j.add?.()}}};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[s,t,i]),!s||s.length===0?null:e.jsxs("div",{className:"fixed inset-0 z-40 flex items-end sm:items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"panel-title",children:[e.jsx("div",{className:"absolute inset-0 backdrop-blur-[2px] bg-black/60",onClick:i}),e.jsxs("div",{className:"relative z-10 w-full sm:max-w-xl mx-auto rounded-2xl border border-white/10 bg-neutral-900/95 p-4 shadow-2xl animate-in fade-in slide-in-from-bottom-2",children:[e.jsx(Rs,{hint:e.jsxs("span",{className:"hidden sm:inline",children:["Press ",e.jsx(pt,{children:"1"}),"-",e.jsx(pt,{children:"9"})," or ",e.jsx(pt,{children:"Enter"})]}),children:n}),a&&a.length>0&&e.jsx("div",{className:"mb-2 flex flex-wrap gap-2",children:a.map((c,r)=>e.jsxs("span",{className:"text-[11px] px-2 py-1 rounded-full bg-white/5 border border-white/10 text-white/80",children:[e.jsxs("span",{className:"opacity-60 mr-1",children:[c.k,":"]}),c.v]},r))}),e.jsx("ul",{className:"space-y-2 max-h-72 overflow-auto pr-1",children:(s??[]).map((c,r)=>{const N=c.label??c.displayName??"â€”",j=[];if(c.sublabel)j.push(c.sublabel);else{c.unit&&j.push(c.unit);const p=[c.brand,c.sku].filter(Boolean).join(" â€¢ ");p&&j.push(p)}const I=j.join(" Â· "),x=typeof c.price=="number"?c.price:void 0,G=()=>typeof c.onPick=="function"?c.onPick(c):typeof t=="function"&&c.onPick==null&&typeof c.add!="function"?t(c):c.add?.();return e.jsx("li",{children:e.jsx("button",{type:"button",onClick:G,className:"group w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-neutral-800/70 hover:bg-neutral-800 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm opacity-90 truncate",children:N}),I&&e.jsx("div",{className:"text-xs opacity-60 mt-0.5 truncate",children:I}),x!=null&&e.jsxs("div",{className:"text-xs text-emerald-300 mt-0.5",children:["â‚¹",x.toFixed(2)]})]}),e.jsx("span",{className:"text-[10px] opacity-60 border border-white/10 rounded px-1 py-0.5",children:r<9?r+1:""})]})})},c.key??c.id??r)})}),e.jsxs("div",{className:"mt-3 text-[11px] opacity-60 flex items-center justify-between",children:[e.jsxs("div",{children:["Tip: press ",e.jsx(pt,{children:"Esc"})," to dismiss"]}),e.jsx("div",{className:"hidden sm:block",children:"Voice picks still work while open"})]})]})]})}function Es({customer:n,onClear:s=()=>{}}){if(!n)return null;const t=n.name||n.displayName||"Customer",i=n.phone||n.mobile||n.contact||"",a=n.email||"",c=String(t).split(/\s+/).filter(Boolean).map(r=>r[0]).slice(0,2).join("").toUpperCase();return e.jsx("div",{className:"rounded-2xl border border-emerald-500/30 bg-emerald-500/10 p-3 shadow-inner",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"w-9 h-9 rounded-full bg-emerald-600/30 text-emerald-200 flex items-center justify-center text-sm font-semibold",children:c}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"text-sm font-medium text-emerald-100 flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"truncate max-w-[220px]",children:t}),n?.isDraft&&e.jsx("span",{className:"px-2 py-0.5 text-[10px] rounded-full bg-amber-500/15 border border-amber-400/30 text-amber-200 shrink-0",children:"Will create on save"})]}),e.jsxs("div",{className:"text-xs opacity-80 truncate",children:[i&&e.jsx("span",{className:"mr-2",children:i}),a&&e.jsx("span",{children:a})]}),n.address&&e.jsx("div",{className:"text-xs opacity-70 mt-0.5 truncate",children:n.address}),e.jsxs("div",{className:"text-[11px] opacity-60 mt-0.5",children:["ID: ",n.id||n.custId||"â€”"]})]})]}),e.jsx("button",{onClick:s,className:"text-xs px-2 py-1 rounded-md border border-emerald-500/40 text-emerald-200 hover:bg-emerald-500/10",children:"Clear"})]})})}function As({open:n=!1,total:s=0,initial:t={cash:0,upi:0,card:0},onApply:i=()=>{},onClose:a=()=>{}}){const[c,r]=He.useState(t.cash||0),[N,j]=He.useState(t.upi||0),[I,x]=He.useState(t.card||0);if(He.useEffect(()=>{r(t.cash||0),j(t.upi||0),x(t.card||0)},[n]),!n)return null;const G=(Number(c)||0)+(Number(N)||0)+(Number(I)||0),p=Math.round((Number(s)-G)*100)/100,U=Math.max(0,Math.min(100,s?G/s*100:0));return e.jsxs("div",{className:"fixed inset-0 z-40 flex items-end sm:items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"split-title",children:[e.jsx("div",{className:"absolute inset-0 backdrop-blur-[1px] bg-black/60",onClick:a}),e.jsxs("div",{className:"relative z-10 w-full sm:max-w-md mx-auto rounded-2xl border border-white/10 bg-neutral-900/95 p-4 shadow-2xl animate-in fade-in slide-in-from-bottom-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{id:"split-title",className:"text-base font-medium opacity-90",children:"Split Payment"}),e.jsx("button",{className:"text-sm opacity-70 hover:opacity-100",onClick:a,children:"Close"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(wt,{label:"Cash",value:c,onChange:r}),e.jsx(wt,{label:"UPI",value:N,onChange:j}),e.jsx(wt,{label:"Card",value:I,onChange:x})]}),e.jsx("div",{className:"mt-3",children:e.jsx("div",{className:"h-1.5 rounded bg-white/10 overflow-hidden",children:e.jsx("div",{className:"h-full bg-emerald-500/70",style:{width:U+"%"}})})}),e.jsxs("div",{className:"mt-3 text-sm opacity-80",children:["Total: ",e.jsxs("span",{className:"opacity-100",children:["â‚¹",Number(s||0).toFixed(2)]}),e.jsx("span",{className:`ml-2 ${p===0?"text-emerald-400":p>0?"text-yellow-400":"text-red-400"}`,children:p===0?"(balanced)":p>0?`(â‚¹${p.toFixed(2)} remaining)`:`(â‚¹${Math.abs(p).toFixed(2)} over)`})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:a,className:"px-3 py-1.5 rounded-lg border border-white/10 bg-neutral-800/70",children:"Cancel"}),e.jsx("button",{onClick:()=>i({cash:Number(c)||0,upi:Number(N)||0,card:Number(I)||0}),className:"px-3 py-1.5 rounded-lg border border-emerald-500/50 bg-emerald-600/80 hover:bg-emerald-600",children:"Apply"})]})]})]})}function wt({label:n,value:s,onChange:t}){return e.jsxs("label",{className:"block",children:[e.jsx("span",{className:"text-xs opacity-70",children:n}),e.jsx("input",{type:"number",inputMode:"decimal",className:"mt-1 w-full px-3 py-2 rounded-lg bg-neutral-800/70 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400/30",value:s,onChange:i=>t(i.target.value)})]})}function _s({open:n=!1,initial:s={days:"",date:""},onApply:t=()=>{},onClose:i=()=>{}}){const[a,c]=He.useState(s.days||""),[r,N]=He.useState(s.date||"");return He.useEffect(()=>{c(s.days||""),N(s.date||"")},[n]),n?e.jsxs("div",{className:"fixed inset-0 z-40 flex items-end sm:items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"credit-title",children:[e.jsx("div",{className:"absolute inset-0 backdrop-blur-[1px] bg-black/60",onClick:i}),e.jsxs("div",{className:"relative z-10 w-full sm:max-w-md mx-auto rounded-2xl border border-white/10 bg-neutral-900/95 p-4 shadow-2xl animate-in fade-in slide-in-from-bottom-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{id:"credit-title",className:"text-base font-medium opacity-90",children:"Credit Terms"}),e.jsx("button",{className:"text-sm opacity-70 hover:opacity-100",onClick:i,children:"Close"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"block col-span-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:"Days"}),e.jsx("input",{type:"number",className:"mt-1 w-full px-3 py-2 rounded-lg bg-neutral-800/70 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400/30",value:a,onChange:j=>c(j.target.value),placeholder:"e.g., 15"})]}),e.jsxs("label",{className:"block col-span-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:"Due Date"}),e.jsx("input",{type:"date",className:"mt-1 w-full px-3 py-2 rounded-lg bg-neutral-800/70 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400/30",value:r,onChange:j=>N(j.target.value)})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:i,className:"px-3 py-1.5 rounded-lg border border-white/10 bg-neutral-800/70",children:"Cancel"}),e.jsx("button",{onClick:()=>t({days:a?Number(a):void 0,date:r||void 0}),className:"px-3 py-1.5 rounded-lg border border-emerald-500/50 bg-emerald-600/80 hover:bg-emerald-600",children:"Apply"})]})]})]}):null}function We(n){if(n!==void 0){if(n===null)return null;if(Array.isArray(n))return n.map(t=>We(t)).filter(t=>t!==void 0);if(typeof n=="object"){const s={};for(const[t,i]of Object.entries(n)){const a=We(i);a!==void 0&&(s[t]=a)}return s}return n}}function Je(n,s=""){const t=[],i=(a,c)=>{if(a===void 0)t.push(c||"<root>");else if(a&&typeof a=="object")if(Array.isArray(a))a.forEach((r,N)=>i(r,`${c}[${N}]`));else for(const[r,N]of Object.entries(a))i(N,c?`${c}.${r}`:r)};return i(n,s),t}function lt(n="",s=""){if(!n||!s)return 0;const t=r=>new Set(String(r).toLowerCase().split(/[^\p{L}\p{N}]+/u).filter(Boolean)),i=t(n),a=t(s);if(i.size===0||a.size===0)return 0;let c=0;for(const r of i)a.has(r)&&c++;return c/Math.min(i.size,a.size)}function Tt(n=""){return String(n).replace(/[^\d]+/g,"")}function Ps(n="",s=""){const t=Tt(n),i=Tt(s);return t&&i&&(t===i||t.length>=10&&i.length>=10&&t.slice(-10)===i.slice(-10))}function ot(n=""){const s=String(n),i=(s.match(/(\+?\d[\d\s\-]{6,18}\d)/g)||[]).map(c=>c.replace(/[^\d]/g,"")).filter(c=>c.length>=7&&c.length<=13).sort((c,r)=>r.length-c.length);if(i.length)return i[0];const a=s.replace(/[^\d]/g,"");return a.length>=7&&a.length<=13?a:""}function Mt(n=""){const s=String(n).toLowerCase().trim();if(/\b(payment|pay|mode|paise|à¤ªà¥ˆà¤¸à¥‡|payment\s+mode|payment\s+kar|payment\s+karne|payment\s+karo)\b/.test(s)){if(/\bupi|gpay|phonepe|google pay|yupi|à¤¯à¥‚à¤ªà¥€à¤†à¤ˆ|à¤¯à¥‚à¤ªà¥€à¤†à¤ˆ\s+payment\b/.test(s))return{intent:"set_payment",entities:{mode:"upi"}};if(/\bcash|cash\s+payment|cash\b|nagad|à¤¨à¤•à¤¦|à¤¨à¤•à¤¦\s+payment|cash\s+kar|cash\s+karne|cash\s+karo\b/.test(s))return{intent:"set_payment",entities:{mode:"cash"}};if(/\b(card|debit|credit\s+card|debit\s+card|à¤•à¤¾à¤°à¥à¤¡|card\s+kar|card\s+karne|card\s+karo)\b/.test(s))return{intent:"set_payment",entities:{mode:"card"}}}if(/^(payment|pay|mode|paise|à¤ªà¥ˆà¤¸à¥‡)\s+(upi|cash|card|yupi|nagad|à¤•à¤¾à¤°à¥à¤¡)$/.test(s)){const t=s.split(/\s+/)[1];return{intent:"set_payment",entities:{mode:t==="yupi"?"upi":t==="nagad"?"cash":t==="à¤•à¤¾à¤°à¥à¤¡"?"card":t}}}if(/\b(payment|pay|mode)\b/.test(s)&&/\bsplit\b/.test(s)){const t=[...s.matchAll(/\b(\d+(?:\.\d+)?)\s*(cash|upi|card)\b/g)],i={cash:0,upi:0,card:0};for(const a of t){const c=parseFloat(a[1]),r=a[2];Number.isFinite(c)&&(r==="cash"&&(i.cash+=c),r==="upi"&&(i.upi+=c),r==="card"&&(i.card+=c))}return{intent:"set_payment",entities:{mode:"split",paymentMode:"split",splitPayment:i}}}if(/\b(payment|pay|mode)\b/.test(s)&&/\bcredit\b/.test(s)){let t;const i=s.match(/\b(\d{1,3})\s*days?\b/);i&&(t=Math.max(0,parseInt(i[1],10)));let a;const c=s.match(/\bon\s+([0-9]{1,2}[\/\-\s][0-9]{1,2}(?:[\/\-\s][0-9]{2,4})?|\d{1,2}\s+[A-Za-z]{3,9}(?:\s+\d{2,4})?)\b/);return c&&(a=c[1]),{intent:"set_payment",entities:{mode:"credit",paymentMode:"credit",creditDueDays:t,creditDueDate:a}}}if(/\b(payment|pay|mode)\b/.test(s)&&/\badvance\b/.test(s)){const t=s.match(/\badvance\s+(\d+(?:\.\d+)?)\b/),i=t?parseFloat(t[1]):void 0;let a;const c=s.match(/\bdue\s+on\s+([0-9]{1,2}[\/\-\s][0-9]{1,2}(?:[\/\-\s][0-9]{2,4})?|\d{1,2}\s+[A-Za-z]{3,9}(?:\s+\d{2,4})?)\b/);return c&&(a=c[1]),{intent:"set_payment",entities:{mode:"advance",paymentMode:"advance",advancePaid:Number.isFinite(i)?i:void 0,advanceDueDate:a}}}if(/\b(invoice|bill)\s*(type)?\b/.test(s)||/^type\s+/.test(s)){if(/\bretail\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Retail"}};if(/\btax\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Tax"}};if(/\bproforma\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Proforma"}};if(/\bestimate\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Estimate"}};if(/\bquote\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Quote"}}}if(/^retail\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Retail"}};if(/^tax\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Tax"}};if(/^proforma\b/.test(s))return{intent:"set_invoice_type",entities:{type:"Proforma"}};if(/\b(customer|client|buyer|à¤—à¥à¤°à¤¾à¤¹à¤•|customer\s+kar|customer\s+karne|customer\s+karo|client\s+kar|client\s+karne|client\s+karo)\b/.test(s)){const t=s.match(/(\d{10,})/),i=s.match(/(?:customer|client|buyer|à¤—à¥à¤°à¤¾à¤¹à¤•|customer\s+kar|customer\s+karne|customer\s+karo|client\s+kar|client\s+karne|client\s+karo)\s+(\w+)/);return{intent:"set_customer",entities:{phone:t?t[1]:void 0,name:i?i[1]:void 0}}}if(/\b(add|put|include|dal|à¤¡à¤¾à¤²|à¤œà¥‹à¤¡à¤¼|add\s+kar|add\s+karne|add\s+karo)\b/.test(s)||!/\b(payment|invoice|customer|mode|type|gst|payment|pay|mode|invoice|bill|customer|client|buyer)\b/.test(s)&&s.length>2){const t=s.match(/\b(\d+(?:\.\d+)?)\b/),i=t?parseFloat(t[1]):1,a=s.replace(/\b(add|put|include|the|a|an|some|please|plz|dal|à¤¡à¤¾à¤²|à¤œà¥‹à¤¡à¤¼|add\s+kar|add\s+karne|add\s+karo|kar|karne|karo)\b/g,"").replace(/\b\d+(?:\.\d+)?\b/g,"").replace(/\b(g|kg|ml|l|pcs|piece|pieces|gram|grams|kilo|kilogram|liter|litre|pcs|pieces|units|nos|number|numbers)\b/g,"").replace(/\s+/g," ").trim();if(a&&a.length>1)return{intent:"add_item",entities:{name:a,productName:a,qty:i}}}if(/\bgst\b/.test(s)||/\bcgst|sgst|igst\b/.test(s)){const t=/\b(enable|include|apply|add|on)\b/.test(s),i=/\b(disable|remove|exclude|off)\b/.test(s),a=t?!0:i?!1:void 0,c=/\bigst\b/.test(s),r=/\bcgst\b/.test(s),N=/\bsgst\b/.test(s),j=/\bgst\b/.test(s),I=X=>{const F=s.match(new RegExp(`\\b${X}\\b\\s*(\\d{1,3})(?:\\s*%|\\s*percent)?`));return F?Math.max(0,Math.min(100,parseInt(F[1],10))):void 0},x=I("gst"),G=I("cgst"),p=I("sgst"),U=I("igst"),R={};if(c&&(R.includeIGST=a!==void 0?a:!0,U!==void 0&&(R.igstRate=U),R.includeGST=!1,R.includeCGST=!1,R.includeSGST=!1),r||N){const X=a!==void 0?a:!0;if(r&&(R.includeCGST=X),N&&(R.includeSGST=X),G!==void 0&&(R.cgstRate=G),p!==void 0&&(R.sgstRate=p),(r||N)&&G===void 0&&p===void 0&&x!==void 0){const F=Math.round(x/2);r&&(R.cgstRate=F),N&&(R.sgstRate=x-F)}R.includeGST=!1,R.includeIGST=!1}return!c&&!r&&!N&&j&&(R.includeGST=a!==void 0?a:!0,x!==void 0&&(R.gstRate=x),R.includeGST&&(R.includeIGST=!1,R.includeCGST=!1,R.includeSGST=!1)),/\b(no|without)\s+gst\b/.test(s)&&(R.includeGST=!1,R.includeIGST=!1,R.includeCGST=!1,R.includeSGST=!1),typeof R.rate>"u"&&(typeof R.gstRate=="number"?R.rate=R.gstRate:typeof R.igstRate=="number"?R.rate=R.igstRate:typeof R.cgstRate=="number"&&typeof R.sgstRate=="number"&&(R.rate=R.cgstRate+R.sgstRate)),typeof R.includeIGST=="boolean"&&(R.igst=R.includeIGST),typeof R.includeCGST=="boolean"&&(R.cgst=R.includeCGST),typeof R.includeSGST=="boolean"&&(R.sgst=R.includeSGST),{intent:"set_gst",entities:R}}return null}const Ms={colgate:["col get","col gate","colgat","kolkata","kolgate","kolget","kolkata"],dabur:["dabar","dab ur","daboor","daboor","dabur","daboor"],parle:["parley","parly","parli","parle","parley","parli"],haldiram:["haldirum","haldiran","haldi ram","haldiram","haldi ram","haldirum"],parachute:["parachut","parashut","parachoot","parachute","parashut","parachoot"],whey:["way","whey","wey","way","wey","whey"],protein:["proteen","protean","protiin","protein","proteen","protiin"],chocolate:["choclate","choklate","choclet","chocolate","choklate","choclet"],biscuit:["biskit","biscut","biskut","biscuit","biskit","biscut"],toothpaste:["tooth pest","toothpest","tooth paste","toothpaste","tooth pest","toothpest"],shampoo:["shampo","shampoo","shampou","shampoo","shampo","shampou"],soap:["soup","sop","soap","soap","soup","sop"],milk:["milk","milke","mylk","doodh","milk","milke"],bread:["bred","bread","brad","roti","double roti","bread"],butter:["buter","butter","butar","makhan","white butter","butter"],cheese:["chees","cheese","cheez","paneer","cottage cheese","cheese"],yogurt:["yogurt","yoghurt","yogart","dahi","curd","yogurt"],juice:["juis","juice","jus","ras","fresh juice","juice"],water:["watar","water","woter","pani","mineral water","water"],sugar:["suger","sugar","shugar","chini","white sugar","sugar"],salt:["salt","solt","sault","namak","rock salt","salt"],oil:["oyl","oil","oel","tel","cooking oil","oil"],rice:["rys","rice","raice","chawal","basmati rice","rice"],wheat:["wheet","wheat","wheat","gehun","atta","wheat"],flour:["flor","flour","flawer","atta","maida","flour"],spices:["spais","spices","spyces","masala","masale","spices"],masala:["masala","masaala","masaala","masala","spice mix","garam masala"],garam:["garam","garam","garam","garam","hot spices","mixed spices"],haldi:["haldi","haldee","haldi","haldi","turmeric","yellow powder"],jeera:["jeera","jeera","jeera","jeera","cumin","zeera"],dhaniya:["dhaniya","dhaniya","dhaniya","dhaniya","coriander","dhaniya powder"],mirchi:["mirchi","mirchi","mirchi","lal mirchi","red chili","red pepper"],adrak:["adrak","adrak","adrak","adrak","ginger","fresh ginger"],lasun:["lasun","lasun","lasun","lasun","garlic","fresh garlic"],pyaaz:["pyaaz","pyaaz","pyaaz","pyaaz","onion","red onion"],tamatar:["tamatar","tamatar","tamatar","tamatar","tomato","red tomato"],aalu:["aalu","aalu","aalu","aalu","potato","aloo"],gobi:["gobi","gobi","gobi","gobi","cauliflower","phool gobi"],baingan:["baingan","baingan","baingan","baingan","eggplant","brinjal"],kaddu:["kaddu","kaddu","kaddu","kaddu","pumpkin","kaddu"],palak:["palak","palak","palak","palak","spinach","palak leaves"],methi:["methi","methi","methi","methi","fenugreek","methi leaves"],pudina:["pudina","pudina","pudina","pudina","mint","pudina leaves"],kothmir:["kothmir","kothmir","kothmir","dhaniya patta","coriander leaves","dhaniya"],ajwain:["ajwain","ajwain","ajwain","ajwain","carom seeds","ajwain"],saunf:["saunf","saunf","saunf","saunf","fennel seeds","saunf"],elaichi:["elaichi","elaichi","elaichi","elaichi","cardamom","elaichi"],dalchini:["dalchini","dalchini","dalchini","dalchini","cinnamon","dalchini"],"tej patta":["tej patta","tej patta","tej patta","tej patta","bay leaf","tej patta"],"badi elaichi":["badi elaichi","badi elaichi","badi elaichi","badi elaichi","black cardamom","badi elaichi"],"star anise":["star anise","star anise","star anise","star anise","star anise","star anise"],"bay leaf":["bay leaf","bay leaf","bay leaf","bay leaf","bay leaf","bay leaf"],cloves:["cloves","cloves","cloves","cloves","cloves","cloves"],cardamom:["cardamom","cardamom","cardamom","cardamom","cardamom","cardamom"],cinnamon:["cinnamon","cinnamon","cinnamon","cinnamon","cinnamon","cinnamon"],nutmeg:["nutmeg","nutmeg","nutmeg","nutmeg","nutmeg","nutmeg"],mace:["mace","mace","mace","mace","mace","mace"],pepper:["pepper","pepper","pepper","pepper","pepper","pepper"],cumin:["cumin","cumin","cumin","cumin","cumin","cumin"],coriander:["coriander","coriander","coriander","coriander","coriander","coriander"],turmeric:["turmeric","turmeric","turmeric","turmeric","turmeric","turmeric"],"red chili":["red chili","red chili","red chili","red chili","red chili","red chili"],"green chili":["green chili","green chili","green chili","green chili","green chili","green chili"],ginger:["ginger","ginger","ginger","ginger","ginger","ginger"],garlic:["garlic","garlic","garlic","garlic","garlic","garlic"],onion:["onion","onion","onion","onion","onion","onion"],tomato:["tomato","tomato","tomato","tomato","tomato","tomato"],potato:["potato","potato","potato","potato","potato","potato"],cauliflower:["cauliflower","cauliflower","cauliflower","cauliflower","cauliflower","cauliflower"],eggplant:["eggplant","eggplant","eggplant","eggplant","eggplant","eggplant"],pumpkin:["pumpkin","pumpkin","pumpkin","pumpkin","pumpkin","pumpkin"],spinach:["spinach","spinach","spinach","spinach","spinach","spinach"],fenugreek:["fenugreek","fenugreek","fenugreek","fenugreek","fenugreek","fenugreek"],mint:["mint","mint","mint","mint","mint","mint"],"coriander leaves":["coriander leaves","coriander leaves","coriander leaves","coriander leaves","coriander leaves","coriander leaves"],"curry leaves":["curry leaves","curry leaves","curry leaves","curry leaves","curry leaves","curry leaves"]},Os={milk:["doodh","milk","dairy milk"],bread:["roti","bread","double roti"],butter:["makhan","butter","white butter"],cheese:["paneer","cheese","cottage cheese"],yogurt:["dahi","yogurt","curd"],juice:["ras","juice","fresh juice"],water:["pani","water","mineral water"],sugar:["chini","sugar","white sugar"],salt:["namak","salt","rock salt"],oil:["tel","oil","cooking oil"],rice:["chawal","rice","basmati rice"],wheat:["gehun","wheat","atta"],flour:["atta","flour","maida"],spices:["masala","spices","masale"],masala:["masala","spice mix","garam masala"],"garam masala":["garam masala","hot spices","mixed spices"],turmeric:["haldi","turmeric","yellow powder"],cumin:["jeera","cumin","zeera"],coriander:["dhaniya","coriander","dhaniya powder"],"red chili":["lal mirchi","red chili","red pepper"],"green chili":["hari mirchi","green chili","green pepper"],ginger:["adrak","ginger","fresh ginger"],garlic:["lasun","garlic","fresh garlic"],onion:["pyaaz","onion","red onion"],tomato:["tamatar","tomato","red tomato"],potato:["aalu","potato","aloo"],cauliflower:["gobi","cauliflower","phool gobi"],eggplant:["baingan","eggplant","brinjal"],pumpkin:["kaddu","pumpkin","kaddu"],spinach:["palak","spinach","palak leaves"],fenugreek:["methi","fenugreek","methi leaves"],mint:["pudina","mint","pudina leaves"],"coriander leaves":["dhaniya patta","coriander leaves","dhaniya"],"curry leaves":["kadi patta","curry leaves","kari patta"]},ht={EXACT_MATCH:1,PHONETIC_MATCH:.7,PARTIAL_MATCH:.4,SYNONYM_MATCH:.6};function Oe(n){return String(n||"").toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim()}function Fs(n,s){const t=Oe(n),i=Oe(s);for(const[a,c]of Object.entries(Ms))if(c.includes(t)&&c.includes(i)||t===a&&c.includes(i)||i===a&&c.includes(t))return!0;return!1}function Ls(n,s){const t=Oe(n),i=Oe(s);for(const[a,c]of Object.entries(Os))if(c.includes(t)&&c.includes(i))return!0;return!1}function nt(n,s){const t=Oe(n),i=Oe(s);if(t===i)return ht.EXACT_MATCH;if(Fs(t,i))return ht.PHONETIC_MATCH;if(Ls(t,i))return ht.SYNONYM_MATCH;const a=lt(t,i);return t.includes(i)||i.includes(t)?Math.max(a,ht.PARTIAL_MATCH):a}function Qt(n,s=[]){const t=Oe(n),i=t.split(" "),a=t.match(/(\d+)\s*(?:pieces?|pcs?|units?|nos?|kg|gm|g|ml|l|liters?|litres?)/i),c=a?parseInt(a[1]):1,r=t.match(/(\d+)\s*(kg|gm|g|ml|l|liters?|litres?|pieces?|pcs?|units?|nos?)/i),N=r?r[2]:"pieces",I=["colgate","dabur","parle","haldiram","parachute","whey","protein","chocolate","biscuit"].find(p=>t.includes(p)),G=["toothpaste","shampoo","soap","milk","bread","butter","cheese","yogurt","juice","water","sugar","salt","oil","rice","wheat","flour","spices","masala"].find(p=>t.includes(p));return{originalInput:n,normalizedInput:t,words:i,quantity:c,unit:N,brand:I,category:G}}function Kt(n,s=[],t={}){const{maxResults:i=10,minScore:a=.3,includeBrand:c=!0,includeCategory:r=!0,includeSKU:N=!0}=t;Qt(n,s);const j=[];Oe(n);const I={};for(const x of s)if(x.brand){const G=Oe(x.brand);I[G]||(I[G]=[]),I[G].push(x)}for(const x of s){let G=0,p=0;const U={name:0,brand:0,category:0,sku:0,description:0},R=nt(n,x.name||x.productName||"");if(R>0&&(G+=R*.4,p++,U.name=R),c&&x.brand){const F=nt(n,x.brand);F>0&&(G+=F*.25,p++,U.brand=F)}if(r&&x.category){const F=nt(n,x.category);F>0&&(G+=F*.15,p++,U.category=F)}if(N&&x.sku){const F=nt(n,x.sku);F>0&&(G+=F*.15,p++,U.sku=F)}if(x.description){const F=nt(n,x.description);F>0&&(G+=F*.05,p++,U.description=F)}const X=p>0?G/p:0;X>=a&&j.push({product:x,score:X,matchDetails:U,confidence:Math.min(X*100,100),matchedFields:Object.entries(U).filter(([F,pe])=>pe>0).map(([F,pe])=>F),isBrandMatch:U.brand>0,brand:x.brand})}return j.sort((x,G)=>G.score-x.score).slice(0,i)}function Gs(n,s=[],t={}){Oe(n);const i={};for(const c of s)if(c.brand){const r=Oe(c.brand);i[r]||(i[r]=[]),i[r].push(c)}const a=[];for(const[c,r]of Object.entries(i)){const N=nt(n,c);N>.6&&a.push({brand:c,products:r,score:N})}for(const{brand:c,products:r}of a)if(r.length>1)return{shouldShow:!0,brand:c,products:r,message:`Found ${r.length} products for brand "${c}". Please choose:`};return{shouldShow:!1}}function Zt(n,s=[],t={}){return Kt(n,s,t).map(a=>({key:a.product.id||a.product.sku,label:a.product.name||a.product.productName,sublabel:[a.product.brand,a.product.category,a.product.sku].filter(Boolean).join(" â€¢ "),price:a.product.sellingPrice||a.product.price||a.product.mrp,unit:a.product.unit||a.product.packSize,confidence:a.confidence,matchDetails:a.matchDetails,matchedFields:a.matchedFields,product:a.product}))}function zs(n,s,t=[]){const i={originalInput:Oe(n),selectedProduct:{id:s.id,name:s.name||s.productName,brand:s.brand,category:s.category,sku:s.sku},timestamp:new Date().toISOString()};try{const a=JSON.parse(localStorage.getItem("voiceLearningData")||"[]");a.push(i),a.length>100&&a.splice(0,a.length-100),localStorage.setItem("voiceLearningData",JSON.stringify(a))}catch(a){console.warn("Failed to save learning data:",a)}}function Xt(n,s=[]){try{const t=JSON.parse(localStorage.getItem("voiceLearningData")||"[]"),i=Oe(n);return t.filter(c=>lt(i,c.originalInput)>.6).sort((c,r)=>lt(i,r.originalInput)-lt(i,c.originalInput)).slice(0,3).map(c=>{const r=s.find(N=>N.id===c.selectedProduct.id);return r?{key:`learned-${c.timestamp}`,label:r.name||r.productName,sublabel:`Learned from: "${c.originalInput}"`,price:r.sellingPrice||r.price||r.mrp,unit:r.unit||r.packSize,confidence:95,isLearned:!0,product:r}:null}).filter(Boolean)}catch(t){return console.warn("Failed to load learning data:",t),[]}}function Jt(n,s=[],t={}){const{includeLearning:i=!0,...a}=t,c=Zt(n,s,a);return[...i?Xt(n,s):[],...c].reduce((I,x)=>{const G=I.find(p=>p.product.id===x.product.id);if(!G)I.push(x);else if(x.confidence>G.confidence){const p=I.indexOf(G);I[p]=x}return I},[])}const Ot=Object.freeze(Object.defineProperty({__proto__:null,enhancedProductMatcher:Jt,extractProductInfo:Qt,findMatchingProducts:Kt,getLearningSuggestions:Xt,getProductSuggestions:Zt,learnFromCorrection:zs,shouldShowBrandSelection:Gs},Symbol.toStringTag,{value:"Module"})),q={CONNECTION_FAILED:"CONNECTION_FAILED",CONNECTION_TIMEOUT:"CONNECTION_TIMEOUT",CONNECTION_LOST:"CONNECTION_LOST",WEBSOCKET_ERROR:"WEBSOCKET_ERROR",MICROPHONE_ACCESS_DENIED:"MICROPHONE_ACCESS_DENIED",MICROPHONE_NOT_FOUND:"MICROPHONE_NOT_FOUND",AUDIO_PROCESSING_ERROR:"AUDIO_PROCESSING_ERROR",AUDIO_QUALITY_POOR:"AUDIO_QUALITY_POOR",RECOGNITION_FAILED:"RECOGNITION_FAILED",RECOGNITION_TIMEOUT:"RECOGNITION_TIMEOUT",RECOGNITION_NOT_SUPPORTED:"RECOGNITION_NOT_SUPPORTED",RECOGNITION_ABORTED:"RECOGNITION_ABORTED",PARSE_FAILED:"PARSE_FAILED",PARSE_TIMEOUT:"PARSE_TIMEOUT",INVALID_INPUT:"INVALID_INPUT",MEMORY_LOW:"MEMORY_LOW",NETWORK_ERROR:"NETWORK_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR"},ve={LOW:"LOW",MEDIUM:"MEDIUM",HIGH:"HIGH",CRITICAL:"CRITICAL"},ye={RETRY:"RETRY",FALLBACK:"FALLBACK",USER_INTERVENTION:"USER_INTERVENTION",RESTART:"RESTART",IGNORE:"IGNORE"},st={[q.CONNECTION_FAILED]:{severity:ve.HIGH,message:"Connection failed. Retrying...",recovery:ye.RETRY,maxRetries:3,retryDelay:2e3,fallback:"webspeech"},[q.CONNECTION_TIMEOUT]:{severity:ve.MEDIUM,message:"Connection timeout. Switching to fallback...",recovery:ye.FALLBACK,maxRetries:1,retryDelay:1e3,fallback:"webspeech"},[q.CONNECTION_LOST]:{severity:ve.HIGH,message:"Connection lost. Attempting to reconnect...",recovery:ye.RETRY,maxRetries:5,retryDelay:3e3,fallback:"webspeech"},[q.WEBSOCKET_ERROR]:{severity:ve.HIGH,message:"WebSocket error. Switching to Web Speech API...",recovery:ye.FALLBACK,maxRetries:1,retryDelay:1e3,fallback:"webspeech"},[q.MICROPHONE_ACCESS_DENIED]:{severity:ve.CRITICAL,message:"Microphone access denied. Please allow microphone access and try again.",recovery:ye.USER_INTERVENTION,maxRetries:0,retryDelay:0,fallback:null},[q.MICROPHONE_NOT_FOUND]:{severity:ve.CRITICAL,message:"No microphone found. Please connect a microphone and try again.",recovery:ye.USER_INTERVENTION,maxRetries:0,retryDelay:0,fallback:null},[q.AUDIO_PROCESSING_ERROR]:{severity:ve.MEDIUM,message:"Audio processing error. Retrying...",recovery:ye.RETRY,maxRetries:2,retryDelay:1e3,fallback:"webspeech"},[q.AUDIO_QUALITY_POOR]:{severity:ve.LOW,message:"Audio quality is poor. Please speak closer to the microphone.",recovery:ye.IGNORE,maxRetries:0,retryDelay:0,fallback:null},[q.RECOGNITION_FAILED]:{severity:ve.MEDIUM,message:"Recognition failed. Please try again.",recovery:ye.RETRY,maxRetries:2,retryDelay:1500,fallback:"webspeech"},[q.RECOGNITION_TIMEOUT]:{severity:ve.MEDIUM,message:"Recognition timeout. Please try again.",recovery:ye.RETRY,maxRetries:1,retryDelay:2e3,fallback:"webspeech"},[q.RECOGNITION_NOT_SUPPORTED]:{severity:ve.CRITICAL,message:"Voice recognition not supported in this browser.",recovery:ye.USER_INTERVENTION,maxRetries:0,retryDelay:0,fallback:null},[q.RECOGNITION_ABORTED]:{severity:ve.LOW,message:"Recognition aborted.",recovery:ye.IGNORE,maxRetries:0,retryDelay:0,fallback:null},[q.PARSE_FAILED]:{severity:ve.MEDIUM,message:"Failed to understand command. Please try rephrasing.",recovery:ye.USER_INTERVENTION,maxRetries:0,retryDelay:0,fallback:null},[q.PARSE_TIMEOUT]:{severity:ve.MEDIUM,message:"Parse timeout. Retrying...",recovery:ye.RETRY,maxRetries:2,retryDelay:1e3,fallback:null},[q.INVALID_INPUT]:{severity:ve.LOW,message:"Invalid input. Please try again.",recovery:ye.IGNORE,maxRetries:0,retryDelay:0,fallback:null},[q.MEMORY_LOW]:{severity:ve.HIGH,message:"Low memory. Restarting voice capture...",recovery:ye.RESTART,maxRetries:1,retryDelay:2e3,fallback:"webspeech"},[q.NETWORK_ERROR]:{severity:ve.HIGH,message:"Network error. Switching to offline mode...",recovery:ye.FALLBACK,maxRetries:1,retryDelay:1e3,fallback:"webspeech"},[q.UNKNOWN_ERROR]:{severity:ve.MEDIUM,message:"An unexpected error occurred. Retrying...",recovery:ye.RETRY,maxRetries:2,retryDelay:2e3,fallback:"webspeech"}};class es{constructor(s={}){this.options={maxErrorHistory:100,enableAnalytics:!0,enableRecovery:!0,enableFallback:!0,onError:null,onRecovery:null,onFallback:null,...s},this.errorHistory=[],this.retryCounts={},this.recoveryInProgress=!1}handleError(s,t={}){const i=this.categorizeError(s),a=st[i]||st[q.UNKNOWN_ERROR];return this.logError(s,i,t),this.options.enableRecovery&&a.recovery!==ye.USER_INTERVENTION?this.attemptRecovery(i,a,t):{type:i,severity:a.severity,message:a.message,recovery:a.recovery,fallback:a.fallback,canRetry:a.maxRetries>0,retryCount:this.retryCounts[i]||0,maxRetries:a.maxRetries}}categorizeError(s){if(!s)return q.UNKNOWN_ERROR;const t=s.message||s.toString();return s.name,t.includes("connection")||t.includes("connect")?t.includes("timeout")?q.CONNECTION_TIMEOUT:t.includes("lost")||t.includes("closed")?q.CONNECTION_LOST:q.CONNECTION_FAILED:t.includes("websocket")||t.includes("WebSocket")?q.WEBSOCKET_ERROR:t.includes("microphone")||t.includes("mic")?t.includes("denied")||t.includes("permission")?q.MICROPHONE_ACCESS_DENIED:t.includes("not found")||t.includes("unavailable")?q.MICROPHONE_NOT_FOUND:q.AUDIO_PROCESSING_ERROR:t.includes("audio")||t.includes("sound")?t.includes("quality")||t.includes("poor")?q.AUDIO_QUALITY_POOR:q.AUDIO_PROCESSING_ERROR:t.includes("recognition")||t.includes("speech")?t.includes("timeout")?q.RECOGNITION_TIMEOUT:t.includes("aborted")?q.RECOGNITION_ABORTED:t.includes("not supported")?q.RECOGNITION_NOT_SUPPORTED:q.RECOGNITION_FAILED:t.includes("parse")||t.includes("understand")?t.includes("timeout")?q.PARSE_TIMEOUT:t.includes("invalid")?q.INVALID_INPUT:q.PARSE_FAILED:t.includes("network")||t.includes("fetch")?q.NETWORK_ERROR:t.includes("memory")||t.includes("out of memory")?q.MEMORY_LOW:q.UNKNOWN_ERROR}async attemptRecovery(s,t,i){const a=this.retryCounts[s]||0;return a>=t.maxRetries?this.options.enableFallback&&t.fallback?this.attemptFallback(t.fallback,i):{type:s,severity:t.severity,message:`Max retries reached. ${t.message}`,recovery:ye.USER_INTERVENTION,fallback:t.fallback,canRetry:!1,retryCount:a,maxRetries:t.maxRetries}:(this.retryCounts[s]=a+1,await new Promise(c=>setTimeout(c,t.retryDelay)),this.options.onRecovery&&this.options.onRecovery(s,a+1,t),{type:s,severity:t.severity,message:t.message,recovery:t.recovery,fallback:t.fallback,canRetry:!0,retryCount:a+1,maxRetries:t.maxRetries,retryDelay:t.retryDelay})}async attemptFallback(s,t){return this.options.onFallback&&this.options.onFallback(s,t),{type:"FALLBACK_ATTEMPTED",severity:ve.MEDIUM,message:`Switching to ${s}...`,recovery:ye.FALLBACK,fallback:s,canRetry:!1,retryCount:0,maxRetries:0}}logError(s,t,i){const a={timestamp:new Date().toISOString(),type:t,message:s.message||s.toString(),stack:s.stack,context:i,userAgent:navigator.userAgent,url:window.location.href};this.errorHistory.push(a),this.errorHistory.length>this.options.maxErrorHistory&&(this.errorHistory=this.errorHistory.slice(-this.options.maxErrorHistory)),this.options.onError&&this.options.onError(a)}getErrorStats(){const s={totalErrors:this.errorHistory.length,errorTypes:{},recentErrors:this.errorHistory.slice(-10),retryCounts:{...this.retryCounts}};return this.errorHistory.forEach(t=>{s.errorTypes[t.type]=(s.errorTypes[t.type]||0)+1}),s}clearHistory(){this.errorHistory=[],this.retryCounts={}}resetRetryCounts(){this.retryCounts={}}getUserFriendlyMessage(s,t=0){const i=st[s]||st[q.UNKNOWN_ERROR];return t>0?`${i.message} (Attempt ${t+1})`:i.message}isRecoverable(s){const t=st[s]||st[q.UNKNOWN_ERROR];return t.recovery!==ye.USER_INTERVENTION&&t.maxRetries>0}getRecoverySuggestions(s){return{[q.MICROPHONE_ACCESS_DENIED]:["Click the microphone icon in your browser's address bar","Go to browser settings and allow microphone access","Refresh the page and try again"],[q.MICROPHONE_NOT_FOUND]:["Connect a microphone to your device","Check if your microphone is working in other applications","Try refreshing the page"],[q.CONNECTION_FAILED]:["Check your internet connection","Try refreshing the page","Switch to offline mode if available"],[q.RECOGNITION_NOT_SUPPORTED]:["Use a modern browser like Chrome, Firefox, or Safari","Enable JavaScript in your browser","Update your browser to the latest version"],[q.AUDIO_QUALITY_POOR]:["Speak closer to the microphone","Reduce background noise","Speak more clearly and slowly"]}[s]||["Try refreshing the page","Check your internet connection","Contact support if the problem persists"]}}new es;const Ft=()=>new Date().toISOString(),Lt=()=>`CUST-${(Date.now()%1e5).toString().padStart(4,"0")}`;function Bs(n,s=0){const t=Number(n);return Number.isFinite(t)?t:s}function jt(n,s){const t=n||{},i=s||{};let a=(typeof t.type=="string"?t.type:void 0)||(t.igst?"igst":t.cgst||t.sgst?"cgst_sgst":t.gst?"gst":void 0);a||(i.includeIGST?a="igst":i.includeCGST||i.includeSGST?a="cgst_sgst":i.includeGST&&(a="gst")),a=String(a||"").toLowerCase();let c;a==="igst"||t.igst||t.includeIGST?c="igst":a==="cgst_sgst"||t.cgst||t.sgst||t.includeCGST||t.includeSGST?c="cgst_sgst":c="gst";let r;return typeof t.rate<"u"?r=t.rate:c==="igst"&&typeof t.igstRate<"u"?r=t.igstRate:c==="cgst_sgst"&&typeof t.cgstRate<"u"?r=t.cgstRate:c==="gst"&&typeof t.gstRate<"u"?r=t.gstRate:c==="igst"&&typeof i.igstRate<"u"?r=i.igstRate:c==="cgst_sgst"&&typeof i.cgstRate<"u"?r=i.cgstRate:c==="gst"&&typeof i.gstRate<"u"&&(r=i.gstRate),typeof r>"u"&&typeof t.rate<"u"&&(r=t.rate),r=Bs(r,void 0),r>=0&&r<=100||(r=void 0),c==="igst"?{includeIGST:!0,includeCGST:!1,includeSGST:!1,includeGST:!1,igstRate:r??18,gstRate:9,cgstRate:9,sgstRate:9,mode:"igst",rate:r??18}:c==="cgst_sgst"?{includeIGST:!1,includeCGST:!0,includeSGST:!0,includeGST:!1,igstRate:18,gstRate:9,cgstRate:r??9,sgstRate:r??9,mode:"cgst_sgst",rate:r??9}:{includeIGST:!1,includeCGST:!1,includeSGST:!1,includeGST:!0,igstRate:18,gstRate:r??9,cgstRate:9,sgstRate:9,mode:"gst",rate:r??9}}function Gt(n){if(n==null)return NaN;if(typeof n=="number")return n;const t=String(n).trim().match(/(\d+(?:\.\d+)?)/);return t?parseFloat(t[1]):NaN}function ts(n={}){const s=()=>{const i=Array.isArray(n.tags)?n.tags.join(" "):String(n.tags||"");return Gt(i)},t=[n.gstRate,n.inlineGstRate,n.normalized?.effectiveRate,n.normalized?.gstRate,n.product?.gstRate,n.product?.gst,n.meta?.gstRate,n.meta?.gst,s()];for(const i of t){const a=Gt(i);if(Number.isFinite(a)&&a>=0&&a<=100)return a}return 0}function Us(n,s){const t=n||{},i=Array.isArray(s)?s:[];let a=t.displayName||t.productName||t.name||t.product&&(t.product.productName||t.product.name)||t.title||t.itemName||t.label||"";if(!a&&t.sku){const p=i.find(U=>String(U.sku||"").toLowerCase()===String(t.sku).toLowerCase());p&&(a=p.productName||p.name||a)}const c=Number(t.qty??t.quantity??t.q??1)||1,r=Number(t.unitPrice??t.price??t.rate??t.mrp??0)||0;let N=t.discountPct??t.discount_percent,j=t.discountAmount??t.discount_value??t.discountInRs;if(N==null&&j==null){if(t.discountType==="percent")N=t.discount;else if(t.discountType==="amount")j=t.discount;else if(t.discount!=null){const p=Number(t.discount);Number.isFinite(p)&&(p>=0&&p<=100?N=p:j=p)}}let I=Number(t.subtotal??t.total);if(!Number.isFinite(I)){const p=c*r;Number.isFinite(Number(j))&&Number(j)>0?I=Math.max(0,p-Number(j)):Number.isFinite(Number(N))&&Number(N)>0?I=Math.max(0,p*(1-Number(N)/100)):I=p}const x=ts(t),G=t.pricingMode||(t.mode&&String(t.mode).toUpperCase().includes("MRP")?"MRP_INCLUSIVE":void 0)||"BASE_PLUS_GST";return{cartLineId:t.cartLineId,id:t.id,sku:t.sku||"",name:a||"â€”",productName:a||t.productName||t.name||void 0,brand:t.brand||t.product&&t.product.brand||void 0,category:t.category||t.cat||t.product&&t.product.category||void 0,unit:t.unit||t.packSize||t.product&&t.product.unit||void 0,qty:c,unitPrice:r,price:r,discountPct:Number.isFinite(Number(N))?Number(N):void 0,discountAmount:Number.isFinite(Number(j))?Number(j):void 0,subtotal:I,quantity:c,total:I,gstRate:x,pricingMode:G,includeGST:!0,includeCGST:!0,includeSGST:!0,includeIGST:!1,cgstRate:Math.round(x/2),sgstRate:Math.floor(x/2),igstRate:x,taxAmount:x?Math.round(I*x/100):0,cgst:x?Math.round(I*(x/2)/100):0,sgst:x?Math.round(I*(x/2)/100):0,igst:0}}function $s({onExit:n,actions:s,fallbackToWhisper:t,whisperEndpoint:i}){const[a,c]=u.useState([]),[r,N]=u.useState([]),[j,I]=u.useState([]),[x,G]=u.useState([]),[p,U]=u.useState([]),[R,X]=u.useState("Did you meanâ€¦?"),[F,pe]=u.useState([]),[ue,de]=u.useState(null),[l,v]=u.useState(null),L=u.useRef(new es({onError:o=>{console.error("Voice Error:",o),Ye.error(`Voice error: ${o.message}`)},onRecovery:(o,k,g)=>{console.log(`Recovering from ${o}, attempt ${k}`),Ye.info(`Retrying... (${k}/${g.maxRetries})`)},onFallback:o=>{console.log(`Switching to ${o}`),Ye.info(`Switching to ${o}...`)}})),y=ws({autoStopSilenceMs:2e3,onFinalize:o=>{console.log("Voice final transcript:",o),Dt(o)},onPartial:()=>{},onError:o=>{const k=L.current.handleError(o,{context:"voice_capture"});k.recovery==="USER_INTERVENTION"&&Ye.error(k.message)},onStatusChange:o=>{console.log("Voice status changed:",o)},enableWebSocket:!0,enableWebSpeech:!0,language:"en-IN"}),Y=!!y?.isPaused,M=y?.isListening&&!Y,V=u.useRef(!1),[O,J]=u.useState(!1);u.useEffect(()=>{M?(V.current=!0,J(!1)):(V.current&&!Y&&J(!0),V.current=!1)},[M,Y]),u.useEffect(()=>{O&&ee("Auto-stopped (silence)","info")},[O]);const[xe,B]=u.useState(0),$=u.useRef(),[me,le]=u.useState(!1),[Ie,we]=u.useState(!1),[Re,_e]=u.useState(!1),[Te,Ge]=u.useState(""),[d,h]=u.useState(""),[f,A]=u.useState({}),T=u.useRef(0),z=u.useRef(0),P=u.useRef(0),[_,w]=u.useState({});function C(o){try{te.setGSTFlags?.(o)}catch{}w(k=>({...k,...o||{}}))}const[E,Z]=u.useState(!1),[fe,be]=u.useState({cash:0,upi:0,card:0}),[De,Ve]=u.useState(!1),[ze,Ze]=u.useState({days:"",date:""}),[et,ss]=u.useState({}),[ns,as]=u.useState({}),[rs,Rt]=u.useState({}),bt=Te||s?.invoiceConfig?.paymentMode||s?.totals?.paymentMode||"",yt=((o="")=>{const k=String(o).trim().toLowerCase();return k==="retail"?"Retail":k==="tax"?"Tax":k==="proforma"?"Proforma":k==="estimate"?"Estimate":k==="quote"?"Quote":o||""})(d||s?.invoiceConfig?.invoiceType||s?.totals?.invoiceConfig?.invoiceType||""),te={addItemByQuery:o=>s?.addItemByQuery?.(o),updateQty:o=>s?.updateQty?.(o),removeItemByName:o=>s?.removeItemByName?.(o),setCustomerByText:o=>s?.setCustomerByText?.(o),setCharge:(o,k)=>s?.setCharge?.(o,k),setInvoiceType:o=>s?.setInvoiceType?.(o),setGSTFlags:o=>s?.setGSTFlags?.(o),setPayment:o=>s?.setPayment?.(o),saveInvoice:o=>s?.saveInvoice?.(o),undo:()=>s?.undo?.(),canUndo:!!s?.canUndo,cart:s?.cart||[],totals:s?.totals||{grandTotal:0}};function Nt(){const o=s?.invoiceConfig||{},k=s?.totals?.invoiceConfig||{},g=s?.settings||{},m=typeof s?.getSettings=="function"?s.getSettings()||{}:{};return{...o,...k,...g,...m}}u.useEffect(()=>{(async()=>{try{const k=it()?.currentUser?.uid;if(!k)return;const m=(await qe(Qe(ke,"businesses",k,"products"))).docs.map(D=>{const W=D.data();return{...W,id:D.id,name:W.productName?.toLowerCase?.()||"",tags:[W.productName,W.brand,W.sku,W.category].filter(Boolean).map(ge=>String(ge).toLowerCase())}});I(m);try{ee(`Inventory loaded (${m.length})`,"info")}catch{}}catch(k){console.error("Failed to load inventory:",k)}})()},[]),u.useEffect(()=>{(async()=>{try{const o=it()?.currentUser?.uid;if(!o)return;const g=(await qe(Qe(ke,"businesses",o,"customers"))).docs.map(m=>{const D=m.data();return{id:String(D.id||m.id||"").trim(),custId:String(D.custId||m.id||"").trim(),name:String(D.name||"").trim(),phone:String(D.phone||"").trim(),email:String(D.email||"").trim(),address:String(D.address||"").trim(),createdAt:String(D.createdAt||"").trim(),updatedAt:String(D.updatedAt||"").trim(),_needle:`${D.name||""} ${D.phone||""} ${D.email||""} ${D.address||""}`.toLowerCase()}});pe(g)}catch(o){console.error("Failed to load customers:",o)}})()},[]),u.useEffect(()=>()=>{try{y?.stop?.()}catch{}try{y?.clearSegments?.()}catch{}},[]),u.useEffect(()=>{const o=()=>{try{y?.stop?.()}catch{}try{y?.clearFinalTranscript?.(),y?.clearSegments?.()}catch{}};return window.addEventListener("fastBilling:stopMic",o),()=>window.removeEventListener("fastBilling:stopMic",o)},[y]),u.useEffect(()=>{Y||y?.finalTranscript&&Dt(y.finalTranscript)},[y?.finalTranscript,Y]),u.useEffect(()=>{const o=k=>{const g=k.detail;if(!g)return;const{name:m,sku:D,qty:W}=g;m&&W?(te.addItemByQuery?.({name:m,sku:D,qty:W}),ee(`+ ${W} Ã— ${m}`,"ok")):ee("Didn't find product","warn")};return window.addEventListener("voice-product-resolved",o),()=>window.removeEventListener("voice-product-resolved",o)},[]),u.useEffect(()=>{const o=k=>{if(p.length){if(k.key==="Escape"){k.preventDefault(),je();return}if(k.key==="Enter"){k.preventDefault(),St(0);return}if(/^[1-9]$/.test(k.key)){const g=parseInt(k.key,10)-1;g>=0&&g<p.length&&(k.preventDefault(),St(g))}}};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[p]);function ee(o,k="info",g=null){const D={id:crypto.randomUUID?.()||`${Date.now()}-${Math.random()}-${o}`,text:o,type:k,action:g,ts:Date.now()};c(W=>[D,...W].slice(0,10)),N(W=>[D,...W].slice(0,30))}function je(){U([]),X("Did you meanâ€¦?")}function dt(o,k,g){const m=k.map((D,W)=>({key:`${D.sku||"nosku"}-${D.id||W}`,displayName:D.productName||D.name||"â€”",unit:D.unit||D.packSize||"",brand:D.brand||"",sku:D.sku||"",price:typeof D.price=="number"?D.price:typeof D.mrp=="number"?D.mrp:void 0,qty:g,add:()=>{je();const ge=Number.isFinite(Number(g))?Number(g):1;te.addItemByQuery?.({productName:D.productName||D.name,name:D.name,sku:D.sku,qty:ge}),ee(`+ ${ge} Ã— ${D.productName||D.name}${D.unit?` (${D.unit})`:""}`,"ok")}}));X(o||"Did you meanâ€¦?"),U(m)}function is(o,k){const g=k.map((m,D)=>({key:`${m.id||m.custId||D}`,displayName:m.name||m.phone||"â€”",unit:m.phone||"",brand:m.email||"",sku:m.id||m.custId||"",price:void 0,qty:1,add:()=>{je();const W={id:m.id||m.custId,...m};de(W),v(null),te.setCustomerByText?.(W),ee(`Customer: ${m.name||m.phone}`,"ok")}}));X(o),U(g)}function St(o){const k=typeof o=="number"?p[o]:o;if(k)return typeof k.add=="function"?k.add():k.onPick?k.onPick(k):null}async function Dt(o){if(Y||!o||!o.trim())return;const k=Mt(o);if(k&&k.intent){$e(k,o),G(m=>[{text:o,ts:Date.now()},...m].slice(0,20));try{y?.clearFinalTranscript?.()}catch{}return}const g=it()?.currentUser?.uid;if(!g){ee("Not logged in","warn");return}if(Date.now()<z.current){const m=String(o||"").toLowerCase();if(/\b(customer|client|buyer|customer details?)\b/.test(m)){const W=ot(o),ge=m.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/),ie=m.match(/(?:name|named|call(?:ed)?|customer)\s*[:\-\s]*([a-zA-Z ]{2,})/),se={};W&&(se.phone=W),ge&&ge[0]&&(se.email=ge[0]),ie&&ie[1]&&ie[1]!=="customer"&&(se.name=ie[1].trim()),je(),$e({intent:"set_customer",entities:se},o)}else je(),$e({intent:""},o);G(W=>[{text:o,ts:Date.now()},...W].slice(0,20));try{y?.clearFinalTranscript?.()}catch{}return}try{let m=await fetch("https://us-central1-stockpilotv1.cloudfunctions.net/parse",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:String(o).slice(0,200),userId:g,locale:"en-IN",intentHints:["add_product","set_customer","set_payment","set_gst","set_invoice_type"]})});if(!m.ok){const W=await m.text().catch(()=>"");console.error("Parse API non-OK",m.status,W),T.current+=1,T.current>=3&&(z.current=Date.now()+120*1e3,Date.now()-P.current>6e4&&(ee("Parser offline. Using local matching for a bitâ€¦","info"),P.current=Date.now()));const ge=String(o||"").toLowerCase();if(/\b(customer|client|buyer|customer details?)\b/.test(ge)){const se=ot(o),oe=ge.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/),ne=ge.match(/(?:name|named|call(?:ed)?|customer)\s*[:\-\s]*([a-zA-Z ]{2,})/),he={};se&&(he.phone=se),oe&&oe[0]&&(he.email=oe[0]),ne&&ne[1]&&ne[1]!=="customer"&&(he.name=ne[1].trim()),je(),$e({intent:"set_customer",entities:he},o)}else je(),$e({intent:""},o);G(se=>[{text:o,ts:Date.now()},...se].slice(0,20));try{y?.clearFinalTranscript?.()}catch{}return}m=await m.json(),T.current=0;const D={intent:String(m.intent||m.action||"").toLowerCase().replace(/\s+/g,"_"),entities:m.entities||m.slots||{}};try{const W=String(o||"").toLowerCase();if(/\b(customer|client|buyer|customer details?)\b/.test(W)){D.intent="set_customer";const ie=ot(o),se=W.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/),oe=W.match(/(?:name|named|call(?:ed)?|customer)\s*[:\-\s]*([a-zA-Z ]{2,})/),ne={...D.entities||{}};ie&&(ne.phone=ie),se&&se[0]&&(ne.email=se[0]),oe&&oe[1]&&oe[1]!=="customer"&&(ne.name=oe[1].trim()),D.entities=ne}}catch{}if(!D.intent){const W=String(o||"").toLowerCase();if(/\b(customer|client|buyer|customer details?)\b/.test(W)){const ie=ot(o),se=W.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/),oe=W.match(/(?:name|named|call(?:ed)?|customer)\s*[:\-\s]*([a-zA-Z ]{2,})/),ne={};ie&&(ne.phone=ie),se&&se[0]&&(ne.email=se[0]),oe&&oe[1]&&oe[1]!=="customer"&&(ne.name=oe[1].trim()),je(),$e({intent:"set_customer",entities:ne},o)}else je(),$e({intent:""},o);G(ie=>[{text:o,ts:Date.now()},...ie].slice(0,20));try{y?.clearFinalTranscript?.()}catch{}return}document.dispatchEvent(new CustomEvent("fastBilling:intent",{detail:{...m,raw:o}})),je(),$e(D,o),G(W=>[{text:o,ts:Date.now()},...W].slice(0,20));try{y?.clearFinalTranscript?.()}catch{}}catch(m){console.error("âŒ Parse API Error",m),console.log("Falling back to local parsing for:",o);const D=Mt(o);if(console.log("Local parse result:",D),D.intent&&D.intent!=="unknown"){ee("Using local parser (Cloud Function unavailable)","info"),$e(D,o),G(W=>[{text:o,ts:Date.now()},...W].slice(0,20));try{y?.clearFinalTranscript?.()}catch{}return}else{ee("Could not understand command","warn"),G(W=>[{text:o,ts:Date.now()},...W].slice(0,20));try{y?.clearFinalTranscript?.()}catch{}}}}function os(o){if(o){if(s?.viewInvoice)return s.viewInvoice(o);if(s?.openInvoice)return s.openInvoice(o);if(s?.goToInvoice)return s.goToInvoice(o);document.dispatchEvent(new CustomEvent("fastBilling:viewInvoice",{detail:{invoiceId:o}}))}}async function Et(){try{const o=Number(te.totals?.grandTotal||0);if(!(Array.isArray(te.cart)&&te.cart.length>0)||!(o>0)){ee("Add at least one item before saving","warn");return}const g=it()?.currentUser?.uid;if(l&&g){const ce=We({...l});delete ce.isDraft,await gt(Ue(ke,"businesses",g,"customers",ce.id),ce,{merge:!0}),pe(K=>[{...ce,_needle:`${ce.name||""} ${ce.phone||""} ${ce.email||""} ${ce.address||""}`.toLowerCase()},...K]),v(null),ee(`Customer created: ${ce.name||ce.phone}`,"ok")}const m=(()=>{const ce={...f||{}};if((Te||s?.invoiceConfig?.paymentMode||s?.totals?.invoiceConfig?.paymentMode)==="split"){const K=ce.splitPayment||{};ce.splitPayment={cash:Math.max(0,Number(K.cash)||0),upi:Math.max(0,Number(K.upi)||0),card:Math.max(0,Number(K.card)||0)}}return(Te||s?.invoiceConfig?.paymentMode||s?.totals?.invoiceConfig?.paymentMode)==="credit"&&(ce.creditDueDays!=null&&(ce.creditDueDays=Math.max(0,parseInt(ce.creditDueDays,10)||0)),ce.creditDueDate!=null&&typeof ce.creditDueDate!="string"&&(ce.creditDueDate=String(ce.creditDueDate))),ce})(),D={...s?.invoiceConfig||s?.totals?.invoiceConfig||{},paymentMode:s?.invoiceConfig?.paymentMode||s?.totals?.invoiceConfig?.paymentMode||bt||"",invoiceType:s?.invoiceConfig?.invoiceType||s?.totals?.invoiceConfig?.invoiceType||yt||"",...m},W=We(D),ge=We((te.cart||[]).map(ce=>Us(ce,j))),ie=We(te.totals),se=ue?We({id:ue.id||ue.custId,name:ue.name||"",phone:ue.phone||"",email:ue.email||"",address:ue.address||""}):void 0,oe=String(W.paymentMode||"").toLowerCase(),ne=f||{},he=ne.splitPayment||{},Xe=Number(ne.advancePaid||0)||0;let Ae=ne.creditDueDays!=null?Math.max(0,parseInt(ne.creditDueDays,10)||0):void 0,Q=ne.creditDueDate!=null&&String(ne.creditDueDate).trim()?String(ne.creditDueDate).trim():void 0;if(!Q&&Ae!=null){const ce=new Date;ce.setDate(ce.getDate()+Ae),Q=ce.toISOString().slice(0,10)}const H={isCredit:oe==="credit",isSplit:oe==="split",isAdvance:oe==="advance"},Ne={mode:oe,splitPayment:{cash:Math.max(0,Number(he.cash)||0),upi:Math.max(0,Number(he.upi)||0),card:Math.max(0,Number(he.card)||0)},advancePaid:Xe,creditDueDays:Ae,creditDueDate:Q,status:oe==="credit"?"pending":"paid"},Ce=We({mode:"fast",invoiceConfig:W,cartOverride:ge,cartItems:ge,itemsOverride:ge,totalsOverride:ie,customerOverride:se,paymentFlags:H,paymentSummary:Ne,...{paymentMode:oe,creditDueDate:Q||null,isPaid:oe!=="credit"},meta:{source:"fastBilling",publishedAt:new Date().toISOString()}}),Me=[...Je({invoiceConfig:W}),...Je({cartOverride:ge}),...Je({totalsOverride:ie}),...Je({customerOverride:se})].filter(Boolean);Me.length&&console.warn("[FastBilling] Preflight: found undefined at:",Me);const Fe=await te.saveInvoice?.(Ce);try{Ye.success(Fe?`Invoice published (#${Fe})`:"Invoice published")}catch{}ee(Fe?`Invoice saved #${Fe}`:"Invoice saved","ok",Fe?()=>os(Fe):null),document.dispatchEvent(new CustomEvent("fastBilling:published",{detail:{invoiceId:Fe||null,source:"fast"}}));try{y?.clearSegments?.()}catch{}}catch(o){console.error("Publish failed:",o);const k=String(o?.message||"");if(/Unsupported field value: undefined/i.test(k)){const g=[...Je({invoiceConfig:s?.invoiceConfig}),...Je({totals:s?.totals}),...Je({cart:s?.cart})].filter(Boolean);console.error("[FastBilling] Host state has undefined at:",g),ee("Publish failed: some fields are undefined. Check console for paths.","warn")}else ee("Save failed","warn")}}async function $e(o,k){const g=String(o?.intent||"").toLowerCase().replace(/\s+/g,"_"),m=o?.entities||{},D=String(k||"");if(["add_item","add_to_cart","addproduct","add_product","add","additem","insert_item","insert_to_cart"].includes(g)){const Q=Number(m.qty??1)||1,H=!!(m.sku||m.productId||m.exact===!0||typeof m.confidence=="number"&&m.confidence>=.96),Ne=String(m.productName||m.name||"").trim();if(Ne.length<=2||Ne.split(/\s+/).length,H){je(),te.addItemByQuery?.({productName:m.productName||m.name,name:m.name,sku:m.sku,qty:Q,...m}),ee(`+ ${Q} Ã— ${m.productName||m.name||m.sku||"item"}`,"ok");return}}switch(g){case"change_qty":case"update_qty":{te.updateQty?.(m),ee(`Qty ${m.name} â†’ ${m.qty}`,"ok");return}case"set_qty":{te.updateQty?.(m),ee(`Qty ${m.name} â†’ ${m.qty}`,"ok");return}case"remove_item":case"delete_item":{te.removeItemByName?.(m.name),ee(`Removed ${m.name}`,"ok");return}case"set_customer":{const Q=m||{};if(!it()?.currentUser?.uid){ee("Not logged in","warn");return}const Ne=ot(D),Ee=Tt(Q.phone||Ne||""),Ce=String(Q.email||"").toLowerCase().trim();let Me=String(Q.name||"").trim();Me.toLowerCase()==="customer"&&(Me="");const Fe=(Ee||Ce||Me).toLowerCase();if(Ee){const K=F.find(ae=>Ps(ae.phone,Ee));if(K){je();const ae={id:K.id,...K};de(ae),v(null),te.setCustomerByText?.(ae),ee(`Customer: ${K.name||K.phone}${K.address?` â€¢ ${K.address}`:""}`,"ok");return}}if(Ce){const K=F.find(ae=>(ae.email||"").toLowerCase()===Ce);if(K){je();const ae={id:K.id,...K};de(ae),v(null),te.setCustomerByText?.(ae),ee(`Customer: ${K.name||K.phone}${K.address?` â€¢ ${K.address}`:""}`,"ok");return}}if(Me&&F.length){const K=F.filter(ae=>(ae.name||"").toLowerCase()===Me.toLowerCase());if(K.length===1){je();const ae={id:K[0].id,...K[0]};de(ae),v(null),te.setCustomerByText?.(ae),ee(`Customer: ${K[0].name||K[0].phone}${K[0].address?` â€¢ ${K[0].address}`:""}`,"ok");return}}if(Fe){const K=F.map(ae=>({c:ae,score:lt(Fe,ae._needle||"")})).filter(ae=>ae.score>.48).sort((ae,Be)=>Be.score-ae.score).slice(0,5);if(K.length>=2){is("Which customer did you mean?",K.map(ae=>ae.c));return}if(K.length===1&&K[0].score>=.92){const ae=K[0].c;je();const Be={id:ae.id,...ae};de(Be),v(null),te.setCustomerByText?.(Be),ee(`Customer: ${ae.name||ae.phone}${ae.address?` â€¢ ${ae.address}`:""}`,"ok");return}}if(Me||Ee||Ce||Q.address){const K=Lt(),ae=Ft(),Be={id:K,custId:K,name:Me||"",phone:Ee||"",email:Ce||"",address:String(Q.address||"").trim(),createdAt:ae,updatedAt:ae,isDraft:!0},rt={id:K,...Be};de(rt),v(Be),te.setCustomerByText?.(rt),ee("New customer will be created on Save","ok");return}{const K=Lt(),ae=Ft(),Be={id:K,custId:K,name:"Walk-in",phone:"",email:"",address:"",createdAt:ae,updatedAt:ae,isDraft:!0},rt={id:K,...Be};de(rt),v(Be),te.setCustomerByText?.(rt),ee("Walk-in customer selected (will be created on Save)","ok");return}}case"set_charge":{te.setCharge?.(m.key,m.amount),ee(`Charge: ${m.key} â‚¹${m.amount}`,"ok");return}case"set_invoice_type":{te.setInvoiceType?.(m.type),h(String(m.type||"")),ee(`Type: ${m.type}`,"ok");return}case"set_gst":{const Q=Nt(),H=jt(m||{},Q);if(!(H&&Number.isFinite(Number(H.rate))&&Number(H.rate)>=0)){const Ce=H.mode||"gst",Me=`Select ${Ce.toUpperCase()} rate`,Fe=[0,5,12,18].map(ce=>({key:`${Ce}-${ce}`,displayName:`${ce}%`,unit:"",brand:"",sku:"",price:void 0,qty:1,onPick:()=>{const K=jt({...m,rate:ce,type:Ce},Q);C(K),ee(`${Ce.toUpperCase()} ${ce}% applied`,"ok")}}));dt(Me,Fe,1),ee("GST updated (choose a rate)","info");return}C(H);const Ee=(H.mode||"GST").toUpperCase();ee(`${Ee} ${H.rate}% applied`,"ok");return}case"set_payment":{const{mode:Q,paymentMode:H,...Ne}=m||{},Ee=We(Ne||{});if(A(Ee),te.setPayment?.({mode:Q||H,paymentMode:H||Q,...Ee}),Ge(String(Q||H||"").toLowerCase()),ee(`Payment: ${Q||H}`,"ok"),Q==="split"||H==="split"){const Ce=m.splitPayment||{};Number(Ce.cash)||Number(Ce.upi)||Number(Ce.card)||(be({cash:0,upi:0,card:0}),Z(!0))}(Q==="credit"||H==="credit")&&(m.creditDueDays!=null&&m.creditDueDays!==""||m.creditDueDate&&String(m.creditDueDate).trim()||(Ze({days:"",date:""}),Ve(!0)));return}case"set_discount":{const{name:Q,pct:H,amt:Ne}=m||{};if(typeof s?.setLineDiscount=="function"){s.setLineDiscount({name:Q,pct:H,amt:Ne}),ee(`Discount ${H!=null?H+"%":"â‚¹"+Ne}${Q?` on ${Q}`:""}`,"ok");return}if(typeof s?.applyDiscount=="function"){s.applyDiscount({name:Q,pct:H,amt:Ne}),ee(`Discount ${H!=null?H+"%":"â‚¹"+Ne}${Q?` on ${Q}`:""}`,"ok");return}ee("Discount action not wired to host. Implement actions.setLineDiscount/applyDiscount.","warn");return}case"finalize":{Et();return}}const ie=D.toLowerCase().match(/\b\d+(?:\.\d+)?\b/),se=ie?ie[0].includes(".")?parseFloat(ie[0]):parseInt(ie[0]):Number(m.qty??1)||1,{shouldShowBrandSelection:oe}=await _t(async()=>{const{shouldShowBrandSelection:Q}=await Promise.resolve().then(()=>Ot);return{shouldShowBrandSelection:Q}},void 0),ne=oe(D,j,{minScore:.6});if(ne.shouldShow){const Q=ne.products.map(H=>({key:H.id||H.sku,displayName:H.productName||H.name,unit:H.unit||H.packSize,brand:H.brand,sku:H.sku,price:H.sellingPrice||H.price||H.mrp,add:()=>{je(),te.addItemByQuery?.({productName:H.productName||H.name,name:H.name,sku:H.sku,qty:se,...H}),ee(`+ ${se} Ã— ${H.productName||H.name}`,"ok")}}));dt(ne.message,Q,se);return}const he=Jt(D,j,{maxResults:7,minScore:.3,includeLearning:!0});if(he.length===0){ee("No products found. Try a different name or check spelling.","warn");return}const Xe=new Map;for(const Q of he){const H=Q.product,Ne=(H.productName||H.name||"").toLowerCase().replace(/\b(ml|ltr|liter|litre|gm|g|kg|pcs|piece|bag|box|bottle|pack|tube|jar|can|sachet|\d+\s*(ml|g|kg|ltr))\b/g,"").replace(/\s{2,}/g," ").trim();if(!Ne)continue;const Ee=Xe.get(Ne)||[];Ee.push({...Q,score:Q.confidence/100}),Xe.set(Ne,Ee)}for(const[,Q]of Xe.entries())if(Q.length>=2){const H=Q.sort((Ne,Ee)=>Ee.score-Ne.score).slice(0,5);dt("Which one did you mean?",H,se);return}const Ae=he[0];if(Ae&&Ae.confidence>=80){if(je(),te.addItemByQuery?.({productName:Ae.product.productName||Ae.product.name,name:Ae.product.name,sku:Ae.product.sku,qty:se,...Ae.product}),ee(`+ ${se} Ã— ${Ae.product.productName||Ae.product.name}`,"ok"),!Ae.isLearned)try{const{learnFromCorrection:Q}=await _t(async()=>{const{learnFromCorrection:H}=await Promise.resolve().then(()=>Ot);return{learnFromCorrection:H}},void 0);Q(D,Ae.product,j)}catch(Q){console.warn("Failed to save learning data:",Q)}return}dt("Select product",he,se)}u.useEffect(()=>{const o=Number(te.totals?.grandTotal||0),k=typeof requestAnimationFrame=="function"?requestAnimationFrame:ie=>setTimeout(()=>ie(Date.now()),16),g=typeof cancelAnimationFrame=="function"?cancelAnimationFrame:clearTimeout;let m=xe,D;const W=400;if($.current!=null){try{g($.current)}catch{}$.current=null}function ge(ie){D||(D=ie);const se=ie-D,oe=Math.min(1,se/W),ne=m+(o-m)*oe;B(ne),oe<1?$.current=k(ge):(B(o),$.current=null)}return m!==o?$.current=k(ge):B(o),()=>{if($.current!=null){try{g($.current)}catch{}$.current=null}}},[te.totals?.grandTotal]),u.useEffect(()=>{const o=new Set((te.cart||[]).map((k,g)=>k.cartLineId||k.id||`${k.sku||k.name||"row"}-${g}`));Rt(k=>{const g={...k};return Object.keys(g).forEach(m=>{o.has(m)||delete g[m]}),g})},[te.cart]);const At=y?.connectionState||"unknown";return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative grid gap-4 "+(me?"grid-cols-1 xl:grid-cols-2":"grid-cols-1"),children:[e.jsxs("div",{className:"w-full space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-gradient-to-r from-neutral-900/80 via-neutral-900/60 to-neutral-800/60 p-4 flex items-center gap-3",children:[e.jsx("div",{className:"text-lg font-semibold tracking-wide",children:"Fast Billing"}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsx("span",{className:"px-2 py-0.5 text-xs rounded-full border "+(M?"border-emerald-400/40 bg-emerald-400/10 text-emerald-300":"border-white/20 text-white/70"),children:M?"Listening":"Paused"}),e.jsxs("span",{className:"px-2 py-0.5 text-xs rounded-full border "+(At==="open"?"border-sky-400/40 bg-sky-400/10 text-sky-300":"border-white/20 text-white/70"),children:["WS: ",At]}),e.jsx("button",{type:"button",onClick:()=>_e(!0),className:"px-2.5 py-1 rounded-lg text-xs border border-white/15 hover:border-white/30 hover:backdrop-blur-md transition-colors","aria-label":"Open voice help",children:"?"})]})]}),e.jsx(ks,{listening:M,paused:Y,autoStopped:O,wsState:y?.connectionState||"closed",vu:y?.audioLevel||0,lastPartial:y?.lastPartial||"",onToggleMic:()=>{if(!y)return;if(y.isListening&&!y.isPaused){try{y.stop?.()}catch{}try{y.clearSegments?.()}catch{}J(!1),ee("Paused","info")}else{try{y.start?.()}catch{}J(!1),ee("Listeningâ€¦","info")}},onClearTranscripts:()=>{try{y?.clearSegments?.()}catch{}ee("Cleared","info")},activity:r,chips:a}),ue&&e.jsx(Es,{customer:ue,onClear:()=>{de(null),v(null)}}),p.length>0&&e.jsx(Ds,{title:R,suggestions:p,onPick:St,onDismiss:je}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 items-center",children:[e.jsx("button",{disabled:!te.canUndo,onClick:te.undo,className:"px-3 py-1.5 rounded-xl border border-white/15 disabled:opacity-50 hover:border-white/30 hover:bg-white/5 transition-colors",title:"Undo last action",children:"â†©ï¸Ž Undo"}),e.jsx("button",{onClick:()=>le(o=>!o),className:"px-3 py-1.5 rounded-xl border border-white/15 hover:border-white/30 hover:bg-white/5 transition-colors text-white/85","aria-pressed":me,title:"Toggle live invoice preview",children:me?"Hide Preview":"Show Preview"}),e.jsx("button",{onClick:()=>we(o=>!o),className:"px-3 py-1.5 rounded-xl border border-white/15 hover:border-white/30 hover:bg-white/5 transition-colors text-white/85","aria-pressed":Ie,title:"Quick settings",children:Ie?"Hide Settings":"Show Settings"}),e.jsxs("div",{className:"ml-auto hidden md:flex items-center gap-2 text-xs text-white/60",children:[e.jsx("span",{className:"px-1.5 py-0.5 rounded border border-white/15 bg-white/5",children:"Space"}),"to start/stop mic"]}),e.jsx("button",{onClick:n,className:"ml-auto md:ml-0 px-3 py-1.5 rounded-xl border border-red-400/30 text-red-200/90 hover:border-red-400/60 hover:bg-red-500/10 transition-colors",title:"Exit fast billing",children:"âœ• Exit"})]}),Ie&&e.jsx("div",{className:"w-full mb-2",children:e.jsx("div",{className:"rounded-2xl border border-white/10 bg-neutral-900/80 p-4 mb-2 shadow",children:e.jsx(Yt,{settings:Nt(),onChange:o=>{const k=jt({type:o.includeIGST?"igst":o.includeCGST||o.includeSGST?"cgst_sgst":"gst",rate:o.includeIGST?o.igstRate:o.includeCGST?o.cgstRate:o.gstRate,igst:!!o.includeIGST,cgst:!!o.includeCGST,sgst:!!o.includeSGST,gst:!!o.includeGST},o);te.setInvoiceType?.(o.invoiceType),te.setPayment?.({mode:o.paymentMode,...o}),C(k)}})})}),e.jsx("div",{className:"w-full",children:e.jsx(Ts,{cart:te.cart,inventory:j,shadowQtys:rs,setShadowQtys:Rt,discountModes:et,setDiscountModes:ss,discountDrafts:ns,setDiscountDrafts:as,onQtyChange:({lineKey:o,cartLineId:k,id:g,sku:m,name:D,qty:W})=>te.updateQty?.({lineKey:o,cartLineId:k,id:g,sku:m,name:D,qty:W}),onSetDiscount:o=>{const k={lineKey:o.lineKey,cartLineId:o.cartLineId,id:o.id,sku:o.sku,name:o.name,discountPct:o.discountPct,discountAmt:o.discountAmt,...o.discount!=null?{discount:o.discount}:{}};typeof s?.setLineDiscount=="function"?s.setLineDiscount(k):typeof s?.applyDiscount=="function"?s.applyDiscount(k):te.updateQty?.(k)},onRemoveLine:o=>typeof s?.removeItem=="function"?s.removeItem(o):te.removeItemByName?.(o?.name)})})]}),me&&e.jsx("div",{className:"w-full space-y-4",children:e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-neutral-900/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm opacity-75 select-none",children:"Invoice Preview"}),e.jsx("div",{className:"text-xs text-white/60",children:"Live with GST & discounts"})]}),(()=>{const o=(te.cart||[]).map((g,m)=>{g.cartLineId||g.id||`${g.sku||g.name||"row"}${m}`;let D=g.displayName||g.productName||g.name||g.product&&(g.product.productName||g.product.name)||g.title||g.itemName||g.label||"";if(!D&&g.sku&&Array.isArray(j)&&j.length){const he=j.find(Xe=>(Xe.sku||"").toLowerCase()===String(g.sku).toLowerCase());he&&(D=he.productName||he.name||D)}const W=Number(g.qty??g.quantity??g.q??1)||1,ge=Number(g.unitPrice??g.price??g.rate??g.mrp??0)||0;let ie=g.discountPct??g.discount_percent,se=g.discountAmount??g.discount_value??g.discountInRs;if(ie==null&&se==null){if(g.discountType==="percent")ie=g.discount;else if(g.discountType==="amount")se=g.discount;else if(g.discount!=null){const he=Number(g.discount);Number.isFinite(he)&&(he>=0&&he<=100?ie=he:se=he)}}let oe=Number(g.subtotal??g.total);if(!Number.isFinite(oe)){const he=W*ge;Number.isFinite(Number(se))&&Number(se)>0?oe=Math.max(0,he-Number(se)):Number.isFinite(Number(ie))&&Number(ie)>0?oe=Math.max(0,he*(1-Number(ie)/100)):oe=he}const ne=ts(g);return{name:D||"â€”",brand:g.brand||g.product&&g.product.brand||"",category:g.category||g.cat||g.product&&g.product.category||"",unit:g.unit||g.packSize||g.product&&g.product.unit||"",qty:W,price:ge,sku:g.sku||"",discountPercent:Number.isFinite(Number(ie))?Number(ie):void 0,discountAmount:Number.isFinite(Number(se))?Number(se):void 0,subtotal:oe,gstRate:ne,pricingMode:g.pricingMode||(g.mode&&String(g.mode).toUpperCase().includes("MRP")?"MRP_INCLUSIVE":void 0)||"BASE_PLUS_GST",includeGST:!0,includeCGST:!0,includeSGST:!0,includeIGST:!1,cgstRate:Math.round(ne/2),sgstRate:Math.floor(ne/2),igstRate:ne,taxAmount:ne?Math.round(oe*ne/100):0,cgst:ne?Math.round(oe*(ne/2)/100):0,sgst:ne?Math.round(oe*(ne/2)/100):0,igst:0}}),k={...Nt(),..._,includeGST:_.includeGST??!0,includeCGST:_.includeCGST??!0,includeSGST:_.includeSGST??!0,includeIGST:_.includeIGST??!1,gstRate:_.gstRate??18,cgstRate:_.cgstRate??9,sgstRate:_.sgstRate??9,igstRate:_.igstRate??18,paymentMode:bt,invoiceType:yt,...f||{}};return e.jsx(Ct,{cart:o,items:o,totals:te.totals,customer:ue,settings:k,paymentMode:bt,invoiceType:yt,invoiceConfig:k})})(),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsx("button",{onClick:Et,className:"px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold",children:"Finalize & Save"}),e.jsxs("div",{className:"ml-auto text-sm opacity-70",children:["Grand Total: â‚¹",Number(xe||0).toFixed(2)]})]})]})})]}),e.jsx(As,{open:E,total:te?.totals?.grandTotal||0,initial:fe,onApply:o=>{be(o),Z(!1),A(k=>({...k||{},splitPayment:o}))},onClose:()=>Z(!1)}),e.jsx(_s,{open:De,initial:ze,onApply:o=>{Ze(o),Ve(!1),A(k=>({...k||{},creditDueDays:o.days,creditDueDate:o.date}))},onClose:()=>Ve(!1)}),Re&&e.jsxs("div",{className:"fixed inset-0 z-[70] flex items-end sm:items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>_e(!1)}),e.jsxs("div",{className:"relative w-full sm:w-[580px] max-h-[85vh] overflow-auto rounded-2xl border border-white/10 bg-neutral-900/95 shadow-2xl p-4 m-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"text-base font-semibold",children:"Voice commands"}),e.jsx("button",{className:"ml-auto px-2 py-1 rounded-lg border border-white/15 hover:border-white/30",onClick:()=>_e(!1),children:"âœ•"})]}),e.jsx("p",{className:"text-sm text-white/70 mb-3",children:"Try speaking any of these, naturally:"}),e.jsxs("ul",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm",children:[e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œAdd 2 Dove soapâ€"}),e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œSet quantity 5 for Parle Gâ€"}),e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œRemove Surf Excelâ€"}),e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œCustomer 9876543210â€"}),e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œGST eighteen percentâ€"}),e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œIGST 12%â€ / â€œCGST SGST 9%â€"}),e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œSplit payment cash 200 upi 300â€"}),e.jsx("li",{className:"rounded-lg border border-white/10 bg-white/5 px-3 py-2",children:"â€œFinalize invoiceâ€"})]}),e.jsxs("div",{className:"mt-4 text-xs text-white/60",children:["Tip: press ",e.jsx("span",{className:"px-1 py-0.5 rounded border border-white/15 bg-white/5",children:"Space"})," to toggle mic."]})]})]})]})}function xt(n){if(n===void 0)return;if(n===null||typeof n!="object")return n;if(Array.isArray(n))return n.map(xt).filter(t=>t!==void 0);const s={};for(const[t,i]of Object.entries(n)){const a=xt(i);a!==void 0&&(s[t]=a)}return s}function zt(n,s="$"){const t=[],i=(a,c)=>{if(a===void 0){t.push(c);return}a&&typeof a=="object"&&(Array.isArray(a)?a.forEach((r,N)=>i(r,`${c}[${N}]`)):Object.entries(a).forEach(([r,N])=>i(N,`${c}.${r}`)))};return i(n,s),t}const Ws=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`line-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;function Hs(n,s={}){const t={...n};if(typeof s.includeGST=="boolean"&&(t.includeGST=s.includeGST),s.igst===!0?(t.includeIGST=!0,t.includeCGST=!1,t.includeSGST=!1,t.includeGST=!1):(s.cgst===!0||s.sgst===!0)&&(t.includeIGST=!1,t.includeCGST=!0,t.includeSGST=!0,t.includeGST=!1),s.igst===!1&&(t.includeIGST=!1),s.cgst===!1&&(t.includeCGST=!1),s.sgst===!1&&(t.includeSGST=!1),Number.isFinite(s.rate)){const i=Math.max(0,Math.min(100,Number(s.rate)));if(t.gstRate=i,t.includeIGST)t.igstRate=i;else if(t.includeCGST||t.includeSGST){const a=i/2;t.cgstRate=a,t.sgstRate=a}else t.includeGST=!0,t.includeIGST=!1,t.includeCGST=!1,t.includeSGST=!1}return t}const Bt=async(n,s)=>{for(const t of s)try{console.log("Updating stock for:",t.name,"ID:",t.id,"Qty:",t.quantity,"Brand:",t.brand,"Category:",t.category);const i=Ue(ke,"businesses",n,"products",t.id),a=await at(i);if(a.exists()){const r=(parseFloat(a.data().quantity)||0)-t.quantity,N=r<0?0:r;await It(i,{quantity:N}),console.log("Stock updated to:",N)}else console.warn("Product not found for ID:",t.id)}catch(i){console.error("Error updating stock for product ID:",t.id,i.message)}},Vs=()=>{const[n,s]=u.useState({name:"",phone:"",email:"",address:""}),[t,i]=u.useState([]),[a,c]=u.useState({includeGST:!1,includeCGST:!1,includeSGST:!1,includeIGST:!1,gstRate:9,cgstRate:9,sgstRate:9,igstRate:18,invoiceType:"",paymentMode:"",orderPricingMode:"",deliveryCharge:0,packingCharge:0,otherCharge:0,extras:{deliveryFee:0,packagingFee:0,insuranceType:"none",insuranceValue:0},driver:{name:"",phone:"",vehicle:"",tracking:""}}),[r,N]=u.useState(!1),[j,I]=u.useState([]),[x,G]=u.useState({visible:!1,issuedAt:null}),[p,U]=u.useState(null),[R,X]=u.useState(""),[F,pe]=u.useState(null),[ue,de]=u.useState({cash:0,upi:0,card:0}),[l,v]=u.useState(!1),[L,y]=u.useState(!1),[Y,M]=u.useState({subtotal:0,taxBreakdown:{},extras:{},finalTotal:0,grandTotal:0}),V=(d,h)=>{Array.isArray(d)&&i(d),h&&typeof h=="object"&&M(f=>({...f,...h,grandTotal:h.grandTotal??h.finalTotal??f.grandTotal}))};u.useEffect(()=>{l||window.dispatchEvent(new Event("fastBilling:stopMic"))},[l]),u.useEffect(()=>()=>{window.dispatchEvent(new Event("fastBilling:stopMic"))},[]),u.useEffect(()=>{(async()=>{const h=ct.currentUser;if(h){const f=Ue(ke,"businesses",h.uid),A=await at(f);A.exists()&&U({...A.data(),uid:h.uid})}})()},[]);const O=(d,h=1)=>{if(!d)return;const f=d.productName||d.name||d.title||d.label||"",A=d.pricingMode?d.pricingMode:d.mrp?"MRP_INCLUSIVE":d.basePrice?"BASE_PLUS_GST":"SELLING_SIMPLE",T=Number(d.gstRate??d.taxRate??a?.gstRate??0),z=us({pricingMode:A,gstRate:T,hsnCode:d.hsnCode,sellingPrice:d.sellingPrice??d.price??void 0,sellingIncludesGst:!(A==="SELLING_SIMPLE"||A==="BASE_PLUS_GST"),mrp:d.mrp,basePrice:d.basePrice}),P={cartLineId:Ws(),id:d.id,name:f,sku:d.sku||"",brand:d.brand||"",category:d.category||"",quantity:Math.max(1,parseFloat(h)||1),price:Number(z.unitPriceNet??0),discount:0,unit:d.unit||d.packSize||"",pricingMode:A,gstRate:T,inlineGstRate:T,hsnCode:d.hsnCode||"",mrp:d.mrp??void 0,basePrice:d.basePrice??void 0,normalized:{unitPriceNet:Number(z.unitPriceNet??0),taxPerUnit:Number(z.taxPerUnit??0),unitPriceGross:Number(z.unitPriceGross??0),effectiveRate:Number(z.effectiveRate??T)}};I(_=>_.find(C=>C.id===P.id)?_:[..._,{id:P.id,name:f}]),i(_=>[..._,P])},J=async(d={})=>{if(!p)return;const{sku:h,name:f,qty:A}=d;let T=null,z=[];try{if(h){const w=ut(Qe(ke,"businesses",p.uid,"products"),mt("sku","==",h));(await qe(w)).forEach(E=>{T||(T={id:E.id,...E.data()})})}if(!T&&f){const w=ut(Qe(ke,"businesses",p.uid,"products"),mt("name","==",f));(await qe(w)).forEach(E=>{T||(T={id:E.id,...E.data()})})}if(!T&&f){const w=ut(Qe(ke,"businesses",p.uid,"products"),mt("productName","==",f));(await qe(w)).forEach(E=>{T||(T={id:E.id,...E.data()})})}if(!T&&f){const w=await qe(Qe(ke,"businesses",p.uid,"products")),C=String(f).toLowerCase(),E=C.split(/\s+/).filter(Boolean);w.forEach(Z=>{const fe=Z.data(),De=(fe.productName||fe.name||"").toLowerCase(),Ve=(fe.brand||"").toLowerCase(),ze=(fe.sku||"").toLowerCase();let Ze=0;(De.includes(C)||Ve.includes(C)||ze.includes(C))&&(Ze+=2),E.forEach(et=>{et.length>=3&&(De.includes(et)||Ve.includes(et)||ze.includes(et))&&(Ze+=1)}),Ze>0&&z.push({id:Z.id,...fe,__score:Ze})}),z.sort((Z,fe)=>(fe.__score||0)-(Z.__score||0))}}catch(w){console.warn("Product lookup failed:",w.message)}const P=Math.max(1,parseFloat(A||1)||1);if(T){O(T,P);return}const _=(z||[]).slice(0,1);_.length?O(_[0],P):alert(`Didn't find a matching product for "${f}". Try again or type to search.`)},xe=async(d={})=>{if(!p)return;const{phone:h,name:f,email:A}=d;try{if(h){const T=ut(Qe(ke,"businesses",p.uid,"customers"),mt("phone","==",String(h))),z=await qe(T);let P=null;if(z.forEach(_=>{P||(P={custId:_.id,..._.data()})}),P){s(P);return}}}catch(T){console.warn("Customer lookup failed:",T.message)}s(T=>({...T,...f&&{name:f},...h&&{phone:String(h)},...A&&{email:A}}))},B=d=>{if(!d)return;const h=String(d).toLowerCase(),f=h==="upi"?"UPI":h==="card"?"Card":h==="credit"?"Credit":"Cash";c(A=>({...A,paymentMode:f}))},$=({type:d,amount:h})=>{const f=parseFloat(h)||0,A=String(d||"").toLowerCase();c(T=>({...T,deliveryCharge:A.includes("deliver")?f:T.deliveryCharge,packingCharge:A.includes("pack")?f:T.packingCharge,otherCharge:!A.includes("deliver")&&!A.includes("pack")?f:T.otherCharge}))},me=d=>{const h=Math.max(0,parseFloat(d.quantity)||0),f=Math.max(0,Math.min(100,parseFloat(d.discount)||0));if(d?.normalized&&(d.pricingMode==="MRP_INCLUSIVE"||d.pricingMode==="BASE_PLUS_GST")){const z=Math.max(0,parseFloat(d.normalized.unitPriceNet)||0),P=Math.max(0,parseFloat(d.normalized.taxPerUnit)||0),_=z>0?P/z:0,w=z*(1-f/100),C=w*(1+_),E=C-w;return{unitNet:z,unitTax:P,unitGross:z*(1+_),unitNetAfterDisc:w,unitTaxAfterDisc:E,unitGrossAfterDisc:C,lineNetAfterDisc:w*h,lineTaxAfterDisc:E*h,lineGrossAfterDisc:C*h}}if(d.pricingMode==="SELLING_SIMPLE"||d.pricingMode==="LEGACY"){const z=Math.max(0,parseFloat(d.price)||0),P=Math.max(0,parseFloat(d.inlineGstRate??d.gstRate??0))/100,_=z*(1-f/100),w=_*(1+P),C=w-_;return{unitNet:z,unitTax:z*P,unitGross:z*(1+P),unitNetAfterDisc:_,unitTaxAfterDisc:C,unitGrossAfterDisc:w,lineNetAfterDisc:_*h,lineTaxAfterDisc:C*h,lineGrossAfterDisc:w*h}}const A=Math.max(0,parseFloat(d.price)||0),T=A*(1-f/100);return{unitNet:T,unitTax:0,unitGross:A,unitNetAfterDisc:T,unitTaxAfterDisc:0,unitGrossAfterDisc:T,lineNetAfterDisc:T*h,lineTaxAfterDisc:0,lineGrossAfterDisc:T*h}},le=d=>(d||[]).map(h=>{const f=me(h);return{...h,unitPriceNet:f.unitNet,unitPriceGross:f.unitGross,unitPriceNetAfterDiscount:f.unitNetAfterDisc,unitTaxAfterDiscount:f.unitTaxAfterDisc,unitPriceGrossAfterDiscount:f.unitGrossAfterDisc,lineNetAfterDiscount:f.lineNetAfterDisc,lineTaxAfterDiscount:f.lineTaxAfterDisc,lineGrossAfterDiscount:f.lineGrossAfterDisc}});function Ie(d,h){const f=h||{},A=f.extras||{},T=parseFloat(f.deliveryCharge)||0,z=parseFloat(f.packingCharge)||0,P=parseFloat(f.otherCharge)||0,_=parseFloat(A.deliveryFee)||0,w=parseFloat(A.packagingFee)||0;let C=0;const E=A.insuranceType||"none",Z=parseFloat(A.insuranceValue)||0;return E==="flat"?C=Z:E==="percent"&&(C=d*(Z/100)),{delivery:T+_,packaging:z+w,insurance:Math.max(0,C),other:P,total:T+_+(z+w)+Math.max(0,C)+P,meta:{type:E,val:Z}}}const we=()=>{const d=le(t),h=d.reduce((E,Z)=>E+(parseFloat(Z.lineNetAfterDiscount)||0),0),f=d.reduce((E,Z)=>E+(parseFloat(Z.lineTaxAfterDiscount)||0),0),A=0,T=0,z=0,P=0,_=Ie(h,a),w=_.total,C=parseFloat((h+f+w).toFixed(2));return{subtotal:h,gstAmount:A,cgstAmount:T,sgstAmount:z,igstAmount:P,rowTax:f,charges:w,grandTotal:C,enriched:d,extras:_}},Re={addItemByQuery:d=>J(d),updateQty:({lineKey:d,cartLineId:h,id:f,sku:A,name:T,qty:z})=>{const P=Math.max(1,parseFloat(z)||1);i(_=>_.map((w,C)=>{const E=w.cartLineId||w.id||`${w.sku||w.name}-${C}`;return h&&w.cartLineId===h||f&&w.id===f||d&&E===d||!h&&!f&&T&&w.name===T||!h&&!f&&A&&w.sku===A?{...w,quantity:P}:w}))},setLineDiscount:({lineKey:d,cartLineId:h,id:f,discountPct:A,discountAmt:T})=>{i(z=>z.map((P,_)=>{const w=P.cartLineId||P.id||`${P.sku||P.name}-${_}`;if(!(h&&P.cartLineId===h||f&&P.id===f||d&&w===d))return P;let E=A;if(E===void 0&&T!==void 0){const fe=(parseFloat(P.quantity)||0)*(parseFloat(P.price)||0);E=fe>0?Number(T)/fe*100:0}const Z=Math.max(0,Math.min(100,parseFloat(E)||0));return{...P,discount:Z}}))},removeItem:({lineKey:d,cartLineId:h,id:f})=>{i(A=>A.filter((T,z)=>{const P=T.cartLineId||T.id||`${T.sku||T.name}-${z}`;return!(h&&T.cartLineId===h||f&&T.id===f||d&&P===d)})),f&&I(A=>A.filter(T=>T.id!==f))},removeItemByName:d=>{i(h=>h.filter(f=>f.name!==d)),I(h=>h.filter(f=>f.name!==d))},setCustomerByText:d=>xe(d),setCharge:(d,h)=>$({type:d,amount:h}),setInvoiceType:d=>c(h=>({...h,invoiceType:d})),setGSTFlags:d=>{c(h=>Hs(h,d))},setPayment:d=>B(d.mode),saveInvoice:async({mode:d})=>{if(!p)throw new Error("Missing user");if(t.length===0)throw new Error("Empty cart");const h=Le().format("YYYY-MM-DDTHH:mm:ss.SSSZ"),f="INV-"+Math.random().toString(36).substr(2,9).toUpperCase(),A=we();let T=!1,z=null,P=null;(a.paymentMode||"").toLowerCase()==="credit"?P=a.creditDueDate||Le().add(7,"days").format("YYYY-MM-DD"):(T=!0,z=h);const _={...a};delete _.splitCash,delete _.splitUPI,delete _.splitCard,delete _.splitPayment;const w=a.splitPayment||ue||{},C={cash:Number(w.cash)||0,upi:Number(w.upi)||0,card:Number(w.card)||0},E={customer:n,custId:n&&n.custId?n.custId:void 0,cartItems:A.enriched,settings:_,paymentMode:a.paymentMode,invoiceType:a.invoiceType,issuedAt:h,invoiceId:f,totalAmount:A.grandTotal,splitPayment:C,creditDueDate:P,isPaid:T,paidOn:z,chargesSnapshot:{delivery:A.extras?.delivery||0,packing:A.extras?.packaging||0,insurance:A.extras?.insurance||0,other:A.extras?.other||0,insuranceType:a?.extras?.insuranceType||"none",insuranceValue:a?.extras?.insuranceValue||0},taxSnapshot:{rowTax:A.rowTax,cartLevel:{gst:A.gstAmount,cgst:A.cgstAmount,sgst:A.sgstAmount,igst:A.igstAmount}},mode:d||"fast"},Z=String(a.paymentMode||"").toLowerCase()==="credit";E.paymentFlags={isCredit:Z,isSplit:!!(C?.cash||C?.upi||C?.card),isAdvance:!!(C?.advanceAmount&&Number(C.advanceAmount)>0)},E.paymentSummary={mode:a.paymentMode||"",splitPayment:C||null,creditDueDays:a.creditDays||null,creditDueDate:P||null,status:T?"paid":Z?"due":"unpaid"};const fe=Ue(ke,"businesses",p.uid,"finalizedInvoices",f),be=xt({...E,createdAt:h}),De=zt(be);return De.length&&console.warn("[CreateInvoice fast save] undefined at:",De),await gt(fe,be),await Bt(p.uid,t),X(f),pe(E),f},undo:void 0,canUndo:!1,get cart(){return t},get totals(){return we()}},_e=d=>s(d),Te=async()=>{if(!p){alert("User not authenticated or user info missing.");return}if(t.length===0){alert("Cart is empty. Please add products to generate invoice.");return}y(!0);const d=Le().format("YYYY-MM-DDTHH:mm:ss.SSSZ"),h="INV-"+Math.random().toString(36).substr(2,9).toUpperCase();X(h);try{if(n&&n.custId){const E=Ue(ke,"businesses",p.uid,"customers",n.custId),Z=await at(E);if(Z.exists()){const be={...Z.data(),...n,updatedAt:d};await It(E,be)}else await gt(E,{...n,createdAt:d})}}catch(E){console.error("Error saving/updating customer:",E),alert("Failed to save customer info. Please try again."),y(!1);return}const f=we(),A=f.grandTotal;if(a.paymentMode==="Split"){const E=a.splitPayment||ue||{},Z=(Number(E.cash)||0)+(Number(E.upi)||0)+(Number(E.card)||0);if(Number(Z.toFixed(2))!==Number(A.toFixed(2))){alert(`Split payment does not match invoice total. Total: â‚¹${A}, Split: â‚¹${Z}`),y(!1);return}}let T=!1,z=null,P=null;a.paymentMode?.toLowerCase()==="credit"?P=a.creditDueDate||Le().add(7,"days").format("YYYY-MM-DD"):(T=!0,z=d);const _={...a};delete _.splitCash,delete _.splitUPI,delete _.splitCard,delete _.splitPayment;const w=a.splitPayment||ue,C={customer:n,custId:n&&n.custId?n.custId:void 0,cartItems:f.enriched,settings:_,paymentMode:a.paymentMode,invoiceType:a.invoiceType,issuedAt:d,invoiceId:h,totalAmount:A,splitPayment:w,creditDueDate:P,isPaid:T,paidOn:z,chargesSnapshot:{delivery:f.extras?.delivery||0,packing:f.extras?.packaging||0,insurance:f.extras?.insurance||0,other:f.extras?.other||0,insuranceType:a?.extras?.insuranceType||"none",insuranceValue:a?.extras?.insuranceValue||0},taxSnapshot:{rowTax:f.rowTax,cartLevel:{gst:f.gstAmount,cgst:f.cgstAmount,sgst:f.sgstAmount,igst:f.igstAmount}}};pe(C),y(!1),G({visible:!0,issuedAt:d})},Ge=()=>G({visible:!1,issuedAt:null});return x.visible&&p&&F?e.jsx(Ct,{customer:n,cartItems:t,settings:a,paymentMode:a.paymentMode,invoiceType:a.invoiceType,issuedAt:x.issuedAt,invoiceId:R,onCancel:Ge,onConfirm:async()=>{try{const d=Ue(ke,"businesses",p.uid,"finalizedInvoices",R),h=xt({...F,createdAt:F.issuedAt,isPaid:F.isPaid,paidOn:F.paidOn,creditDueDate:F.creditDueDate}),f=zt(h);f.length&&console.warn("[CreateInvoice preview confirm] undefined at:",f),await gt(d,h),console.log("Invoice saved to Firestore:",R),await Bt(p.uid,t)}catch(d){console.error("Error saving invoice:",d.message),alert("Failed to save invoice. Please try again.");return}G({visible:!1,issuedAt:null})},taxRates:{gst:a.gstRate,cgst:a.cgstRate,sgst:a.sgstRate,igst:a.igstRate},userInfo:{businessName:p.businessName||"N/A",ownerName:p.ownerName||"N/A",address:p.address||"N/A",phone:p.phone||"N/A",email:p.email||"N/A",gstin:p.gstin||"N/A",pan:p.pan||"N/A"}}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6 px-2 sm:px-4 md:px-6 pb-32 pt-[env(safe-area-inset-top)] text-white",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold",children:"Billing"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs sm:text-sm text-white/70",children:"Mode:"}),e.jsx("button",{className:`px-2 sm:px-3 py-1 rounded-xl border text-sm ${l?"":"bg-white/10"}`,onClick:()=>v(!1),children:"Classic"}),e.jsx("button",{className:`px-2 sm:px-3 py-1 rounded-xl border text-sm ${l?"bg-white/10":""}`,onClick:()=>v(!0),children:"Fast Billing"})]})]}),l?(()=>{const d=h=>{console.log("Final Voice Command:",h)};return e.jsxs("div",{className:"space-y-4 px-2 sm:px-4 md:px-6 pb-24 text-white",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold",children:"Fast Billing"}),e.jsx("button",{onClick:()=>v(!1),className:"px-3 py-1 rounded-xl border border-white/20 text-sm",children:"Exit"})]}),e.jsx($s,{onExit:()=>v(!1),actions:Re,onVoiceCommand:d,fallbackToWhisper:!0,whisperFallbackApi:"/api/voice/fallback",inventory:j,settings:a})]})})():e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"p-3 sm:p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-base sm:text-lg font-semibold mb-2 text-white",children:"Customer Information"}),p&&e.jsx(hs,{customer:n,onChange:_e,userId:p.uid})]}),e.jsxs("div",{className:"p-3 sm:p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("h2",{className:"text-base sm:text-lg font-semibold text-white",children:"Add Product"})}),e.jsx(ls,{onSelect:d=>{if(!d)return;const h=d.productName||d.name||d.title||d.label||"",f={id:d.id,...d,productName:h,pricingMode:d.pricingMode||(d.mrp?"MRP_INCLUSIVE":"SELLING_SIMPLE"),gstRate:d.gstRate??d.taxRate??0,sellingIncludesGst:d.sellingIncludesGst??d.pricingMode!=="BASE_PLUS_GST"};j.find(T=>T.id===f.id)||I(T=>[...T,f])}})]}),e.jsxs("div",{className:"rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)] overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>N(d=>!d),className:"w-full flex items-center justify-between px-4 py-3 text-left text-white hover:bg-white/5 transition",children:[e.jsx("span",{className:"font-semibold",children:"Invoice Settings & Delivery"}),e.jsx("span",{className:"text-sm text-white/70",children:r?"â–¼ Hide":"â–¶ Show"})]}),r&&e.jsxs("div",{className:"border-t border-white/10 px-4 pb-4",children:[e.jsx(Yt,{settings:a,onChange:c,grandTotal:Y.grandTotal||Y.finalTotal||0}),a.paymentMode==="Credit"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-white/80 mb-1",children:"Credit Due Date (Default: 7 days from today)"}),e.jsx("input",{type:"date",className:"w-full rounded px-3 py-2 bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50",value:a.creditDueDate||"",onChange:d=>c(h=>({...h,creditDueDate:d.target.value}))})]})]})]}),e.jsxs("div",{className:"p-3 sm:p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-base sm:text-lg font-semibold mb-2 text-white",children:"Product Cart"}),e.jsx(ds,{selectedProducts:j,cartItems:t,onUpdateCart:V,settings:a})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:Te,className:"px-6 py-3 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)] transition",children:"Create Bill"})})]}),e.jsx("div",{className:"fixed bottom-3 sm:bottom-4 inset-x-3 sm:inset-x-4 z-50 md:hidden",children:e.jsx("button",{onClick:Te,className:"w-full text-slate-900 py-3 rounded-xl shadow-lg text-base sm:text-lg font-semibold bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)]",children:"Create Bill"})})]})]}),L&&e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative p-4 sm:p-6 rounded-2xl border border-white/10 bg-white/10 shadow-2xl text-white w-[min(90vw,420px)]",children:[e.jsx("div",{className:"mx-auto mb-3 h-8 w-8 sm:h-10 sm:w-10 rounded-full border-4 border-white/30 border-t-emerald-300 animate-spin"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-base sm:text-lg font-semibold",children:"Creating invoiceâ€¦"}),e.jsx("div",{className:"text-xs sm:text-sm text-white/80 mt-1",children:"Preparing preview and totals"})]}),e.jsx("div",{className:"mt-4 h-2 w-full overflow-hidden rounded-full bg-white/10",children:e.jsx("div",{className:"h-full w-1/2 animate-[shimmer_1.6s_linear_infinite] bg-gradient-to-r from-transparent via-white/60 to-transparent"})}),e.jsx("style",{children:"@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}"})]})})]})};function Ys(n){try{const s=Math.round(Number(n||0));if(!isFinite(s))return"Zero";const t=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],i=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"],a=U=>U?U+" ":"",c=U=>U<20?t[U]:i[Math.floor(U/10)]+(U%10?" "+t[U%10]:""),r=U=>{const R=Math.floor(U/100),X=U%100;return(R?t[R]+" Hundred"+(X?" ":""):"")+(X?c(X):"")};let N="",j=Math.floor(s/1e7),I=s%1e7,x=Math.floor(I/1e5);I=I%1e5;let G=Math.floor(I/1e3);I=I%1e3;let p=I;return j&&(N+=a(r(j))+"Crore "),x&&(N+=a(r(x))+"Lakh "),G&&(N+=a(r(G))+"Thousand "),p&&(N+=r(p)),N.trim()||"Zero"}catch{return"Zero"}}const b=xs.create({page:{padding:30,fontSize:8,fontFamily:"Helvetica",color:"#111827",backgroundColor:"#FFFFFF"},header:{marginBottom:12,paddingBottom:10,borderBottomWidth:2,borderBottomColor:"#E5E7EB"},heading:{fontSize:20,fontWeight:700,marginBottom:3,color:"#111827"},invoiceMeta:{fontSize:7,color:"#6B7280",marginTop:2,lineHeight:1.3},sectionTitle:{fontSize:9,fontWeight:700,marginBottom:5,textTransform:"uppercase",letterSpacing:.3,color:"#374151"},card:{borderWidth:1,borderColor:"#E5E7EB",borderRadius:6,padding:8,marginBottom:8,backgroundColor:"#FAFAFA"},row:{flexDirection:"row",justifyContent:"space-between",gap:8},infoText:{fontSize:8,lineHeight:1.4,color:"#374151",marginBottom:2},table:{marginTop:6,borderWidth:1,borderColor:"#E5E7EB",borderRadius:4,overflow:"hidden",backgroundColor:"#FFFFFF"},tableHeader:{flexDirection:"row",backgroundColor:"#F3F4F6",borderBottomWidth:1,borderBottomColor:"#E5E7EB",alignItems:"center"},tableRow:{flexDirection:"row",borderBottomWidth:.5,borderBottomColor:"#F3F4F6",backgroundColor:"#FFFFFF",alignItems:"center"},th:{fontWeight:700,fontSize:7,padding:4,paddingVertical:6,color:"#374151",textAlign:"left"},td:{fontSize:7,padding:4,paddingVertical:4,color:"#111827",lineHeight:1.3,textAlign:"left"},tdRight:{fontSize:7,padding:4,paddingVertical:4,color:"#111827",lineHeight:1.3,textAlign:"right"},bold:{fontWeight:700},footer:{marginTop:12,paddingTop:8,borderTopWidth:1,borderTopColor:"#E5E7EB",textAlign:"center",fontSize:7,color:"#6B7280"},grandTotalBox:{backgroundColor:"#ECFDF5",borderWidth:1,borderColor:"#10B981",borderRadius:4,padding:8,marginTop:8},taxSummary:{marginTop:8,padding:8,backgroundColor:"#FAFAFA",borderWidth:1,borderColor:"#E5E7EB",borderRadius:4},taxSummaryTitle:{fontSize:10,fontWeight:700,marginBottom:6,color:"#111827"},taxSummaryRow:{flexDirection:"row",justifyContent:"space-between",marginBottom:3,fontSize:8},taxSummaryTotal:{flexDirection:"row",justifyContent:"space-between",marginTop:4,paddingTop:4,borderTopWidth:1,borderTopColor:"#D1D5DB",fontSize:10,fontWeight:700}}),Se=n=>`â‚¹${Number(n||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,qs=n=>{if(!n)return null;if(n instanceof Date)return n;if(typeof n=="number")return new Date(n);if(typeof n=="string"){const s=new Date(n);return Number.isNaN(s.getTime())?null:s}return n?.seconds?new Date(n.seconds*1e3):n?.toDate?n.toDate():null},Ut=n=>{const s=qs(n);return s?s.toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}):"N/A"},$t=n=>{const s=Number(n.quantity||n.qty||1),t=Number(n.price||n.unitPrice||n.sellingPrice||0),i=Number(n.gstRate||n.taxRate||n.inlineGstRate||0),a=Number(n.discount||n.discountPct||0),c=Number(n.discountAmount||0);let r=t;n.normalized&&(n.pricingMode==="MRP_INCLUSIVE"||n.pricingMode==="BASE_PLUS_GST")&&(r=Number(n.normalized.unitPriceNet||t));const N=c>0?c/s:r*(a/100),j=(r-N)*s,I=j*(i/100),x=j+I;return{unitNet:r,unitDiscount:N,netSubtotal:j,taxAmt:I,lineTotal:x,qty:s,gstRate:i,discPct:a,discAmt:c}},Wt=(n={},s={})=>{const t=(n.state||"").toUpperCase().trim(),i=(s.state||"").toUpperCase().trim();return t&&i&&t!==i},Qs=({invoice:n={},userInfo:s={},billingSettings:t={}})=>{const i=Array.isArray(n.cartItems)?n.cartItems:[],a=n.customer||{},c=s||{};let r=0,N=0,j=0,I=0,x=0,G=0;const p=Wt(a,c);i.forEach(M=>{const V=$t(M);r+=V.netSubtotal,N+=V.taxAmt,j+=V.discAmt>0?V.discAmt:V.unitNet*V.qty*(V.discPct/100),p?G+=V.taxAmt:(I+=V.taxAmt/2,x+=V.taxAmt/2)});const U=Number(n.settings?.deliveryFee||n.deliveryFee||0),R=Number(n.settings?.packagingFee||n.packagingFee||0),X=Number(n.settings?.otherCharge||0),F=Number(n.settings?.insuranceValue||n.insuranceValue||0),pe=U+R+X+F,ue=r+N+pe,de=n.isPaid||n.settings?.isPaid||!1,l=(n.paymentMode||n.settings?.paymentMode||"CASH").toUpperCase(),v=(n.invoiceType||"Tax").charAt(0).toUpperCase()+(n.invoiceType||"Tax").slice(1),L=Ut(n.createdAt||n.issuedAt),y=t.bank||{},Y=t.payment||{};return e.jsx(fs,{title:n.id||"Invoice",children:e.jsxs(gs,{size:"A4",style:b.page,wrap:!0,children:[e.jsxs(re,{style:b.header,children:[e.jsx(S,{style:b.heading,children:"TAX INVOICE"}),e.jsxs(re,{style:b.row,children:[e.jsxs(re,{style:{flex:1},children:[e.jsxs(S,{style:b.invoiceMeta,children:[e.jsx(S,{style:b.bold,children:"Invoice No: "}),n.id||"N/A"]}),e.jsxs(S,{style:b.invoiceMeta,children:[e.jsx(S,{style:b.bold,children:"Date: "}),L]}),e.jsxs(S,{style:b.invoiceMeta,children:[e.jsx(S,{style:b.bold,children:"Status: "}),de?"Paid":"Pending"]})]}),e.jsx(re,{style:{flex:1,alignItems:"flex-end"},children:e.jsxs(re,{style:b.grandTotalBox,children:[e.jsx(S,{style:[b.sectionTitle,{fontSize:8,marginBottom:4}],children:"Grand Total"}),e.jsx(S,{style:[b.infoText,b.bold,{fontSize:16,color:"#059669"}],children:Se(ue)})]})})]})]}),e.jsxs(re,{style:b.row,children:[e.jsxs(re,{style:[b.card,{flex:1}],children:[e.jsx(S,{style:b.sectionTitle,children:"Bill To (Customer)"}),e.jsx(S,{style:b.infoText,children:a.name||a.businessName||"N/A"}),a.email&&e.jsxs(S,{style:b.infoText,children:["Email: ",a.email]}),a.phone&&e.jsxs(S,{style:b.infoText,children:["Phone: ",a.phone]}),(a.city||a.state)&&e.jsx(S,{style:b.infoText,children:[a.city,a.state].filter(Boolean).join(", ")}),a.address&&e.jsx(S,{style:b.infoText,children:a.address})]}),e.jsxs(re,{style:[b.card,{flex:1}],children:[e.jsx(S,{style:b.sectionTitle,children:"Sold By (Retailer)"}),e.jsx(S,{style:b.infoText,children:c.businessName||c.name||"N/A"}),c.email&&e.jsxs(S,{style:b.infoText,children:["Email: ",c.email]}),c.phone&&e.jsxs(S,{style:b.infoText,children:["Phone: ",c.phone]}),c.gstNumber&&e.jsxs(S,{style:b.infoText,children:["GST: ",c.gstNumber]}),(c.city||c.state)&&e.jsx(S,{style:b.infoText,children:[c.city,c.state].filter(Boolean).join(", ")}),c.address&&e.jsx(S,{style:b.infoText,children:c.address})]})]}),e.jsxs(re,{style:b.card,children:[e.jsx(S,{style:b.sectionTitle,children:"PRODUCTS"}),i.length===0?e.jsx(S,{style:b.infoText,children:"No items available."}):e.jsxs(re,{style:b.table,children:[e.jsxs(re,{style:b.tableHeader,children:[e.jsx(S,{style:[b.th,{flex:2.8}],children:"Name"}),e.jsx(S,{style:[b.th,{flex:1}],children:"Unit"}),e.jsx(S,{style:[b.th,{flex:.6,textAlign:"right"}],children:"Qty"}),e.jsx(S,{style:[b.th,{flex:1.2,textAlign:"right"}],children:"Unit (Net)"}),e.jsx(S,{style:[b.th,{flex:.8,textAlign:"right"}],children:"Discount"}),e.jsx(S,{style:[b.th,{flex:1,textAlign:"right"}],children:"Net"}),e.jsx(S,{style:[b.th,{flex:.8,textAlign:"right"}],children:"GST %"}),e.jsx(S,{style:[b.th,{flex:.8,textAlign:"right"}],children:"Tax"}),e.jsx(S,{style:[b.th,{flex:1,textAlign:"right"}],children:"Total"})]}),i.map((M,V)=>{const O=$t(M),J=Wt(a,c),xe=J?0:O.gstRate/2,B=J?0:O.gstRate/2,$=J?0:O.taxAmt/2,me=J?0:O.taxAmt/2,le=J?O.taxAmt:0;return e.jsxs(He.Fragment,{children:[e.jsxs(re,{style:b.tableRow,children:[e.jsx(S,{style:[b.td,{flex:2.8}],children:M.name||M.productName||M.displayName||"N/A"}),e.jsx(S,{style:[b.td,{flex:1}],children:M.unit||M.packSize||"â€”"}),e.jsx(S,{style:[b.tdRight,{flex:.6}],children:O.qty}),e.jsx(S,{style:[b.tdRight,{flex:1.2}],children:Se(O.unitNet)}),e.jsx(S,{style:[b.tdRight,{flex:.8}],children:O.discAmt>0?Se(O.discAmt):O.discPct>0?`${O.discPct}%`:"â€”"}),e.jsx(S,{style:[b.tdRight,{flex:1}],children:Se(O.netSubtotal)}),e.jsx(S,{style:[b.tdRight,{flex:.8}],children:O.gstRate>0?`${O.gstRate.toFixed(2).replace(/\.00$/,"")}%`:"â€”"}),e.jsx(S,{style:[b.tdRight,{flex:.8}],children:Se(O.taxAmt)}),e.jsx(S,{style:[b.tdRight,{flex:1}],children:Se(O.lineTotal)})]}),e.jsxs(re,{style:[b.tableRow,{backgroundColor:"#F9FAFB",paddingVertical:2}],children:[e.jsx(S,{style:[b.td,{flex:2.8,fontSize:6,color:"#6B7280"}]}),e.jsx(S,{style:[b.td,{flex:1,fontSize:6,color:"#6B7280"}]}),e.jsx(S,{style:[b.tdRight,{flex:6.2,fontSize:6,color:"#6B7280"}],children:J?`IGST ${xe.toFixed(2).replace(/\.00$/,"")}% = ${Se(le)}`:`CGST ${xe.toFixed(2).replace(/\.00$/,"")}% = ${Se($)} â€¢ SGST ${B.toFixed(2).replace(/\.00$/,"")}% = ${Se(me)}`})]})]},V)})]})]}),e.jsxs(re,{style:b.taxSummary,children:[e.jsx(S,{style:b.taxSummaryTitle,children:"Tax Summary"}),e.jsxs(re,{style:{alignItems:"flex-end"},children:[e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"Net Subtotal:"}),e.jsx(S,{style:{fontSize:8},children:Se(r)})]}),e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"Total Discount:"}),e.jsx(S,{style:{fontSize:8},children:Se(j)})]}),e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"Total Tax:"}),e.jsx(S,{style:{fontSize:8},children:Se(N)})]}),I>0&&e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"CGST:"}),e.jsx(S,{style:{fontSize:8},children:Se(I)})]}),x>0&&e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"SGST:"}),e.jsx(S,{style:{fontSize:8},children:Se(x)})]}),G>0&&e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"IGST:"}),e.jsx(S,{style:{fontSize:8},children:Se(G)})]}),U>0&&e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"Delivery:"}),e.jsx(S,{style:{fontSize:8},children:Se(U)})]}),R>0&&e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"Packing:"}),e.jsx(S,{style:{fontSize:8},children:Se(R)})]}),F>0&&e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"Insurance:"}),e.jsx(S,{style:{fontSize:8},children:Se(F)})]}),X>0&&e.jsxs(re,{style:b.taxSummaryRow,children:[e.jsx(S,{style:{fontSize:8,color:"#6B7280",marginRight:12},children:"Other:"}),e.jsx(S,{style:{fontSize:8},children:Se(X)})]}),e.jsx(re,{style:{height:1,backgroundColor:"#D1D5DB",marginVertical:4,width:"100%"}}),e.jsxs(re,{style:b.taxSummaryTotal,children:[e.jsx(S,{style:{fontSize:10,fontWeight:700},children:"Grand Total:"}),e.jsx(S,{style:{fontSize:12,fontWeight:700,color:"#059669"},children:Se(ue)})]})]}),e.jsxs(S,{style:{fontSize:7,color:"#6B7280",marginTop:6},children:["Payment Mode: ",l," | Invoice Type: ",v]}),de&&n.settings?.paidOn&&e.jsxs(S,{style:{fontSize:7,color:"#10B981",marginTop:2},children:["âœ… Paid on: ",Ut(n.settings.paidOn)," via ",(n.settings.paidVia||n.paidVia||"").toUpperCase()]})]}),e.jsxs(re,{style:[b.row,{marginTop:8}],children:[e.jsxs(re,{style:[b.card,{flex:1,marginRight:4}],children:[e.jsx(S,{style:b.sectionTitle,children:"Bank Details"}),e.jsxs(S,{style:b.infoText,children:[y.bankName||"Bank",y.branch?` â€” ${y.branch}`:""]}),y.accountNumber&&e.jsxs(S,{style:b.infoText,children:["Account: ",y.accountNumber]}),y.ifsc&&e.jsxs(S,{style:b.infoText,children:["IFSC: ",y.ifsc]}),y.accountName&&e.jsxs(S,{style:b.infoText,children:["Name: ",y.accountName]})]}),e.jsxs(re,{style:[b.card,{flex:1,marginLeft:4}],children:[e.jsx(S,{style:b.sectionTitle,children:"UPI"}),e.jsx(S,{style:b.infoText,children:Y.upiId||"â€”"})]})]}),e.jsxs(re,{style:[b.row,{marginTop:8}],children:[e.jsxs(re,{style:[b.card,{flex:1,marginRight:4}],children:[e.jsx(S,{style:[b.sectionTitle,{fontSize:8,marginBottom:4}],children:"Amount in Words"}),e.jsxs(S,{style:[b.infoText,{fontSize:9,fontWeight:500}],children:["Rupees ",Ys(ue)," Only"]})]}),e.jsxs(re,{style:[b.card,{flex:1,marginLeft:4}],children:[e.jsx(S,{style:[b.sectionTitle,{fontSize:8,marginBottom:4}],children:"Authorized Signatory"}),e.jsx(re,{style:{height:20,borderBottomWidth:1,borderBottomColor:"#D1D5DB",marginBottom:4}}),e.jsx(S,{style:[b.infoText,{fontSize:7,color:"#6B7280"}],children:"Seal & Signature"})]})]}),e.jsxs(re,{style:{marginTop:12,paddingTop:8,borderTopWidth:1,borderTopColor:"#E5E7EB",flexDirection:"row",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(re,{style:{flexDirection:"row",alignItems:"center",gap:6},children:[e.jsx(bs,{src:"/assets/flyp_logo.png",style:{width:24,height:24,opacity:.8},cache:!1}),e.jsx(S,{style:b.footer,children:"Powered by FLYP"})]}),e.jsx(S,{style:[b.footer,{fontStyle:"italic"}],children:"Thank you for your business!"})]})]})})},ft={branding:{logoUrl:"",signatureUrl:"",stampUrl:""},bank:{bankName:"",branch:"",accountNumber:"",ifsc:"",accountName:""},payment:{upiId:"",upiQrUrl:""},terms:""},kt=(n={})=>(n.paymentModeLower||n.paymentMode||n.paymentSummary?.mode||n.invoiceConfig?.paymentMode||"").toString().toLowerCase(),Ht=(n={})=>n.creditDueDate||n.paymentSummary?.creditDueDate||n.settings?.creditDueDate||n.invoiceConfig?.creditDueDate||n.chargesSnapshot?.creditDueDate||null,Vt=(n={},s="")=>typeof n.isPaid=="boolean"?n.isPaid:n.paymentSummary?.status?n.paymentSummary.status!=="pending":s!=="credit",Ks=()=>{const[n,s]=u.useState([]),[t,i]=u.useState([]),[a,c]=u.useState(""),[r,N]=u.useState(null),[j,I]=u.useState(""),[x,G]=u.useState(""),[p,U]=u.useState(!1),[R,X]=u.useState(ft),[F,pe]=u.useState(!1),[ue,de]=u.useState(null);return u.useEffect(()=>{(async()=>{const v=ct.currentUser?.uid;if(v)try{const L=Ue(ke,"businesses",v,"preferences","billing"),y=await at(L);if(y.exists()){const Y=y.data(),M=Y.bank||{},V={bankName:M.bankName||M.name||"",branch:M.branch||"",accountNumber:M.accountNumber||M.account||"",ifsc:M.ifsc||"",accountName:M.accountName||""},O={...ft,...Y,branding:{...ft.branding,...Y.branding||{}},bank:V,payment:{...ft.payment,...Y.payment||{}},terms:Y.terms||""};X(O)}}catch(L){console.warn("Failed to load billing settings:",L)}})()},[]),u.useEffect(()=>{(async()=>{const v=ct.currentUser?.uid;if(v)try{const L=Ue(ke,"businesses",v),y=await at(L);y.exists()&&de(y.data())}catch(L){console.warn("Failed to load user info:",L)}})()},[]),u.useEffect(()=>{(async()=>{const v=ct.currentUser?.uid;if(v)try{const L=Qe(ke,`businesses/${v}/finalizedInvoices`),y=await qe(L),M=(await Promise.all(y.docs.map(async V=>{const O=V.data();let J=O.customer||{};if(O.custId)try{const xe=await at(Ue(ke,"businesses",v,"customers",O.custId));xe.exists()&&(J={...J,...xe.data()})}catch(xe){console.warn("Customer lookup failed:",xe)}return{id:V.id,...O,customer:J,createdAt:O.createdAt instanceof Date?O.createdAt:O.createdAt?.toDate?.()||(typeof O.createdAt=="string"?new Date(O.createdAt):null),total:O.totalAmount??O.total??0}}))).filter(V=>V.createdAt).sort((V,O)=>new Date(O.createdAt)-new Date(V.createdAt));s(M),i(M)}catch(L){console.error("Error loading invoices:",L)}})()},[]),u.useEffect(()=>{const l=a.toLowerCase(),v=n.filter(L=>{const y=L.customer?.name?.toLowerCase().includes(l)||L.invoiceType?.toLowerCase().includes(l),Y=L.createdAt?new Date(L.createdAt):null,M=j?Le(Y).format("YYYY-MM-DD")===j:!0;return y&&M});i(v)},[a,n,j,x]),e.jsxs("div",{className:"px-4 py-6 md:px-6 pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] text-white",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-emerald-200",children:"All Invoices"}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-end mb-4 gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"Search by customer or invoice type...",value:a,onChange:l=>c(l.target.value),className:"px-4 py-2 w-full rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})}),e.jsxs("div",{className:"w-64",children:[e.jsx("label",{className:"block text-sm mb-1 text-white/80",children:"Invoice Date"}),e.jsx("input",{type:"date",value:j,onChange:l=>I(l.target.value),className:"px-3 py-2 rounded-xl w-full bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400/50"})]})]}),e.jsx("div",{className:"space-y-4",children:t.map(l=>e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"px-4 py-4 flex flex-col md:flex-row justify-between items-start md:items-center text-sm space-y-2 md:space-y-0 bg-white/10 backdrop-blur-xl border border-white/10 rounded-xl shadow-[0_8px_40px_rgba(0,0,0,0.35)]",children:[e.jsxs("div",{className:"flex-1 mb-2 md:mb-0",children:[e.jsx("p",{className:"font-semibold",children:l.customer?.name||"Unnamed"}),e.jsxs("p",{className:"text-white/70",children:[l.customer?.address||"No Address"," | ",l.customer?.phone||"No Phone"]}),e.jsxs("p",{className:"text-white/60",children:["Items: ",l.cartItems?.length||0," | Date: ",l.createdAt?Le(l.createdAt).local().format("DD MMM YYYY, hh:mm A"):"N/A"]})]}),e.jsxs("div",{className:"flex flex-col items-end justify-center gap-2 relative min-h-[50px]",children:[(()=>{const v=kt(l),L=l.paymentFlags?.isCredit===!0||v==="credit",y=Vt(l,v);if(!(L&&!y))return null;const Y=Ht(l),M=Y?Le(Y):null,V=M?M.isBefore(Le(),"day"):!1;return e.jsxs("span",{className:`absolute top-1/2 right-[72px] transform -translate-y-1/2 text-white text-[10px] px-3 py-[2px] rounded-full shadow whitespace-nowrap ${V?"bg-orange-600":"bg-red-600"}`,children:[V?"Overdue: ":"Credit Due: ",M?M.format("DD MMM"):"N/A"]})})(),e.jsxs("p",{className:"font-semibold text-lg",children:["â‚¹",Number(l.totalAmount||l.total||0).toFixed(2)]}),e.jsx("button",{className:"mt-1 px-3 py-1 rounded-lg text-xs font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_6px_20px_rgba(16,185,129,0.35)]",onClick:()=>N(l),children:"View"})]})]})},l.id))}),r&&cs.createPortal(e.jsx("div",{className:"fixed inset-0 w-screen h-screen bg-black bg-opacity-50 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"rounded-lg shadow-lg p-4 md:p-6 max-w-4xl xl:max-w-5xl 2xl:max-w-6xl w-full max-h-screen overflow-y-auto space-y-4 text-white bg-white/10 backdrop-blur-2xl border border-white/10 mx-4",children:[e.jsx("div",{className:"invoice-preview-container",children:e.jsx(Ct,{customer:r.customer,cartItems:(r.cartItems||[]).map(l=>({...l,unit:l.unit||"-"})),settings:{...r.settings,creditDueDate:Ht(r),splitCash:r.settings?.splitCash??r.paymentSummary?.splitPayment?.cash??r.splitPayment?.cash??0,splitUPI:r.settings?.splitUPI??r.paymentSummary?.splitPayment?.upi??r.splitPayment?.upi??0,splitCard:r.settings?.splitCard??r.paymentSummary?.splitPayment?.card??r.splitPayment?.card??0,isPaid:r.isPaid,paidOn:r.paidOn,paidVia:r.paidVia,deliveryFee:r.settings?.deliveryFee??r.deliveryFee??0,packagingFee:r.settings?.packagingFee??r.packagingFee??0,insuranceType:r.settings?.insuranceType??r.insuranceType??"",insuranceValue:r.settings?.insuranceValue??r.insuranceValue??0,driverName:r.settings?.driverName??r.driverName??"",driverPhone:r.settings?.driverPhone??r.driverPhone??"",vehicleId:r.settings?.vehicleId??r.vehicleId??"",trackingRef:r.settings?.trackingRef??r.trackingRef??""},deliveryExtras:{driverName:r.settings?.driverName??r.driverName??"",driverPhone:r.settings?.driverPhone??r.driverPhone??"",vehicleId:r.settings?.vehicleId??r.vehicleId??"",trackingRef:r.settings?.trackingRef??r.trackingRef??""},invoiceType:r.invoiceType,paymentMode:kt(r),issuedAt:r.createdAt,userInfo:{businessName:r.userInfo?.businessName,gstNumber:r.userInfo?.gstNumber||r.gstNumber||"N/A"},onCancel:()=>N(null),viewOnly:!0,previewMode:!0,branding:R.branding,bank:R.bank,payment:R.payment,terms:R.terms})}),e.jsxs("div",{className:"mt-4 p-4 rounded text-sm bg-white/5 backdrop-blur-xl border border-white/10",children:[e.jsxs("p",{className:"mb-2",children:["Here is your receipt from ",e.jsx("strong",{children:r.userInfo?.businessName}),", located at"," ",e.jsx("strong",{children:r.userInfo?.address||"N/A"}),".",e.jsx("br",{}),"Total: ",e.jsxs("strong",{children:["â‚¹",Number(r.totalAmount||0).toFixed(2)]}),e.jsx("br",{}),"Issued on:"," ",e.jsx("strong",{children:r.createdAt?Le(r.createdAt).format("DD MMM YYYY, hh:mm A"):"N/A"})]}),(()=>{const l=kt(r),v=r.paymentFlags?.isCredit===!0||l==="credit",L=Vt(r,l);return v&&!L?e.jsx("button",{className:"px-4 py-2 rounded-lg mb-4 font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)]",onClick:()=>U(!0),children:"Mark as Paid"}):null})(),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)] disabled:opacity-50 disabled:cursor-not-allowed",onClick:async()=>{if(r)try{pe(!0);const l={...r,customer:r.customer||{},userInfo:ue||r.userInfo||{}},v=e.jsx(Qs,{invoice:l,userInfo:ue||r.userInfo||{},billingSettings:R}),L=await ys(v).toBlob(),y=r.id||`INV-${Le(r.createdAt).format("YYYYMMDD")}`,Y=Le(r.createdAt).format("DD-MMM-YYYY"),M=`${y}-${Y}.pdf`;Ns.saveAs(L,M),Ye.success("PDF downloaded successfully!")}catch(l){console.error("[ViewInvoices] Failed to generate PDF",l),Ye.error("Failed to generate PDF. Please try again.")}finally{pe(!1)}},disabled:F,children:F?"Generating PDF...":"Download PDF"}),e.jsx("a",{href:(()=>{const v=(r.customer?.phone||"").toString().replace(/\D/g,""),L=r.id||"Invoice",y=`â‚¹${Number(r.totalAmount||0).toFixed(2)}`,Y=Le(r.createdAt).format("DD MMM YYYY, hh:mm A"),M=r.userInfo?.businessName||ue?.businessName||"FLYP",V=[`ðŸ“„ Invoice ${L}`,`ðŸ’° Amount: ${y}`,`ðŸ“… Issued: ${Y}`,"","Thank you for your business!",`â€” ${M}`].join(`
`),O=encodeURIComponent(V);return v?`https://wa.me/${v}?text=${O}`:`https://wa.me/?text=${O}`})(),target:"_blank",rel:"noopener noreferrer",className:"px-4 py-2 rounded-lg inline-block font-medium text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)]",title:r.customer?.phone?`Send to ${r.customer.phone}`:"Open WhatsApp",children:"Share via WhatsApp"})]}),e.jsx("p",{className:"mt-2 text-xs text-white/70 italic",children:"Powered by FLYP â€” smart business invoicing"})]})]})}),document.body),p&&e.jsx(ms,{isOpen:!0,onClose:()=>U(!1),invoice:r,onConfirm:async l=>{const L=`businesses/${ct.currentUser?.uid}/finalizedInvoices/${r.id}`,y=Ue(ke,L),Y=new Date;await It(y,{isPaid:!0,paidOn:Y,paidVia:l});const M=n.map(V=>V.id===r.id?{...V,isPaid:!0,paidOn:Y,paidVia:l}:V);s(M),i(M),Ye.success("Invoice marked as paid successfully!"),U(!1),N(null)}})]})},ln=()=>{const[n,s]=u.useState("create"),[t,i]=u.useState(!1);return e.jsxs("section",{className:"px-2 sm:px-4 py-4 sm:py-6 md:px-6 max-w-6xl mx-auto pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] text-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 sm:mb-4",children:[e.jsx("h1",{className:"text-lg sm:text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-emerald-200",children:"Billing Dashboard"}),e.jsx("button",{onClick:()=>i(!0),className:"ml-2 text-base sm:text-lg text-white/70 hover:text-white p-1 rounded-lg hover:bg-white/10 transition",title:"Customize Billing",children:"âš™"})]}),e.jsxs("div",{className:"flex flex-wrap justify-center mb-4 sm:mb-6 gap-1 sm:gap-2 bg-white/5 backdrop-blur-xl p-1 sm:p-2 rounded-2xl border border-white/10",children:[e.jsx("button",{className:`px-3 sm:px-4 py-2 rounded-l-xl transition text-sm sm:text-base ${n==="create"?"bg-emerald-500 text-slate-900 shadow-[0_8px_24px_rgba(16,185,129,0.35)]":"bg-white/10 text-white hover:bg-white/15 border border-white/15"}`,onClick:()=>s("create"),children:"Create Invoice"}),e.jsx("button",{className:`px-3 sm:px-4 py-2 rounded-r-xl transition text-sm sm:text-base ${n==="view"?"bg-emerald-500 text-slate-900 shadow-[0_8px_24px_rgba(16,185,129,0.35)]":"bg-white/10 text-white hover:bg-white/15 border border-white/15"}`,onClick:()=>s("view"),children:"View Invoices"})]}),n==="create"&&e.jsx("div",{className:"space-y-4 pb-28",children:e.jsx(Vs,{})}),n==="view"&&e.jsx(Ks,{}),n==="create"&&e.jsx("div",{className:"fixed bottom-4 inset-x-4 z-50 md:hidden",children:e.jsx("button",{onClick:()=>console.log("Create Bill tapped"),className:"w-full text-slate-900 py-3 rounded-xl shadow-lg text-lg font-semibold bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)]",children:"Create Bill"})}),e.jsx(ps,{isOpen:t,onClose:()=>i(!1),onSaved:a=>console.log("Billing settings saved:",a)})]})};export{ln as default};
