import{j as r,y as o,r as Q,s as z,u as K,g as X,d as A}from"./index-DRC3F7i0.js";import{r as h}from"./router-BPBaD_i0.js";import{m as Y,c as Z,d as ee,s as te}from"./firebase-DWi1MSv1.js";import{l as re}from"./logInventoryChange-kGfLyhaN.js";import"./vendor-Ckhrjn13.js";import"./index.esm-Bux_mLJ0.js";const P={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_FUNCTIONS_ORIGIN:"https://us-central1-stockpilotv1.cloudfunctions.net",VITE_MSG91_WIDGET_ID:"356a79684758348381353138",VITE_PARSE_URL:"https://asia-south1-stockpilotv1.cloudfunctions.net/parse",VITE_REACT_APP_OCR_FUNCTION_URL:"https://ocrfromimage-rg2uh6cnqq-el.a.run.app",VITE_SPEECH_WS_URL:"wss://flyp-voice-streamer-30934537475.asia-south1.run.app/ws"},ce=({userId:u})=>{const[c,j]=h.useState(null),[d,R]=h.useState(""),[g,_]=h.useState(!1),[m,b]=h.useState([]),[w,k]=h.useState(""),[y,I]=h.useState(""),[C,S]=h.useState(!1),v=a=>{const e=Number(a);return Number.isFinite(e)&&e>=0?e:0},n=a=>typeof a=="string"?a.trim():"",D=a=>{const[e,t]=a.split(","),s=e.match(/data:(.*);base64/)[1]||"application/octet-stream",i=atob(t),l=new Array(i.length);for(let p=0;p<i.length;p++)l[p]=i.charCodeAt(p);const f=new Uint8Array(l);return new Blob([f],{type:s})},T=a=>{const e=a.target.files[0];if(e&&e.size<=5*1024*1024&&(e.type.includes("image")||e.type==="application/pdf")){j(e);const t=new FileReader;t.onload=()=>R(t.result),t.onerror=()=>o.error("Failed to read file for preview."),t.readAsDataURL(e),o.info(e.type==="application/pdf"?"‚úÖ PDF selected. Ready to extract.":`‚úÖ ${e.name} selected. Ready to scan.`)}else o.error("File must be under 5MB and in JPG/PNG/PDF format.")},O=a=>typeof import.meta<"u"&&P?.VITE_PARSE_CATALOGUE_AI_URL||"https://us-central1-stockpilotv1.cloudfunctions.net/parseCatalogueWithAI",L=()=>typeof import.meta<"u"&&P?.VITE_OCR_FILE_URL||"https://us-central1-stockpilotv1.cloudfunctions.net/ocrFromFile",B=a=>(a||[]).map(e=>({productName:n(e.name||e.productName||""),brand:n(e.brand||""),sku:n(e.sku||""),category:n(e.category||""),quantity:String(e.quantity??"1"),unit:n(e.unit||"pcs"),costPrice:String(e.price??e.costPrice??""),sellingPrice:String(e.sellingPrice??e.mrp??""),description:n(e.description||""),imageURL:d})),U=async(a=!1)=>{if(!c){o.error("No image selected.");return}if(!u){o.dismiss(),o.error("User not authenticated. Please log in again.");return}_(!0);const e=c.type==="application/pdf";a?o.loading(e?"ü§ñ AI reading PDF catalogue‚Ä¶":"ü§ñ AI reading image‚Ä¶"):o.loading(e?"üìÑ Extracting from PDF‚Ä¶":"üì§ Scanning with OCR‚Ä¶");try{const s=await(G=>new Promise((W,M)=>{const x=new FileReader;x.readAsDataURL(G),x.onload=()=>W(x.result.split(",")[1]),x.onerror=J=>M(J)}))(c),i=e?{pdfBase64:s,mimeType:"application/pdf"}:{imageBase64:s};a&&(w?.trim()&&(i.brandHint=w.trim()),y?.trim()&&(i.categoryHint=y.trim()));const l=a?O(!0):L(),f=a?new AbortController:null,p=a?setTimeout(()=>f?.abort(),13e4):null,E=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:f?.signal});p&&clearTimeout(p);const F=await E.json();if(!E.ok)throw new Error(F?.error||(a?"AI parse failed.":"OCR failed."));const N=F?.products||[];if(!Array.isArray(N)||N.length===0)throw new Error(a?"AI found no products. Dense catalogues can take 1‚Äì2 min‚Äîif it timed out, try cropping to one table section or a clearer image.":"No products found. Try a clearer image, or use **Parse with AI** for catalogues.");const $=B(N);b($),o.dismiss(),o.success(a?"‚úÖ AI parse complete. Review and save.":"‚úÖ Scan complete. Review and save.")}catch(t){o.dismiss();const s=t?.name==="AbortError";o.error(s?"Parsing took too long (max 2 min). Try a smaller crop or one section of the catalogue.":t?.message||(a?"AI parse failed.":"OCR scan failed.")),console.error(a?"AI Parse Error:":"OCR Scan Error:",t)}finally{_(!1)}},q=(a,e,t)=>{const s=[...m];s[a][e]=t,b(s)},V=async()=>{if(!u){o.error("User not authenticated.");return}if(!m.length){o.info("Nothing to save.");return}let a=null;try{if(d&&d.startsWith("data:")){const t=D(d),s=c?.name||`ocr-${Date.now()}.png`,i=`businesses/${u}/products/ocr/${Date.now()}-${s}`,l=Q(z,i);await K(l,t),a=await X(l)}else d&&(a=d)}catch(t){console.warn("Image upload failed, proceeding without imageURL",t),a=null}const e=m.map(t=>({productName:n(t.productName),brand:n(t.brand),sku:n(t.sku||""),category:n(t.category||""),quantity:v(t.quantity),unit:n(t.unit||"pcs"),costPrice:v(t.costPrice),sellingPrice:v(t.sellingPrice),description:n(t.description),imageURL:a||null})).filter(t=>t.productName&&t.quantity>0);if(!e.length){o.error("Please provide at least one valid product with name and quantity.");return}S(!0),o.loading("üíæ Saving products...");try{const t=Y(A),s=Z(A,"businesses",u,"products");e.forEach(i=>{const l=ee(s);t.set(l,{...i,ownerUid:u,createdAt:te(),source:"ocr"})}),await t.commit();try{for(const i of e)await re({productId:"",sku:i.sku||"",previousData:{},updatedData:i,action:"created",source:"ocr"})}catch(i){console.warn("logInventoryChange failed (non-blocking)",i)}o.dismiss(),o.success(`‚úÖ Saved ${e.length} product${e.length>1?"s":""}.`),b([]),j(null),R("")}catch(t){o.dismiss(),console.error(t),o.error("Failed to save products. See console.")}finally{S(!1)}},H=a=>{const e=m.filter((t,s)=>s!==a);b(e)};return r.jsxs("div",{className:"p-4 rounded-xl bg-white/10 backdrop-blur-xl border border-white/10 shadow-[0_8px_40px_rgba(0,0,0,0.35)] text-white",children:[typeof import.meta<"u"&&P&&!1,r.jsx("h3",{className:"text-lg font-semibold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-emerald-200",children:"OCR / PDF Inventory Upload"}),r.jsx("p",{className:"text-xs text-white/60 mb-2",children:"Upload an image or a price-list PDF to build inventory."}),r.jsx("input",{type:"file",accept:"image/*,.pdf",onChange:T,className:"mt-1 p-2 rounded bg-white/10 border border-white/20 text-white file:bg-white/10 file:border-0 file:px-3 file:py-1 file:mr-3 file:rounded cursor-pointer"}),d&&(c?.type==="application/pdf"?r.jsxs("div",{className:"mt-2 px-3 py-2 rounded border border-white/20 bg-white/5 text-white/90 text-sm",children:["üìÑ PDF: ",c?.name||"Uploaded"," ‚Äî ready to extract"]}):r.jsx("img",{src:d,alt:"Preview",className:"mt-2 w-40 h-40 object-cover rounded border border-white/20 ring-1 ring-white/10"})),r.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs text-white/60 mb-0.5",children:"Brand hint (optional)"}),r.jsx("input",{type:"text",value:w,onChange:a=>k(a.target.value),placeholder:"e.g. Ashirvad",className:"w-full px-2 py-1.5 rounded bg-white/10 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-400/50"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs text-white/60 mb-0.5",children:"Category hint (optional)"}),r.jsx("input",{type:"text",value:y,onChange:a=>I(a.target.value),placeholder:"e.g. CPVC plumbing, Fittings",className:"w-full px-2 py-1.5 rounded bg-white/10 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-400/50"})]})]}),r.jsx("p",{className:"mt-2 text-xs text-white/50",children:"Optional hints help the AI set brand/category when the catalogue is unclear."}),r.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[r.jsx("button",{onClick:()=>U(!1),className:"px-4 py-2 rounded-xl font-semibold text-slate-900 bg-white/90 hover:bg-white border border-white/30 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition",disabled:g||!c,children:g?"Scanning‚Ä¶":"Quick OCR"}),r.jsx("button",{onClick:()=>U(!0),className:"px-4 py-2 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_8px_24px_rgba(16,185,129,0.35)] disabled:opacity-50 disabled:cursor-not-allowed transition",disabled:g||!c,title:"Best for catalogues, price lists, and handwritten lists",children:g?"Parsing‚Ä¶":"Parse with AI"})]}),r.jsxs("p",{className:"mt-2 text-xs text-white/50",children:["Use ",r.jsx("strong",{children:"Parse with AI"})," for catalogues, price lists, or handwritten lists."]}),m.length>0&&r.jsxs(r.Fragment,{children:[r.jsxs("table",{className:"mt-4 w-full text-sm border border-white/10 bg-white/5 backdrop-blur-xl rounded-xl overflow-hidden",children:[r.jsx("thead",{children:r.jsxs("tr",{className:"bg-white/10 text-white/80",children:[r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"Product"}),r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"Brand"}),r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"Qty"}),r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"Unit"}),r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"Cost"}),r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"Sell"}),r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"Desc"}),r.jsx("th",{className:"px-2 py-2 border-b border-white/10",children:"üóëÔ∏è"})]})}),r.jsx("tbody",{children:m.map((a,e)=>r.jsxs("tr",{className:"hover:bg-white/5 border-t border-white/10",children:[["productName","brand","quantity","unit","costPrice","sellingPrice","description"].map(t=>r.jsx("td",{children:r.jsx("input",{type:["quantity","costPrice","sellingPrice"].includes(t)?"number":"text",value:a[t],onChange:s=>q(e,t,s.target.value),className:"w-full px-2 py-1 rounded bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/40"})},t)),r.jsx("td",{children:r.jsx("button",{onClick:()=>H(e),className:"text-rose-300 hover:text-rose-200",children:"‚ùå"})})]},e))})]}),r.jsx("button",{onClick:V,disabled:C,className:"mt-4 px-4 py-2 rounded-xl font-semibold text-slate-900 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 hover:shadow-[0_10px_30px_rgba(16,185,129,0.35)] disabled:opacity-60 disabled:cursor-not-allowed",children:C?"Saving...":"Save Products"})]})]})};export{ce as default};
