import{initializeApp as re}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as ae,signInWithEmailAndPassword as Z,onAuthStateChanged as se,signOut as ie,createUserWithEmailAndPassword as ce}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{collection as U,serverTimestamp as W,addDoc as G,query as de,onSnapshot as le,getFirestore as ue,getDoc as Q,doc as j,setDoc as me}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import{getStorage as pe,ref as ge,uploadBytes as ye,getDownloadURL as fe}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(r){if(r.ep)return;r.ep=!0;const c=s(r);fetch(r.href,c)}})();const ve="modulepreload",be=function(e){return"/"+e},K={},he=function(t,s,n){let r=Promise.resolve();if(s&&s.length>0){let l=function(o){return Promise.all(o.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=a?.nonce||a?.getAttribute("nonce");r=l(s.map(o=>{if(o=be(o),o in K)return;K[o]=!0;const d=o.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${u}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":ve,d||(m.as="script"),m.crossOrigin="",m.href=o,i&&m.setAttribute("nonce",i),document.head.appendChild(m),d)return new Promise((g,p)=>{m.addEventListener("load",g),m.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${o}`)))})}))}function c(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return r.then(a=>{for(const i of a||[])i.status==="rejected"&&c(i.reason);return t().catch(c)})},x=()=>{const e=document.getElementById("modal-container");e&&(e.innerHTML="",e.classList.add("hidden"),e.style.display="none");const t=document.getElementById("app-container");t&&t.classList.remove("blur-sm"),setTimeout(()=>{document.body.offsetHeight},50)},O=async(e,t)=>{try{const s=await fetch(e);if(!s.ok)throw new Error(`Could not fetch ${e}`);const n=await s.text();console.log(`🔍 Injecting HTML from: ${e}`),t.innerHTML=n,console.log(`✅ Loaded ${e}`)}catch(s){console.error("HTML Injection Error:",s),t.innerHTML=`<p class="p-8 text-red-400">Error loading ${e}</p>`}},ee=e=>{const t=document.createElement("div");t.className="fixed top-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-500 opacity-0",t.innerHTML=`<strong>✅</strong> ${e}`,document.body.appendChild(t),setTimeout(()=>t.classList.add("opacity-100"),100),setTimeout(()=>{t.classList.remove("opacity-100"),setTimeout(()=>t.remove(),500)},3e3)};let M=null,B=null;const z=async e=>{e.preventDefault();const t=e.target;console.log("📤 Submitting product form");const s=t.querySelector('button[type="submit"]');s.disabled=!0,s.textContent="Saving...";const n=t.querySelector("#add-product-form-error");n&&(n.textContent="");const r=t.querySelector("#product-name").value,c=t.querySelector("#product-sku").value,a=t.querySelector("#quantity")?.value,i=t.querySelector("#product-unit").value,l=t.querySelector("#selling-price")?.value,o=Array.from(t.querySelector("#product-image").files).slice(0,3),d=t.querySelector("#description")?.value,u=t.querySelector("#brand-name").value;console.log("📦 Product Data Captured:",{productName:r,productSku:c,productQuantity:a,productUnit:i,productPrice:l,productImageFiles:o,productDescription:d,productBrand:u,productCategory:t.querySelector("#category").value,costPrice:t.querySelector("#cost-price")?.value});const m=t.querySelector("#category").value,g=t.querySelector("#cost-price")?.value;if(!r||!c||isNaN(Number(a))||isNaN(Number(l))||isNaN(Number(g))){n&&(n.textContent="Please fill in all required fields correctly."),s.disabled=!1,s.textContent="Save";return}try{if(!B||!M){console.error("User or Firestore DB not initialized."),n&&(n.textContent="User not logged in or database error."),s.disabled=!1,s.textContent="Save";return}let p=[];if(o.length>0){const w=pe();for(const E of o){const h=ge(w,`users/${B.uid}/products/${c}_${Date.now()}_${E.name}`);try{const y=await ye(h,E),q=await fe(y.ref);p.push(q)}catch(y){console.error("⚠️ Image upload failed:",y),n&&(n.textContent="One or more images failed to upload."),s.disabled=!1,s.textContent="Save";return}}}const f=U(M,`businesses/${B.uid}/products`);console.log("📁 Ready to save to Firestore at:",`businesses/${B.uid}/products`);const b={name:r,sku:c,quantity:Number(a),unit:i,price:Number(l),image:p,description:d,brand:u,category:m,cost:Number(g),createdAt:W()};console.log("🚀 Sending product data to Firestore:",b),await G(f,b),console.log("✅ Firestore write completed"),ee(`Product "${r}" added successfully!`),t.reset(),s.disabled=!1,s.textContent="Save",x(),console.log("Saved to Firestore:",b)}catch(p){console.error("Error adding document: ",p),console.log("❌ Firestore save failed with error:",p.message),n&&(n.textContent="Failed to save product."),s.disabled=!1,s.textContent="Save"}},N=e=>{const t=document.getElementById("inventory-list");if(!t)return;const s=document.getElementById("search-input"),n=document.getElementById("sort-select"),r=s?.value.toLowerCase()||"",c=n?.value||"";let a=[...e];const i=document.querySelector(".chip.active"),l=i?i.dataset.status:null;if(l==="in-stock"?a=a.filter(o=>o.quantity>0):l==="low"?a=a.filter(o=>o.quantity===0):l==="out-of-stock"&&(a=a.filter(o=>o.quantity===0)),a=a.filter(o=>o.name.toLowerCase().includes(r)||o.sku.toLowerCase().includes(r)||o.brand.toLowerCase().includes(r)),c==="name-asc"&&a.sort((o,d)=>o.name.localeCompare(d.name)),c==="name-desc"&&a.sort((o,d)=>d.name.localeCompare(o.name)),c==="qty-asc"&&a.sort((o,d)=>o.quantity-d.quantity),c==="qty-desc"&&a.sort((o,d)=>d.quantity-o.quantity),c==="price-asc"&&a.sort((o,d)=>o.price-d.price),c==="price-desc"&&a.sort((o,d)=>d.price-o.price),a.length===0){t.innerHTML=`<tr><td colspan="10" class="text-center p-8 text-gray-500">You haven't added any products yet. Click "Add Inventory" to get started.</td></tr>`;return}t.innerHTML=a.map(o=>{const d=o.quantity>0?'<span class="text-sm px-2 py-1 rounded-full bg-green-600 text-white">🟢 In Stock</span>':'<span class="text-sm px-2 py-1 rounded-full bg-red-600 text-white">🔴 Low</span>',u=Array.isArray(o.image)?o.image[0]:o.image;return`
      <tr class="border-b border-white/10 hover:bg-white/5">
        <td class="p-4">${u?`<img src="${u}" alt="${o.name}" class="w-12 h-12 object-cover rounded" />`:'<div class="w-12 h-12 bg-gray-700 text-white flex items-center justify-center rounded">📦</div>'}</td>
        <td class="p-4 font-medium">${o.name}</td>
        <td class="p-4 text-gray-400">${o.sku}</td>
        <td class="p-4 text-gray-400">${o.brand}</td>
        <td class="p-4 text-gray-400">${o.category}</td>
        <td class="p-4 text-gray-400">${o.quantity}</td>
        <td class="p-4 text-gray-400">${o.unit}</td>
        <td class="p-4 text-gray-400">₹${o.cost}</td>
        <td class="p-4 text-gray-400">₹${o.price}</td>
        <td class="p-4 text-center whitespace-nowrap w-32">${d}</td>
      </tr>
    `}).join("")},X=(e=document.getElementById("inventory-list"))=>{if(!B||!e)return;console.log("🔄 Listening for inventory updates...");const t=de(U(M,`businesses/${B.uid}/products`));le(t,s=>{const n=[];s.forEach(i=>{n.push({id:i.id,...i.data()})}),n.sort((i,l)=>{const o=i.createdAt?.toDate?.()?i.createdAt.toDate():0;return(l.createdAt?.toDate?.()?l.createdAt.toDate():0)-o}),N(n);const r=document.getElementById("search-input"),c=document.getElementById("sort-select");r&&r.addEventListener("input",()=>N(n)),c&&c.addEventListener("change",()=>N(n));const a=document.querySelectorAll(".chip");a.forEach(i=>{i.addEventListener("click",()=>{a.forEach(l=>l.classList.remove("active")),i.classList.add("active"),N(n)})})})},J=()=>{document.getElementById("close-add-inventory-options-modal-btn")?.addEventListener("click",x),document.getElementById("open-manual-entry-form")?.addEventListener("click",()=>{const e=document.getElementById("inventory-tab-content");e&&fetch("./src/modals/manual-entry-form.html").then(t=>t.text()).then(t=>{e.innerHTML=t;const s=document.createElement("button");s.textContent="← Back to Inventory",s.className="mb-4 bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700",s.addEventListener("click",()=>{O("./src/modals/add-inventory-options-modal.html",e).then(()=>{J()})}),e.prepend(s),document.getElementById("manual-entry-form")?.addEventListener("submit",z),console.log("🧩 handleAddProduct bound to #manual-entry-form");const n=document.getElementById("product-image"),r=document.getElementById("image-preview");n?.addEventListener("change",i=>{const l=document.getElementById("image-preview");l.innerHTML="";const o=Array.from(i.target.files),d=["image/jpeg","image/png","image/webp"],u=5*1024*1024;let m=[];o.forEach((p,f)=>{if(!d.includes(p.type)){alert(`${p.name} is not a valid image. Only JPG, PNG, and WEBP allowed.`);return}if(p.size>u){alert(`${p.name} exceeds 5MB limit.`);return}m.push(p);const b=new FileReader;b.onload=function(w){const E=document.createElement("div");E.className="relative inline-block m-1",E.innerHTML=`
                <img src="${w.target.result}" alt="Preview" class="w-16 h-16 object-cover rounded border border-gray-300" />
                <button data-index="${f}" class="absolute top-0 right-0 bg-red-600 text-white text-xs px-1 rounded remove-preview">&times;</button>
              `,l.appendChild(E)},b.readAsDataURL(p)});const g=new DataTransfer;m.forEach(p=>g.items.add(p)),n.files=g.files,l.addEventListener("click",p=>{if(p.target.classList.contains("remove-preview")){const f=Number(p.target.dataset.index),b=Array.from(n.files).filter((E,h)=>h!==f),w=new DataTransfer;b.forEach(E=>w.items.add(E)),n.files=w.files,n.dispatchEvent(new Event("change"))}}),l.classList.remove("hidden")});const c=document.getElementById("image-upload-area"),a=document.getElementById("remove-image");c?.addEventListener("click",()=>{n.click()}),c?.addEventListener("dragover",i=>{i.preventDefault(),c.classList.add("bg-gray-700")}),c?.addEventListener("dragleave",i=>{i.preventDefault(),c.classList.remove("bg-gray-700")}),c?.addEventListener("drop",i=>{i.preventDefault(),c.classList.remove("bg-gray-700"),i.dataTransfer.files[0]&&(n.files=i.dataTransfer.files,n.dispatchEvent(new Event("change")))}),a?.addEventListener("click",()=>{n.value="",r.src="",r.classList.add("hidden"),a.classList.add("hidden")})})}),document.getElementById("open-ocr-upload-form")?.addEventListener("click",()=>{O("./src/modals/ocr-upload-form.html",document.getElementById("inventory-tab-content")).then(()=>{setTimeout(()=>{document.getElementById("close-ocr-upload-form-btn")?.addEventListener("click",x);const e=document.getElementById("ocr-image-file"),t=document.getElementById("ocr-upload-area");document.getElementById("ocr-preview");const s=document.getElementById("ocr-inventory-form"),n=document.getElementById("ocr-preview-output");if(!e||!s||!n){console.error("❌ OCR DOM not ready");return}const r=["image/jpeg","image/png","image/webp"],c=5*1024*1024;t?.addEventListener("click",()=>{e.click()}),t?.addEventListener("dragover",i=>{i.preventDefault(),t.classList.add("bg-gray-700")}),t?.addEventListener("dragleave",i=>{i.preventDefault(),t.classList.remove("bg-gray-700")}),t?.addEventListener("drop",i=>{i.preventDefault(),t.classList.remove("bg-gray-700");const l=i.dataTransfer.files[0];l&&r.includes(l.type)&&l.size<=c?(e.files=i.dataTransfer.files,e.dispatchEvent(new Event("change"))):alert("Invalid file type or size exceeds 5MB.")}),e?.addEventListener("change",i=>{const l=i.target.files[0],o=document.getElementById("ocr-preview");if(!o){console.error("❌ Element with id 'ocr-preview' not found.");return}if(o.innerHTML="",l&&r.includes(l.type)&&l.size<=c){const d=new FileReader;d.onload=function(u){const m=document.createElement("div");m.className="relative inline-block m-1",m.innerHTML=`
                <img src="${u.target.result}" alt="Preview" class="w-24 h-24 object-cover rounded border border-gray-300" />
                <button id="remove-ocr-preview" class="absolute top-0 right-0 bg-red-600 text-white text-xs px-1 rounded">&times;</button>
              `,o.appendChild(m)},d.readAsDataURL(l)}o.addEventListener("click",d=>{d.target.id==="remove-ocr-preview"&&(e.value="",o.innerHTML="")})}),s?.addEventListener("submit",async i=>{i.preventDefault(),console.log("🧠 OCR Form Submitted. Starting scan...");const l=e.files[0];if(l){if(!window.Tesseract){n.innerHTML="<div class='text-red-500'>❌ OCR Engine not found. Make sure Tesseract.js is loaded.</div>";return}n.innerHTML="<div class='text-yellow-300 flex items-center gap-2'><svg class='animate-spin h-5 w-5 text-yellow-300' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'><circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle><path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z'></path></svg>🕵️ Scanning image, please wait...</div>";try{const d=(await Tesseract.recognize(l,"eng")).data.text;console.log("📄 OCR Result:",d),n.innerHTML=`<pre class="bg-black p-2 rounded border border-gray-700 overflow-auto text-green-400">${d}</pre>`;const m=d.replace(/[“”"':*]/g,"").replace(/\s{2,}/g," ").trim().split(`
`).map(f=>f.trim()).filter(f=>f),g=[];if(m.forEach(f=>{const b=/^(.+?)\s+(\d+)\s*(pcs|kg|ltr|box)?(?:\s*₹?\s*(\d+))?$/i,w=f.match(b);if(w){const[,E,h,y,q]=w;g.push({name:E,quantity:h,unit:y||"pcs",price:q})}}),g.length===0){n.innerHTML+='<div class="text-yellow-400 mt-2">⚠️ No structured items found from OCR. Please edit manually or retry.</div>';return}let p=`
              <table class="mt-4 w-full text-sm text-white border border-gray-700">
                <thead class="bg-gray-800 text-white">
                  <tr>
                    <th class="p-2">✔</th>
                    <th class="p-2">Product Name</th>
                    <th class="p-2">Qty</th>
                    <th class="p-2">Unit</th>
                    <th class="p-2">Price</th>
                    <th class="p-2"></th>
                  </tr>
                </thead>
                <tbody>
            `;g.forEach((f,b)=>{p+=`
                <tr class="border-b border-gray-600">
                  <td class="text-center"><input type="checkbox" class="ocr-product-check" data-index="${b}" checked /></td>
                  <td><input type="text" class="ocr-name bg-transparent border p-1 w-full" value="${f.name}" /></td>
                  <td><input type="number" class="ocr-qty bg-transparent border p-1 w-full" value="${f.quantity}" /></td>
                  <td><input type="text" class="ocr-unit bg-transparent border p-1 w-full" value="${f.unit}" /></td>
                  <td><input type="number" class="ocr-price bg-transparent border p-1 w-full" value="${f.price}" /></td>
                  <td><button class="delete-row text-red-500 px-2">🗑️</button></td>
                </tr>
              `}),p+=`</tbody></table>
              <button id="confirm-ocr-upload" class="mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">✅ Confirm & Upload</button>
            `,n.innerHTML+=p,n.innerHTML+=`
              <button id="add-product-row" class="mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">➕ Add Another Product Row</button>
            `,n.innerHTML+=`
              <div class="flex gap-2 mt-3">
                <button id="delete-selected-rows" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">🗑️ Delete Selected Rows</button>
                <button id="download-csv" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">📥 Download CSV</button>
              </div>
            `,setTimeout(()=>{const f=document.getElementById("add-product-row"),b=n.querySelector("table tbody");f?.addEventListener("click",()=>{const h=n.querySelector("table tbody"),y=document.createElement("tr");y.className="border-b border-gray-600",y.innerHTML=`
                  <td class="text-center"><input type="checkbox" class="ocr-product-check" checked /></td>
                  <td><input type="text" class="ocr-name bg-transparent border p-1 w-full" placeholder="Product name" /></td>
                  <td><input type="number" class="ocr-qty bg-transparent border p-1 w-full" placeholder="Qty" /></td>
                  <td><input type="text" class="ocr-unit bg-transparent border p-1 w-full" placeholder="Unit" /></td>
                  <td><input type="number" class="ocr-price bg-transparent border p-1 w-full" placeholder="Price" /></td>
                  <td><button class="delete-row text-red-500 px-2">🗑️</button></td>
                `,h.appendChild(y)}),b.addEventListener("click",h=>{h.target.classList.contains("delete-row")&&h.target.closest("tr")?.remove()}),document.getElementById("delete-selected-rows")?.addEventListener("click",()=>{n.querySelectorAll("table tbody tr").forEach(y=>{y.querySelector(".ocr-product-check")?.checked&&y.remove()})}),document.getElementById("download-csv")?.addEventListener("click",()=>{const h=n.querySelectorAll("table tbody tr");let y=`Product Name,Quantity,Unit,Price
`;h.forEach($=>{const D=$.querySelector(".ocr-name")?.value||"",_=$.querySelector(".ocr-qty")?.value||"",R=$.querySelector(".ocr-unit")?.value||"",oe=$.querySelector(".ocr-price")?.value||"";y+=`${D},${_},${R},${oe}
`});const q=new Blob([y],{type:"text/csv;charset=utf-8;"}),H=URL.createObjectURL(q),C=document.createElement("a");C.setAttribute("href",H),C.setAttribute("download","ocr_inventory.csv"),C.style.display="none",document.body.appendChild(C),C.click(),document.body.removeChild(C)})},100),setTimeout(()=>{const f=document.getElementById("confirm-ocr-upload");if(!f){console.warn("⚠️ confirm-ocr-upload button not found after DOM update.");return}f.addEventListener("click",async()=>{if(console.log("💾 Saving OCR extracted products to Firestore..."),!B||!M)return alert("User or DB not ready.");const b=n.querySelectorAll("tbody tr");let w=0,E=0;for(let h=0;h<b.length;h++){const y=b[h];if(y.style.border="",!y.querySelector(".ocr-product-check")?.checked)continue;const H=y.querySelector(".ocr-name")?.value.trim(),C=parseInt(y.querySelector(".ocr-qty")?.value||"0"),$=y.querySelector(".ocr-unit")?.value.trim(),D=parseFloat(y.querySelector(".ocr-price")?.value||"0");if(!H||isNaN(C)||!$||isNaN(D)){y.style.border="2px solid red",E++;continue}const _={name:H,sku:`${H}-${Date.now()}`,quantity:C,unit:$,price:D,cost:D,brand:"N/A",category:"Uncategorized",description:"Added via OCR",image:[],createdAt:W()};try{const R=U(M,`businesses/${B.uid}/products`);await G(R,_),w++}catch(R){console.error("❌ Failed to save OCR product:",R),E++}}w>0?(ee(`${w} OCR products added successfully!`),n.innerHTML=`<div class="text-green-400 mt-4">✅ ${w} products saved to inventory!</div>`):n.innerHTML+='<div class="text-yellow-400 mt-4">⚠️ No valid product rows were saved. Please check highlighted rows.</div>'})},100)}catch(o){console.error("❌ OCR failed",o),n.innerHTML=`<div class="text-red-500">Error during OCR: ${o.message}</div>`}}});const a=document.getElementById("scan-import-btn");a&&a.addEventListener("click",async()=>{const i=document.getElementById("ocr-preview");if(!i){console.error("❌ Element with id 'ocr-preview' not found."),alert("OCR preview area not found. Please reload the page.");return}const l=i.querySelector("img");if(!l){alert("Please upload an image before scanning.");return}a.textContent="Scanning...",a.disabled=!0;try{const d=(await Tesseract.recognize(l.src,"eng")).data.text;console.log("OCR Result:",d);const u=d.split(`
`).map(g=>g.trim()).filter(g=>g.length>0),m=B.uid;for(const g of u){const p=g.match(/(.+?)\s+(\d+)\s*(pcs|kg|ltr)?/i);if(p){const[f,b,w,E]=p,h=E||"unit",y={productName:b.trim(),quantity:parseInt(w),unit:h,createdAt:W()};await G(U(M,`businesses/${m}/products`),y)}}alert("Inventory imported successfully!")}catch(o){console.error("OCR Error:",o),alert("Failed to scan image. Please try again.")}finally{a.textContent="Scan and Import",a.disabled=!1}})},300)})}),document.getElementById("open-ai-autogen-form-btn")?.addEventListener("click",()=>{O("./src/modals/ai-autogen-form.html",modalContainer).then(()=>{document.getElementById("close-ai-autogen-form-btn")?.addEventListener("click",x)})})},te=()=>{const e=document.getElementById("inventory-tab-content");e&&(e.innerHTML=""),O("./src/modals/add-inventory-options-modal.html",e).then(()=>{J()})},ne=(e,t)=>{if(M=e,B=t,!document.getElementById("modal-container")||!document.getElementById("inventory-tab-content"))return;document.addEventListener("click",c=>{c.target?.id==="close-add-inventory-options-modal-btn"&&x()}),X(),(()=>{const c=document.getElementById("inventory-tab-content");if(!c)return;[{id:"tab-add",action:te},{id:"tab-view",path:"./src/views/inventory-view.html"},{id:"tab-group",path:"./src/views/item-group.html"},{id:"tab-alerts",path:"./src/views/low-stock-alert.html"}].forEach(i=>{const l=document.getElementById(i.id);l&&l.addEventListener("click",async()=>{i.action?i.action():(c.innerHTML="",await O(i.path,c),i.id==="tab-view"&&setTimeout(()=>{const o=document.getElementById("inventory-list");X(o)},100))})})})()},we=Object.freeze(Object.defineProperty({__proto__:null,bindInventoryOptionButtons:J,handleAddProduct:z,initInventoryPage:ne,loadAddInventoryOptions:te},Symbol.toStringTag,{value:"Module"})),Ee=(e,t)=>{console.log("Billing page initialized for user:",t.uid);const s=document.getElementById("product-select"),n=document.getElementById("add-to-cart-btn"),r=document.getElementById("cart-table-body"),c=new TomSelect(s,{valueField:"id",labelField:"label",searchField:["label","search"],options:[],create:!1,maxOptions:500,highlight:!0,render:{option:function(d,u){return`<div>${u(d.label)}</div>`}}});let a=[];const i=e.collection("businesses").doc(t.uid).collection("products");i.get().then(d=>{const u=[];d.forEach(m=>{const g=m.data();u.push({id:m.id,label:`${g.productName} - ${g.sku||""}`,search:`${g.productName||""} ${g.sku||""} ${g.brand||""} ${g.category||""}`})}),c.addOptions(u)}).catch(d=>{console.error("Error loading products:",d)}),n.addEventListener("click",()=>{const d=c.getValue();d&&i.doc(d).get().then(u=>{if(!u.exists)return;const m=u.data(),g=a.find(p=>p.id===d);g?g.quantity+=1:a.push({id:d,name:m.productName,price:m.sellingPrice,quantity:1}),l()})});function l(){r.innerHTML="",a.forEach(u=>{const m=document.createElement("tr");m.innerHTML=`
                <td>${u.name}</td>
                <td>${u.quantity}</td>
                <td>₹${u.price.toFixed(2)}</td>
                <td>₹${(u.quantity*u.price).toFixed(2)}</td>
                <td><button class="text-red-600 font-bold delete-cart-item" data-id="${u.id}">🗑️</button></td>
            `,r.appendChild(m)}),r.querySelectorAll(".delete-cart-item").forEach(u=>{u.addEventListener("click",()=>{const m=u.getAttribute("data-id");o(m)})})}function o(d){a=a.filter(u=>u.id!==d),l()}};console.log("✅ main.js loaded successfully");const Le={apiKey:"AIzaSyBPkkXZWll0VifG5kb0DDSsoV5UB-n5pFE",authDomain:"stockpilotv1.firebaseapp.com",projectId:"stockpilotv1",storageBucket:"stockpilotv1.firebasestorage.app",messagingSenderId:"30934537475",appId:"1:30934537475:web:84a2f76609dbb1db290536",measurementId:"G-SENFJ2HSBW"};let V,A,T,k,I="";const v={},xe=()=>{v.landingPageView=document.getElementById("landing-page-view"),v.dashboardView=document.getElementById("dashboard-view"),v.modalContainer=document.getElementById("modal-container"),v.pageContent=document.getElementById("page-content")},S=async(e,t)=>{try{const s=await fetch(e.startsWith("./")?e:`./src/views/${e}`);if(!s.ok)throw new Error(`Could not fetch ${e}`);const n=await s.text();t.innerHTML=n,console.log(`✅ Loaded ${e}`)}catch(s){console.error("HTML Injection Error:",s),t.innerHTML=`<div class="p-6 bg-red-900 text-white rounded">❌ Failed to load: ${e}</div>`}},L=async e=>{if(e==="landing"){if(!v.landingPageView){console.warn("Landing page view container not found");return}await S("./src/views/landing-page.html",v.landingPageView),P("landing");return}if(!v.pageContent){console.error("❌ pageContent container not found");return}v.pageContent.innerHTML="",document.querySelectorAll(".dashboard-nav-link").forEach(t=>{t.classList.toggle("active",t.getAttribute("href")===`#${e}`)}),await S(`./src/views/${e}.html`,v.pageContent),e==="inventory"&&(console.log("🔧 Inventory page init with:",T,k),ne(T,k)),e==="billing"&&Ee(T,k)},Ie=()=>{const e=document.getElementById("sign-in-modal");e&&(e.querySelector("#close-modal-btn").addEventListener("click",()=>{e.querySelector("#sign-in-form")?.reset(),e.querySelector("#form-error").textContent="",x()}),e.querySelector("#sign-in-form").addEventListener("submit",async t=>{t.preventDefault();const s=t.target,n=s.querySelector("#form-error");n.textContent="";try{const r=await Z(A,s["login-email"].value,s["login-password"].value),c=j(T,"businesses",r.user.uid),a=await Q(c);if(a.exists()){const i=a.data();x(),s.reset(),k=r.user,P("dashboard"),i.role==="retailer"?await L("inventory"):i.role==="distributor"?await L("billing"):await L("inventory")}else n.textContent="User profile not found."}catch(r){n.textContent=r.message}}))},Be=()=>{const e=document.querySelectorAll(".role-card"),t=document.getElementById("next-to-details"),s=document.getElementById("close-modal-btn");e.forEach(n=>{n.addEventListener("click",()=>{e.forEach(c=>c.classList.remove("selected")),n.classList.add("selected"),I=n.getAttribute("data-role");const r=document.getElementById("selected-role");r&&(r.value=I)})}),t?.addEventListener("click",async()=>{if(!I){alert("Please select a role to continue.");return}const n=document.getElementById("selected-role");n&&(n.value=I);const r=document.getElementById("registration-modal");if(r){const a=await(await fetch("./src/views/registration-form.html")).text();r.innerHTML=a,setTimeout(()=>{const i=document.getElementById("selected-role");i&&(i.value=I);const l=document.getElementById("registration-form");l&&l.addEventListener("submit",async o=>{o.preventDefault();try{const u=(await ce(A,l["register-email"].value,l["register-password"].value)).user.uid;await me(j(T,"businesses",u),{businessName:l["business-name"].value,ownerName:l["owner-name"].value,email:l["register-email"].value,phone:l.phone.value,city:l.city.value,role:I,createdAt:new Date().toISOString()}),x(),v.modalContainer.innerHTML="",P("dashboard"),I==="retailer"?await L("inventory"):I==="distributor"?await L("billing"):await L("inventory"),I=""}catch(d){alert(d.message)}})},0)}}),s?.addEventListener("click",()=>{x()})},Y=async e=>{await S(`./src/modals/${e}.html`,v.modalContainer),e==="sign-in-modal"&&Ie(),e==="registration-modal"&&Be()};typeof z!="function"&&console.warn("⚠️ handleAddProduct is not implemented. Manual inventory form may not submit properly.");const Ce=async()=>{v.modalContainer&&(v.modalContainer.innerHTML="",await S("./src/modals/add-inventory-options-modal.html",v.modalContainer),requestAnimationFrame(()=>{const e=document.getElementById("open-manual-entry-form"),t=document.getElementById("ocr-upload-btn"),s=document.getElementById("ai-autogen-btn"),n=document.getElementById("close-add-inventory-options-modal-btn");n&&n.addEventListener("click",()=>{v.modalContainer.innerHTML="";const r=document.getElementById("inventory-panel");r&&(r.innerHTML='<p class="text-gray-400 italic">Please select a tab above to get started.</p>')}),e&&e.addEventListener("click",async()=>{const r=document.getElementById("inventory-panel");r&&(await S("./src/modals/manual-entry-form.html",r),v.modalContainer.innerHTML="",requestAnimationFrame(()=>{const c=document.getElementById("close-add-product-modal-btn"),a=document.getElementById("add-product-form");c&&c.addEventListener("click",()=>{r.innerHTML='<p class="text-gray-400 italic">Please select a tab above to get started.</p>'}),a&&a.addEventListener("submit",z)}))}),t&&t.addEventListener("click",async()=>{await S("./src/modals/ocr-upload-form.html",v.modalContainer),requestAnimationFrame(()=>{document.getElementById("close-ocr-upload-modal-btn")?.addEventListener("click",x)})}),s&&s.addEventListener("click",async()=>{await S("./src/modals/ai-autogen-form.html",v.modalContainer),requestAnimationFrame(()=>{document.getElementById("close-ai-autogen-modal-btn")?.addEventListener("click",x)})})}))},F=()=>{document.body.addEventListener("click",e=>{if(e.target.closest("#close-add-inventory-options-modal-btn")){x();return}const t=e.target.closest("#register-btn, #register-btn-hero"),s=e.target.closest("#sign-in-btn"),n=e.target.closest("#sign-out-btn"),r=e.target.closest(".dashboard-nav-link");if(t&&(I="",Y("registration-modal")),s&&Y("sign-in-modal"),n&&ie(A).then(async()=>{k=null,P("landing"),await L("landing"),F()}).catch(a=>console.error("Sign out failed:",a)),r){e.preventDefault();const a=r.getAttribute("href").substring(1);L(a)}e.target.closest("#add-product-btn")&&Ce()}),document.body.addEventListener("click",async e=>{const t=e.target.closest("#tab-add, #tab-view, #tab-group, #tab-alerts");if(!t)return;const s=t.id,n={"tab-add":"./src/modals/add-inventory-options-modal.html","tab-view":"./src/views/inventory-view.html","tab-group":"./src/views/item-group.html","tab-alerts":"./src/views/low-stock-alert.html"},r=document.getElementById("inventory-tab-content");if(r)if(r.innerHTML="",s==="tab-add"){const{loadAddInventoryOptions:c}=await he(async()=>{const{loadAddInventoryOptions:a}=await Promise.resolve().then(()=>we);return{loadAddInventoryOptions:a}},void 0);c()}else await S(n[s],r)})},P=e=>{v.landingPageView?.classList.toggle("hidden-view",e!=="landing"),v.dashboardView?.classList.toggle("hidden-view",e!=="dashboard")},Se=async()=>{xe();try{V=re(Le),A=ae(V),T=ue(V);const e=new URLSearchParams(window.location.search),t=e.get("login-email"),s=e.get("login-password");if(t&&s)try{k=(await Z(A,t,s)).user;const r=await Q(j(T,"businesses",k.uid)),c=r.exists()?r.data().role:null;P("dashboard"),c==="retailer"?await L("inventory"):c==="distributor"?await L("billing"):await L("inventory"),window.history.replaceState({},document.title,window.location.pathname+"#dashboard"),F();return}catch(n){console.error("Auto-login from URL failed",n),alert("Login failed. Please try again."),await L("landing")}else await L("landing");F()}catch(e){console.error("Firebase init failed:",e),document.body.innerHTML='<div class="p-10 bg-red-900 text-white">FATAL ERROR: Firebase not configured</div>';return}se(A,async e=>{if(k=e,e){const t=await Q(j(T,"businesses",e.uid)),s=t.exists()?t.data().role:null;P("dashboard"),s==="retailer"?await L("inventory"):s==="distributor"?await L("billing"):await L("inventory")}else await L("landing");F()})};document.addEventListener("DOMContentLoaded",()=>{window.location.hash||(window.location.hash="#landing"),Se()});
