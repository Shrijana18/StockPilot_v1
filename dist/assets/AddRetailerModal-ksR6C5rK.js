const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.esm-Bux_mLJ0.js","assets/firebase-DWi1MSv1.js"])))=>i.map(i=>d[i]);
import{j as e,d as P,_ as te}from"./index-DRC3F7i0.js";import{r as y}from"./router-BPBaD_i0.js";import{c as S,d as T,s as j,l as $}from"./firebase-DWi1MSv1.js";import{A as ie}from"./index-DSciU07p.js";import{m as J}from"./proxy-BgUy8BPw.js";let D=null;try{const{getFunctions:n,httpsCallable:a}=await te(async()=>{const{getFunctions:c,httpsCallable:C}=await import("./index.esm-Bux_mLJ0.js");return{getFunctions:c,httpsCallable:C}},__vite__mapDeps([0,1]));D={getFunctions:n,httpsCallable:a}}catch{}function ce({open:n,onClose:a,distributorId:c,onCreated:C,createdBy:o,useCloudFunction:X=!0,toast:m,uiVariant:F="centered",autofocus:z=!1}){const[t,v]=y.useState({businessName:"",ownerName:"",email:"",phone:"",gst:"",address:"",city:"",state:""}),[h,N]=y.useState(!1),[R,x]=y.useState(""),[g,E]=y.useState(null),O=y.useMemo(()=>t.businessName.trim()!==""&&!h,[t,h]),A=y.useMemo(()=>{const i=t.email.trim()!==""||t.phone.trim()!=="";return t.businessName.trim()!==""&&i&&!h},[t,h]);y.useEffect(()=>{if(!n)return;const i=r=>{const u=navigator.platform.toUpperCase().includes("MAC")?r.metaKey:r.ctrlKey;r.key==="Escape"&&!h&&a?.(),u&&r.key==="Enter"&&A&&!h&&(r.preventDefault(),document.getElementById("add-retailer-submit")?.click())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[n,h,A,a]),y.useEffect(()=>{n||(v({businessName:"",ownerName:"",email:"",phone:"",gst:"",address:"",city:"",state:""}),N(!1),x(""),E(null))},[n]);const p=i=>r=>v(s=>({...s,[i]:r.target.value})),B=()=>{if(!t.businessName.trim())return"Business name is required.";if(!t.email.trim()&&!t.phone.trim())return"Provide at least an email or a phone number.";if(t.email.trim()&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email.trim()))return"Enter a valid email address.";if(t.phone.trim()){const i=t.phone.replace(/[^\d]/g,"");if(!(i.length===10||i.length===12&&i.startsWith("91")))return"Enter a valid 10‑digit Indian phone (with or without +91)."}return t.gst.trim()&&!/^[0-9A-Z]{15}$/i.test(t.gst.trim())?"Enter a valid 15‑character GSTIN (alphanumeric).":""},q=async()=>{if(x(""),!c){const i="Missing distributorId – cannot create retailer.";x(i),m?.({type:"error",message:i});return}if(!t.businessName.trim()){const i="Business name is required.";x(i),m?.({type:"error",message:i});return}try{const i=_(t.phone),r=t.email.trim().toLowerCase()||null,s=S(P,"businesses",c,"connectedRetailers");if((await getDocs(s)).docs.find(k=>{const I=k.data(),f=I.retailerPhone||I.phone,L=(I.retailerEmail||I.email||"").toLowerCase();return i&&f&&f===i||r&&L&&L===r})){const k="A retailer with this email or phone number already exists.";x(k),m?.({type:"error",message:k});return}}catch(i){console.error("Error checking duplicates:",i)}N(!0);try{const i=T(S(P,"businesses",c,"connectedRetailers")),r=i.id,s={retailerId:r,retailerName:t.businessName.trim(),status:"provisioned-local",source:"provisioned-local",createdAt:j(),updatedAt:j()};if(t.email.trim()&&(s.retailerEmail=t.email.trim()),t.phone.trim()){const u=_(t.phone);u&&(s.retailerPhone=u)}t.address.trim()&&(s.retailerAddress=t.address.trim()),t.city.trim()&&(s.retailerCity=t.city.trim()),t.state.trim()&&(s.retailerState=t.state.trim()),t.gst.trim()&&(s.gst=t.gst.trim().toUpperCase()),o?.type&&o?.id?(s.addedBy={type:o.type,id:o.id},o.name&&(s.addedBy.name=o.name),o.flypEmployeeId&&(s.addedBy.flypEmployeeId=o.flypEmployeeId)):s.addedBy={type:"distributor",id:c},await $(i,s,{merge:!0}),C?.({retailerId:r,payload:s}),m?.({type:"success",message:"Retailer created successfully!"}),a?.()}catch(i){console.error("Error creating retailer:",i);const r=i.message||"Failed to create retailer. Please check your permissions.";x(r),m?.({type:"error",message:r})}finally{N(!1)}},W=async i=>{try{await navigator.clipboard.writeText(i),m?.({type:"success",message:"Invite link copied."})}catch{m?.({type:"error",message:"Could not copy. Select and copy manually."})}},K=async i=>{i.preventDefault(),x("");const r=B();if(r){x(r),m?.({type:"error",message:r});return}if(!c){const s="Missing distributorId – cannot create provisional retailer.";x(s),m?.({type:"error",message:s});return}N(!0);try{if(X&&D){const w=await D.httpsCallable(D.getFunctions(),"createProvisionalRetailer")({distributorId:c,payload:{businessName:t.businessName.trim(),ownerName:t.ownerName.trim(),email:t.email.trim()||null,phone:_(t.phone),gst:t.gst.trim()||null,address:t.address.trim()||null,city:t.city.trim()||null,state:t.state.trim()||null}}),{provisionalId:U,inviteUrl:M}=w?.data||{},H={provisionalId:U,inviteUrl:M,payload:w?.data?.payload||null};E(H),C?.(H),m?.({type:"success",message:"Provisional retailer created."}),N(!1);return}const s=_(t.phone),u=t.email.trim().toLowerCase()||null,G=S(P,"businesses",c,"connectedRetailers");if((await getDocs(G)).docs.find(Z=>{const w=Z.data(),U=w.retailerPhone||w.phone,M=(w.retailerEmail||w.email||"").toLowerCase();return s&&U&&U===s||u&&M&&M===u}))throw new Error("A retailer with this email or phone number already exists.");const f=ae(),L=T(S(P,"provisionalRetailers"),f),l={createdBy:c,businessName:t.businessName.trim(),status:"provisional",connectedDistributorId:c,createdAt:j(),updatedAt:j()};t.ownerName.trim()&&(l.ownerName=t.ownerName.trim()),t.email.trim()&&(l.retailerEmail=t.email.trim()),s&&(l.retailerPhone=s),t.gst.trim()&&(l.gst=t.gst.trim().toUpperCase()),t.address.trim()&&(l.address=t.address.trim()),t.city.trim()&&(l.city=t.city.trim()),t.state.trim()&&(l.state=t.state.trim()),await $(L,l,{merge:!0});const V=T(S(P,"businesses",c,"connectedRetailers")),b={retailerId:V.id,provisionalId:f,retailerName:l.businessName,status:"provisioned",source:"provisioned",createdAt:j(),updatedAt:j()};l.retailerEmail&&(b.retailerEmail=l.retailerEmail),l.retailerPhone&&(b.retailerPhone=l.retailerPhone),l.address&&(b.retailerAddress=l.address),l.city&&(b.retailerCity=l.city),l.state&&(b.retailerState=l.state),o?.type&&o?.id?(b.addedBy={type:o.type,id:o.id},o.name&&(b.addedBy.name=o.name),o.flypEmployeeId&&(b.addedBy.flypEmployeeId=o.flypEmployeeId)):b.addedBy={type:"distributor",id:c},await $(V,b);const ee=`${window.location.origin}/claim?pid=${f}`,Y={provisionalId:f,inviteUrl:ee,payload:l};E(Y),C?.(Y),m?.({type:"success",message:"Provisional retailer created (local draft)."})}catch(s){console.error(s);const u="Failed to create provisional retailer.";x(u),m?.({type:"error",message:u})}finally{N(!1)}};return F==="embedded"?n?e.jsxs("div",{className:"w-full",children:[e.jsx("style",{children:`
          .no-scrollbar::-webkit-scrollbar { display: none; }
          .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
          .input { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); }
          .input:focus { outline: none; box-shadow: 0 0 0 2px rgba(16,185,129,0.35); }
          .chip { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.14); }
        `}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 backdrop-blur-md",children:[e.jsx("div",{className:"px-5 py-4 border-b border-white/10 flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] uppercase tracking-wider text-white/60",children:"Provisioned Retailer"}),e.jsx("h3",{id:"add-retailer-title",className:"text-lg md:text-xl font-semibold",children:"Add Retailer for Management"}),e.jsx("div",{className:"text-[11px] text-white/50 mt-0.5",children:"Create a managed retailer entry now and share an invite to claim later."})]})}),e.jsxs("div",{className:"px-5 py-4 space-y-4",children:[e.jsxs("form",{onSubmit:K,className:"space-y-3",children:[R&&e.jsx("div",{className:"rounded-lg border border-red-500/30 bg-red-500/10 text-red-200 text-sm px-3 py-2",children:R}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(d,{label:"Business Name *",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2 text-white placeholder:text-white/40",value:t.businessName,onChange:p("businessName"),placeholder:"e.g., Shree Ganesh Traders",required:!0,autoFocus:z})}),e.jsx(d,{label:"Owner Name",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2 text-white placeholder:text-white/40",value:t.ownerName,onChange:p("ownerName"),placeholder:"e.g., Ramesh Patil"})}),e.jsxs(d,{label:"Email",children:[e.jsx("input",{type:"email",className:"w-full rounded-lg input px-3 py-2 text-white placeholder:text-white/40",value:t.email,onChange:p("email"),placeholder:"owner@retailer.com"}),e.jsx("div",{className:"mt-1 text-[11px] text-white/50",children:"We'll send an invite here if provided."})]}),e.jsxs(d,{label:"Phone (+91)",children:[e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"inline-flex items-center px-3 rounded-l-lg input border-r-0 text-white/70 select-none",children:"+91"}),e.jsx("input",{inputMode:"numeric",pattern:"[0-9]*",className:"w-full rounded-r-lg input px-3 py-2 text-white placeholder:text-white/40",value:Q(t.phone),onChange:i=>v(r=>({...r,phone:i.target.value})),placeholder:"10‑digit number"})]}),e.jsx("div",{className:"mt-1 text-[11px] text-white/50",children:"Enter 10 digits; we'll format as +91 automatically."})]}),e.jsxs(d,{label:"GSTIN (optional)",children:[e.jsx("input",{className:"w-full rounded-lg input px-3 py-2 uppercase text-white placeholder:text-white/40",value:t.gst,onChange:i=>v(r=>({...r,gst:i.target.value.toUpperCase()})),placeholder:"15‑character GSTIN"}),e.jsx("div",{className:"mt-1 text-[11px] text-white/50",children:"Optional. 15 characters alphanumeric."})]}),e.jsx(d,{label:"Address (optional)",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2 text-white placeholder:text-white/40",value:t.address,onChange:p("address"),placeholder:"Street address"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(d,{label:"City (optional)",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2 text-white placeholder:text-white/40",value:t.city,onChange:p("city"),placeholder:"City"})}),e.jsx(d,{label:"State (optional)",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2 text-white placeholder:text-white/40",value:t.state,onChange:p("state"),placeholder:"State"})})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-2"}),e.jsxs("div",{className:"pt-2 flex items-center justify-between flex-wrap gap-3",children:[e.jsx("div",{className:"text-[11px] text-white/55",children:'* Email or Phone required only for "Create & Generate Invite". You can invite later from the panel.'}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("button",{type:"button",disabled:!O,onClick:q,className:"px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-slate-900 font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-all",children:h?"Creating…":"Create"}),e.jsx("button",{id:"add-retailer-submit",type:"submit",disabled:!A,className:"px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 text-white disabled:opacity-50 disabled:cursor-not-allowed transition-all",children:h?"Creating…":"Create & Generate Invite"})]})]})]}),g&&e.jsxs("div",{className:"mt-4 rounded-lg border border-white/10 bg-white/5 p-4",children:[e.jsx("div",{className:"text-sm text-white/90 font-medium mb-2",children:"Invite Link"}),g?.provisionalId&&e.jsx("div",{className:"mb-2",children:e.jsxs("span",{className:"chip rounded-md px-2 py-1 text-[10px] uppercase tracking-wide text-white/70",children:["ID: ",g.provisionalId]})}),e.jsx("div",{className:"text-xs text-white/80 break-all mb-3",children:g.inviteUrl}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm transition-all",onClick:()=>W(g.inviteUrl),children:"Copy Link"}),e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm transition-all",onClick:()=>{E(null),a?.()},children:"Done"})]})]})]})]})]}):null:e.jsx(ie,{children:n&&e.jsxs(J.div,{className:"fixed inset-0 z-[60] flex items-center justify-center",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:a}),e.jsxs(J.div,{initial:{opacity:0,y:30,scale:.98},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:20,scale:.98},transition:{duration:.2},className:`${F==="centered"?"w-[94%] max-w-3xl":"w-[92%] max-w-2xl"} relative rounded-2xl border border-white/10 bg-[#0b1220]/95 text-white shadow-[0_30px_120px_rgba(0,0,0,.6)] backdrop-blur-xl max-h-[90vh] overflow-y-auto no-scrollbar mx-auto my-6`,role:"dialog","aria-modal":"true","aria-labelledby":"add-retailer-title",children:[e.jsxs("div",{className:"px-5 py-4 border-b border-white/10 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] uppercase tracking-wider text-white/60",children:"Provisioned Retailer"}),e.jsx("h3",{id:"add-retailer-title",className:"text-lg md:text-xl font-semibold",children:"Add Retailer for Management"}),e.jsx("div",{className:"text-[11px] text-white/50 mt-0.5",children:"Create a managed retailer entry now and share an invite to claim later."})]}),e.jsx("button",{className:"rounded-full px-3 py-1.5 bg-white/10 hover:bg-white/15 text-white/90 text-sm",onClick:a,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"max-h-[70vh] overflow-y-auto px-5 py-4 space-y-4 no-scrollbar",children:[e.jsx("style",{children:`
                .no-scrollbar::-webkit-scrollbar { display: none; }
                .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
                .input { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); }
                .input:focus { outline: none; box-shadow: 0 0 0 2px rgba(16,185,129,0.35); }
                .chip { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.14); }
              `}),e.jsxs("form",{onSubmit:K,className:"space-y-3",children:[R&&e.jsx("div",{className:"rounded-lg border border-red-500/30 bg-red-500/10 text-red-200 text-sm px-3 py-2",children:R}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(d,{label:"Business Name *",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2",value:t.businessName,onChange:p("businessName"),placeholder:"e.g., Shree Ganesh Traders",required:!0,autoFocus:z})}),e.jsx(d,{label:"Owner Name",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2",value:t.ownerName,onChange:p("ownerName"),placeholder:"e.g., Ramesh Patil"})}),e.jsxs(d,{label:"Email",children:[e.jsx("input",{type:"email",className:"w-full rounded-lg input px-3 py-2",value:t.email,onChange:p("email"),placeholder:"owner@retailer.com"}),e.jsx("div",{className:"mt-1 text-[11px] text-white/50",children:"We’ll send an invite here if provided."})]}),e.jsxs(d,{label:"Phone (+91)",children:[e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"inline-flex items-center px-3 rounded-l-lg input border-r-0 text-white/70 select-none",children:"+91"}),e.jsx("input",{inputMode:"numeric",pattern:"[0-9]*",className:"w-full rounded-r-lg input px-3 py-2",value:Q(t.phone),onChange:i=>v(r=>({...r,phone:i.target.value})),placeholder:"10‑digit number"})]}),e.jsx("div",{className:"mt-1 text-[11px] text-white/50",children:"Enter 10 digits; we’ll format as +91 automatically."})]}),e.jsxs(d,{label:"GSTIN (optional)",children:[e.jsx("input",{className:"w-full rounded-lg input px-3 py-2 uppercase",value:t.gst,onChange:i=>v(r=>({...r,gst:i.target.value.toUpperCase()})),placeholder:"15‑character GSTIN"}),e.jsx("div",{className:"mt-1 text-[11px] text-white/50",children:"Optional. 15 characters alphanumeric."})]}),e.jsx(d,{label:"Address (optional)",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2",value:t.address,onChange:p("address"),placeholder:"Street address"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(d,{label:"City (optional)",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2",value:t.city,onChange:p("city"),placeholder:"City"})}),e.jsx(d,{label:"State (optional)",children:e.jsx("input",{className:"w-full rounded-lg input px-3 py-2",value:t.state,onChange:p("state"),placeholder:"State"})})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-2"}),e.jsxs("div",{className:"pt-2 flex items-center justify-between",children:[e.jsx("div",{className:"text-[11px] text-white/55",children:'* Email or Phone required only for "Create & Generate Invite". You can invite later from the panel.'}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:a,className:"px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 text-white",children:"Cancel"}),e.jsx("button",{type:"button",disabled:!O,onClick:q,className:"px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-slate-900 font-semibold disabled:opacity-50",children:h?"Creating…":"Create"}),e.jsx("button",{id:"add-retailer-submit",type:"submit",disabled:!A,className:"px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-white/15 text-white disabled:opacity-50",children:h?"Creating…":"Create & Generate Invite"})]})]})]}),g&&e.jsx("div",{className:"px-5 pb-5",children:e.jsxs("div",{className:"mt-2 rounded-lg border border-white/10 bg-white/5 p-3",children:[e.jsx("div",{className:"text-sm text-white/90 font-medium mb-1",children:"Invite Link"}),g?.provisionalId&&e.jsx("div",{className:"mb-2",children:e.jsxs("span",{className:"chip rounded-md px-2 py-1 text-[10px] uppercase tracking-wide text-white/70",children:["ID: ",g.provisionalId]})}),e.jsx("div",{className:"text-xs text-white/80 break-all",children:g.inviteUrl}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm",onClick:()=>W(g.inviteUrl),children:"Copy Link"}),e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm",onClick:()=>{E(null),a?.()},children:"Done"})]})]})})]})]})]})})}function d({label:n,children:a}){return e.jsxs("label",{className:"block",children:[e.jsx("div",{className:"text-xs text-white/70 mb-1",children:n}),a]})}function _(n){const a=(n||"").replace(/[^\d]/g,"");return a?a.length===10?`+91${a}`:a.length===12&&a.startsWith("91")?`+${a}`:a.length===13&&a.startsWith("91")?`+${a}`:a.length===12&&a.startsWith("91")===!1?`+91${a.slice(-10)}`:`+91${a.slice(-10)}`:null}function Q(n){const a=(n||"").replace(/[^\d]/g,"");return a.length>=10?a.slice(-10):a}function ae(){const n=crypto.getRandomValues(new Uint32Array(4));return Array.from(n,a=>a.toString(16).padStart(8,"0")).join("").slice(0,20)}export{ce as A};
