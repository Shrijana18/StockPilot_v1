import{initializeApp as L}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as I,onAuthStateChanged as C,createUserWithEmailAndPassword as A,signInWithEmailAndPassword as M}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{addDoc as S,collection as w,serverTimestamp as x,query as B,onSnapshot as D,getFirestore as q,setDoc as $,doc as E,getDoc as k}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const c=()=>{const e=document.getElementById("modal-container");e&&(e.innerHTML="")},T=async(e,n)=>{try{const t=await fetch(e);if(!t.ok)throw new Error(`Could not fetch ${e}`);n.innerHTML=await t.text(),console.log(`‚úÖ Loaded ${e}`)}catch(t){console.error("HTML Injection Error:",t),n.innerHTML=`<p class="p-8 text-red-400">Error loading ${e}</p>`}};let h=null,u=null;const H=async e=>{e.preventDefault();const n=e.target,t=n.querySelector("#add-product-form-error");t&&(t.textContent="");const r=n.querySelector("#product-name").value,o=n.querySelector("#product-sku").value,i=n.querySelector("#product-quantity").value;if(!r||!o||!i){t&&(t.textContent="All fields are required.");return}try{await S(w(h,`businesses/${u.uid}/products`),{name:r,sku:o,quantity:Number(i),createdAt:x()}),c()}catch(d){console.error("Error adding document: ",d),t&&(t.textContent="Failed to save product.")}},V=e=>{const n=document.getElementById("inventory-list");if(n){if(e.length===0){n.innerHTML=`<tr><td colspan="4" class="text-center p-8 text-gray-500">You haven't added any products yet. Click "Add New Product" to get started.</td></tr>`;return}n.innerHTML=e.map(t=>`
        <tr class="border-b border-white/10 hover:bg-white/5">
            <td class="p-4 font-medium">${t.name}</td>
            <td class="p-4 text-gray-400">${t.sku}</td>
            <td class="p-4 font-bold text-lg text-white">${t.quantity}</td>
            <td class="p-4">
                <button class="text-sm font-medium text-teal-400 hover:text-teal-300">Edit</button>
            </td>
        </tr>
    `).join("")}},F=()=>{if(!u)return;const e=B(w(h,`businesses/${u.uid}/products`));D(e,n=>{const t=[];n.forEach(r=>{t.push({id:r.id,...r.data()})}),t.sort((r,o)=>(o.createdAt?.toDate()||0)-(r.createdAt?.toDate()||0)),V(t)})},O=(e,n)=>{h=e,u=n,document.getElementById("page-content").onclick=t=>{t.target.id==="add-product-btn"&&T("./pages/add-product-modal.html",document.getElementById("modal-container")).then(()=>{document.getElementById("close-add-product-modal-btn").addEventListener("click",c),document.getElementById("add-product-form").addEventListener("submit",H)})},F()},P=(e,n)=>{console.log("Billing page initialized for user:",n.uid)};console.log("‚úÖ main.js loaded successfully");const j={apiKey:"AIzaSyBPkkXZWll0VifG5kb0DDSsoV5UB-n5pFE",authDomain:"stockpilotv1.firebaseapp.com",projectId:"stockpilotv1",storageBucket:"stockpilotv1.firebasestorage.app",messagingSenderId:"30934537475",appId:"1:30934537475:web:84a2f76609dbb1db290536",measurementId:"G-SENFJ2HSBW"};let f,g,l,p;const s={},R=()=>{s.landingPageView=document.getElementById("landing-page-view"),s.dashboardView=document.getElementById("dashboard-view"),s.modalContainer=document.getElementById("modal-container"),s.pageContent=document.getElementById("page-content")},y=async(e,n)=>{try{const t=await fetch(e.startsWith("./")?e:`./pages/${e}`);if(!t.ok)throw new Error(`Could not fetch ${e}`);const r=await t.text();n.innerHTML=r,console.log(`‚úÖ Loaded ${e}`)}catch(t){console.error("HTML Injection Error:",t),n.innerHTML=`<div class="p-6 bg-red-900 text-white rounded">‚ùå Failed to load: ${e}</div>`}},a=async e=>{if(e==="landing"){if(!s.landingPageView){console.warn("Landing page view container not found");return}await y("landing-page.html",s.landingPageView),m("landing");return}if(!s.pageContent){console.error("‚ùå pageContent container not found");return}s.pageContent.innerHTML="",document.querySelectorAll(".dashboard-nav-link").forEach(n=>{n.classList.toggle("active",n.getAttribute("href")===`#${e}`)}),await y(`./pages/${e}.html`,s.pageContent),e==="inventory"&&O(l,p),e==="billing"&&P(l,p)},z=()=>{const e=document.getElementById("registration-modal");e&&(e.querySelector("#close-modal-btn").addEventListener("click",c),e.querySelector("#details-form").addEventListener("submit",async n=>{n.preventDefault();const t=n.target,r=t.querySelector("#form-error");r.textContent="";try{const o=await A(g,t.email.value,t.password.value),i=t["business-role"].value;await $(E(l,"businesses",o.user.uid),{ownerId:o.user.uid,businessName:t["business-name"].value,role:i,createdAt:new Date}),c(),m("dashboard"),a(i==="retailer"?"inventory":i==="distributor"?"billing":"dashboard")}catch(o){r.textContent=o.message}}))},N=()=>{const e=document.getElementById("sign-in-modal");e&&(e.querySelector("#close-modal-btn").addEventListener("click",c),e.querySelector("#sign-in-form").addEventListener("submit",async n=>{n.preventDefault();const t=n.target,r=t.querySelector("#form-error");r.textContent="";try{const o=await M(g,t.email.value,t.password.value),i=E(l,"businesses",o.user.uid),d=await k(i);if(d.exists()){const b=d.data();c(),m("dashboard"),b.role==="retailer"?a("inventory"):b.role==="distributor"?a("billing"):a("dashboard")}else r.textContent="User profile not found."}catch(o){r.textContent=o.message}}))},v=async e=>{await y(`./pages/${e}.html`,s.modalContainer),e==="registration-modal"&&z(),e==="sign-in-modal"&&N()},U=()=>{document.body.addEventListener("click",e=>{const n=e.target.closest("#register-btn, #register-btn-hero"),t=e.target.closest("#sign-in-btn"),r=e.target.closest(".dashboard-nav-link");if(n&&v("registration-modal"),t&&v("sign-in-modal"),r){e.preventDefault();const o=r.getAttribute("href").substring(1);a(o)}})},m=e=>{s.landingPageView?.classList.toggle("hidden-view",e!=="landing"),s.dashboardView?.classList.toggle("hidden-view",e!=="dashboard")},W=async()=>{R(),console.log("Initializing AppLogic with views:",{landing:s.landingPageView,dashboard:s.dashboardView,pageContent:s.pageContent}),console.log("üì¶ Cached Elements:",s);try{f=L(j),g=I(f),l=q(f)}catch(e){console.error("Firebase init failed:",e),document.body.innerHTML='<div class="p-10 bg-red-900 text-white">FATAL ERROR: Firebase not configured</div>';return}C(g,async e=>{p=e,console.log("üë§ Auth State Changed:",e),e?(m("dashboard"),await a("inventory")):await a("landing"),U()})};document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ DOM Ready. Initializing app..."),window.location.hash||(window.location.hash="#landing"),W()});
