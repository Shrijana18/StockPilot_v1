import{j as e,d as I}from"./index-DRC3F7i0.js";import{a as G,u as M,r as b}from"./router-BPBaD_i0.js";import{d as S,e as D}from"./firebase-DWi1MSv1.js";import{p as V,F as E}from"./FileSaver.min-DVuNBBJs.js";import{D as O}from"./DistributorInvoicePdf-o0mROIQ5.js";import{D as $}from"./DistributorManualInvoicePdf-B4FHrTjE.js";import{s as g}from"./pricing-SUVGnFgL.js";import"./vendor-Ckhrjn13.js";import"./index.esm-Bux_mLJ0.js";import"./index-CbpqHhv-.js";import"./bidi-DLACMwmw.js";const Z=()=>{const{distributorId:x,invoiceId:p}=G();M();const[t,T]=b.useState(null),[c,k]=b.useState(null),[A,u]=b.useState(!0),[f,N]=b.useState(!1),[B,y]=b.useState(!1);b.useEffect(()=>{(async()=>{if(!x||!p){console.error("[PublicInvoiceView] Missing distributorId or invoiceId",{distributorId:x,invoiceId:p}),u(!1);return}console.log("[PublicInvoiceView] Fetching invoice:",{distributorId:x,invoiceId:p});try{const s=S(I,`businesses/${x}/invoices`,p),a=await D(s);if(!a.exists()){console.warn("[PublicInvoiceView] Invoice not found:",p),u(!1);return}const l={id:a.id,...a.data()};if(console.log("[PublicInvoiceView] Invoice loaded:",l),T(l),l.orderId)try{console.log("[PublicInvoiceView] Fetching order data:",l.orderId);const o=S(I,`businesses/${x}/orderRequests`,l.orderId),d=await D(o);if(d.exists()){const n={id:d.id,...d.data()};console.log("[PublicInvoiceView] Order data loaded:",n),k(n)}else console.warn("[PublicInvoiceView] Order not found:",l.orderId)}catch(o){console.error("[PublicInvoiceView] Error fetching order data:",o)}else console.log("[PublicInvoiceView] No orderId in invoice")}catch(s){console.error("[PublicInvoiceView] Error fetching invoice:",s),alert("Failed to load invoice. Please check the URL and try again.")}finally{u(!1)}})()},[x,p]);const v=r=>{if(!r)return"N/A";let s;return r?.seconds?s=new Date(r.seconds*1e3):r?.toDate?s=r.toDate():r instanceof Date?s=r:s=new Date(r),isNaN(s.getTime())?"N/A":s.toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})},i=r=>`₹${Number(r||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,R=(r,s,a)=>{const l=a.pricingMode||"LEGACY",o=Number(a.basePrice||0),d=Number(a.mrp||0),n=Number(a.sellingPrice||a.price||a.unitPrice||0),h=Number(a.gstRate||a.taxRate||0),P=Array.isArray(r?.proforma?.lines)?r.proforma.lines[s]:void 0,m=P?.gstRate!==void 0?Number(P.gstRate):h;return l==="MRP_INCLUSIVE"?d>0&&m>0?g(d,m).base:d||n:l==="SELLING_PRICE"?n>0&&m>0?g(n,m).base:n:l==="BASE_PLUS_TAX"?o>0?o:n>0&&m>0?g(n,m).base:n:o||n},L=r=>{if(!r)return"N/A";const s=r.payment||{};return s.mode||s.normalized?.label||s.normalized?.mode||r.paymentMode||r.paymentUi||"N/A"},F=()=>{if(!t)return{label:"Pending",isPaid:!1};if(c&&(c.isPaid===!0||c.paymentStatus==="Paid"||c.payment?.isPaid===!0))return{label:"Paid",isPaid:!0};const r=t.payment||{};if(typeof r.isPaid=="boolean")return{label:r.isPaid?"Paid":"Pending",isPaid:r.isPaid};const a=(r.status||t.paymentStatus||"").toString().trim().toLowerCase();return["paid","complete","completed"].includes(a)?{label:"Paid",isPaid:!0}:{label:"Pending",isPaid:!1}},C=async()=>{if(t)try{N(!0);const s=!t.orderId?e.jsx($,{invoice:t}):e.jsx(O,{invoice:t,order:c}),a=await V(s).toBlob(),l=t.invoiceNumber||t.invoiceId||t.id,o=v(t.issuedAt||t.createdAt).replace(/\s+/g,"-"),d=`${l}-${o}.pdf`;E.saveAs(a,d)}catch(r){console.error("Failed to generate PDF",r),alert("Failed to download PDF. Please try again.")}finally{N(!1)}};if(A)return e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center",children:e.jsx("div",{className:"text-slate-600",children:"Loading invoice..."})});if(!t)return e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Invoice Not Found"}),e.jsx("p",{className:"text-slate-600",children:"The invoice you're looking for doesn't exist or has been removed."})]})});const j=F();return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50 py-6 px-4 print:py-0 print:px-0",children:e.jsxs("div",{className:"max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl border border-slate-200 p-4 md:p-6 print:p-4 print:shadow-none print:border-0 print:rounded-none print:max-w-full",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4 pb-4 border-b-2 border-slate-200 print:mb-2 print:pb-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-[0.2em] text-slate-400 mb-1 font-semibold",children:"Tax Invoice"}),e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900 print:text-xl",children:t.invoiceNumber||t.id}),e.jsxs("p",{className:"text-xs text-slate-500 mt-0.5 print:text-[10px]",children:["Issued on ",v(t.issuedAt||t.createdAt)]})]}),e.jsxs("div",{className:"flex gap-2 print:hidden",children:[e.jsx("button",{onClick:C,disabled:f,className:`px-3 py-1.5 rounded-lg text-xs font-semibold transition ${f?"bg-slate-400 text-white cursor-not-allowed":"bg-gradient-to-r from-slate-900 to-slate-800 text-white hover:from-slate-800 hover:to-slate-700 shadow-md"}`,children:f?"Preparing...":"Download PDF"}),e.jsx("button",{onClick:()=>{const r=window.location.href;navigator.clipboard.writeText(r).then(()=>{y(!0),setTimeout(()=>y(!1),2e3)})},className:"px-3 py-1.5 rounded-lg text-xs font-semibold bg-emerald-500 text-white hover:bg-emerald-600 shadow-md transition",title:"Copy invoice link",children:B?"✓ Copied!":"Copy Link"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 print:grid-cols-3 print:gap-2",children:[e.jsxs("div",{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border-2 border-emerald-300 rounded-xl p-3 print:border print:p-2",children:[e.jsx("p",{className:"text-[10px] uppercase text-emerald-700 mb-0.5 font-semibold tracking-wide",children:"Grand Total"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-emerald-800 print:text-lg",children:i(t.totals?.grandTotal||0)})]}),e.jsxs("div",{className:`border-2 rounded-xl p-3 print:border print:p-2 ${j.isPaid?"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-300":"bg-gradient-to-br from-amber-50 to-amber-100 border-amber-300"}`,children:[e.jsx("p",{className:"text-[10px] uppercase mb-0.5 font-semibold tracking-wide text-slate-700",children:"Payment Status"}),e.jsx("p",{className:`text-lg md:text-xl font-bold print:text-base ${j.isPaid?"text-emerald-800":"text-amber-800"}`,children:j.label})]}),e.jsxs("div",{className:"bg-gradient-to-br from-slate-50 to-slate-100 border-2 border-slate-300 rounded-xl p-3 print:border print:p-2",children:[e.jsx("p",{className:"text-[10px] uppercase text-slate-700 mb-0.5 font-semibold tracking-wide",children:"Payment Method"}),e.jsx("p",{className:"text-lg md:text-xl font-bold text-slate-900 print:text-base",children:L(t)})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 print:grid-cols-2 print:gap-3",children:[e.jsxs("div",{className:"border-2 border-slate-200 rounded-xl p-3 bg-slate-50/50 print:border print:p-2",children:[e.jsx("p",{className:"text-[10px] uppercase text-slate-600 mb-1.5 font-semibold tracking-wide",children:"Bill To (Buyer)"}),e.jsx("p",{className:"font-bold text-base text-slate-900 print:text-sm",children:t.buyer?.businessName||t.buyer?.name||t.customer?.name||t.customer?.businessName||"N/A"}),e.jsxs("div",{className:"text-xs text-slate-600 mt-1.5 space-y-0.5 print:text-[10px]",children:[(t.buyer?.email||t.customer?.email)&&e.jsx("p",{children:t.buyer?.email||t.customer?.email}),(t.buyer?.phone||t.customer?.phone)&&e.jsx("p",{children:t.buyer?.phone||t.customer?.phone}),(t.buyer?.address||t.customer?.address)&&e.jsx("p",{children:t.buyer?.address||t.customer?.address}),(t.buyer?.city||t.customer?.city||t.buyer?.state||t.customer?.state)&&e.jsx("p",{children:[t.buyer?.city||t.customer?.city,t.buyer?.state||t.customer?.state].filter(Boolean).join(", ")})]})]}),e.jsxs("div",{className:"border-2 border-slate-200 rounded-xl p-3 bg-slate-50/50 print:border print:p-2",children:[e.jsx("p",{className:"text-[10px] uppercase text-slate-600 mb-1.5 font-semibold tracking-wide",children:"Sold By (Seller)"}),e.jsx("p",{className:"font-bold text-base text-slate-900 print:text-sm",children:t.seller?.businessName||"N/A"}),e.jsxs("div",{className:"text-xs text-slate-600 mt-1.5 space-y-0.5 print:text-[10px]",children:[t.seller?.email&&e.jsx("p",{children:t.seller.email}),t.seller?.phone&&e.jsx("p",{children:t.seller.phone}),t.seller?.gstNumber&&e.jsxs("p",{children:["GSTIN: ",t.seller.gstNumber]}),(t.seller?.city||t.seller?.state)&&e.jsx("p",{children:[t.seller?.city,t.seller?.state].filter(Boolean).join(", ")})]})]})]}),(()=>{const r=c?.items||t?.items||t?.cartItems||[];return!r||r.length===0?null:e.jsxs("div",{className:"mb-4 print:mb-2",children:[e.jsx("h3",{className:"font-bold text-sm text-slate-900 mb-2 print:text-xs print:mb-1",children:"Order Items"}),e.jsx("div",{className:"overflow-x-auto -mx-4 px-4 print:mx-0 print:px-0",children:e.jsx("div",{className:"inline-block min-w-full align-middle",children:e.jsxs("table",{className:"min-w-full text-[10px] border-collapse print:text-[9px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200",children:[e.jsx("th",{className:"px-2 py-1.5 text-left font-semibold text-slate-700 text-[10px]",children:"Product"}),e.jsx("th",{className:"px-2 py-1.5 text-left font-semibold text-slate-700 text-[10px]",children:"SKU"}),e.jsx("th",{className:"px-2 py-1.5 text-left font-semibold text-slate-700 text-[10px]",children:"Brand"}),e.jsx("th",{className:"px-2 py-1.5 text-right font-semibold text-slate-700 text-[10px]",children:"Unit"}),e.jsx("th",{className:"px-2 py-1.5 text-right font-semibold text-slate-700 text-[10px]",children:"Base Price"}),e.jsx("th",{className:"px-2 py-1.5 text-right font-semibold text-slate-700 text-[10px]",children:"MRP"}),e.jsx("th",{className:"px-2 py-1.5 text-right font-semibold text-slate-700 text-[10px]",children:"GST %"}),e.jsx("th",{className:"px-2 py-1.5 text-right font-semibold text-slate-700 text-[10px]",children:"Selling"}),e.jsx("th",{className:"px-2 py-1.5 text-center font-semibold text-slate-700 text-[10px]",children:"Qty"}),e.jsx("th",{className:"px-2 py-1.5 text-right font-semibold text-slate-700 text-[10px]",children:"Total"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:r.map((s,a)=>{const l=Number(s.quantity||s.qty||0),o=Number(s.sellingPrice||s.price||s.unitPrice||0),d=l*o,n=R(c||t,a,s),h=Array.isArray(c?.proforma?.lines)&&c.proforma.lines[a]?.gstRate||Array.isArray(t?.proforma?.lines)&&t.proforma.lines[a]?.gstRate||s.gstRate||s.taxRate||0;return e.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[e.jsxs("td",{className:"px-2 py-1.5 align-top",children:[e.jsx("p",{className:"font-semibold text-slate-900 leading-tight",children:s.productName||s.name||"N/A"}),s.hsnCode&&e.jsxs("p",{className:"text-[9px] text-slate-400 mt-0.5",children:["HSN: ",s.hsnCode]})]}),e.jsx("td",{className:"px-2 py-1.5 text-slate-600 text-[10px]",children:s.sku||"—"}),e.jsx("td",{className:"px-2 py-1.5 text-slate-600 text-[10px]",children:s.brand||"—"}),e.jsx("td",{className:"px-2 py-1.5 text-right text-slate-600 text-[10px]",children:s.unit||"—"}),e.jsx("td",{className:"px-2 py-1.5 text-right text-slate-700 text-[10px]",children:n>0?i(n):"—"}),e.jsx("td",{className:"px-2 py-1.5 text-right text-slate-700 text-[10px]",children:s.mrp>0?i(s.mrp):"—"}),e.jsx("td",{className:"px-2 py-1.5 text-right text-slate-700 text-[10px]",children:h?`${h}%`:"—"}),e.jsx("td",{className:"px-2 py-1.5 text-right font-semibold text-emerald-600 text-[10px]",children:i(o)}),e.jsx("td",{className:"px-2 py-1.5 text-center text-slate-700 text-[10px] font-medium",children:l}),e.jsx("td",{className:"px-2 py-1.5 text-right font-semibold text-slate-900 text-[10px]",children:i(d)})]},a)})})]})})})]})})(),t.totals&&e.jsxs("div",{className:"border-2 border-slate-200 rounded-xl p-3 mb-4 bg-slate-50/30 print:border print:p-2",children:[e.jsx("h3",{className:"font-bold text-sm text-slate-900 mb-2 print:text-xs",children:"Invoice Breakdown"}),e.jsxs("div",{className:"space-y-0.5 text-xs print:text-[10px]",children:[t.totals.grossItems!==void 0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Unit Price Total"}),e.jsx("span",{children:i(t.totals.grossItems)})]}),t.totals.lineDiscountTotal!==void 0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"− Line Discounts"}),e.jsx("span",{children:i(t.totals.lineDiscountTotal)})]}),t.totals.itemsSubTotal!==void 0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Items Sub‑Total"}),e.jsx("span",{children:i(t.totals.itemsSubTotal)})]}),t.totals.delivery>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"+ Delivery"}),e.jsx("span",{children:i(t.totals.delivery)})]}),t.totals.packing>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"+ Packing"}),e.jsx("span",{children:i(t.totals.packing)})]}),t.totals.insurance>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"+ Insurance"}),e.jsx("span",{children:i(t.totals.insurance)})]}),t.totals.other>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"+ Other"}),e.jsx("span",{children:i(t.totals.other)})]}),t.totals.discountTotal>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"− Order Discount"}),e.jsx("span",{children:i(t.totals.discountTotal)})]}),t.totals.taxableBase!==void 0&&e.jsxs("div",{className:"flex justify-between font-semibold pt-2 border-t",children:[e.jsx("span",{children:"Taxable Base"}),e.jsx("span",{children:i(t.totals.taxableBase)})]}),t.totals.taxType==="IGST"&&t.totals.taxBreakup?.igst!==void 0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"IGST"}),e.jsx("span",{children:i(t.totals.taxBreakup.igst)})]}),t.totals.taxType!=="IGST"&&e.jsxs(e.Fragment,{children:[t.totals.taxBreakup?.cgst!==void 0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"CGST"}),e.jsx("span",{children:i(t.totals.taxBreakup.cgst)})]}),t.totals.taxBreakup?.sgst!==void 0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"SGST"}),e.jsx("span",{children:i(t.totals.taxBreakup.sgst)})]})]}),t.totals.roundOff!==void 0&&t.totals.roundOff!==0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Round Off"}),e.jsx("span",{children:i(t.totals.roundOff)})]}),e.jsxs("div",{className:"flex justify-between text-base font-bold text-slate-900 pt-2 mt-2 border-t-2 border-slate-300 print:text-sm print:pt-1 print:mt-1",children:[e.jsx("span",{children:"Grand Total"}),e.jsx("span",{children:i(t.totals.grandTotal||0)})]})]})]}),e.jsxs("div",{className:"text-center text-[10px] text-slate-400 pt-3 border-t border-slate-200 print:text-[9px] print:pt-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx("img",{src:"/assets/flyp_logo.png",alt:"FLYP Logo",className:"w-6 h-6 opacity-80"}),e.jsx("p",{children:"Powered by FLYP — Smart Business Invoicing"})]}),e.jsx("p",{className:"mt-2 text-[9px] text-slate-500",children:"This is a digital invoice. You can download the PDF using the button above."})]})]})})};export{Z as default};
