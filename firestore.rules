rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helpers ----------

    function isAuthed() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return isAuthed() && request.auth.uid == uid;
    }

    // TEMP PHASE: Relax email verification requirement.
    // Later, switch back to strict: request.auth.token.email_verified == true
    function isEmailVerified() {
      return isAuthed();
    }

    // E.164 India (+91XXXXXXXXXX)
    function isValidPhoneFormat(phone) {
      return phone is string && phone.matches('^\\+91[0-9]{10}$');
    }

    // Email cannot be changed after creation
    function emailUnchanged(data) {
      return !('email' in data) || data.email == resource.data.email;
    }

    // Retailer â†” Distributor helpers
    function isConnectedRetailer(distributorId) {
      return isAuthed()
        && exists(/databases/$(database)/documents/businesses/$(distributorId)/connectedRetailers/$(request.auth.uid))
        && get(/databases/$(database)/documents/businesses/$(distributorId)/connectedRetailers/$(request.auth.uid)).data.status == "accepted";
    }

    function isDistributorEmployee(distributorId) {
      return isAuthed()
        && (
          // Original check: auth.uid matches employee document ID in Firestore
          (
            exists(/databases/$(database)/documents/businesses/$(distributorId)/distributorEmployees/$(request.auth.uid))
            && get(/databases/$(database)/documents/businesses/$(distributorId)/distributorEmployees/$(request.auth.uid)).data.status == "active"
          )
          ||
          // NEW: Also check custom claims for employees using custom tokens
          (
            request.auth.token.isDistributorEmployee == true
            && request.auth.token.distributorId == distributorId
          )
        );
    }

    function hasEmployeeAccess(distributorId, section) {
      return isDistributorEmployee(distributorId)
        && (
          // Original check: accessSections from Firestore document
          (
            exists(/databases/$(database)/documents/businesses/$(distributorId)/distributorEmployees/$(request.auth.uid))
            && get(/databases/$(database)/documents/businesses/$(distributorId)/distributorEmployees/$(request.auth.uid)).data.accessSections[section] == true
          )
          ||
          // NEW: Also check custom claims accessSections
          (
            request.auth.token.isDistributorEmployee == true
            && request.auth.token.distributorId == distributorId
            && request.auth.token.accessSections[section] == true
          )
        );
    }

    // ============================================================
    // BUSINESSES (one document per user)
    // ============================================================
    match /businesses/{userId} {

      // CREATE
      allow create: if isAuthed()
        && isSelf(userId)
        && request.resource.data.ownerId == userId
        && (!('email' in request.resource.data) || request.resource.data.email == request.auth.token.email)
        && (!('phone' in request.resource.data) || isValidPhoneFormat(request.resource.data.phone));

      // READ own doc
      allow read: if isAuthed() && isSelf(userId);
      
      // READ: Allow product owners to read distributor businesses for connection purposes
      // This allows product owners to search and verify distributors by FLYP ID, view connected distributors, or view distributors with pending orders
      allow read: if isAuthed() 
        && isEmailVerified()
        && exists(/databases/$(database)/documents/businesses/$(request.auth.uid))
        && get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"]
        && exists(/databases/$(database)/documents/businesses/$(userId))
        && get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["distributor", "Distributor"];
      
      // READ: Allow distributors to read product owner businesses if they have a connection
      // This allows distributors to fetch product owner details for their connections
      allow read: if isAuthed() 
        && isEmailVerified()
        && exists(/databases/$(database)/documents/businesses/$(request.auth.uid))
        && get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["distributor", "Distributor"]
        && exists(/databases/$(database)/documents/businesses/$(userId))
        && get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["productowner", "ProductOwner"]
        && exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedProductOwners/$(userId));

      // UPDATE
      // Allows updating all profile fields including:
      // - Basic info: ownerName, businessName, address, city, state, pincode
      // - Tax: gstNumber, panNumber
      // - Banking: bankName, bankBranch, bankAccountNumber, bankIfsc, bankAccountName, upiId
      // - Preferences: invoicePreference, businessMode, whatsappAlerts, emailNotifications, smsNotifications
      // - Credit: defaultCreditDays, paymentTerms, autoSendInvoice
      // - Business: businessHours, logoUrl
      // - Security: twoFactorEnabled, sessionTimeout
      // - Profile metadata: profileVersion, lastUpdated
      // - WhatsApp: whatsappBusinessAccountId, whatsappPhoneNumberId, whatsappPhoneNumber, whatsappPhoneRegistered,
      //   whatsappPhoneVerificationStatus, whatsappProvider, whatsappEnabled, whatsappLastSyncedAt, whatsappConnectedAt,
      //   whatsappWebhookUrl, whatsappWebhookConfigured, whatsappWebhookConfiguredAt, whatsappCreatedVia, whatsappCreatedAt,
      //   whatsappAccountReviewStatus, whatsappAccountReviewUpdatedAt, whatsappPhoneUpdatedAt, whatsappVerified,
      //   whatsappStatusLastChecked, whatsappTestMode, whatsappTestRecipient, whatsappTestAccessToken,
      //   embeddedSignupData, whatsappAccessToken, whatsappOAuthCode, metaBusinessId
      allow update: if isAuthed()
        && isSelf(userId)
        && isEmailVerified()
        && (
          // ownerId must equal userId (user can only update their own doc)
          // This handles both: setting ownerId on legacy docs AND keeping it unchanged
          request.resource.data.ownerId == userId
        )
        && emailUnchanged(request.resource.data)
        && (
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['phone'])
          || isValidPhoneFormat(request.resource.data.phone)
        );

      // Allow territory management (add/update/remove) - distributors can manage their territories at any time
      // Supports both old single territory format and new multiple territories array format
      allow update: if isAuthed()
        && isSelf(userId)
        && isEmailVerified()
        && (
          // Only territory-related fields can change (new array format)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'territories', 'territoryUpdatedAt', 'updatedAt'
          ])
          // Or old single territory format (for backward compatibility)
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'territoryCenter', 'territoryZoom', 'territoryName', 'territoryUpdatedAt', 'updatedAt'
          ])
          // Or allow removing territory fields (for deletion)
          || (
            !('territoryCenter' in request.resource.data) && 'territoryCenter' in resource.data
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['territoryCenter', 'territoryZoom', 'territoryName', 'territoryUpdatedAt'])
          )
        );

      allow delete: if isAuthed() && isSelf(userId);

      // Discovery & partner lookups
      allow get: if isAuthed() && (
        (isSelf(userId) && isEmailVerified()) ||
        (resource.data.role == "Distributor" || resource.data.role == "distributor") ||
        exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectionRequests/$(userId)) ||
        exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedRetailers/$(userId))
      );

      // No blind list of all businesses
      allow list: if false;

      // --- Billing Settings (preferences subcollection) ---
      match /preferences/{docId} {
        allow read, write: if isAuthed() && isSelf(userId) && isEmailVerified();
      }

      // --- Store Layout (for location management) ---
      match /storeLayout/{docId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- Virtual Store Layout (for virtual store builder/viewer) ---
      match /virtualStore/{docId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- Order Settings ---
      match /orderSettings/{anyPath=**} {
        allow read, write: if isAuthed() && isSelf(userId) && isEmailVerified();
      }

      match /orderSettings/global/retailerOverrides/{retailerId} {
        allow get, list: if isAuthed() && isSelf(retailerId) && isEmailVerified();
      }
      match /orderSettings/retailerOverrides/{retailerId} {
        allow get, list: if isAuthed() && isSelf(retailerId) && isEmailVerified();
      }
      match /orderSettings/global {
        allow get: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isConnectedRetailer(userId)
        );
      }

      // ======================== EMPLOYEES (retailer-scoped) ========================
      match /employees/{employeeId} {
        allow read, write: if isAuthed() && isSelf(userId) && isEmailVerified();

        allow get: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) ||
          request.auth.uid == employeeId ||
          (request.auth.token.businessId == userId && request.auth.token.employeeId == employeeId)
        );

        allow update: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || (
            (request.auth.uid == employeeId || request.auth.token.employeeId == employeeId) &&
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['online', 'lastSeen'])
          )
        );

        allow create, delete: if isAuthed() && isSelf(userId) && isEmailVerified();
      }

      // ==================== DISTRIBUTOR EMPLOYEES (distributor-scoped) ====================
      match /distributorEmployees/{employeeId} {
        allow read, write: if isAuthed() && isSelf(userId) && isEmailVerified();

        allow get: if isAuthed() && request.auth.uid == employeeId;

        allow update: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || (
            request.auth.uid == employeeId &&
            // Allow employees to update presence fields AND session fields
            (
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['online', 'lastSeen']) ||
              request.resource.data.diff(resource.data).changedKeys().hasOnly([
                'currentSessionId', 'currentSessionStartedAt', 'lastSessionStartedAt', 'sessionActive'
              ]) ||
              // Allow updating both presence and session fields together
              request.resource.data.diff(resource.data).changedKeys().hasOnly([
                'online', 'lastSeen', 'currentSessionId', 'currentSessionStartedAt', 
                'lastSessionStartedAt', 'sessionActive'
              ])
            )
          )
        );

        allow create, delete: if isAuthed() && isSelf(userId) && isEmailVerified();
      }

      // --- Employee Sessions (direct subcollection under businesses) ---
      match /employeeSessions/{sessionId} {
        // Employees can create their own sessions
        // The custom token UID = employee document ID, so auth.uid == employeeId
        allow create: if isAuthed() && 
          request.resource.data.employeeId == request.auth.uid &&
          request.resource.data.distributorId == userId &&
          exists(/databases/$(database)/documents/businesses/$(userId)/distributorEmployees/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/businesses/$(userId)/distributorEmployees/$(request.auth.uid)).data.status == "active";
        
        // Employees can read their own sessions, distributor owner can read all
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) ||
          (resource.data.employeeId == request.auth.uid &&
           exists(/databases/$(database)/documents/businesses/$(userId)/distributorEmployees/$(request.auth.uid))) ||
          (request.auth.token.isDistributorEmployee == true &&
           request.auth.token.distributorId == userId &&
           request.auth.token.employeeId is string &&
           resource.data.employeeId == request.auth.token.employeeId)
        );
        
        // Employees can update their own sessions, distributor owner can update any
        allow update: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) ||
          (resource.data.employeeId == request.auth.uid &&
           exists(/databases/$(database)/documents/businesses/$(userId)/distributorEmployees/$(request.auth.uid))) ||
          (request.auth.token.isDistributorEmployee == true &&
           request.auth.token.distributorId == userId &&
           request.auth.token.employeeId is string &&
           resource.data.employeeId == request.auth.token.employeeId)
        );
        
        // Only distributor owner can delete sessions
        allow delete: if isAuthed() && isSelf(userId) && isEmailVerified();
      }

      // --- INVENTORY PRODUCTS ---
      // Supports both Product Owners and Distributors managing their inventory
      // Path: businesses/{userId}/products/{productId}
      match /products/{productId} {
        // READ: Product owner can read their products, connected retailers can read distributor products,
        // distributor employees can read distributor products,
        // and connected distributors can read product owner products
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isConnectedRetailer(userId) ||
          isDistributorEmployee(userId) ||
          // Allow distributors connected to product owner to read product owner's products
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["distributor", "Distributor"] &&
           exists(/databases/$(database)/documents/businesses/$(userId)) &&
           get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["productowner", "ProductOwner"] &&
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedProductOwners/$(userId)))
        );

        // CREATE: Product owner can create products in their inventory,
        // Distributor can create products in their inventory,
        // Distributor employees can create products
        allow create: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );

        // UPDATE: Product owner can update their products,
        // Distributor can update their products,
        // Distributor employees can update products
        allow update: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );

        // DELETE: Product owner can delete their products,
        // Distributor can delete their products,
        // Distributor employees can delete products
        allow delete: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      match /inventoryLogs/{logId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- Restock Orders (Smart Order Creator) ---
      match /restockOrders/{orderId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- POS ITEMS LAYER ---
      match /items/{itemId} {
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isConnectedRetailer(userId) || 
          isDistributorEmployee(userId)
        );

        allow write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- MENU CATEGORIES ---
      match /categories/{categoryId} {
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isConnectedRetailer(userId) || 
          isDistributorEmployee(userId)
        );

        allow write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- TABLES (Restaurant/Cafe/Hotel) ---
      match /tables/{tableId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- KITCHEN ORDERS ---
      match /kitchenOrders/{orderId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }
      match /menuCategories/{categoryId} {
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isConnectedRetailer(userId) || 
          isDistributorEmployee(userId)
        );

        allow write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- Retailer & Distributor Invoices ---
      match /finalizedInvoices/{invoiceId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // ðŸ”¥ NEW: distributor invoices created from TrackOrders.jsx
      match /invoices/{invoiceId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      match /customers/{customerId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- EVENT LEADS (Lead Management for Exhibitors/Distributors) ---
      match /leads/{leadId} {
        // READ: User can read their own leads
        allow read: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // CREATE: User can create their own leads
        allow create: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // UPDATE: User can update their own leads
        allow update: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // DELETE: User can delete their own leads
        allow delete: if isAuthed() && isSelf(userId) && isEmailVerified();
      }

      match /connectionRequests/{retailerId} {
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          request.auth.uid == retailerId
        );

        allow create: if isAuthed() && request.auth.uid == retailerId;

        allow update: if isAuthed() && isSelf(userId) && isEmailVerified();
      }

      match /sentRequests/{distributorId} {
        allow read, write: if isAuthed() && isSelf(userId) && isEmailVerified();

        allow update: if isAuthed() && resource.data.distributorId == request.auth.uid;
      }

      // --- Retailer copy of orders ---
      match /sentOrders/{orderId} {
        // READ
        allow read: if request.auth != null && (
          (request.auth.uid == userId && isEmailVerified()) || 
          request.auth.uid == resource.data.distributorId ||
          // âœ… allow distributor employees
          isDistributorEmployee(resource.data.distributorId)
        );

        // CREATE
        allow create: if request.auth != null && (
          (request.auth.uid == userId && isEmailVerified()) ||
          request.auth.uid == request.resource.data.distributorId ||
          isDistributorEmployee(request.resource.data.distributorId)
        );

        // UPDATE
        allow update: if request.auth != null && (
          (request.auth.uid == userId && isEmailVerified()) || 
          request.auth.uid == resource.data.distributorId ||
          isDistributorEmployee(resource.data.distributorId)
        );

        allow delete: if request.auth != null && request.auth.uid == userId && isEmailVerified();
      }

      match /retailerRequests/{requestId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      match /dispatches/{docId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      match /dispatchTracker/{docId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      match /analytics/{docId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- Connected Distributors (for Product Owners) ---
      match /connectedDistributors/{docId} {
        // READ: Product owner can read their connected distributors, distributor can read their own connection
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          (request.auth.uid == docId && 
           exists(/databases/$(database)/documents/businesses/$(docId)) &&
           get(/databases/$(database)/documents/businesses/$(docId)).data.role in ["distributor", "Distributor"])
        );
        
        // CREATE/UPDATE: Product owner can create/update connections with attachments, policy acceptance, notes
        // Distributor can update their own connection (e.g., policy acceptance, status)
        // Supports new fields: attachments, policiesAccepted, policyVersion, policyAcceptedAt, policyAcceptedBy, connectionNotes, status
        allow create, update: if isAuthed() && isEmailVerified() && (
          (isSelf(userId)) || 
          (request.auth.uid == docId && 
           exists(/databases/$(database)/documents/businesses/$(docId)) &&
           get(/databases/$(database)/documents/businesses/$(docId)).data.role in ["distributor", "Distributor"])
        );
        
        // DELETE: Product owner can delete their connections, distributor can delete their own connection record
        // Supports disconnectReason field for audit trail
        allow delete: if isAuthed() && isEmailVerified() && (
          (isSelf(userId)) || 
          (request.auth.uid == docId && 
           exists(/databases/$(database)/documents/businesses/$(docId)) &&
           get(/databases/$(database)/documents/businesses/$(docId)).data.role in ["distributor", "Distributor"])
        );

        match /assistantChats/{messageId} {
          allow read, write: if isAuthed() && (
            (isSelf(userId) && isEmailVerified()) || 
            request.auth.uid == docId
          );
        }
      }

      // --- Territories (for Product Owners) ---
      match /territories/{territoryId} {
        // READ: Product owner can read their territories
        allow read: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // CREATE: Product owner can create territories
        allow create: if isAuthed() && isEmailVerified() && isSelf(userId);
        
        // UPDATE: Product owner can update their territories
        allow update: if isAuthed() && isEmailVerified() && isSelf(userId);
        
        // DELETE: Product owner can delete their territories
        allow delete: if isAuthed() && isEmailVerified() && isSelf(userId);
      }

      // --- Connected Product Owners (for Distributors) ---
      match /connectedProductOwners/{docId} {
        // READ: Distributor can always read their connected product owners
        allow read: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // CREATE/UPDATE: 
        // 1. Distributor can create/update their own connections (e.g., accept policy, update status)
        // 2. Product owner can create/update connections in distributor's collection (when connecting)
        //    Path: businesses/{distributorId}/connectedProductOwners/{productOwnerId}
        //    - userId = distributorId
        //    - docId = productOwnerId
        //    - request.auth.uid = productOwnerId (when product owner is connecting)
        // Supports new fields: attachments, policiesAccepted, policyVersion, policyAcceptedAt, policyAcceptedBy, connectionNotes, status
        allow create, update: if isAuthed() && isEmailVerified() && (
          (isSelf(userId)) ||
          // Allow product owner to write to distributor's connectedProductOwners collection
          (request.auth.uid == docId && 
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           exists(/databases/$(database)/documents/businesses/$(userId)) &&
           get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["distributor", "Distributor"])
        );
        
        // DELETE: 
        // 1. Distributor can delete their own connections
        // 2. Product owner can delete their connection from distributor's collection (when disconnecting)
        // Path: businesses/{distributorId}/connectedProductOwners/{productOwnerId}
        // - userId = distributorId
        // - docId = productOwnerId  
        // - request.auth.uid = productOwnerId (when product owner is deleting)
        // Supports disconnectReason field for audit trail
        allow delete: if isAuthed() && isEmailVerified() && (
          // Distributor deleting their own connection
          (isSelf(userId)) ||
          // Product owner deleting from distributor's collection
          (request.auth.uid == docId && 
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           exists(/databases/$(database)/documents/businesses/$(userId)) &&
           get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["distributor", "Distributor"])
        );
      }

      // --- Assigned Orders (from Product Owners to Distributors) ---
      match /assignedOrders/{orderId} {
        // READ: Distributor and employees can read assigned orders
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) ||
          isDistributorEmployee(userId)
        );
        
        // CREATE: Product owners can assign orders to distributors
        // Also allows distributors to create orders (for order requests from distributor to product owner)
        allow create: if isAuthed() && isEmailVerified() && (
          // Distributor creating order (for requests to product owner)
          (isSelf(userId)) ||
          isDistributorEmployee(userId) ||
          // Product owner assigning order to distributor
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           exists(/databases/$(database)/documents/businesses/$(userId)) &&
           get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["distributor", "Distributor"] &&
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedDistributors/$(userId)))
        );
        
        // UPDATE: Distributor and employees can update order status, product owner can update their assigned orders
        allow update: if isAuthed() && isEmailVerified() && (
          (isSelf(userId)) ||
          isDistributorEmployee(userId) ||
          // Product owner updating their assigned order
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           resource.data.productOwnerId == request.auth.uid)
        );
        
        // DELETE: Only distributor can delete (product owner can cancel via status update)
        allow delete: if isAuthed() && isEmailVerified() && (
          (isSelf(userId)) ||
          isDistributorEmployee(userId)
        );
      }

      // --- Product Owner Orders (new flow: Product Owner -> Distributor) ---
      // Path: businesses/{distributorId}/productOwnerOrders/{orderId}
      match /productOwnerOrders/{orderId} {
        // READ: Distributor and employees can read orders assigned to them, Product Owner can read orders they assigned
        allow read: if isAuthed() && (
          // Distributor reading their own orders
          (isSelf(userId) && isEmailVerified()) ||
          isDistributorEmployee(userId) ||
          // Product owner reading orders they assigned
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           resource.data.productOwnerId == request.auth.uid) ||
          // Retailer reading their own orders from product owner
          (request.auth.uid == userId && isEmailVerified() &&
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role != "distributor")
        );
        
        // CREATE: Product owner can assign orders to distributor or retailer
        allow create: if isAuthed() && isEmailVerified() && (
          exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
          (
            // Assigning to distributor (must be connected)
            (exists(/databases/$(database)/documents/businesses/$(userId)) &&
             get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["distributor", "Distributor"] &&
             exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedDistributors/$(userId)) &&
             request.resource.data.distributorId == userId) ||
            // Assigning to retailer (must be in connectedRetailers)
            (exists(/databases/$(database)/documents/businesses/$(userId)) &&
             exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedRetailers/$(userId)) &&
             request.resource.data.retailerId == userId)
          ) &&
          request.resource.data.productOwnerId == request.auth.uid
        );
        
        // UPDATE: Distributor, retailer, and employees can update order status, Product Owner can update their assigned orders
        allow update: if isAuthed() && isEmailVerified() && (
          // Distributor/Retailer updating order status
          (isSelf(userId)) ||
          isDistributorEmployee(userId) ||
          // Product owner updating their assigned order
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           resource.data.productOwnerId == request.auth.uid)
        );
        
        // DELETE: Only distributor/retailer can delete (product owner can cancel via status update)
        allow delete: if isAuthed() && isEmailVerified() && (
          (isSelf(userId)) ||
          isDistributorEmployee(userId)
        );
      }

      // --- Assigned Orders To Distributors (Product Owner's mirror view) ---
      // Path: businesses/{productOwnerId}/assignedOrdersToDistributors/{orderId}
      match /assignedOrdersToDistributors/{orderId} {
        // READ: Product owner can read their assigned orders
        allow read: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // CREATE: Product owner can create mirror record when assigning order
        allow create: if isAuthed() && isEmailVerified() && (
          isSelf(userId) &&
          request.resource.data.productOwnerId == request.auth.uid
        );
        
        // UPDATE: Product owner can update their assigned orders
        allow update: if isAuthed() && isEmailVerified() && (
          isSelf(userId) &&
          resource.data.productOwnerId == request.auth.uid
        );
        
        // DELETE: Product owner can delete their assigned orders
        allow delete: if isAuthed() && isEmailVerified() && (
          isSelf(userId) &&
          resource.data.productOwnerId == request.auth.uid
        );
      }

      // --- Assigned Orders To Retailers (Product Owner's direct retailer orders) ---
      // Path: businesses/{productOwnerId}/assignedOrdersToRetailers/{orderId}
      match /assignedOrdersToRetailers/{orderId} {
        // READ: Product owner can read their assigned orders to retailers
        allow read: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // CREATE: Product owner can create order when assigning to retailer
        allow create: if isAuthed() && isEmailVerified() && (
          isSelf(userId) &&
          request.resource.data.productOwnerId == request.auth.uid
        );
        
        // UPDATE: Product owner can update their assigned orders
        allow update: if isAuthed() && isEmailVerified() && (
          isSelf(userId) &&
          resource.data.productOwnerId == request.auth.uid
        );
        
        // DELETE: Product owner can delete their assigned orders
        allow delete: if isAuthed() && isEmailVerified() && (
          isSelf(userId) &&
          resource.data.productOwnerId == request.auth.uid
        );
      }

      // --- Distributor Orders To Product Owner (reverse flow) ---
      // Path: businesses/{productOwnerId}/distributorOrderRequests/{orderId}
      match /distributorOrderRequests/{orderId} {
        // READ: Product owner can read orders from distributors, Distributor can read orders they sent
        allow read: if isAuthed() && (
          // Product owner reading their orders
          (isSelf(userId) && isEmailVerified()) ||
          // Distributor reading orders they sent
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["distributor", "Distributor"] &&
           resource.data.distributorId == request.auth.uid)
        );
        
        // CREATE: Distributor can create order requests to product owner
        allow create: if isAuthed() && isEmailVerified() && (
          exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["distributor", "Distributor"] &&
          exists(/databases/$(database)/documents/businesses/$(userId)) &&
          get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["productowner", "ProductOwner"] &&
          exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedProductOwners/$(userId)) &&
          request.resource.data.distributorId == request.auth.uid &&
          request.resource.data.productOwnerId == userId
        );
        
        // UPDATE: Both product owner and distributor can update order status
        allow update: if isAuthed() && isEmailVerified() && (
          // Product owner updating order status
          (isSelf(userId)) ||
          // Distributor updating order they sent
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["distributor", "Distributor"] &&
           resource.data.distributorId == request.auth.uid)
        );
        
        // DELETE: Only product owner can delete
        allow delete: if isAuthed() && isEmailVerified() && isSelf(userId);
      }

      // --- Sent Orders To Product Owner (Distributor's mirror view) ---
      // Path: businesses/{distributorId}/sentOrdersToProductOwners/{orderId}
      match /sentOrdersToProductOwners/{orderId} {
        // READ: Distributor can read orders they sent to product owners, Product Owner can read orders they're quoting
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) ||
          isDistributorEmployee(userId) ||
          // Product Owner can read orders they need to quote
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/distributorOrderRequests/$(orderId)))
        );
        
        // CREATE: Distributor can create mirror record when sending order, Product Owner can create when submitting quote
        allow create: if isAuthed() && isEmailVerified() && (
          (isSelf(userId) && request.resource.data.distributorId == request.auth.uid) ||
          (isDistributorEmployee(userId) && request.resource.data.distributorId == userId) ||
          // Product Owner can create when submitting a quote (document might not exist if distributor's mirror creation failed)
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           request.resource.data.productOwnerId == request.auth.uid &&
           request.resource.data.distributorId == userId &&
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/distributorOrderRequests/$(orderId)))
        );
        
        // UPDATE: Distributor can update orders they sent, Product Owner can update when sending quote
        allow update: if isAuthed() && isEmailVerified() && (
          (isSelf(userId) && resource.data.distributorId == request.auth.uid) ||
          (isDistributorEmployee(userId) && resource.data.distributorId == userId) ||
          // Product Owner can update when they send a quote
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["productowner", "ProductOwner"] &&
           resource.data.productOwnerId == request.auth.uid)
        );
        
        // DELETE: Distributor can delete orders they sent
        allow delete: if isAuthed() && isEmailVerified() && (
          (isSelf(userId) && resource.data.distributorId == request.auth.uid) ||
          (isDistributorEmployee(userId) && resource.data.distributorId == userId)
        );
      }
      
      // --- Orders (Product Owner's view of orders) ---
      match /orders/{orderId} {
        // READ: Product owner can read their orders
        allow read: if isAuthed() && isSelf(userId) && isEmailVerified();
        
        // CREATE: Product owner can create orders (assigned to distributors)
        // Also allows distributors to create orders in product owner's collection (for order requests)
        allow create: if isAuthed() && isEmailVerified() && (
          // Product owner creating order
          (isSelf(userId)) ||
          // Distributor creating order request in product owner's collection
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["distributor", "Distributor"] &&
           exists(/databases/$(database)/documents/businesses/$(userId)) &&
           get(/databases/$(database)/documents/businesses/$(userId)).data.role in ["productowner", "ProductOwner"] &&
           exists(/databases/$(database)/documents/businesses/$(request.auth.uid)/connectedProductOwners/$(userId)))
        );
        
        // UPDATE: Both product owner and distributor can update order status
        allow update: if isAuthed() && isEmailVerified() && (
          // Product owner updating their order
          (isSelf(userId)) ||
          // Distributor updating order status (e.g., accepting, shipping, completing)
          (exists(/databases/$(database)/documents/businesses/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/businesses/$(request.auth.uid)).data.role in ["distributor", "Distributor"] &&
           resource.data.distributorId == request.auth.uid)
        );
        
        // DELETE: Only product owner can delete
        allow delete: if isAuthed() && isEmailVerified() && isSelf(userId);
      }

      match /connectedRetailers/{retailerUid} {
        // READ: Allow distributor employees to read connected retailers (needed for order creation)
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          request.auth.uid == retailerUid ||
          isDistributorEmployee(userId)
        );

        // UPDATE: Allow retailer to update their own profile fields
        allow update: if isAuthed()
          && request.auth.uid == retailerUid
          && request.resource.data.retailerId == retailerUid
          && !('status' in request.resource.data)
          && !('connectedAt' in request.resource.data)
          && request.resource.data.keys().hasOnly([
            'retailerId','retailerName','retailerEmail','retailerPhone',
            'city','businessName','gstNumber','logoUrl','updatedAt'
          ]);

        // UPDATE: Allow distributor/employees to update PROVISIONAL retailer information
        // This allows editing businessName, email, phone, city, state, address, gst for provisional retailers
        allow update: if isAuthed()
          && (
            (isSelf(userId) && isEmailVerified()) ||
            isDistributorEmployee(userId)
          )
          // Only allow for provisional retailers (check status or source field)
          && (
            // If status exists and is a string, check if it starts with "provisioned"
            (resource.data.status is string && resource.data.status.matches('(?i)^provisioned.*')) ||
            // If source exists and is a string, check if it starts with "provisioned"
            (resource.data.source is string && resource.data.source.matches('(?i)^provisioned.*')) ||
            // If status doesn't exist or is null, allow update (likely provisional)
            (resource.data.status == null)
          )
          // Allow updating retailer information fields (check if only these fields changed)
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'businessName', 'retailerName',
            'email', 'retailerEmail',
            'phone', 'retailerPhone',
            'city', 'retailerCity',
            'state', 'retailerState',
            'address', 'retailerAddress',
            'gst', 'gstNumber',
            'updatedAt'
          ])
          // Ensure status and source don't change (keep as provisional)
          && (!('status' in request.resource.data) || request.resource.data.status == resource.data.status)
          && (!('source' in request.resource.data) || request.resource.data.source == resource.data.source);

        // UPDATE: Allow distributor/employees to update location fields (lat, lng, formattedAddress)
        // Rule allows updating ONLY location-related fields for distributors and their employees
        allow update: if isAuthed()
          && (
            (isSelf(userId) && isEmailVerified()) ||
            isDistributorEmployee(userId)
          )
          // Get changed keys
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'lat','lng','formattedAddress','locationUpdatedAt','updatedAt'
          ])
          // Validate lat/lng data types
          && (request.resource.data.lat is number || request.resource.data.lat == null)
          && (request.resource.data.lng is number || request.resource.data.lng == null);

        allow create: if isAuthed() && (
          (request.auth.uid == retailerUid &&
            request.resource.data.retailerId == retailerUid &&
            request.resource.data.keys().hasOnly([
              'retailerId','retailerName','retailerEmail','retailerPhone',
              'city','businessName','gstNumber','logoUrl','updatedAt'
            ])
          ) ||
          // Allow business owner (distributor or product owner) to create retailers
          (request.auth.uid == userId && isEmailVerified()) ||
          isDistributorEmployee(userId)
        );

        match /assistantChats/{messageId} {
          allow read, write: if isAuthed() && (
            (isSelf(userId) && isEmailVerified()) || 
            request.auth.uid == retailerUid
          );
        }
      }

      match /incomingOrders/{orderId} {
        allow create: if isAuthed() && (
          (request.auth.uid != userId && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );

        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- DIRECT ORDERS ---
      match /orders/{orderId} {
        allow create: if isAuthed() && (
          ((isSelf(userId) && isEmailVerified()) &&
            request.resource.data.distributorId == userId &&
            request.resource.data.retailerId is string)
          ||
          (!isSelf(userId) &&
            isConnectedRetailer(userId) &&
            request.resource.data.retailerId == request.auth.uid &&
            request.resource.data.distributorId == userId)
          ||
          (isDistributorEmployee(userId) &&
            request.resource.data.distributorId == userId &&
            request.resource.data.retailerId is string)
        );

        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          request.auth.uid == resource.data.retailerId || 
          isDistributorEmployee(userId)
        );

        allow update, delete: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- ORDER REQUESTS (active & passive) ---
      match /orderRequests/{orderId} {
        allow create: if isAuthed() && (
          (
            // Passive (distributor-initiated)
            (isSelf(userId) && isEmailVerified()) &&
            request.resource.data.createdBy == "distributor" &&
            request.resource.data.creatorUid == request.auth.uid &&
            request.resource.data.distributorId == userId
          )
          ||
          (
            // Active (retailer-initiated)
            !isSelf(userId) &&
            isConnectedRetailer(userId) &&
            request.resource.data.createdBy == "retailer" &&
            request.resource.data.creatorUid == request.auth.uid &&
            request.resource.data.distributorId == userId &&
            request.resource.data.retailerId == request.auth.uid
          )
          ||
          (
            // Passive (distributor employee-initiated with createdBy: "distributor" - original logic)
            isDistributorEmployee(userId) &&
            hasEmployeeAccess(userId, "createOrders") &&
            request.resource.data.createdBy == "distributor" &&
            request.resource.data.creatorUid == request.auth.uid &&
            request.resource.data.distributorId == userId
          )
          ||
          (
            // NEW: Passive (distributor employee-initiated with createdBy: "employee")
            isDistributorEmployee(userId) &&
            hasEmployeeAccess(userId, "createOrders") &&
            request.resource.data.createdBy == "employee" &&
            request.resource.data.creatorUid == request.auth.uid &&
            request.resource.data.distributorId == userId
          )
        );

        // Owner and employees with manageOrders access can manage orderRequests
        allow read, update, delete: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          (isDistributorEmployee(userId) && hasEmployeeAccess(userId, "manageOrders"))
        );
      }

      // --- Custom Columns for Inventory ---
      match /customColumns/{columnId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- Employee Activity Tracking ---
      match /employeeActivity/{activityId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- WhatsApp Inbox (Incoming Messages) ---
      match /whatsappInbox/{messageId} {
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
        // Write is handled by Cloud Functions (webhook)
        allow write: if false;
      }

      // --- WhatsApp Messages (Outgoing Messages) ---
      match /whatsappMessages/{messageId} {
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
        // Write is handled by Cloud Functions and whatsappService
        allow create: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
        // Update is handled by Cloud Functions (status updates)
        allow update: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
        allow delete: if false;
      }

      // --- WhatsApp Conversations (Conversation metadata) ---
      match /whatsappConversations/{conversationId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- WhatsApp Menus (Automated Response Menus) ---
      match /whatsappMenus/{menuId} {
        allow read, write: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }

      // --- Delivery Routes (Route Optimization) ---
      match /deliveryRoutes/{routeId} {
        // READ: Distributor and employees can read routes
        allow read: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
        
        // CREATE: Distributor and employees can create routes
        allow create: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
        
        // UPDATE: Distributor and employees can update routes
        allow update: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
        
        // DELETE: Distributor and employees can delete routes
        allow delete: if isAuthed() && (
          (isSelf(userId) && isEmailVerified()) || 
          isDistributorEmployee(userId)
        );
      }
    }

    // ============================================================
    // PROVISIONAL RETAILERS (Distributor-added temporary accounts)
    // ============================================================
    match /provisionalRetailers/{pid} {
      allow read: if isAuthed() && (
        (request.auth.uid == resource.data.createdBy && isEmailVerified()) ||
        (isDistributorEmployee(resource.data.createdBy) &&
         hasEmployeeAccess(resource.data.createdBy, "addRetailers"))
      );
      allow write: if false; // CF only
    }

    // ============================================================
    // GLOBAL COLLECTIONS
    // ============================================================
    match /assistantQueries/{docId} {
      allow create: if isAuthed();

      allow read: if isAuthed() && request.auth.uid == resource.data.userId && isEmailVerified();

      allow update: if isAuthed() && request.auth.uid == resource.data.userId && isEmailVerified();
    }

    match /channels/{channelId} {
      allow read, write: if isAuthed();

      match /messages/{messageId} {
        allow read, write: if isAuthed();
      }
    }

    // Global employee index lookup (read-only helper)
    match /employeeIndex/{flypId} {
      allow read: if isAuthed();
    }

    // ðŸ” PHONE UNIQUENESS & RESERVATION
    match /phoneIndex/{e164} {
      allow create: if isAuthed()
        && request.resource.data.uid == request.auth.uid
        && !exists(/databases/$(database)/documents/phoneIndex/$(e164));
      allow read: if isAuthed() && request.auth.uid == resource.data.uid;
      allow update, delete: if false;
    }

    // Block any future OTP scratch from client
    match /otpRequests/{docId} {
      allow read: if false;
      allow write: if false;
    }

    // ============================================================
    // DEMO REQUESTS (Landing Page Form Submissions)
    // ============================================================
    match /demoRequests/{requestId} {
      // Allow anyone (even unauthenticated) to create demo requests from landing page
      allow create: if request.resource.data.keys().hasOnly([
        'name', 'businessCategory', 'role', 'phone', 'email', 
        'submittedAt', 'timestamp', 'status'
      ])
      && request.resource.data.name is string
      && request.resource.data.businessCategory is string
      && request.resource.data.role is string
      && request.resource.data.phone is string
      && request.resource.data.email is string
      && request.resource.data.status == 'new';

      // Allow authenticated users to read (for admin dashboard)
      allow read: if isAuthed() && isEmailVerified();

      // Allow updates only for status changes (for marking as contacted/processed)
      allow update: if isAuthed() && isEmailVerified()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])
        && request.resource.data.status in ['new', 'contacted', 'converted', 'rejected'];

      // No deletes from client (admin can delete via console if needed)
      allow delete: if false;
    }

    // Website Analytics - Allow unauthenticated users to track page views and events
    match /websiteAnalytics/{docId} {
      // Allow anyone to create analytics events (page views, button clicks, etc.)
      allow create: if true;

      // Only authenticated admins can read analytics data
      allow read: if isAuthed() && isEmailVerified();

      // No updates or deletes from client
      allow update: if false;
      allow delete: if false;
    }

    // Event Leads - Public collection for expo/event lead management (no authentication required)
    // This allows quick lead capture at events without requiring login
    match /eventLeads/{leadId} {
      // Allow anyone to create leads (for expo use)
      allow create: if true;
      
      // Allow anyone to read leads (for viewing saved leads)
      allow read: if true;
      
      // Allow anyone to update leads (for editing lead information)
      allow update: if true;
      
      // Allow anyone to delete leads (for removing incorrect entries)
      allow delete: if true;
    }

    // ============================================================
    // WHATSAPP OAUTH SESSIONS (for Embedded Signup)
    // ============================================================
    match /whatsappOAuthSessions/{sessionId} {
      // Allow authenticated users to create their own sessions
      // Accepts both 'embedded_signup' and 'embedded_signup_sdk' types
      allow create: if isAuthed() 
        && request.resource.data.uid == request.auth.uid
        && (request.resource.data.type == 'embedded_signup' 
            || request.resource.data.type == 'embedded_signup_sdk');
      
      // Allow users to read their own sessions
      allow read: if isAuthed() 
        && resource.data.uid == request.auth.uid;
      
      // Allow users to delete their own sessions (cleanup after use)
      allow delete: if isAuthed() 
        && resource.data.uid == request.auth.uid;
      
      // No updates - sessions are immutable
      allow update: if false;
    }

    // ============================================================
    // PENDING WABAs (fallback for unmatched WABAs)
    // ============================================================
    match /pendingWABAs/{wabaId} {
      // Cloud Functions can create pending WABAs
      allow create: if false; // Only CF can create
      
      // Users can read pending WABAs (for matching)
      allow read: if isAuthed() && isEmailVerified();
      
      // Cloud Functions can update/delete
      allow update, delete: if false; // Only CF can update/delete
    }
  }
}
